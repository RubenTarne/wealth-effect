---
title: "Financial Vulnerability and the Housing Market - an Agent-Based Analysis"
author: "Ruben Tarne"
date: "`r Sys.Date()`"
header-includes: 
- \usepackage{amsmath, amsfonts, longtable, tabulary, calc, subfig, booktabs, array, caption}
- \usepackage{floatrow, multirow, wrapfig, float, colortbl, pdflscape, tabu, threeparttable}
- \usepackage{threeparttablex}
- \usepackage[normalem]{ulem}
- \usepackage{makecell}
- \usepackage{xcolor}
- \usepackage{placeins}
- \floatsetup[figure]{capposition=top}
- \floatsetup[table]{capposition=top}
- \renewcommand{\textfraction}{0.05}
- \renewcommand{\topfraction}{0.8}
- \renewcommand{\bottomfraction}{0.8}
- \renewcommand{\floatpagefraction}{0.75}
output:
  bookdown::pdf_document2:
    keep_tex: true
    latex_engine: xelatex
    toc: false
  html_notebook: default
  html_document:
    df_print: paged
  bookdown::html_document2: default
  pdf_document: default
  word_document: default
  bookdown: bookdown::gitbook
  bookdown::word_document2:
    toc: true
abstract: "This paper explores the dynamics of financial fragility of indebted households over the housing cycle, utilising an agent-based housing market model, calibrated using UK mirco data. Two different channels by which mortgage-debt holders can become financially vulnerable, are of interest: Households becoming financially vulnerable by purchasing property and homeowners becoming vulnerable by a precautionary channel. A precautionary channel could induce homeowners to dissave in a housing market upswing and thereby reduce their financial buffers, making them more susceptible to income or interest rate shocks. Interestingly, the precautionary channel seems to be at least as important for the dynamics of financial vulnerability as the direct effect of purchases, while at a different state of the housing cycle. This finding makes a case for including a precautionry saving motive into the analyses of financial vulnerability dynamics, like now-casts of forecasts. Additionally, the model produces strong path depencies of financial vulnerability, specifically, peaks of previous housing cycles influence current financial vulnerability significantly. This result carries the policy implication that high house prices alone could be increasing financial vulnerability by inducing over-consumption and the depletion of financial buffers."
bibliography: "library-zotero.bib"
biblio-style: "apalike"
link-citations: true
indent: true
---

```{r, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
# This code runs the housing market model with the pre-specified parameter values - however, for micro-data analysis pre-calculations have to be done for building the data frames necessary 
# shell(paste("mvn exec:java", shQuote("-Dexec.args=-configFile src/config-files/test/agent_Data_0.155_0.888_0.98.properties -outputFolder Results/test_agent_Data_0.155_0.888_0.98 -dev")))
# shell(paste("mvn exec:java", shQuote("-Dexec.args=-configFile src/config-files/test/agent_Data_1.0_egal_0.961_noFTBSM.properties -outputFolder Results/test_agent_Data_1.0_egal_0.961_noFTBSM -dev")))

library(here)
library(bookdown)
library(knitr)
library(kableExtra) # needs to be called here to install the necessary latex packages, see: https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_pdf.pdf
source(here::here("R code files\\R functions WP vulnerabilities.R"))
set.seed(1)
# set the model and folder names for the baseline version 
model_name_1 <- "Monte10_0.163_0.682_0.595_3.674_67_0.984_0.972_0.802_vul40" # use here either the string of param values or the Monte10 version without the "test_"
model_folder_1 <- paste0("test_", model_name_1) #agent_Data_0.155_0.888_0.98 test_Monte10_0.222_0.556_0.657_4_0.988_0.969_0.7 # the folder is named differently than the model, by adding test_ before
model_folder_noFTBSM_1 <- "test_Agent_data_0.163_0.682_0.595_3.674_67_0.984_0.972_0.802_vul40"  # test_agent_Data_0.155_0.888_0.98_noFTBSM

# set the model and folder names for the "less-at-risk" model version
model_name_2 <- "Monte10_0.163_0.682_0.595_3.674_67_0.984_0.972_0.802_vul50" # use here either the string of param values or the Monte10 version without the "test_"
model_folder_2 <- paste0("test_", model_name_2) #agent_Data_0.155_0.888_0.98 test_Monte10_0.222_0.556_0.657_4_0.988_0.969_0.7 # the folder is named differently than the model, by adding test_ before
model_folder_noFTBSM_2 <- "test_Agent_data_0.163_0.682_0.595_3.674_67_0.984_0.972_0.802_vul50"  # test_agent_Data_0.155_0.888_0.98_noFTBSM

troughs_limits <- c(6,7) # this gives the index of the troughs spanning all figures with a housing cycle. c(2,3) would mean "paint from trough 2 to trough 3"
rolling_averages <- 6
vul_rho_1 <- 0.4 # BLC calculation for financial vulnerabitlity threshold 
vul_rho_2 <- 0.5
monthsToCover <- 8


```

```{r message=FALSE, warning=FALSE, cache=TRUE, readData, echo=FALSE, results='hide'}
outfile_1 <- read_csv(here::here(paste0("Results/", model_folder_1, "/Output-run1.csv")))
outfile_2 <- read_csv(here::here(paste0("Results/", model_folder_2, "/Output-run1.csv")))
properties_file <- read.properties(here::here(paste0("Results/", model_folder_1, "/", model_name_1, ".properties")))
nMCRuns <- as.numeric(properties_file$N_SIMS) # read here number of monte carlo simulations
nPeriods <- as.numeric(properties_file$N_STEPS) - as.numeric(properties_file$TIME_TO_START_RECORDING)
# outfile <- read_outfile_total(wd_model = "Results", model_folder_name = model_folder, nRuns = nMCRuns) 

was_wave_5_hhold_eul_final <- read_sav("~/UK-WEA-survey/UKDA-7215-spss/spss/spss24/was_wave_5_hhold_eul_final.sav")

agent_data_vul_1 <-         readRDS(file = here::here(paste0("Agent_data_", model_folder_noFTBSM_1, ".rds")))
transactions_vul_1 <-       readRDS(file = here::here(paste0("transactions_", model_folder_noFTBSM_1,".rds")))

# different_Ampudia_vul_1 <-  readRDS(file = here::here(paste0("different_Ampudia_", model_folder_noFTBSM_1,".rds")))

agent_data_vul_2 <-         readRDS(file = here::here(paste0("Agent_data_", model_folder_noFTBSM_2, ".rds")))
transactions_vul_2 <-       readRDS(file = here::here(paste0("transactions_", model_folder_noFTBSM_2,".rds")))
different_Ampudia_vul_2 <-  readRDS(file = here::here(paste0("different_Ampudia_", model_folder_noFTBSM_2,".rds")))

# load(here::here(file = paste0(model_folder_noFTBSM_1, ".RData"))) # this includes sortingData_data_vul_FTBS and transactions_hpi
# # load(here::here(file = paste0(model_folder_noFTBSM_1,"_diffAmpudia.RData"))) # this is for testing the consumption channel strength with different Ampudia measures
# load(here::here(file = paste0("test_Agent_data_0.23_0.515_0.457_2.195_71_0.923_0.833_0.977_povLine40Percent_40vul","_diffAmpudia.RData")))


```

# Introduction

The economic downturn after the Great Financial Crisis of 2007/08 increased households' difficulties in servicing their mortgage debt that had been increasing rapidly in the years prior. Especially lower-income and more highly-leveraged households seemed to be hit hardest, leading to defaults and significant reductions in consumption [@Mian2013]. These reductions in consumption seemed to be partly due to lower collateral values limiting the households' ability for equity withdrawal and a precautionary saving motive of households increasing their precautionary wealth [@Aladangady2017; @carroll_concavity_1996; @carroll_how_2011]. But how exactly did the households end up in this financially vulnerable state? To what extend is it due to higher debt services and lower liquidity due to previous property purchases? And to what extend is it due to a precautionary channel, where households deplete their financial assets when house prices are rising, leaving them more exposed when prices start falling? Answering these questions is important for understanding the evolution of financial vulnerability and countering it effectively.

This paper addresses these questions by using an agent-based housing market model simulating endogenous boom and bust cycles of house prices and mortgage credit while households adopt a precautionary (or collateral) saving motive. Interestingly, the precautionary saving motive is found to be a strong driver of financial vulnerability. When house prices are high financial vulnerability rises as households close to their credit constraint reduce their financial buffer stock. Moreover, previous house price booms influence the financial vulnerability in the current cycle. Households that bought property in previous booms can become newly financially vulnerable in later periods of high house prices due to consuming their financial buffer. From a policy perspective, this result implies that periods of high house prices themselves could increase financial vulnerability -- even in the complete absence of new households going into debt. It follows that either interfering in individual consumption choices, i.e. constraining the dissaving of buffer stocks at high house prices, or dampening house boom phases could limit this effect.

This paper connects the literature of collateral and precautionary saving with that of estimating and understanding drivers of financial vulnerability of households. The collateral effect describes the ability of households to finance their desired consumption with help of withdrawing equity from their property via a mortgage. Changes in the value of their property (i.e. their collateral) affect their ability to take out loans to finance their consumption. This can affect the consumption decisions of credit-constrained households, usually households that are highly leveraged or have high debt-service-to-income ratios. To distinguish the precautionary and collateral channel can be quite difficult in reality, as to assess if a household is currently credit constrained or just close to their constraint, is hard. Their effects on consumption, meanwhile, is hard to distinguish. The collateral channel would imply that with falling house prices more credit-constraint households would have less ability to withdraw house equity, lowering their consumption spending. In a similar way, households not yet restricted but getting closer to their borrowing limit (due to falling house prices) could reduce their spending to increase their precautionary wealth. @Mian2013 find a collateral channel to be essential in explaining the drop in aggregate consumption after the financial crisis of 2007/08. Their findings have been supported by @Kaplan2016. @cloyne_effect_2019 show similarly the importance of a collateral channel to explain aggregate consumption fluctuations in the UK between 2005-15. @Aladangady2017 find for the US a consumption sensitivity to house prices for households with above-median debt-service-to-income ratios (DSRs) but not for households with below median DSRs, i.e. for households that are potentially credit-constrained or close to their credit constraint. These findings are mirrored by @Zhang2019 for the Netherlands. @guerrieri_credit_2017 find that a precautionary channel can explain the recent economic recession followed by an environment of low interest rates. All these findings point to the importance of a precautionary and/or collateral channel connecting the housing cycle with the business cycle.

To the author's knowledge, the effects of these channels on the financial vulnerability of households themselves have not yet been directly studied, however, some empirical studies touch upon the relationship. For instance, @brunetti_financial_2020 expand the analysis of financially vulnerable households @brunetti_is_2016 from Italy to several European countries and the US. Both papers find that increases in the illiquidity of a household's portfolio due to housing strongly increases its chance to become financially fragile. Theoretically, this illiquidity could be partly driven by a precautionary channel. @brunetti_is_2016 estimate household financial fragility based on the Italian household micro data between 1998 and 2012. They categorize households as fragile when they are not able to cover 1,500 â‚¬ of unexpected expenses. This measure does therefore not necessarily aim to capture over-indebted households but households with poor portfolio allocation. They find that portfolios tend to become too illiquid in housing market boom phases -- which, again, would be in line with the workings of a precautionary channel. @kaplan_wealthy_2014 find on the basis of household micro data from the US (1989-2010), UK (2008-10), Germany (2008-10) and others the share of wealthy hand-to-mouth households, i.e. households that spend all their available resources in every pay-period and hold considerable amounts of illiquid wealth but no liquid wealth (financial buffer). They find that roughly 20% of households in the US qualify as wealthy hand-to-mouth and 22% of households in the UK. Potentially, precautionary (or collateral) saving motives play a role in such a large share of households being wealthy hand-to-mouth households.

The paper also connects to the research of financial vulnerability of households, by identifying the precautionary channel as a potentially important and overlooked driver in financial vulnerability. A larger strand of literature is concerned with estimating the effects of different macroeconomic developments on the financial vulnerability of households while trying to address the lack of timeliness of micro household data. Most of this literature is performing stress tests -- like interest rate hikes or unemployment increases -- on household micro data, after the data has been adjusted for current macroeconomic trends.[^1] This adjustment is usually done in a relatively static way by projecting developments in the national accounts on the single households in the micro data. There are, however, some now-casting studies explicitly modelling households behaviour, making the projections more dynamic. These include @ampudia_household_2016 and @Ampudia2016, working with the European Household Finance and Consumption Survey (HFCS) [@european_central_bank_household_2020] or @peterson_household_2016 working with Canadian micro household data. @ampudia_household_2016 implement a simulation of the consumption response of households to the changes in aggregate wealth (differentiated by asset class) while using heterogeneous marginal propensities to consume (MPC), dependent on the households income, following @Mian2013. They find that all income groups contribute, in real terms, equally to the observed slump in aggregate consumption, as high-income households experienced larger nominal losses in wealth than lower-income households but have lower MPCs. The authors focus, however, only on the effect the loss in wealth had on aggregate consumption while not considering the effect this consumption had on the financial vulnerability of households by lowering households' financial buffers. @peterson_household_2016 build a dynamic model connecting micro-household data with macro data to simulate future financial vulnerability under a given macroeconomic scenario. Households have simple behavioral rules and their balance sheets change over time. However, the authors do not consider a consumption response to changes in wealth.

[^1]: See for a brief literature overview @bankowska_household_2017.

But how important is a precautionary/collateral channel for the dynamics of the financial vulnerability of households? This paper explores this question while focusing on the housing market and the house price cycle, i.e. the effects of taking on mortgage debt and changes in the households' portfolio compositions. To this end, an agent-based model is employed as it allows to reflect a very high degree of heterogeneity and simulates individual market interactions. The high heterogeneity allows to recreate the unequal distributions of financial wealth, housing wealth, mortgage debt and income found in the micro data and which are essential in mapping financial vulnerability. Moreover, the distribution of financial wealth and income influences which households can afford to shift their portfolio composition towards housing wealth. This shift in their portfolio composition can make households financially vulnerable, for instance, by converting them to wealthy hand-to-mouth households [@kaplan_wealthy_2014]. The housing market allows for individual interactions, including between households and a commercial bank, applying loan-to-value rules and thereby limiting certain households from entering the housing market and between households themselves when buying and selling properties. What emerges is a housing cycle where turnover and clearing of the market varies strongly, influencing the emergence of financially vulnerable households. Because of the focus of this article on the housing market, the analysis of financially vulnerable households is limited to those holding mortgage debt, excluding renters.[^2]

[^2]: A relaxation of this assumption is made in Chapter \@ref(main-analysis-with-simpler-definition-of-financial-vulnerability) in the Appendix where the analysis of the main chapter is repeated with the financial vulnerability measure of @lusardi_financially_2011, i.e. includes all households owning less than 1500 money units in financial assets.

This paper contributes to the literature by exploring the dynamics of financial vulnerability over the housing cycle, accounting for a precautionary/collateral channel. Moreover, strong path dependencies of financial vulnerability are discovered, implying that past housing cycles can significantly affect current vulnerability. The paper also contributes by expanding the agent-based housing market model by @tarne_effect_2021 to include a precautionary channel and calibrate the newly implemented parameters to match key stylized facts about the UK housing market and the characteristics of financially vulnerable households.

The remainder of the paper is structured as follows. In Chapter \@ref(the-model) the model is introduced while focusing on the differences to the model in @tarne_effect_2021. Chapter \@ref(financial-vulnerability) introduces the concept of financial vulnerability employed here and Chapter \@ref(calibration) presents the calibration of the model. Chapter \@ref(results) introduces the different channels by which households become financially vulnerable in the model and shows their dynamics and relative importance over the housing cycle. Chapter \@ref(households-at-risk-of-becoming-financially-vulnerable) alters the definition of financial vulnerability to allow for some income risk. Chapter \@ref(characteristics-of-financially-vulnerable-households) compares the characteristics of households financially vulnerable and non-vulnerable and Chapter \@ref(path-dependency-of-financial-vulnerability) explores the path dependency of financial vulnerability. Finally, Chapter \@ref(conclusion) concludes.

# The Model

The model used here follows @tarne_effect_2021.[^3] Therefore, only a very brief introduction to the model is given here where the focus is put on the differences between this model version and the version in @tarne_effect_2021.

[^3]: A list with all equations from @tarne_effect_2021 can be found here: [\<https://github.com/RubenTarne/wealth-effect/blob/Tarne-BezemerTheobald/Equations%20-%20WP%20-%20Tarne%20Bezemer%20Theobald.pdf\>](https://github.com/RubenTarne/wealth-effect/blob/Tarne-BezemerTheobald/Equations%20-%20WP%20-%20Tarne%20Bezemer%20Theobald.pdf){.uri}. Their model itself is an adaptation of @Baptista2016.

## Overview

The model is an agent-based housing market model, calibrated using UK data. The model consists of heterogeneous households and a commercial bank. With young households entering and old households exiting the simulation, the demographic distribution is held stable to the UK distribution of 2011. Housing consists as a fixed stock where individual houses are characterised by a quality parameter serving as a proxy for their condition, size and location. Households can be renters in private housing, owner-occupiers, consisting of first-time-buyers (FTB) and second-and-subsequent buyers (SSB), and buy-to-let investors (BTL), which purchase property that they can rent out. Households that are in neither of these regimes build a residual called 'social housing.' Generally, households can change between these regimes, depending on their interactions on the housing and rental market. These interactions happen in discrete time (monthly steps) where households in the residual of social housing decide if renting privately or buying a home is relatively cheaper for them. When they decide to enter the ownership market their bid price is a function of their income, financial wealth and the mortgage credit the commercial bank is willing to lend. When households ask the commercial bank for a mortgage loan, the bank applies a specific loan-to-value ratio, depending on the regime of the household (first-time buyer, second-and-subsequent buyer, buy-to-let investor), to set the amount of credit it is willing to lend in case the household succeeds in purchasing a property on the market. BTL investors decide according to the projected yield of the property, considering current rental prices, house price expectations and mortgage costs. The supply-side of the housing market is filled by owner occupiers -- which move houses[^4], on average, every seventeen years (according to UK data) -- and buy-to-let investors, when they decide to sell their property -- which, again, is influenced by the expected yield of the property. The asking price of sellers is close (and slightly above) currently observed sale prices of houses of the same quality parameter.

[^4]: The reason for moving can be due to employment, divorce, etc. which the model does not cover.

All bids and offers are matched in a double auction. In a first round, each bid is matched with the offered house of the highest quality that is still affordable. If more than one bid is matched with an offer, there is a chance for the offer price to increase before being matched with a random bid (that still qualifies). In a second round, the mechanism of the first round is repeated with all bids and offers that have not been matched yet. Once no offers and bids can be matched anymore the auctioning process stops. Households whose bids and offers that have not been cleared decide the following month how to proceed: home-buyers re-calculate the costs of buying and renting and might decide to enter the rental market, buy-to-let investors re-calculate the prospective yield, and might decide against investing. Movers keep their house on the market but might decide to lower the offer price, buy-to-let investors with property for sale might decide to take it off the market if the investment gains for their property becomes favorable again.

The housing market generates boom-bust cycles with high turnover in the upswing and very low turnover in the house price bust (see Figure \@ref(fig:turnover) in the Appendix). The boom-bust cycle is primarily driven by the price expectation mechanism of households. These price expectations are backward-looking, i.e. built by projecting past price developments (conservatively) into the future. As the model does not encompass a firm sector, households receive their monthly employment income exogenously. Employment income is determined according to the household's age and their pre-set income percentile, according to UK micro data. This implies that there is no feedback loop from lower consumption induced by lower house prices to lower employment income -- via lower revenue of a firm sector. For the analysis of the dynamics of financial vulnerability, this will lead to an under-representation of financial vulnerability due to rising unemployment and lower income due to a housing bust.

The model version used here differs from @tarne_effect_2021 in two aspects. First, it implements a maximum age for households an age limit for taking on mortgages (the specific value is part of the output calibration presented in Chapter \@ref(calibration)), and more importantly, adjusts the consumption function to implement a precautionary/collateral channel. The households' new consumption function is described in detail in the next Chapter.

## Households' Consumption

@Aladangady2017 found the overall housing wealth effect of 4.7% in the US to be exclusively driven by households which are credit constrained (collateral channel) or close to their credit constraint (precautionary channel), which he defined as households with above-median debt-service-to income ratios (DSR). Specifically, these households have an estimated housing wealth effect of 12.7%, versus 0% for households with below-average DSRs. Similarly, @Zhang2019 finds a housing wealth effect for Dutch households with above-median debt-to-income ratios (DTI) of 10.3% versus 4.1% for households with below-median DTIs. These different responses to house prices could be driven by both a collateral or a precautionary channel. Households close to their borrowing constraint might adjust their spending based on their wealth indistinguishable from households that are credit-constrained [@Aladangady2017]. Credit-constrained and and households close to their borrowing limit might lower their spending when house prices are falling because they either have less access to credit or to increase their precautionary [@carroll_how_2011]. I implement a desired-consumption function mirroring these findings:

```{=tex}
\begin{equation}
c^{desired}_{i,t} = c_{0} + \alpha_{i} y^{m,disp}_{i,t} + \beta_{i}b_{i,t} + \gamma_{i,t} (w^{h}_{i,t} -  q_{i,t}),
(\#eq:dConsumption)
\end{equation}
```
where $c_{0}$ represents the basic consumption and is set to the poverty line of 40% of median income, following @Ampudia2016.[^5] $y^{m,disp}_{i,t}$ is monthly disposable income (defined as $y_{i,t} - \sum_{i=1}^{k} m_{i,k}$)[^6], $b_{i,t}$ deposits, $w^{h}_{i,t}$ gross housing wealth and $q_{i,t}$ mortgage debt. $\alpha_{i}$ is dependent on the on the agents' income (specifically their income percentile assigned at "birth" $\Xi_{i}$), becoming weaker the higher the household's income, while first-time buyer agents have an extra saving motive to save up for a down payment.[^7] $\beta_{i}$, like $\alpha_{i}$ gets weaker the higher the households' income [@Dynan2004; @Arrondel2019].

[^5]: In @tarne_effect_2021 $c_{0}$ is lower and set to the minimum monthly earnings a household could have, corresponding to the monthly income support of the UK government.

[^6]: To be consistent with @Ampudia2016, I exclude mortgage and rental payments, i.e. housing consumption, from the caclculation of desired consumption.

[^7]: First-time buyers with $\Xi_{i} >$ `r properties_file$minIncomePercentile` have marginal propensity to consume out of disposable income ($\alpha_{i}$) of `r properties_file$MPCForFirstTimeBuyers`. This diverges from @tarne_effect_2021. See chapter \@ref(calibration) in the Appendix for the calibration of these values.

$\gamma_{i,t}$ is the effect of net housing wealth on consumption. If the households DSR is above the median, $\gamma_{i,t} = 0.01$ (which adds up to a yearly value of 12.7%). The households DSR is defined as the sum of monthly mortgage payments over its income $\sum_{i=1}^{k} m_{i,k} / y_{i,t}$. The desired consumption is subject to certain constraints:

```{=tex}
\begin{equation}
c_{i,t} = 
\begin{cases}
\text{if } b_{i,t}-( c^{desired}_{i,t} - y^{m,disp}_{i,t} )<\zeta_{i,t} y^{m,disp}_{i,t} &\text{, }\beta_{i}, \gamma_{i,t} = 0\\
\text{if } c^{desired}_{i,t} < c_{0} & \text{, } \alpha_{i}, \beta_{i}, \gamma_{i,t} = 0\\
\text{if } y^{m,disp}_{i,t} <  c_{0} \text{ and first condition does not hold} & \text{, } c^{desired}_{i,t} = y^{m,disp}_{i,t}\\
\text{else } & \text{, } c_{i,t}=c^{desired}_{i,t}
\end{cases}
(\#eq:Consumption)
\end{equation}
```
where the first condition states that households do not consume more than their current disposable income (after taxes and mortgage payments) if it would bring their deposits below a precautionary value ($\zeta_{i,t} y^{m,disp}_{i,t}$),[^8] which is $0$ if the household has a DSR above the median. The second condition states that households always consume $c_{0}$, even if their desired consumption is lower (for instance due to large negative housing wealth or the first-time buyer saving motive). However, if the household's income is below 40% of median income and its deposits are not exceeding its liquidity preference, the household only consumes her disposable income.[^9]

[^8]: Set to `r properties_file$liquidityPreference`. See calibration in chapter \@ref(calibration).

[^9]: In very rare cases, for instance for BTL investors with large mortgage payments and low rental income, households can have negative disposable income. These households then dissave as long as they have financial wealth. Once they go bankrupt, their deposits are set to zero for the following month -- which represents a very rudimentary default mechanism.

# Financial Vulnerability

To calibrate the financial vulnerability in the model to that of the Wealth and Asset Survey, the concept of financial vulnerability, used for the analysis of this paper, must be introduced first. It is defined following @Ampudia2016. First, the financial margin $FM_{i,t}$ of a household is calculated as its monthly income, less its monthly mortgage payments and its basic living expenses $c_{0}$:

```{=tex}
\begin{equation}
FM_{i,t} = y^{\text{net}}_{i,t} - \sum_{i=1}^{k} m_{i,k} - \rho y^{median}_{t},
(\#eq:FM)
\end{equation}
```
where $FM_{i,t,}$ is the household's financial margin, $y^{\text{net}}_{i,t}$ her post-tax income, $\sum_{i=1}^{k} m_{i,k}$ is the sum of her monthly mortgage payments (which are constant over their individual repayment period), $i$ the individual index of the household, $t$ the simulation period (month) and $k$ the house the mortgage is paid for. $\rho y^{median}_{t}$ are the basic living costs (excluding housing consumption), matching $c_{0}$ as 40% of median income [@Ampudia2016]. If a household has a negative financial margin, it is financially distressed, meaning, income minus the mortgage payments is not enough to meet monthly basic living expenses. If the households hold debt[^10] and cannot, from income or deposits, service their payments for less than eight months they are considered to be financially vulnerable:[^11]

[^10]: @Ampudia2016 generally include households in their analysis, regardless of them holding debt. However, as they are interested in analysing the effects of stress tests on the overall exposure at default, they ultimately consider only indebted households. As the model presented here features only mortgage debt and thereby excludes possible indebtedness of renters, for simplicity, I only include indebted households in this analysis. However, in Chapter \@ref(main-analysis-with-simpler-definition-of-financial-vulnerability) in the Appendix I re-do the main analysis of the paper with a simpler definition of financial vulnerability (all households with less than 1500 money units), including households without debt holdings.

[^11]: Following @Ampudia2016, the number of months set as a threshold here is chosen so that the exposure at default (EAD) of the commercial bank in the model matches the share of non-performing mortgage loans to all mortgage loans in the UK, which was 2.4% between 2015-2019 [@EBA2019]. As is explained in more detail in chapter \@ref(causes-for-financial-vulnerability), to calibrate the model I define basic living costs with $\rho =$ `r vul_rho_2`, not `r vul_rho_1` as defined above, to allow for capturing some income risk, otherwise not present in the model. The exposure at default (EAD) in the current model calibration is `r formattable::percent(mean(outfile_2$"EAD Ampudia (X*medIncome Y*m)"), digits = 1)`.

```{=tex}
\begin{equation}
f_{i,t} = 
\begin{cases}
1 \iff FM_{i,t}< 0 \land  |FM_{i,t}| \cdot 8 > b_{i,t} \and q_{i,t} > 0\\
0 \iff FM_{i,t} \geq 0 \lor  |FM_{i,t}| \cdot 8 \leq b_{i,t} \lor q_{i,t} \leq 0
\end{cases}.
(\#eq:finVul)
\end{equation}
```
# Calibration

```{r buildingDistributionData, echo=FALSE, message=FALSE, warning=FALSE, results=FALSE}

Wave_5_HH <- was_wave_5_hhold_eul_final%>%
  mutate(MortgagePayment1 = case_when(MPayM1W5 %in% c(-9:-6) ~ 0, TRUE~as.numeric(MPayM1W5)),
         MortgagePayment2 = case_when(MPayM2W5 %in% c(-9:-6) ~ 0, TRUE~as.numeric(MPayM2W5)),
         MortgagePayment3 = case_when(MPayM3W5 %in% c(-9:-6) ~ 0, TRUE~as.numeric(MPayM3W5)),
         totalMortgagePayments = MortgagePayment1 + MortgagePayment2 + MortgagePayment3,
         Mortgage1 = case_when(MVal1W5 %in% c(-9:-6) ~ 0, TRUE~as.numeric(MVal1W5)),
         Mortgage2 = case_when(MVal2W5 %in% c(-9:-6) ~ 0, TRUE~as.numeric(MVal2W5)),
         Mortgage3 = case_when(MVal3W5 %in% c(-9:-6) ~ 0, TRUE~as.numeric(MVal3W5)),
         totalMortgageDebt = Mortgage1 + Mortgage2 + Mortgage3)%>%
  select(totalMortgageDebt,
         totalMortgagePayments,
         w5xshhwgt,                    # weight
         HRPDVAgeW5,                # age
         
         NumAdultW5, # number adults in household
         NumChildW5, # number of children
         Ten1w5_i, # tenure (only one is imputed)
         
         ## mortgages and housing
         MNumbNW5, #	Number mortgages or loans on property (only if no mortgage in W4 on this property
         MNumbOW5, #	Number mortgages or loans on property (only if mortgage in W4 on this property
         MNumbw5_i, #	Number of mortgages/loans
         MVal1W5, #	Amount still outstanding mortgageloan
         MValB1W5, #	Banded amount outstanding on mortgageloan (only about 100)
         MYLft1W5,        # Years left to run on mortgage
         # MPayM1W5, # Total monthly repayments for mortgage
         MPayB1W5, # Banded amount (about 25)
         MPastSPA1W5, # expecting to pay mortgage past pension age
         MIntRate1W5,	# Interest paid on mortgage?

         TotMortw5, # Total mortgage on main residence
         DVHValuew5, # Value of main residence
         OthMortw5_sum, #Total property debt
         DBurdHW5, # debt burden
         HBuyYrW5, #	Year bought main residence
         
         # finanaical wealth
         
         HFINWw5_sum, # Gross Financial Wealth
         HFINWNTw5_sum,   # Household Net financial Wealth (financial assets minus financial liabilities)
        
         DVTotGIRW5,                 # Household Gross Annual (regular) income
         DVTotNIRW5,                 # Household Net Annual (regular) income
         DVGrsRentAmtAnnualw5_aggr,  # Household Gross annual income from rent
         DVNetRentAmtAnnualw5_aggr,  # Household Net annual income from rent
       
         # List of other household variables of possible interest
         HRPDVILO3aW5,	# ILO employment status of HRP or partner
         
         HRPNSSEC3W5, # Socio-economic classification of HRP or partner

         HPHYSWW5,                   # Total Physical Wealth
         HPROPWw5,                   # Total property wealth
         TOTPENw5_aggr,              # Total hhold pension value
         TotWlthW5,                  # Total household wealth
         DVPropertyw5)%>% # 5	Sum of all property values
rename(Weight = "w5xshhwgt",
         Age = "HRPDVAgeW5", 
         NFW = "HFINWNTw5_sum",
         GrossFinancialWealth = "HFINWw5_sum",
         GrossAnnualRegularIncome = "DVTotGIRW5",                 # Household Gross Annual (regular) income
         NetAnnualRegularIncome = "DVTotNIRW5",                 # Household Net Annual (regular) income
         GrossAnnualRentalIncome = "DVGrsRentAmtAnnualw5_aggr",  # Household Gross annual income from rent
         NetAnnualRentalIncome = "DVNetRentAmtAnnualw5_aggr",  # Household Net annual income from rent
         
         # List of other household variables of possible interest
         Employment = "HRPDVILO3aW5",              # Employment Status of HRP or partner
         PhysicalWealth = "HPHYSWW5",                   # Total Physical Wealth
         NetHousingWealth = "HPROPWw5",                   # Total property wealth
         TotalPensionWealth = "TOTPENw5_aggr",              # Total hhold pension value
         TotalWealth = "TotWlthW5",                  # Total household wealth
         # NetAnnualSelfEmployedIncome = "DVNISEw5_aggr",              # Household Total Annual Net self employed income
         # NetAnnualEmployeeIncome = "DVNIEMPw5_aggr",             # Household Total Annual Net employee income
         # GrossAnnualInvestmentIncome = "DVGIINVw5_aggr",             # Household Gross annual income from investments
         # NetAnnualInvestmentIncome = "DVNIINVw5_aggr",             # Household Net annual income from investments
         GrossHousingWealth = "DVPropertyw5")%>%
filter(!is.na(Weight)) %>%# there is at least one observation where the weight is NA, which leads to problems when building the unweighted version
mutate(finanicalMargin = NetAnnualRegularIncome/12 - totalMortgagePayments - vul_rho_2 * 2750, # TODO better calculate this value on the spot 
         monthsAbleToCover = GrossFinancialWealth/finanicalMargin, # negative value means finanical margin is negative
         vulnerable = case_when(monthsAbleToCover < 0 & monthsAbleToCover > -monthsToCover & totalMortgagePayments !=0 ~ 1, TRUE ~ 0),
         debtIsHeavyBurden = case_when(DBurdHW5 == 1 ~ 1,TRUE ~ 0)
  ) 

wave_5_for_graph <-Wave_5_HH %>% #Wave_5_HH %>%  weighted_Wave5
  filter(totalMortgagePayments != 0) %>%
  mutate(vulnerable = case_when(vulnerable == 0 ~ FALSE, vulnerable ==1 ~TRUE))%>%
  mutate(DSR = 12*totalMortgagePayments/ GrossAnnualRegularIncome)%>%
  mutate(DTI = totalMortgageDebt/GrossAnnualRegularIncome)

core_medians_WAS_DSR <- wave_5_for_graph %>%
  group_by(vulnerable) %>%
  summarise(coreIndicator = weighted.median(DSR, w = Weight))

core_medians_WAS_Age <- wave_5_for_graph %>%
  group_by(vulnerable) %>%
  summarise(coreIndicator = weighted.median(Age, w = Weight))

wave_5_calculating_nonPayments <-Wave_5_HH %>% #Wave_5_HH %>%  weighted_Wave5
  mutate(MortgagePaymentsRecorded = case_when(totalMortgagePayments == 0 ~ FALSE, totalMortgagePayments != 0 ~ TRUE))%>%
  filter(totalMortgageDebt !=0)%>%
  mutate(vulnerable = case_when(vulnerable == 0 ~ FALSE, vulnerable ==1 ~TRUE))%>%
  mutate(DSR = 12*totalMortgagePayments/ GrossAnnualRegularIncome)%>%
  mutate(DTI = totalMortgageDebt/GrossAnnualRegularIncome)


wave_5_payments_T_F <- wave_5_calculating_nonPayments %>%
  group_by(MortgagePaymentsRecorded) %>%
  tally(wt= Weight)
# n[2] is where mortgagepaymentsRecorded = TRUE
share_wave_5_payment <- wave_5_payments_T_F$n[2] / sum(wave_5_payments_T_F$n)

wave_5_payments_T_F_Age <- wave_5_calculating_nonPayments %>%
  group_by(MortgagePaymentsRecorded) %>%
  summarise(coreIndicator = weighted.median(Age, w = Weight))

wave_5_payments_T_F_DTI <- wave_5_calculating_nonPayments %>%
  group_by(MortgagePaymentsRecorded) %>%
  summarise(coreIndicator = weighted.median(DTI, w = Weight))


wave_5_calculating_shareVulTotalPopulation <-Wave_5_HH %>% #Wave_5_HH %>%  weighted_Wave5
  mutate(MortgagePaymentsRecorded = case_when(totalMortgagePayments == 0 ~ FALSE, totalMortgagePayments != 0 ~ TRUE))%>%
  mutate(vulnerable = case_when(vulnerable == 0 ~ FALSE, vulnerable ==1 ~TRUE))%>%
  mutate(hasDebt = case_when(totalMortgageDebt !=0 ~ TRUE, TRUE ~ FALSE))%>%  
  mutate(DSR = 12*totalMortgagePayments/ GrossAnnualRegularIncome)%>%
  mutate(DTI = totalMortgageDebt/GrossAnnualRegularIncome)

## build data frame for calculting weighed mean -> share of vulnerable households in indebted households
wave_vul_weight <- Wave_5_HH%>%  # weighted_Wave5  # Wave_5_HH
  filter(totalMortgageDebt!=0)%>%
  filter(totalMortgagePayments != 0) %>%
  select(vulnerable,Weight)

# calculating the share of vulnerable households in all households when assuming that indebted households
# reporting and not reporting have the same chance of being vulnerable (they are probably lower..)
share_vul_HH_payment_subgroup <- weighted.mean(wave_vul_weight$vulnerable, w = wave_vul_weight$Weight)

share_wave_5_VulHH_AllHH <- wave_5_calculating_shareVulTotalPopulation%>%
  group_by(hasDebt) %>%
  tally(wt = Weight)

number_households_wave_5 <- tally(wave_5_calculating_shareVulTotalPopulation, wt = Weight)

share_wave_5_VulHH_AllHH <-share_wave_5_VulHH_AllHH %>% 
  filter(hasDebt == TRUE)%>%
  select(n)
share_wave_5_VulHH_AllHH <- share_wave_5_VulHH_AllHH / number_households_wave_5 * share_vul_HH_payment_subgroup

sortingData_for_figure <-  agent_data_vul_2 %>% # sortingData_data_vul_noFTBSM sortingData_data_vul_noFTBSM_0.961
  filter(Debt < 0)%>%
  mutate(DTI = Debt/(-12* MonthlyGrossTotalIncome))%>%
  mutate(DSR = MonthlyMortgagePayments/MonthlyGrossTotalIncome)%>%
  mutate(hasDebt = case_when(Debt<0 ~ TRUE, TRUE ~ FALSE))


core_medians_DSR <- sortingData_for_figure %>%
  group_by(vulnerable) %>%
  summarise(coreIndicator = median(DSR, na.rm = TRUE))


core_medians_Age <- sortingData_for_figure %>%
  group_by(vulnerable) %>%
  summarise(coreIndicator = median(Age, na.rm = TRUE))

```

The new parameters introduced to the base model [@Baptista2016] are given in Table \@ref(tab:parameters). The propensities to consume out of disposable income and wealth are taken from @Dynan2004 and @Arrondel2019 and adjusted slightly to match the wealth inequality and debt-to-income ratio of the UK. Apart from these parameters, I re-calibrated the commercial bank's internal LTV caps for the different agent classes to match the stylized facts. To my knowledge, there are no empirical statistics on these caps and the Bank of England is currently not enforcing LTV caps themselves. As LTV caps have strong effects on the housing market dynamics [@tarne_effect_2021] they are included in the calibration.

As targets for the calibration important stylized facts from the UK are selected. These include the Bank of England's *Core Indicators for setting the LTV and DTI ratios* [@BoE2018, p. 68] shown in Table \@ref(tab:BoECoreIndicators). Additional stylized facts with focus on the wealth distribution and the characteristics of financially vulnerable households[^12] are taken from the ONS and the Wealth and Asset Survey, reported in Table \@ref(tab:CoreIndicators). To find values for the remaining parameters in Table \@ref(tab:parameters) that lead to the model matching the stylized facts choosen, upper and lower limits are set (reported in the table). In a second step, a Latin Hypercube is used to sample 1000 different parameter combinations with which the model is run. The model outputs were rated with help of an (unweighted) cost function of the quadratic distance from the target values of the stylized facts. From this array of models one matching the stylized facts as good as possible was selected.

[^12]: As target for the calibration I use the definition of households vulnerability -- explained in chapter \@ref(causes-for-financial-vulnerability) -- where basic consumption equals 40% of median income but the financial margin is calculated basic living costs of 50% of median income. This way I am able to account for more income risk.

While the model is not able to match all stylized facts, none of the indicators are critically off target. The output of the model is in bounds of the reported Bank of England's Core Indicators' values (Table \@ref(tab:BoECoreIndicators)) with the exception of the slightly too-high average debt-to-income ratio (DTI) of Owner-Occupiers (encompassing first-time buyers and second-and-subsequent buyers), the too-high monthly purchases of buy-to-let (BTL) agents, and rental yield. As in the model BTL agents rarely become financially vulnerable, even with this higher turnover, this should not distort the analysis much.

As I am making statements about the importance of a collateral/precaution channel on financial vulnerability I have to make sure that the households vulnerable in the model are similar to those in the UK. Therefore, I compare the output of the model with the fifth wave of the Wealth and Asset Survey (WAS), using the same definition of financial vulnerability as presented in chapter \@ref(financial-vulnerability).

Figure \@ref(fig:DSRWAS) shows the debt-service-to-income ratio distributions (density curves) for financially vulnerable and non-vulnerable households in the WAS (left panel) and model (right panel). The median DSR of non-vulnerable households is `r formattable::percent(core_medians_WAS_DSR$coreIndicator[1], digits = 1)` in the WAS and `r formattable::percent(core_medians_DSR$coreIndicator[1], digits = 1)` in the model. Financially vulnerable households' DSR is `r formattable::percent(core_medians_WAS_DSR$coreIndicator[2], digits = 1)` in the WAS and `r formattable::percent(core_medians_DSR$coreIndicator[2], digits = 1)` in the model.[^13] While median DSRs of the model and WAS are very close together, the DSRs of the model have a higher density at very low values, possibly due to the house prices falling to lower levels in the model than observed in reality. The density of DSRs at the right tail is lower in the model than in the WAS, which is probably due to the higher stability of households' wages in the model than observed in reality. As the figure consists of density curves, the share of financially vulnerable households in all households with mortgage debt is hidden.[^14] For the WAS the share of vulnerable households of all households with mortgage debt is `r formattable::percent(share_vul_HH_payment_subgroup, digits = 1)` and for the model, using the same definition as introduced above, this share is `r formattable::percent(mean(outfile_2$"%vulHH of indebtedHH"), digits = 1)`.

[^13]: A alternative measurement for the model is the mean of the median DSR in each period - not the overall median of the DSR distribution of all financially vulnerable households over all periods (i.e. each households is recorded once per period). The median DSR of vulnerable households is then `r formattable::percent(mean(outfile_2$"vulHH medianDSR"), digits = 1)`. This measurement is also used in table \@ref(tab:CoreIndicators).

[^14]: More specifically, due to data limitations I only take the sub-group of interviewed households with recorded mortgage payments into account, as I need those to calculate their financial margin. They make up `r formattable::percent(share_wave_5_payment, digits = 0)` of all indebted households interviewed. Both sub-groups seem to be quite similar, while those reporting specific monthly mortgage payments tend to be a bit younger (median age is `r wave_5_payments_T_F_Age%>%filter(MortgagePaymentsRecorded == TRUE)%>% select(coreIndicator)` instead of `r wave_5_payments_T_F_Age%>%filter(MortgagePaymentsRecorded == FALSE)%>% select(coreIndicator)`). Assuming the share of vulnerable households would be the same in the sub-group with and without recorded mortgage payments, the share of financially vulnerable households of *all* households would be `r formattable::percent(share_wave_5_VulHH_AllHH, digits = 1)` -- in the model this share is `r formattable::percent(mean(outfile_2$"nVulHH (X*medIncome Y*m)" / outfile_2$TotalPopulation), digits = 1)`.

```{r DSRWAS, fig.cap="Histogram and median value of debt-service-ratios of finanically vulnerable and non-vulnerable households in the Wealth and Asset Survey (left) and the model (right)",fig.subcap=c("Wealth and Asset Survey", "Model output"),  fig.show='hold', message=FALSE, warning=FALSE, out.width='49%', results=FALSE,  echo=FALSE}

# when using density curves, the WAS data of indebted households is about 2500 data points (which are then weighed, i.e. multiplied by their weight) which makes the distribution very smooth. To achieve a comparable smoothness for model data the kernel adjustment value is higher
kernel_adjust_WAS <- 2
kernel_adjust_model <- 4

### WAS 
wave_5_for_graph%>%
  ggplot(aes(DSR, fill = vulnerable, weight = Weight)) +
  geom_density(alpha = 0.5, position = "identity", adjust = kernel_adjust_WAS) +
  # geom_histogram(alpha = 0.5, position = "identity") +
  xlim(c(0,0.75))+
  geom_vline(
    data = core_medians_WAS_DSR, linetype = "dashed", size = 1,
    aes(xintercept = coreIndicator, colour = vulnerable)
  )+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  labs(caption = "Notes: Subgroup of households with recorded mortgage payments.")

##### model 
sortingData_for_figure %>%
  ggplot(aes(DSR, fill = vulnerable)) +
  geom_density(alpha = 0.5, position = "identity", adjust = kernel_adjust_model) +
  # geom_histogram(alpha = 0.5, position = "identity" ) +
  xlim(c(0,0.75))+
  geom_vline(
    data = core_medians_DSR, linetype = "dashed", size = 1,
    aes(xintercept = coreIndicator, colour = vulnerable)
  )+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  labs(caption = "Notes: Each data point is one household in one period (month) \nover one Monte-Carlo simulation with 600 periods.")
```

<!-- median Age -->

Another important stylized fact is to match the age distribution of vulnerable and non-vulnerable households. Since with retirement the households' in the model income falls significantly at age 65, a higher share of vulnerable households here (as opposed to the WAS) could imply an overestimation of dissaving on financial vulnerability, driven by drops in income. In the model, the age of financially vulnerable households is driven by both the saving motive for first-time buyers (stronger motive leads to younger households entering the market) and the maximum age by which a household has to repay her mortgages (the higher the maximum age, the older financially vulnerable households tend to be). In the WAS the median age for financially non-vulnerable households is `r round(core_medians_WAS_Age$coreIndicator[1], digits = 0)` years and `r round(core_medians_Age$coreIndicator[1], digits = 1)` years in the model. For vulnerable households the median age is `r round(core_medians_WAS_Age$coreIndicator[2], digits = 0)` years in the WAS and `r round(core_medians_Age$coreIndicator[2], digits = 1)` in the model. The age distribution of the model is remarkably similar to that of the WAS, but with lower densities at both tails.

With the exception of a higher deposits-to-debt ratio, the rest of the empirical values, which are presented in Table \@ref(tab:CoreIndicators), are matched remarkably well.

```{r AgeWAS, fig.cap="Histogram of the age of finanically vulnerable and non-vulnerable households in the Wealth and Asset Survey (left) and the model (right)", fig.subcap=c("Wealth and Asset Survey", "Model output"), fig.show='hold', message=FALSE, warning=FALSE, out.width='49%', results=FALSE,  echo=FALSE}


binSize <- 20 # if using histogram

# WAS
wave_5_for_graph%>%
  ggplot(aes(Age, fill = vulnerable, weight = Weight))+
  geom_density(alpha = 0.5, position = "identity" , adjust = kernel_adjust_WAS) +
  # geom_histogram(alpha = 0.5, position = "identity", bins = binSize) +
  xlim(c(20,80))+
  geom_vline(
    data = core_medians_WAS_Age, linetype = "dashed", size = 1,
    aes(xintercept = coreIndicator, colour = vulnerable)
  )+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
    labs(caption = "Notes: Subgroup of households with recorded mortgage payments.")


# Model
sortingData_for_figure %>%
  ggplot(aes(Age, fill = vulnerable))+
  geom_density(alpha = 0.5, position = "identity", adjust = kernel_adjust_model )+
  # geom_histogram(alpha = 0.5, position = "identity" , bins = binSize)+
  xlim(c(20,80))+
  geom_vline(
    data = core_medians_Age, linetype = "dashed", size = 1,
    aes(xintercept = coreIndicator, colour = vulnerable)
  )+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  labs(caption = "Notes: Each data point is one household in one period (month) \nover one Monte-Carlo simulation with 600 periods.")
```

(ref:Dynan-citation) @Dynan2004

(ref:Arrondel-citation) @Arrondel2019

```{r parameters, echo=FALSE, message=FALSE, warning=FALSE}
# - FTB SM MPC check
# - FTB SM percentile check
# - financial wealth effect for income percentiles check 
# - liquidity preference
# - payments to income
# - LTV FTB, SSB BTL



parameters_table <-data.frame(Parameter = c("$\\alpha_{\\Xi \\leq 0.25}$", 
                                            "$\\alpha_{\\Xi > 0.25 \\leq 0.5}$", 
                                            "$\\alpha_{\\Xi > 0.5 \\leq 0.75}$", 
                                            "$\\alpha_{\\Xi > 0.75 \\leq 0.9}$", 
                                            "$\\alpha_{\\Xi > 0.9 \\leq 0.99}$",
                                            "$\\alpha_{\\Xi > 0.99}$",
                                            "$\\beta_{\\Xi \\leq 0.25}$", 
                                            "$\\beta_{\\Xi > 0.25 \\leq 0.5}$", 
                                            "$\\beta_{\\Xi > 0.5 \\leq 0.75}$", 
                                            "$\\beta_{\\Xi > 0.75 \\leq 0.9}$", 
                                            "$\\beta_{\\Xi > 0.9}$", 
                                            "$\\alpha_{FTB,i}$", 
                                            "$\\Xi_{i}$", 
                                            "$\\zeta_{i,t}$",
                                            "$\\sigma$",
                                            "$Age^{OO}_{repayment}$",
                                            "$LTV^{cap}_{FTB}$",
                                            "$LTV^{cap}_{SSB}$",
                                            "$LTV^{cap}_{BTL}$"), # possibly use another variable name. In the equation list this is alpha (with equation number 39 as of March 2021) ###### TODO Update once complete model description is written
                              Description = c("Monthly propensity to consume out of disposable income for households in income percentile $\\leq 0.25$",
                                              "Monthly propensity to consume out of disposable income for households in income percentile $> 0.25 \\leq 0.5$",
                                              "Monthly propensity to consume out of disposable income for households in income percentile $> 0.5 \\leq 0.75$",
                                              "Monthly propensity to consume out of disposable income for households in income percentile $> 0.75 \\leq 0.9$",
                                              "Monthly propensity to consume out of disposable income for households in income percentile $> 0.9 \\leq 0.99$",
                                              "Monthly propensity to consume out of disposable income for households in income percentile $> 0.99$",
                                              "Monthly propensity to consume induced by finanical wealth for households in income percentile $\\leq 0.25$",
                                              "Monthly propensity to consume induced by finanical wealth for households in income percentile $> 0.25 \\leq 0.5$",
                                              "Monthly propensity to consume induced by finanical wealth for households in income percentile $> 0.5 \\leq 0.75$",
                                              "Monthly propensity to consume induced by finanical wealth for households in income percentile $> 0.75 \\leq 0.9$",
                                              "Monthly propensity to consume induced by finanical wealth for households in income percentile $> 0.9$",
                                              "Propensity to consume out of disposable income for FTB agents above specific income percentile",
                                              "Income percentile value above which FTB agents save for a downpayment via $\\alpha_{FTB,i}$",
                                              "Liquidity preference for households with DSRs below the median, for households with DSRs above the median $\\zeta_{i,t} = 0$",
                                              "Maximum share of posttax income that investors spend on mortgage payments",
                                              "Maximum age by which mortgages for owner-occupiers have to be repaid",
                                              "Maximum LTV of FTB mortgage contracts", 
                                              "Maximum LTV of SSB mortgage contracts",
                                              "Maximum LTV of BTL mortgage contracts"),
                              Value = c(properties_file$consumptionFractionQ1,
                                        properties_file$consumptionFractionQ2,
                                        properties_file$consumptionFractionQ3,
                                        properties_file$consumptionFractionQ4,
                                        properties_file$consumptionFractionTop10,
                                        properties_file$consumptionFractionTop1,
                                        properties_file$wealthEffectQ1, # in the properties file Q1 and Q2 are separate fields
                                        properties_file$wealthEffectQ2,
                                        properties_file$wealthEffectQ3,
                                        properties_file$wealthEffectQ4,
                                        properties_file$wealthEffectTop10, #  in the properties file there is a top 1% field as well
                                        properties_file$MPCForFirstTimeBuyers,
                                        properties_file$minIncomePercentile,
                                        properties_file$liquidityPreference,
                                        properties_file$paymentsToIncome,
                                        properties_file$BANK_AGE_LIMIT,
                                        properties_file$centralBankFirstTimeBuyerLTVLimit,
                                        properties_file$centralBankOwnerOccupierLTVLimit,
                                        properties_file$centralBankBTLLTVLimit),
                              Source = c("(ref:Dynan-citation) PSID and SCF Data",
                                         "as above", 
                                         "as above",
                                         "as above",
                                         "as above",
                                         "as above",
                                         "(ref:Arrondel-citation)",
                                         "as above",
                                         "as above",
                                         "as above",
                                         "as above",
                                         "[0 - 1.0]",
                                         "[0.5 - 1.0]",
                                         "[0 - 4.0]",
                                         "[0.33 - 0.75]",
                                         "[65 - 75]",
                                         "[0.75 - 0.99]",
                                         "[0.75 - 0.99]",
                                         "[0.75 - 0.99]"
                              )
)

# parameter list
# 1# min income percentile       #  0 - 1.0
# 2# MPCForFirstTimeBuyers       #  0.5 - 1.0
# 3# payments to income          #  0.33 - 0.75
# 4# liquidity preference        #  0 - 4.0
# 5# BANK_AGE_LIMIT              #  65 - 75
# 6# LTV 1                       #  0.75 - 0.99
# 7# LTV 2                       #  0.75 - 0.99
# 8# LTV 3                       #  0.75 - 0.99

names(parameters_table) <- c("Parameter", "Description", "Value", "Range for calibration / Source")

parameters_table %>%
  kbl(booktabs =T, 
      # align ="c",
      escape = FALSE, # this will convert the math expressions properly
      caption = "New parameters") %>%
  kable_styling(latex_options =c("striped"), full_width = FALSE)%>%
  column_spec(2, width = "9cm") %>%
  column_spec(4, width = "2.5cm") %>%
footnote(general = paste0("The marginal propensities to consume, based on ", "(ref:Dynan-citation)" ," and ", "(ref:Arrondel-citation)", ", are each slightly adjusted to match the wealth inequality and debt-to-deposit ratio."),
         threeparttable =T)




```

(ref:BoE2018-citation) [@BoE2018, p.68]

```{r BoECoreIndicators, message=FALSE, warning=FALSE,  echo=FALSE}
# build data frame with the core indicators
# 2:nPeriods+1 because the files start only in their second column
coreIndicators <- data.frame(row.names = ("Model Output"),Debt_to_income_ratio =mean(rowMeans(read_csv(here::here(paste0("Results/",model_folder_1,"/coreIndicator-debtToIncome.csv")), col_names = FALSE)[1:nMCRuns,2:(nPeriods+1)], na.rm = TRUE)),
                         OO_debt_to_income_ratio = mean(rowMeans(read_csv(here::here(paste0("Results/",model_folder_1,"/coreIndicator-ooDebtToIncome.csv")), col_names = FALSE)[1:nMCRuns,2:(nPeriods+1)], na.rm = TRUE)),
                         OO_LTI_mean_above_median = mean(rowMeans(read_csv(here::here(paste0("Results/",model_folder_1,"/coreIndicator-ooLTI.csv")), col_names = FALSE)[1:nMCRuns,2:(nPeriods+1)], na.rm = TRUE)),
                         OO_LTV_mean_above_median = mean(rowMeans(read_csv(here::here(paste0("Results/",model_folder_1,"/coreIndicator-ooLTVAboveMedian.csv")), col_names = FALSE)[1:nMCRuns,2:(nPeriods+1)], na.rm = TRUE)),
                         BTL_LTV_ratio = mean(rowMeans(read_csv(here::here(paste0("Results/",model_folder_1,"/coreIndicator-btlLTV.csv")), col_names = FALSE)[1:nMCRuns,2:(nPeriods+1)], na.rm = TRUE)),
                         # OO_LTV_mean = mean(rowMeans(read_csv(here::here(paste0("Results/",model_folder_1,"/coreIndicator-ooLTV.csv")), col_names = FALSE)[1:nMCRuns,2:(nPeriods+1)], na.rm = TRUE)),
                         Housing_transactions_month = mean(rowMeans(read_csv(here::here(paste0("Results/",model_folder_1,"/coreIndicator-housingTransactions.csv")), col_names = FALSE)[1:nMCRuns,2:(nPeriods+1)], na.rm = TRUE)),
                         Mortgage_approvals = mean(rowMeans(read_csv(here::here(paste0("Results/",model_folder_1,"/coreIndicator-mortgageApprovals.csv")), col_names = FALSE)[1:nMCRuns,2:(nPeriods+1)], na.rm = TRUE)),
                         Advances_to_homemovers = mean(rowMeans(read_csv(here::here(paste0("Results/",model_folder_1,"/coreIndicator-advancesToMovers.csv")), col_names = FALSE)[1:nMCRuns,2:(nPeriods+1)], na.rm = TRUE)),
                         Advances_to_FTB = mean(rowMeans(read_csv(here::here(paste0("Results/",model_folder_1,"/coreIndicator-advancesToFTB.csv")), col_names = FALSE)[1:nMCRuns,2:(nPeriods+1)], na.rm = TRUE)),
                         Advances_to_BTL = mean(rowMeans(read_csv(here::here(paste0("Results/",model_folder_1,"/coreIndicator-advancesToBTL.csv")), col_names = FALSE)[1:nMCRuns,2:(nPeriods+1)], na.rm = TRUE)),
                         House_price_to_income_ratio = mean(rowMeans(read_csv(here::here(paste0("Results/",model_folder_1,"/coreIndicator-priceToIncome.csv")), col_names = FALSE)[1:nMCRuns,2:(nPeriods+1)], na.rm = TRUE)),
                         Rental_Yield = mean(rowMeans(read_csv(here::here(paste0("Results/",model_folder_1,"/coreIndicator-RentalYield.csv")), col_names = FALSE)[1:nMCRuns,2:(nPeriods+1)], na.rm = TRUE))
                         # Spreads_in_bp = mean(rowMeans(read_csv(here::here(paste0("Results/",model_folder_1,"/coreIndicator-interestRateSpread.csv")), col_names = FALSE)[1:nMCRuns,2:(nPeriods+1)], na.rm = TRUE)),
                         # BTL_share = mean(rowMeans(read_csv(here::here(paste0("Results/",model_folder_1,"/coreIndicator-BTLMarketShare.csv")), col_names = FALSE)[1:nMCRuns,2:(nPeriods+1)], na.rm = TRUE))
                         )
# adjsut from % to double values
coreIndicators <- coreIndicators %>%
  mutate(Debt_to_income_ratio = Debt_to_income_ratio / 100, 
         OO_debt_to_income_ratio = OO_debt_to_income_ratio / 100,
         BTL_LTV_ratio = BTL_LTV_ratio / 100,
         OO_LTV_mean_above_median = OO_LTV_mean_above_median / 100,
         Rental_Yield = Rental_Yield / 100)

# read the excel of the Bank of England's core indicators (from end 2018)
# as the table is not easily read due to its formatting, I clean the data first
BoE_coreIndicators <- as.data.frame(read_excel(path = here::here("statistical output R/Bank of England core indicators time series.xlsx")))
# name the columns
names(BoE_coreIndicators) <- c("Indicator", "sub_Indicator",		"Average 1987-2006(b)",	"Average 2006(c)",	"Minimum since 1987(b)",	"Maximum since 1987(b)",	"Previous value (oya)",	"Latest value (as of 16 November 2018)", "NA")


# read the rows where the "subindicator" is named. This could lead to errors if the names of the indicators change in the table (for instance when using newer versions)
coreIndicators_From_BoE <- data.frame(Debt_to_income_ratio = t( filter(BoE_coreIndicators, sub_Indicator %in% "of which: mortgages(h)")[3:8]), # subgroup of Household debt to income ratio(g)
                                      OO_debt_to_income_ratio = t(filter(BoE_coreIndicators, sub_Indicator %in% "of which: owner occupier mortgages(i)")[3:8]), # subgroup of Household debt to income ratio(g)
                         OO_LTI_mean_above_median = t(filter(BoE_coreIndicators, sub_Indicator %in% "Owner-occupier mortgage LTI ratio (mean above the median)(d)")[3:8]), # Owner-occupier mortgage LTI ratio (mean above the median)(d)
                         OO_LTV_mean_above_median = t(filter(BoE_coreIndicators, sub_Indicator %in% "Owner-occupier mortgage LTV ratio (mean above the median)(d)")[3:8]),
                         BTL_LTV_ratio = t(filter(BoE_coreIndicators, sub_Indicator %in% "Buy-to-let mortgage LTV ratio (mean)(e)")[3:8]),
                         # OO_LTV_mean = filter(BoE_coreIndicators, sub_Indicator %in% "Buy-to-let mortgage LTV ratio (mean)(e)")[3:8],
                         Housing_transactions_month = t(filter(BoE_coreIndicators, sub_Indicator %in% "Housing Transactions(k)")[3:8]),
                         Mortgage_approvals = t(filter(BoE_coreIndicators, sub_Indicator %in% "Approvals of loans secured on dwellings(j)")[3:8]),
                         Advances_to_homemovers = t(filter(BoE_coreIndicators, sub_Indicator %in% "Advances to homemovers(l)")[3:8]),
                         Advances_to_FTB = t(filter(BoE_coreIndicators, sub_Indicator %in% "Advances to first time buyers(l)")[3:8]),
                         Advances_to_BTL = t(filter(BoE_coreIndicators, sub_Indicator %in% "Advances to buy-to-let purchasers(l)")[3:8]),
                         House_price_to_income_ratio = t(filter(BoE_coreIndicators, sub_Indicator %in% "House price to household disposable income ratio(p)")[3:8]),
                         Rental_Yield = t(filter(BoE_coreIndicators, sub_Indicator %in% "Rental yield(q)")[3:8])
                         )

# add row names and make cells numeric
coreIndicators_From_BoE <- as.data.frame(row.names = c("Average 1987-2006(b)",	"Average 2006(c)",	"Minimum since 1987(b)",	"Maximum since 1987(b)",	"Previous value (oya)",	"Latest value (as of 16 November 2018)"), sapply(coreIndicators_From_BoE, as.numeric))

# combine BoE and model data (transpose it too)
coreIndicatorsDisplay <- as.data.frame(bind_rows(coreIndicators, coreIndicators_From_BoE))

# c("Household mortgage debt to income",
#   "Owner-occupier mortgage debt to income",
#   "Owner-occupier mortgage LTI ratio (mean above the median)",
#   "Owner-occupier mortgage LTV ratio (mean above the median)",
#   "Buy-to-let mortgage LTV ratio (mean)",
#   "Monthly Housing Transactions",
#   "Approvals of loans secured on dwellings",
#   "Advances to homemovers",
#   "Advances to first time buyers",
#   "Advances to buy-to-let purchasers",
#   "House price to household disposable income ratio",
#   "Rental yield"), .before = 1)
#   

# format(coreIndicatorsDisplay[,11:12], digits = 4, scientific = FALSE)

   
coreIndicatorsDisplay_3 <- format(coreIndicatorsDisplay[,11:12], digits = 3, scientific = FALSE)
# For some reason the BoE data in "display_3" are always 3 digits. So 2 digits does not work. I do not understand but simply
# use 3 digits for the lower numbers now
coreIndicatorsDisplay_1 <- format(coreIndicatorsDisplay[,1:5], digits = 3,  scientific = FALSE)
coreIndicatorsDisplay_2 <- format(coreIndicatorsDisplay[,6:10], digits = 0, scientific = FALSE)


coreIndicatorsDisplay_1and2 <- bind_cols(coreIndicatorsDisplay_1, coreIndicatorsDisplay_2)

coreIndicatorsDisplay <- as.data.frame(t(bind_cols(coreIndicatorsDisplay_1and2, coreIndicatorsDisplay_3)), row.names = c("Debt to income",
                                                                          "OO debt to income",
                                                                          "OO LTI ratio (mean above the median)",
                                                                          "OO LTV ratio (mean above the median)",
                                                                          "BTL LTV ratio",
                                                                          "Monthly Housing Transactions",
                                                                          "Approvals of mortages",
                                                                          "Advances to homemovers",
                                                                          "Advances to FTB",
                                                                          "Advances to BTL",
                                                                          "House price to income ratio",
                                                                          "Rental yield"))
# coreIndicatorsDisplay <- signif(coreIndicatorsDisplay, digits = 3)
# implement line-breaks 
lineBreaks_table<- c("Model Output", "Average \n1987-2006",	"Average\n2006",	"Minimum \nsince 1987",	"Maximum \nsince 1987",	"Previous \nvalue (oya)",	"Latest value\n(November 2018)" )
if (knitr:::is_latex_output()){
  coreIndicatorsDisplay %>%
    mutate_all(linebreak)%>%
    kableExtra::kbl(
                    caption = "Comparison Model and Bank of England Core Indicators",
                    booktabs =T,
                    escape =F,
                    col.names =linebreak(lineBreaks_table, align ="c"))%>%
    kable_styling(latex_options =c("striped","scale_down")) %>%
    add_header_above(c(" "=1,"Model"=1,"Bank of England Core Indicators"=6))%>%
    footnote(general = paste0("The Core Indicators are taken from the Financial Stability Report ", "(ref:BoE2018-citation)", "; OO = Owner-Occupier, encompassing FTB and SSB; all values are means, except where stated otherwise; Model values are gained from 10 Monte-Carlo runs with an observation period of 1000 after a burn-in period of 1600."),
             threeparttable =T)
}

if (knitr:::is_html_output()){
  names(coreIndicatorsDisplay) <- c("Model Output", "Average 1987-2006",	"Average 2006",	"Minimum since 1987",	"Maximum since 1987",	"Previous value (oya)",	"Latest value (November 2018)" )
  coreIndicatorsDisplay %>%
    kableExtra::kable(caption = "Comparison Model and Bank of England Core Indicators")%>%
    kable_styling(latex_options =c("striped","scale_down"))%>%
    add_header_above(c(" "=1,"Model"=1,"Bank of England Core Indicators"=6)) 
}
#####TODO: rounding numbers in table -> or set specific rows as integers
#####TODO: color the last column according to its values
```

```{r CoreIndicators, message=FALSE, warning=FALSE,  echo=FALSE}
# ONS wealth data https://www.ons.gov.uk/peoplepopulationandcommunity/personalandhouseholdfinances/incomeandwealth/datasets/totalwealthwealthingreatbritain
#
#- wealth inequality
# - deposits/credit
# - average deposit? - do I have that? yes - 68,160 between 43,200 and 82,000 
# - median DSR vul HH
# - median DSR non-vul HH
# - share of vul HH in indebted HH (I use this due to WAS data constraints)
# - median Age vul HH
# - median Age non-vul HH ?? - this depends

Wave_5_HH_vul <- Wave_5_HH %>%
  # filter(totalMortgagePayments != 0) %>%
  # filter(totalMortgageDebt!=0)%>%
  mutate(finanicalMargin = NetAnnualRegularIncome/12 - totalMortgagePayments - vul_rho_2 * 2749.667,
         monthsAbleToCover = GrossFinancialWealth/finanicalMargin, # negative value means finanical margin is negative
         vulnerable = case_when(monthsAbleToCover<0 & monthsAbleToCover > - monthsToCover & totalMortgagePayments != 0 ~ TRUE, TRUE ~ FALSE),
         DSR = 12*totalMortgagePayments/ GrossAnnualRegularIncome,
         DTI = totalMortgageDebt/GrossAnnualRegularIncome) 


# calculate for indebted households
wave_indebted <- Wave_5_HH_vul%>% 
  filter(totalMortgageDebt!=0)%>%
  filter(totalMortgagePayments != 0) 

# calculate for vulnerable households
wave_vul <- Wave_5_HH_vul%>% 
  filter(totalMortgageDebt!=0)%>%
  filter(totalMortgagePayments != 0) %>%
  filter(vulnerable == TRUE)

# calculate for non-vulnerable, indebted households
wave_NonVul <- Wave_5_HH_vul%>% 
  filter(totalMortgageDebt!=0)%>%
  filter(totalMortgagePayments != 0) %>%
  filter(vulnerable == FALSE)

coreIndicators_table <- data.frame(row.names = c("Wealth Inequality", 
                                                 "Deposits/Debt", 
                                                 "Average Deposit", 
                                                 "median DSR all indebted HH", # this is not non-vul!
                                                 "median DSR vul HH",
                                                 "share vul HH of all indebted HH",
                                                 "median Age vul HH",
                                                 "median Age non-vul HH"
),  Model_output = NA, UK_values = c(0.449, # wealth inequality (0.407 - 0.474)
                                     1.57, # deposits over debt (1.3 - 1.84)
                                     67000, # average deposits(54200 - 82000) I use here data from 2010-2016 (not starting at 2006). It is more comparable with the debt/deposit ratio
                                     format(weighted.median(wave_indebted$DSR, w = wave_indebted$Weight), digits = 3,nsmall = 0, scientific = FALSE), # median DSR all indebted HH: wave_5_for_graph %>%summarise(coreIndicator = weighted.median(DSR, w = Weight))
                                     format(weighted.median(wave_vul$DSR, w = wave_vul$Weight), digits = 3,nsmall = 0, scientific = FALSE), # median DSR vul HH
                                     format(share_vul_HH_payment_subgroup, digits = 3,nsmall = 0, scientific = FALSE), # share of vul HH of all indebted hh
                                     weighted.median(wave_vul$Age, w = wave_vul$Weight), # median Age of vulnerable households
                                     weighted.median(wave_NonVul$Age, w = wave_NonVul$Weight) # median age of non-vulnerable households
), 
UK_values_range = c("0.407 - 0.474",
                    "1.3 - 1.84",
                    "54200 - 82000",
                    "-",
                    "-",
                    "-",
                    "-",
                    "-"),
Source = c("ONS 2006-2016 (without pension wealth)", 
           "ONS 2010-2016 (net finanical wealth / mortgage debt)",
           "ONS 2010-2016 (net financial wealth without pension wealth)",
           "Wealth and Asset Survey wave 5 (July 2014 - June 2016)",
           "as above",
           "as above",
           "as above",
           "as above"))
### footnote "parameter values defining households as vulnerable are 0.7 and 8 months"
### "data from wealth and asset survey is the subgroup of households with specific mortgage payments"

names(coreIndicators_table) <- c("Model output", "mean UK values", "UK value range", "Source")


outfile_2_tmp <- read_outfile_total(wd_model = "Results", model_folder_name = model_folder_2, nRuns = nMCRuns) 

  line_results <- outfile_2_tmp%>%
    mutate(depositsOverDebt = DepositsEndPeriod / totalCredit)%>%
    mutate(vulConsumptionChannel = `nowVul Dissaving` / 
             (`nowVul Purchase`+ `nowVul Dissaving`+`nowVul Other`)) %>%
    mutate(averageDeposits = `DepositsEndPeriod` /  TotalPopulation) %>%
    select(`medianAge vulHH`, 
           `medianAge nonVulHH`,
           medianDebtServiceRatio, 
           `vulHH medianDSR`, 
           `%vulHH of indebtedHH`,
           depositsOverDebt, 
           vulConsumptionChannel,
           averageDeposits)%>%
    apply(MARGIN = 2, FUN = mean_and_NaN_check)%>%
    round(digits = 3)

  
  line_results_WS <- outfile_2_tmp%>%
    filter(`Sale HPI` > 0.98 & `Sale HPI` < 1.21) %>%
    pull(`Top 10% wealth share`)%>%
    mean_and_NaN_check()%>%
    round(digits = 3)
  
  coreIndicators_table$`Model output` <- c(line_results_WS, # wealth inequality
                                           formattable::percent(line_results[["depositsOverDebt"]],digits = 1), # 
                                           line_results[["averageDeposits"]],
                                           line_results[["medianDebtServiceRatio"]],
                                           line_results[["vulHH medianDSR"]],
                                           line_results[["%vulHH of indebtedHH"]],
                                           line_results[["medianAge vulHH"]],
                                           line_results[["medianAge nonVulHH"]]
  )  
  coreIndicators_table[3,] <- format(coreIndicators_table[3,], digits = 0,nsmall = 0,  scientific = FALSE)
  coreIndicators_table %>%
    kbl(booktabs =T,
        caption = "Other Stylized Facts to Match") %>%
    kable_styling(latex_options =c("striped", "scale_down"), full_width = FALSE)%>%
    column_spec(5, width = "12em")%>%
    footnote(general = "Data by the ONS retrieved from https://www.ons.gov.uk/peoplepopulationandcommunity/ personalandhouseholdfinances/incomeandwealth/datasets/totalwealthwealthingreatbritain and for mortgage debt from https://www.ons.gov.uk/peoplepopulationandcommunity/personalandhouseholdfinances/incomeandwealth/ datasets/householddebtwealthingreatbritain ; difference in periods covered by UK data due to data constraints; wealth inequality in the model is measured with the subset of periods with house prices between 98% and 121% of 2011-prices (UK price level range from 2006-2016); data from the fifth wave of the Wealth and Asset Survey is the subgroup of households with recorded mortgage payments; vul = financially vulnerable; HH = household; DSR = Debt-Service-to-Income ratio; Model values are gained from 10 Monte-Carlo runs with an observation period of 1000 steps after a burn-in period of 1600 steps.",
           threeparttable =T)

```

\FloatBarrier

# Results

With the model matching a wide range of stylized facts we can look at the dynamics and drivers of financial vulnerability.

## Causes for Financial Vulnerability

Following from the definition of financial vulnerability used here (chapter \@ref(financial-vulnerability)), households run the risk of becoming financially vulnerable when they a) turn their financial margin negative or b) reduce their deposits below the defined threshold.

In the model, the behavior of households driving financial vulnerability most are property transactions and consumption. Income does not play a central role as it is by design rather stable (with the notable exception of households entering retirement and rental income for BTL investors). Purchases reduce the household's financial margin (Equation \@ref(eq:FM)) by increases in monthly mortgage payments and down payments deplete her deposits (Equation \@ref(eq:finVul)). These households are defined to be *vulnerable by purchase* -- or vulnerable by the purchase channel -- when they become vulnerable by act of a property purchase, i.e. immediately. Dissaving only affects the deposits of households, not their financial margin. Dissaving can be induced by the precautionary/collateral channel for households with above-median DSRs, but also by consumption induced by financial wealth for all households. Dissaving only occurs induced by a wealth effect as consumption induced by income ($\alpha_{i}$ in Equation \@ref(eq:dConsumption)) is never larger than the household's disposable income. To capture both channels, households are defined as *vulnerable by dissaving* (or via the dissaving channel) when they were dissaving the period they became vulnerable (and did not buy a house at the same time).[^15] All other cases of households becoming vulnerable are defined as *by other*, including households experiencing a decline in their income (for instance when entering retirement, or decreases in rental income for BTL agents), turning their financial margin negative.

[^15]: Households can become financially vulnerable just a few months after buying a house. Due to this temporal closeness one might classify them as *vulnerable by purchase*, too*.* However, while the purchase may have decreased the households' financial margin and the down payments their financial buffer, dissaving induced by positive net wealth was necessary to make the households financially vulnerable.

Figure \@ref(fig:stockVulnerable1) shows the stock of financially vulnerable households, divided up by the cause for their vulnerability, over a representative house price cycle. Most households become financially vulnerable by dissaving, on average `r formattable::percent(mean(outfile_1$"nowVul Dissaving") / (mean(outfile_1$"nowVul Purchase") + mean(outfile_1$"nowVul Dissaving") + mean(outfile_1$"nowVul Other")), digits = 0)`. This is driven by low-income households with above-median DSRs having -- as by design -- no liquidity preference and therefore deposits below the vulnerability threshold. There is a noticeable spike in the share of financially vulnerable households due to property purchases when prices rise in the beginning of the house price upswing. At this moment, the housing market turnover is highest (see the market turnover in Figure \@ref(fig:turnover) in the Appendix). Overall, the cyclicality of financial vulnerability is low. This result is due to the limited impact low house prices have on the consumption of financially vulnerable homeowners. Usually, these households have no room to deleverage as their disposable income is almost completely used for basic consumption.[^16] Negative equity then either induces only minuscule or no saving response.

[^16]: Except their income is lower than the basic consumption, then they consume less, see Equation \@ref(eq:Consumption). This allows us to abstract from actual bankruptcy dynamics, but does not change the fact they cannot deleverage.

```{r, stockVulnerable1, echo = FALSE, warning=FALSE,message=FALSE, results= FALSE, fig.align='center', fig.cap = "Share of households with current risk of default by cause of financial vulnerability over the house price cycle - 6 months rolling averages",  out.width='66%'}
# get first the position of house price troughs from a smoothed HPI line
# (not as necessary for troughs as for peaks, which are more irreglar)
HPI_troughs <- find_peaks_smoothed( -outfile_1$`Sale HPI`, m=10, smoothedPerdiods = 12)
# translate the position of troughs into the corresponding periods to use later in graph
trough_period <- c(outfile_1$`Model time`[HPI_troughs])

# , fig.subcap= c("cause of vulnerability", "agent classes vulnerable"), fig.show='hold' # in case this is put back in
outfile_1_tmp <- outfile_1 %>%
  select("nowVul Purchase", "nowVul Dissaving",  "nowVul Other")

outfile_1_tmp <- as.matrix(outfile_1_tmp)/outfile_1$TotalPopulation # adjust for % of total population
outfile_1_tmp <- as.data.frame(runmean(outfile_1_tmp, rolling_averages)) # build a rolling average (6 for 6 months)
colnames(outfile_1_tmp) <- list("purchase", "dissaving", "other") # abbreviate colnames for figure

outfile_1_tmp <- outfile_1_tmp %>%
  bind_cols(outfile_1$`Model time`, outfile_1$`Sale HPI`)%>%
  pivot_longer(c("purchase", "dissaving", "other"))  ## prepare for boxplots

colnames(outfile_1_tmp) <- list("Period","HousePriceIndex", "vulnerable_by", "value")
outfile_1_tmp$vulnerable_by <- factor(outfile_1_tmp$vulnerable_by, levels = c("other", "purchase", "dissaving"))
# outfile_1_tmp$vulnerable_by <- factor(outfile_1_tmp$vulnerable_by, levels = c("other", "dissaving", "purchase"))
# parameters for figure
relation_rhs_lhs <- 100

color_set_1 <- cet_pal(5, name = "r3") # color sets also used for later figure

outfile_1_tmp %>%
    filter(Period >= trough_period[troughs_limits[1]], Period <= trough_period[troughs_limits[2]])%>%
  ggplot(aes(x=Period, fill = vulnerable_by))+
  geom_col( aes(y = value))+
  geom_line( aes(y = HousePriceIndex / relation_rhs_lhs), size=1, linetype="dashed") +
  scale_y_continuous(
    # Features of the first axis
    name = "Share of vulnerable households",
     labels = scales::percent,
    # Add a second axis and specify its features
    sec.axis = sec_axis(~ . *relation_rhs_lhs, name="House Price Index (---)"),
    expand = expansion(mult = c(0, 0.05)) # make the barplots start at the axis
  ) +
  scale_x_continuous(expand = expansion(mult = c(0,0)))+
  # theme_classic()+
  theme(legend.position = "bottom") +
  theme(legend.background = element_blank()) +  # Remove overall border
  theme(legend.key = element_blank()) +
  # scale_fill_viridis_d()
  scale_fill_manual(values = color_set_1)



```

## Households at risk of becoming financially vulnerable

So far the households defined as financially vulnerable were on the path of defaulting in the next couple of months.[^17] However, this narrows the analysis to households that are already vulnerable despite the models overall (interest rate and employment income) stability. To include households that would easily become at risk of defaulting as soon as they were hit by a small interest rate or income shock, I broaden the definition of financial vulnerability used here. I implement a simple buffer of 10% of median income, amounting to about 275 money units, modifying Equation \@ref(eq:finVul) the following way:

[^17]: Recall from Equation \@ref(eq:Consumption) that in the model these households do not actually default, but reduce their consumption below basic consumption if they would otherwise default

```{=tex}
\begin{equation}
f_{i,t} = 
\begin{cases}
1 \iff FM_{i,t} - 0.1 y^{median}_{t} < 0 \land  |FM_{i,t} - 0.1 y^{median}_{t}| \cdot 8 > b_{i,t}\\
0 \iff FM_{i,t} - 0.1 y^{median}_{t} \geq 0 \lor  |FM_{i,t} - 0.1 y^{median}_{t}| \cdot 8 \leq b_{i,t}
\end{cases}
(\#eq:finVulalt)
\end{equation}
```
With this definition I now consider households to be financially vulnerable even if their financial margin is positive but below 10% of median income and if this broader margin cannot at least be covered for eight months by the financial wealth of the household. Income or interest rate shocks amounting to 10% of median income would bring these households close to defaulting. This simple buffer, however, does not take into account higher risk of different types of households to be actually subjected to certain shocks (for instance that lower income households tend to be more affected by negative income shocks [@ampudia_household_2016]) as this is out of scope of this paper.

Figure \@ref(fig:stockVulnerable2) shows the share of these newly defined financially vulnerable households. As expected, the overall share of households defined as financially vulnerable is higher than with the stricter definition. Moreover, the relative importance of both channels becomes more equal. While households becoming financially vulnerable by dissaving now make up on average `r formattable::percent(mean(outfile_2$"nowVul Dissaving") / (mean(outfile_2$"nowVul Purchase") + mean(outfile_2$"nowVul Dissaving") + mean(outfile_2$"nowVul Other")), digits = 0)` of all vulnerable households, `r formattable::percent(mean(outfile_2$"nowVul Purchase") / (mean(outfile_2$"nowVul Purchase") + mean(outfile_2$"nowVul Dissaving") + mean(outfile_2$"nowVul Other")), digits = 0)` are vulnerable by purchases.[^18]

[^18]: Generally, these values give a direction of the relative strengths of both effects. They are partly influenced by the setting of the parameter $\rho$ and the number of months a household has to be able to cover its negative financial margin (Equation \@ref(eq:finVulalt)). Chapter \@ref(different-thresholds-for-financial-vulnerability) in the Appendix shows this for different parameter settings. Additionally, Chapter \@ref(different-model-parametrisation) in the Appendix shows the sensitivity of the strength of the dissaving channel to different calibrations of the free parameters of the model.

```{r, stockVulnerable2, echo = FALSE, warning=FALSE,message=FALSE, results= FALSE, fig.align='center', fig.cap = "Share of households at risk of default by shocks -- by cause of financial vulnerability over the house price cycle - 6 months rolling averages",  out.width='66%'}
# get first the position of house price troughs from a smoothed HPI line
# (not as necessary for troughs as for peaks, which are more irreglar)
HPI_troughs <- find_peaks_smoothed( -outfile_2$`Sale HPI`, m=10, smoothedPerdiods = 12)
# translate the position of troughs into the corresponding periods to use later in graph
trough_period <- c(outfile_2$`Model time`[HPI_troughs])

# , fig.subcap= c("cause of vulnerability", "agent classes vulnerable"), fig.show='hold' # in case this is put back in
outfile_2_tmp <- outfile_2 %>%
  select("nowVul Purchase", "nowVul Dissaving",  "nowVul Other")

outfile_2_tmp <- as.matrix(outfile_2_tmp)/outfile_2$TotalPopulation # adjust for % of total population
outfile_2_tmp <- as.data.frame(runmean(outfile_2_tmp, rolling_averages)) # build a rolling average (6 for 6 months)
colnames(outfile_2_tmp) <- list("purchase", "dissaving", "other") # abbreviate colnames for figure

outfile_2_tmp <- outfile_2_tmp %>%
  bind_cols(outfile_2$`Model time`, outfile_2$`Sale HPI`)%>%
  pivot_longer(c("purchase", "dissaving", "other"))  ## prepare for boxplots

colnames(outfile_2_tmp) <- list("Period","HousePriceIndex", "vulnerable_by", "value")
outfile_2_tmp$vulnerable_by <- factor(outfile_2_tmp$vulnerable_by, levels = c("other", "purchase", "dissaving"))
# outfile_2_tmp$vulnerable_by <- factor(outfile_2_tmp$vulnerable_by, levels = c("other", "dissaving", "purchase"))
# parameters for figure
relation_rhs_lhs <- 50

color_set_1 <- cet_pal(5, name = "r3") # color sets also used for later figure

outfile_2_tmp %>%
    filter(Period >= trough_period[troughs_limits[1]], Period <= trough_period[troughs_limits[2]])%>%
  ggplot(aes(x=Period, fill = vulnerable_by))+
  geom_col( aes(y = value))+
  geom_line( aes(y = HousePriceIndex / relation_rhs_lhs), size=1, linetype="dashed") +
  scale_y_continuous(
    # Features of the first axis
    name = "Share of vulnerable households",
     labels = scales::percent,
    # Add a second axis and specify its features
    sec.axis = sec_axis(~ . *relation_rhs_lhs, name="House Price Index (---)"),
    expand = expansion(mult = c(0, 0.05)) # make the barplots start at the axis
  ) +
  scale_x_continuous(expand = expansion(mult = c(0,0)))+
  # theme_classic()+
  theme(legend.position = "bottom") +
  theme(legend.background = element_blank()) +  # Remove overall border
  theme(legend.key = element_blank()) +
  # scale_fill_viridis_d()
  scale_fill_manual(values = color_set_1)



```

Another change is that the share of financially vulnerable households shows distinct cyclicality. While the overall share of financially vulnerable households follows the house price cycle with a small lag, interestingly, both effects peak at different points of the housing cycle. The share of households vulnerable by purchases peaks around the middle of the upswing, where housing market turnover is highest. The share of households vulnerable by dissaving peaks around the midpoint of the house price downturn.[^19] When house prices fall below a certain threshold these financially vulnerable households deleverage, increasing their financial buffer and ceasing to be vulnerable.[^20] Up to this point, financial vulnerability is increasing.

[^19]: Calculated over the course 10 Monte-Carlo runs the maximum correlation of overall vulnerability is `r round(ccf(outfile_2$"nVulHH (X*medIncome Y*m)", outfile_2$"Sale HPI")$acf[which.max(ccf(outfile_2$"nVulHH (X*medIncome Y*m)", outfile_2$"Sale HPI")$acf)],digits = 2)` at a lag of `r round(ccf(outfile_2$"nVulHH (X*medIncome Y*m)", outfile_2$"Sale HPI")$lag[which.max(ccf(outfile_2$"nVulHH (X*medIncome Y*m)", outfile_2$"Sale HPI")$acf)],digits = 2)` months. For the dissaving channel, the maximum correlation is `r round(ccf(outfile_2$"nowVul Dissaving", outfile_2$"Sale HPI")$acf[which.max(ccf(outfile_2$"nowVul Dissaving", outfile_2$"Sale HPI")$acf)],digits = 2)` at a lag of `r round(ccf(outfile_2$"nowVul Dissaving", outfile_2$"Sale HPI")$lag[which.max(ccf(outfile_2$"nowVul Dissaving", outfile_2$"Sale HPI")$acf)],digits = 2)` months and for the purchase channel `r round(ccf(outfile_2$"nowVul Purchase", outfile_2$"Sale HPI")$acf[which.max(ccf(outfile_2$"nowVul Purchase", outfile_2$"Sale HPI")$acf)],digits = 2)` at a lag of `r round(ccf(outfile_2$"nowVul Purchase", outfile_2$"Sale HPI")$lag[which.max(ccf(outfile_2$"nowVul Purchase", outfile_2$"Sale HPI")$acf)],digits = 2)` months. See also Figure \@ref(fig:crossCorrelation2) in the Appendix.

[^20]: This form of deleveraging could be critigued on the basis of some recent studies [@ganong_liquidity_2020; @Berger2018; @guren_housing_2021] finding for the US that the housing wealth consumption elasticity for households that are 'underwater', i.e. experience negative housing equity, is quite insensitive. For the model used here, this would imply that underwater households would deleverage at most with $(1-\alpha)y^{m,disp}_{i,t}$. As especially low-income households with high $\alpha$ become financially vulnerable (see in detail in Chapter \@ref(characteristics-of-financially-vulnerable-households)), each months' saving would be very small and take longer than in its current form in the model where negative housing wealth induces additional saving (Equation \@ref(eq:dConsumption) and \@ref(eq:Consumption)). This comparatively slower deleveraging would then reduce the volatility of the share of households being financially vulnerable by dissaving. However, the reduction in volatility might not be that strong, as financially vulnerable households in the model already tend to be restricted in their saving response by the essential consumption $c_{0}$ as they have low incomes and high debt-service-ratios. Moreover, it is reasonable to assume that households with negative net housing wealth and low financial wealth (recall that households with above-median debt-service-to-income ratios have no precautionary savings buffer) would build up some financial wealth as buffer-stock as empirically house price busts tend to go together with higher income insecurity -- a mechanism that is not included in this housing market model. This timely build-up of a buffer stock would decrease the share of households vulnerable, and, therefore, generate comparable dynamics of the share of households being financially vulnerable.

Financial vulnerability decreases by households either increasing their financial margin or deposits. Similar to the classification above, the economic actions of households reducing financial vulnerability are divided into *non-vulnerable by sales* -- when they just sold property and ceased to be vulnerable -- and *non-vulnerable by saving* -- when they have a positive saving rate and did not just sell property. The rest --death, regular repayment, inheritance and increases in income turning the financial margin positive, but not the saving rate -- are subsumed under the label *other*.

Figure \@ref(fig:contributorsVulnerability) shows the causes for increases and decreases in the share of financially vulnerable households. The red line shows the overall resulting change of the share of vulnerable households. As already mentioned above, in the house price upswing the overall increase in financial vulnerability is driven by purchases. The reason this increase is not stronger is due to both financially vulnerable households selling property and saving up deposit-buffers. The saving channel here consists mainly of households becoming vulnerable by purchases but with high enough income to save up above the vulnerability threshold quickly. The saving channel reducing vulnerability is dominant in most parts of the cycle. From around the midpoint of the house price downturn the saving channel is stronger than the dissaving channel leading to reductions in overall vulnerability. Here, not only the share of households vulnerable by purchases declines but also those vulnerable by dissaving.

```{r contributorsVulnerability, fig.align='center', fig.cap="Contributors to changes in the share of financially vulnerable households over the housing cycle - 6 months rolling averages", fig.dim=c(6, 4), message=FALSE, warning=FALSE,  echo=FALSE, out.width='66%', results=FALSE}
# get first the position of house price troughs from a smoothed HPI line
# (not as necessary for troughs as for peaks, which are more irreglar)
# HPI_troughs <- find_peaks_smoothed( -outfile_2$`Sale HPI`, m=10, smoothedPerdiods = 12)
# translate the position of troughs into the corresponding periods to use later in graph
trough_period <- c(outfile_2$`Model time`[HPI_troughs])


outfile_2_tmp <- outfile_2 %>%
  select("vulnerable by purchase", "vulnerable by dissaving",  "vulnerable by other", "non-vulnerable by sale", "non-vulnerable by saving",  "non-vulnerable by other",`nVulHH (X*medIncome Y*m)`)%>%
  mutate(`non-vulnerable by sale` = -`non-vulnerable by sale`,
         `non-vulnerable by saving` = -`non-vulnerable by saving`,
         `non-vulnerable by other` = -`non-vulnerable by other`)

outfile_2_tmp <- as.matrix(outfile_2_tmp)/outfile_2$TotalPopulation # adjust for % of total population
outfile_2_tmp <- as.data.frame(runmean(outfile_2_tmp, rolling_averages)) # build a rolling average (6 for 6 months)
colnames(outfile_2_tmp) <- list("vulnerable by purchase", "vulnerable by dissaving",  "vulnerable by other", "non-vulnerable by sale", "non-vulnerable by saving",  "non-vulnerable by other", "vul HH") # abbreviate colnames for figure

outfile_2_tmp <- outfile_2_tmp %>%
  mutate(change = `vul HH`- lag(`vul HH`))%>%
  bind_cols(outfile_2$`Model time`, outfile_2$`Sale HPI`)%>%
  select(-`vul HH`) %>%
  pivot_longer(c("vulnerable by purchase", "vulnerable by dissaving",  "vulnerable by other", "non-vulnerable by sale", "non-vulnerable by saving",  "non-vulnerable by other"))  ## prepare for boxplots

colnames(outfile_2_tmp) <- list("change", "Period","HousePriceIndex", "cause", "value")
outfile_2_tmp$cause <- factor(outfile_2_tmp$cause, levels =c("vulnerable by other",  "vulnerable by purchase",  "vulnerable by dissaving", 
                                                          "non-vulnerable by other", "non-vulnerable by sale", "non-vulnerable by saving"))
# this is so I can display "change rate" and "HPI" in the graph. 
dat_text <- data.frame(
  label = c("change \nrate", "house price \nindex (rhs)"),
  Period = c(mean(c(trough_period[troughs_limits[1]],trough_period[troughs_limits[2]])+20), mean(c(trough_period[troughs_limits[1]],trough_period[troughs_limits[2]]))+20), # +10 here to shift to the right
  value = c(- 0.0015, 0.0025),
  # value = -mean(range(outfile_2_tmp$value)), 
  cause = c("vulnerable by other", "vulnerable by other")) # this is arbitrary, but otherwise it will not plot

# parameters for figure
relation_rhs_lhs <- 400
color_set_1 <- cet_pal(5, name = "r3") # color sets also used for later figure
color_set_2 <- c(color_set_1[1:3],cet_pal(6, name = "r1")[4:6]) #, cet_pal(10, name = "r1")[6], cet_pal(10, name = "r1")[8])

outfile_2_tmp %>%
  filter(Period >= trough_period[troughs_limits[1]], Period <= trough_period[troughs_limits[2]])%>%
  ggplot(aes(x=Period, fill =cause))+
  geom_col( aes(y = value))+
  geom_line( aes(y = change), size=1, color = "darkred")+
  geom_line( aes(y = HousePriceIndex / relation_rhs_lhs), size=1, linetype="dashed") +
  scale_y_continuous(
    # Features of the first axis
    name = "share of vulnerable households",
    labels = scales::percent,
    # Add a second axis and specify its features
    sec.axis = sec_axis(~ . *relation_rhs_lhs, name="House Price Index"),
    expand = expansion(mult = c(0, 0.05)) # make the barplots start at the axis
  ) +
  scale_x_continuous(expand = expansion(mult = c(0,0)))+
  # theme_classic()+
  theme(legend.position = "bottom") +
  theme(legend.background = element_blank()) +  # Remove overall border
  theme(legend.key = element_blank()) +
  scale_fill_manual(values = color_set_2)+ 
  geom_text(data = dat_text, aes(y= value), hjust = 0.1, vjust = 0.1, label = c("change \nrate (lhs)", "house price \nindex (rhs)"), color = c("darkred","black"), size=3)


```

## Characteristics of Financially Vulnerable Households

To understand which households become financially vulnerable, some of the households' characteristics are compared here. Figure \@ref(fig:distributionsVulHH) shows the distributions of different characteristics of financially vulnerable and indebted non-vulnerable households. The distributions are aggregated from monthly data, implying, simply put, that households that are vulnerable for two months are weighed double compared to a household only vulnerable for one month. What emerges are clear differences between vulnerable (green and yellow) and non-vulnerable households (grey). Financially vulnerable households have lower income than non-vulnerable households and tend to be more highly leveraged. While the credit volume taken out is similar between vulnerable and non-vulnerable households, vulnerable households have lower deposits when they enter the ownership market, resulting in higher debt-service-to-income ratios. As the median DSR of all indebted households is on average `r line_results[["medianDebtServiceRatio"]]` these households end up above the set threshold where housing wealth affects their consumption, i.e. where they are considered credit-constrained.

```{r distributionsVulHH, fig.cap="Densitiy curves and median values (striped lines) of central attributes of financially vulnerable and indebted non-vulnerable households", fig.subcap=c("Income", "Debt for last \\newline property purchase",  "Debt-Service-to-Income Ratio", "Deposits before last \\newline property purchase", "House price index at \\newline last property purchase", "Age"),  fig.show='hold', message=FALSE, warning=FALSE, fig.ncol = 3, out.width='33%', results=FALSE,  echo=FALSE}
transactions_to_join <- transactions_vul_2 %>%
  filter(transactionType == "sale")

sortingData_for_figure <-  agent_data_vul_2%>%
  mutate(agent = case_when(
    isBTL==1 & inFirstHome==0 & isFTB==0 ~ "BTL", 
    # isBTL ==0 & inFirstHome == 0 &isFTB==0 ~ "Mover", 
    # isFTB ==1 ~ "FirstTimeBuyer",
    # isBTL==1 &  isFTB==0 ~ "BTL", 
    NHouses>0 & isBTL == 0 & inFirstHome == 0 ~ "SSB",
    inFirstHome==1 ~ "FTB", 
    NHouses==0 ~ "Renter"))%>%
  mutate(ConsumptionNetHousingWealth = ConsHWealth + ConsDebt)%>%
  mutate(ConsumptionNetWealth = ConsHWealth + ConsDebt+ConsFWealth)%>%
  filter(Debt < 0)%>%
  filter(FinVulReason != "other")%>%
  filter(Period >= 2300)%>%
  # distinct(id, .keep_all = TRUE) %>%
  mutate(DTI = Debt/(-12* MonthlyGrossTotalIncome))%>%
  mutate(DSR = MonthlyMortgagePayments/MonthlyGrossTotalIncome)%>%
  mutate(CTI = Consumption/MonthlyDisposableIncome) %>%
  mutate(hasDebt = case_when(Debt<0 ~ TRUE, TRUE ~ FALSE))%>%
  left_join(transactions_to_join, by = c("id" = "buyerId"))%>%
  mutate(principal = transactionPrice-mortgageDownpayment)%>%
  mutate(LTV = principal/transactionPrice)%>%
  mutate(LTI = principal/ (12*buyerMonthlyGrossTotalIncome))%>%
  mutate(prePurchaseDeposits = mortgageDownpayment+buyerPostPurchaseBankBalance) %>%
  mutate(howLongAgo = Period - `Model time`) %>% # time now - time of purchase
  filter(howLongAgo > 0)%>% # future purchases have to be excluded (i.e. at period 2300 a purchase in period 2320 or similar)
  group_by(id, Period) %>% top_n(-1, howLongAgo)  # each vul HH each period has the last purchase "attached to them"

nrBins <- 20
color_temp <- cet_pal(5, name = "r3") # color sets also used for later figure
color_set_distr <- color_temp[c(3,2,4)]
color_set_distr[3] <- "darkgrey"
sortingData_for_figure$FinVulReason <- factor(sortingData_for_figure$FinVulReason, levels =c("dissaving", "purchase", "not vulnerable"))


################### INCOME
core_means <- sortingData_for_figure %>%
  group_by(FinVulReason) %>%
  summarise(coreIndicator = median(MonthlyGrossTotalIncome, na.rm = TRUE))

sortingData_for_figure %>%
  ggplot(aes(MonthlyGrossTotalIncome, fill = FinVulReason))+
  # ggtitle("Model households \nsubgroup indebted households")+
  geom_density(alpha = 0.5, position = "identity" , adjust = 5)+
  xlab("Monthly Gross Total Income \nand median value, between 0-7000")+
  # geom_histogram(alpha = 0.5, position = "identity", bins = nrBins )+
  xlim(c(0,7000))+
  geom_vline(
    data = core_means, linetype = "dashed", size = 1,
    aes(xintercept = coreIndicator, colour = FinVulReason)) +
  scale_fill_manual(values = color_set_distr) +
  scale_color_manual(values = color_set_distr)


################### DEBT
core_means <- sortingData_for_figure %>%
  group_by(FinVulReason) %>%
  summarise(coreIndicator = median(principal, na.rm = TRUE))

sortingData_for_figure %>%
  ggplot(aes(principal, fill = FinVulReason))+
  # ggtitle("Model households \nsubgroup indebted households")+
  geom_density(alpha = 0.5, position = "identity" , adjust = 5)+
  xlab("Debt at last purchase (log scale) \nand median value between 1000 and 1 million")+
  # geom_histogram(alpha = 0.5, position = "identity", bins = nrBins )+
  scale_x_log10(limits = c(1000,1000000))+
  geom_vline(
    data = core_means, linetype = "dashed", size = 1,
    aes(xintercept = coreIndicator, colour = FinVulReason)) +
  scale_fill_manual(values = color_set_distr) +
  scale_color_manual(values = color_set_distr)



################### DSR
core_means <- sortingData_for_figure %>%
  group_by(FinVulReason) %>%
  summarise(coreIndicator = median(DSR, na.rm = TRUE))

sortingData_for_figure %>%
  ggplot(aes(DSR, fill = FinVulReason))+
  # ggtitle("Model households \nsubgroup indebted households")+
  geom_density(alpha = 0.5, position = "identity" , adjust = 5)+
  xlab("Debt-Service-Ratio and median value between 0 and 0.75")+
  # geom_histogram(alpha = 0.5, position = "identity", bins = nrBins )+
  xlim(c(0,0.75))+
  geom_vline(
    data = core_means, linetype = "dashed", size = 1,
    aes(xintercept = coreIndicator, colour = FinVulReason)) +
  scale_fill_manual(values = color_set_distr) +
  scale_color_manual(values = color_set_distr)

################### pre-purchase deposits
core_means <- sortingData_for_figure %>%
  group_by(FinVulReason) %>%
  summarise(coreIndicator = median(prePurchaseDeposits, na.rm = TRUE))

sortingData_for_figure %>%
  ggplot(aes(prePurchaseDeposits, fill = FinVulReason))+
  # ggtitle("Model households \nsubgroup indebted households")+
  geom_density(alpha = 0.5, position = "identity" , adjust = 5)+
  xlab("Deposits right before purchase (log scale)\nbetween 1000 and 1 million")+
  # geom_histogram(alpha = 0.5, position = "identity", bins = nrBins )+
  scale_x_log10(limits = c(1000,1000000))+
  geom_vline(
    data = core_means, linetype = "dashed", size = 1,
    aes(xintercept = coreIndicator, colour = FinVulReason)) +
  scale_fill_manual(values = color_set_distr) +
  scale_color_manual(values = color_set_distr)

################### SALE HPI
core_means <- sortingData_for_figure %>%
  group_by(FinVulReason) %>%
  summarise(coreIndicator = median(`Sale HPI.y`, na.rm = TRUE))

sortingData_for_figure %>%
  ggplot(aes(`Sale HPI.y`, fill = FinVulReason))+
  # ggtitle("Model households \nsubgroup indebted households")+
  geom_density(alpha = 0.5, position = "identity" , adjust = 5)+
  xlab("House price index when \nhoushold bought last property")+
  # geom_histogram(alpha = 0.5, position = "identity", bins = nrBins )+
  # xlim(c(0,0.75))+
  geom_vline(
    data = core_means, linetype = "dashed", size = 1,
    aes(xintercept = coreIndicator, colour = FinVulReason)) +
  scale_fill_manual(values = color_set_distr) +
  scale_color_manual(values = color_set_distr)
################# age
core_means <- sortingData_for_figure %>%
  group_by(FinVulReason) %>%
  summarise(coreIndicator = median(Age, na.rm = TRUE))

sortingData_for_figure %>%
  ggplot(aes(Age, fill = FinVulReason))+
  # ggtitle("Model households with top66%income FTB saving motive 60%\nsubgroup indebted households")+  #\nlowest income quartile exempt
  geom_density(alpha = 0.6, position = "identity" , adjust = 5)+
  # geom_histogram(alpha = 0.5, position = "identity", bins = nrBins )+
  xlim(c(20,80))+
  xlab("Age and median value between 20 and 80")+
  geom_vline(
    data = core_means, linetype = "dashed", size = 1,
    aes(xintercept = coreIndicator, color = FinVulReason)
  ) +
  scale_fill_manual(values = color_set_distr) +
  scale_color_manual(values = color_set_distr)

```

Some differences emerge between households vulnerable by purchases and vulnerable by dissaving. The former tend to have slightly lower incomes. Also, their deposits right before their last property purchase (which can be used as down payment) are lower than of households who become (later) vulnerable by dissaving -- the distribution of pre-purchase deposits of households vulnerable by dissaving is very similar to that of non-vulnerable households. These differences could be expected: when buying a home these lower incomes increase the risk of negative financial margins, the lower deposits before the purchase translate to lower deposits after the purchase, increasing the risk of financial vulnerability. These households become financially vulnerable by buying property. By the definition used here, households vulnerable by dissaving can become only vulnerable at least one period after their last property purchase.[^21] Consequently, households vulnerable by dissaving are (on average) older than households vulnerable by purchase.

[^21]: At the same time, over their lifetime, households can became financially vulnerable by purchase and later by dissaving (given they ceased to be vulnerable in between).

As is shown in more detail in Chapter \@ref(financial-vulnerability-by-agent-class) in the Appendix, a larger share of second-and-subsequent buyers are financially vulnerable due to dissaving than first-time buyers where it is more equally distributed. Note that buy-to-let investors are rarely vulnerable at all, due to their higher income.

## Path Dependency of Financial Vulnerability

```{r loadValuesPathDependency, echo=FALSE, message=FALSE, warning=FALSE, results=FALSE}
period_to_filter <- c(trough_period[10],trough_period[10]+50) # +50 is approximately the peak of fin vul by dissaving
HowLongBackPathDependency <- 300
```

This chapter is concerned with the long-term effects of housing cycles on financial vulnerability. Generally, due to the long contract maturity, mortgage debt tends to have long-term effects on the real economy [@Drehmann2018]. Likewise, debt-financed property purchases could influence the financial vulnerability of households for long periods of time. To visualize this in the model, the left panel of Figure \@ref(fig:whenVulBuy) maps the households vulnerable at the beginning of the latest house price upswing -- which is where the blue striped line intercepts (period `r period_to_filter[1]`). The dots symbolize one household's last property purchase each, according to when (x-axis) and at what price levels (y-axis) they bought it -- looking back up to 25 years, the maturity of all mortgage contracts. The green dots in the left panel show that when house prices are currently low, households vulnerable by purchase either just bought property (at low prices) or did so at previous cycle peaks. The horizontal spread of these green dots suggests considerable path dependency of financial vulnerability induced by purchases.[^22] Households vulnerable by dissaving (yellows dots) have their last property purchases more equally distributed over the past housing cycles. While this figure does not reveal how long the households vulnerable by dissaving have been vulnerable for, Figure \@ref(fig:vulSince) in the Appendix shows that most of them have been vulnerable for several years prior.

[^22]: Households vulnerable by purchase in the current period had to be -- following from the distinction made here between vulnerability channels -- vulnerable continuously from their last property purchase until the current period.

The right panel of Figure \@ref(fig:whenVulBuy) shows the financially vulnerable households `r period_to_filter[2] - period_to_filter[1]` periods later than the in the left panel shortly after the house price peak (marked again by the dotted line). There are two major differences from low to high prices. Most households that became newly vulnerable and bought their last property between period `r period_to_filter[1]` and `r period_to_filter[2]` became vulnerable by purchase. Only very few bought property and became vulnerable a couple of periods later due to increased consumption induced by their positive net housing wealth (the few yellow dots between in the periods before the vertical line). The other major difference can be found around periods 2225 and 2325 where a large amount of households vulnerable by dissaving appear. This tells us that with the rising house prices (between periods `r period_to_filter[1]` and `r period_to_filter[2]`) households which bought their last property at high house price levels, one or two cycles ago,[^23] now became newly financially vulnerable by dissaving. Looking at the micro data tells us that these households -- highly leveraged by the property purchase -- experienced negative equity when house prices started to drop. Negative housing wealth leads to increased saving (see Equation \@ref(eq:dConsumption)) and thereby increasing deposits as long as prices stay low. When house prices rise again, their net housing wealth turns positive, inducing the depletion of their savings.

[^23]: The effect seems to fade for the third cycle.

```{r whenVulBuy, fig.cap="When did households, vulnerable at house price peak and trough buy?",fig.subcap=c("Households vulnerable at trough \\newline House price level at last purchase", "Households vulnerable at peak \\newline House price level at last purchase"),  fig.show='hold', message=FALSE, warning=FALSE, out.width='49%', results=FALSE,  echo=FALSE}

# period_to_filter <- c(2368,2414)
color_set_1 <- cet_pal(5, name = "r3") # color sets also used for later figure

vul_certain_period_trough <-agent_data_vul_2%>%
  mutate(agent = case_when(
    isBTL==1 & inFirstHome==0 & isFTB==0 ~ "BTL", 
    # isBTL ==0 & inFirstHome == 0 &isFTB==0 ~ "Mover", 
    # isFTB ==1 ~ "FirstTimeBuyer",
    # isBTL==1 &  isFTB==0 ~ "BTL", 
    NHouses>0 & isBTL == 0 & inFirstHome == 0 ~ "SSB",
    inFirstHome==1 ~ "FTB", 
    NHouses==0 ~ "Renter"))%>%
  filter(FinVulReason != "not vulnerable")%>%
  filter(FinVulReason != "other")%>%
  filter(Period == period_to_filter[1])%>%
  # filter(agent=="inFirstHome")%>%
  left_join(transactions_vul_2, by = c("id" = "buyerId"))%>%
  mutate(principal = transactionPrice-mortgageDownpayment)%>%
  mutate(prePurchaseDeposits = principal+buyerPostPurchaseBankBalance) %>%
  mutate(LTV = principal/transactionPrice)%>%
  mutate(LTI = principal/ (12*buyerMonthlyGrossTotalIncome))%>%
  mutate(howLongAgo = Period - `Model time`) %>%
  filter(transactionType == "sale")%>%
  filter(howLongAgo > 0)%>%
  group_by(id) %>% top_n(-1, howLongAgo) 

vul_certain_period_peak <-agent_data_vul_2%>%
  mutate(agent = case_when(
    isBTL==1 & inFirstHome==0 & isFTB==0 ~ "BTL", 
    # isBTL ==0 & inFirstHome == 0 &isFTB==0 ~ "Mover", 
    # isFTB ==1 ~ "FirstTimeBuyer",
    # isBTL==1 &  isFTB==0 ~ "BTL", 
    NHouses>0 & isBTL == 0 & inFirstHome == 0 ~ "SSB",
    inFirstHome==1 ~ "FTB", 
    NHouses==0 ~ "Renter"))%>%
  filter(FinVulReason != "not vulnerable")%>%
  filter(FinVulReason != "other")%>%
  filter(Period == period_to_filter[2])%>%
  # filter(agent=="inFirstHome")%>%
  left_join(transactions_vul_2, by = c("id" = "buyerId"))%>%
  mutate(principal = transactionPrice-mortgageDownpayment)%>%
  mutate(prePurchaseDeposits = principal+buyerPostPurchaseBankBalance) %>%
  mutate(LTV = principal/transactionPrice)%>%
  mutate(LTI = principal/ (12*buyerMonthlyGrossTotalIncome))%>%
  mutate(howLongAgo = Period - `Model time`) %>%
  filter(transactionType == "sale")%>%
  filter(howLongAgo > 0)%>%
  group_by(id) %>% top_n(-1, howLongAgo) 

########################### HPI und last sale
HPI1 <- outfile_2 %>%
  select(`Sale HPI`, `Model time`)%>%
  filter(`Model time` <= period_to_filter[1])

colnames(HPI1) <- list("House Price Index", "Period") 

data1 <- vul_certain_period_trough %>%
  filter(agent != "Renter")  # Households selling their homes at the end of the period could be still recorded vulnerable (which happens at the beginning of a period) - very rarely

(ggplot(data = HPI1, aes(y = `House Price Index`, x = Period) )+
    geom_line( size=0.5, linetype="dashed", color = "black")+ 
    geom_point(data = data1, aes(x = `Model time`,y= `Sale HPI.y`, color = FinVulReason), position = position_jitter(width = 0.025, height = 0.025))+
    xlab(paste0("In what period did the household - vulnerable\nin period ", period_to_filter[1], " - buy their last property?"))+
    ylab(paste0("At what house price index did the household - vulnerable\nin period ", period_to_filter[1], " - buy their last property?")) +
    theme(legend.position = "bottom") +
    ylim(c(0.10, 1.5)) +
    xlim(c(period_to_filter[1] - HowLongBackPathDependency, period_to_filter[2])) + 
    geom_vline(
      xintercept = period_to_filter[1], linetype = 2, size = 1, color = "darkblue" 
    )+
    scale_color_manual(values = color_set_1[c(3,2)])+
    annotate("text", x = 2400, y = 0.8, label = "all house-\nholds \ndepicted\nare\nvulnerable\nin this\nperiod", color = "darkblue")) 


########################### HPI und last sale
HPI2 <- outfile_2 %>%
  select(`Sale HPI`, `Model time`)%>%
  filter(`Model time` <= period_to_filter[2])

colnames(HPI2) <- list("House Price Index", "Period") 


data2 <- vul_certain_period_peak %>%
  filter(agent != "Renter")  # Households selling their homes at the end of the period could be still recorded vulnerable (which happens at the beginning of a period) - very rarely

  
(ggplot(data = HPI2, aes(y = `House Price Index`, x = Period) )+
    geom_line( size=0.5, linetype="dashed", color = "black")+ 
    geom_point(data = data2, aes(x = `Model time`,y= `Sale HPI.y`, color = FinVulReason), position = position_jitter(width = 0.025, height = 0.025))+
    xlab(paste0("In what period did the household - vulnerable\nin period ", period_to_filter[2], " - buy their last property?"))+
    ylab(paste0("At what house price index did the household - vulnerable\nin period ", period_to_filter[2], " - buy their last property?")) +
    theme(legend.position = "bottom") +
    ylim(c(0.10, 1.5)) +
    xlim(c(period_to_filter[1] - HowLongBackPathDependency, period_to_filter[2])) + 
    geom_vline(
      xintercept = period_to_filter[2], linetype =2, size = 1, color = "darkblue"
    )+
    scale_color_manual(values = color_set_1[c(3,2)]) +
    annotate("rect", xmin = 2212, xmax = 2252, ymin = 1, ymax = 1.4, alpha = 0, color = "red") +
    annotate("rect", xmin = 2305, xmax = 2345, ymin = 1, ymax = 1.4, alpha = 0, color = "red") +
    annotate("text", x = 2280, y = 1.2, label = "newly\nvulnerable\nwith high\nprices", color = "red")+
    annotate("text", x = 2420, y = 0.8, label = "all house-\nholds \ndepicted\nare\nvulnerable\nin this\nperiod", color = "darkblue")
)

```

The increase in households becoming financially vulnerable by dissaving with high house prices and which bought their current home at a previous cycle peak is demonstrated more generally (by comparing more than two points of one housing cycle) in Table \@ref(tab:vulnerbilityTable). Here, periods where the house price influence on vulnerability is high are defined as the half of the house price cycle where the share of households vulnerable by dissaving is highest. When this price influence is high, the share of households vulnerable by dissaving that bought their last property at high (i.e. above median) prices is 1.1% versus only 0.7% when price influence is low. The share of households vulnerable by dissaving that bought their last property at low prices is less affected by the overall price influence (even shrinks from 0.3% to 0.2%).

```{r vulnerbilityTable, message=FALSE, warning=FALSE,  echo=FALSE}



out <- read_csv(here::here(paste0("Results\\", model_folder_noFTBSM_2, "\\Output-run", 1, ".csv")))


hpi_median <- out %>%
  filter(`Model time` > 2300) %>%
  select(`Sale HPI`, `Model time`, `vulnerable by dissaving`, `vulnerable by purchase`)
  # median(hpi_median$`Sale HPI`)


out_HPI <- out %>%
  select(`Model time`, `Sale HPI`)

peaks <-  find_peaks_smoothed(x = hpi_median$`Sale HPI`,m= 30,smoothedPerdiods = 24, paint = FALSE)
# diff(peaks)
beginning_period_high <- c()
# shift a quarter of the cycle left from the point of highest vul diss (which is +15 periods after cycle due to crosscorrelations (kann man auch noch reincoden))
for(i in 1:(length(peaks)-1))beginning_period_high[i] <- peaks[i] + (15 - round(0.25 * diff(peaks)[i], digits = 0))

end_period_high <- vector()
for(i in 1:(length(peaks)-1))end_period_high[i] <- peaks[i] + (15 + round(0.25 * diff(peaks)[i], digits = 0))

# build the high dissaving frame
high_periods <- c()
for(i in 1:(length(peaks)-1)) high_periods <- append(high_periods,c(beginning_period_high[i]:end_period_high[i]))

low_periods <- c()
for(i in 1:(length(peaks)-2)) low_periods <- append(low_periods,c(end_period_high[i]:beginning_period_high[i+1]))

# plot(hpi_median$`Sale HPI`, type = 'l', main = "high_periods")
# points(low_periods, hpi_median$`Sale HPI`[low_periods], col = 'red', pch = 19)
# points(high_periods, hpi_median$`Sale HPI`[high_periods], col = 'blue', pch = 19)


# translate to periods
adjusted_high_periods <- hpi_median$`Model time`[high_periods]
adjusted_low_periods <- hpi_median$`Model time`[low_periods]

table_vul <- different_Ampudia_vul_2 %>%
  left_join(out_HPI, by = c("Period" = "Model time")) %>%
  left_join(out_HPI, by = "Model time") %>%
  filter(vulnerable == "TRUE") %>%
  mutate(Price_level = case_when(Period %in% adjusted_high_periods ~ "high", Period %in% adjusted_low_periods ~ "low", TRUE ~ "undefined"))%>%
  mutate(Price_level_purchase = case_when(`Sale HPI.y`>= median(hpi_median$`Sale HPI`)~ "high", TRUE~ "low")) # %>%


table_vul_2 <- table_vul %>%
  filter(Price_level != "undefined") %>%
  filter(FinVulReason %in% c("dissaving", "purchase")) %>%
  # group_by(Price_level, Period)%>%
  group_by(Price_level, FinVulReason, Price_level_purchase)%>%
  # tally() %>%
  tally()


a <- table_vul_2 %>%
  filter(Price_level == "high")%>%
  mutate(n = (n / 10000) / length(high_periods))

b <- table_vul_2 %>%
  filter(Price_level == "low")%>%
  mutate(n = (n / 10000) / length(low_periods))

table_vul_2 <- bind_rows(a,b)
table_vul_2$n <-  formattable::percent(table_vul_2$n, digits = 1)

table_vul_print <- pivot_wider(table_vul_2, names_from = c( FinVulReason, Price_level_purchase), values_from = n) 
table_vul_print$Share_vul_hh_diss <- table_vul_print$dissaving_high + table_vul_print$dissaving_low
table_vul_print$Share_vul_hh_purch <- table_vul_print$purchase_high + table_vul_print$purchase_low

table_vul_print <- table_vul_print[,c(1,6,7,2,4,3,5)]

colnames(table_vul_print) <- list(" ", "by dissaving", "by purchase"," by dissaving", " by purchase","by dissaving ", "by purchase " )

table_vul_print <- as.data.frame(table_vul_print)

table_vul_print %>%
  # mutate_all(linebreak)%>%
  kableExtra::kbl(
    caption = "Path dependency of financial vulnerability",
    booktabs = T,
    escape = T,
    align = "c"
    # col.names = linebreak(lineBreaks_table, align ="c")
    )%>%
  kable_styling(latex_options =c("scale_down")) %>%

  # Watch out -> here I set the names of the target values
  add_header_above(c("Price\ninfluence" = 1, "% vulnerable\nhouseholds" = 2,
                     "% vul HH that purchased\nat high prices" = 2,
                     "% vul HH that purchased\nat low prices" = 2)) %>%
  footnote(general = "Model values are calculated from single-run with 300 Periods. These periods are equally divided into periods of high and low price influence, where the mid-point of the high price influence is defined as the period where the number of households financially vulnerable by dissaving is highest, based on the cross-correaltions in the Appendix. Periods of high and low prices, on the other hand, are defined as periods with price indices above and below the median house price index, respectively.",threeparttable =T)
```

In conclusion, the financial-vulnerability-channels of purchasing and dissaving work at different points of the house price cycle. The purchasing channel increases the share of vulnerable households mainly in the upswing and immediately after households buy property. The dissaving channel on the other hand is more important at high prices, where increases are rooted to a sizable extent in purchases at previous house price peaks. This can include households that previously became vulnerable by purchases as they can become vulnerable again by dissaving at a later house price peak. For both effects there is a "floor" of financially vulnerable households, consisting mainly of households that bought at low prices, therefore experiencing almost exclusively positive net housing wealth, which -- due to their above-median DSR -- leads to below-vulnerability-threshold deposits.

This differences between the purchase and the dissaving channel is even more pronounced when using a simpler definition of financial vulnerability used here (see chapter \@ref(main-analysis-with-simpler-definition-of-financial-vulnerability)).

# Conclusion

This paper analysed two important contributors to financial vulnerability of the household sector stemming from housing market dynamics. Purchases, as well as a precautionary or collateral channel, have been found to be central to understanding financial vulnerability dynamics. While housing wealth effects, and more specifically collateral or precautionary channels, have been identified to affect aggregate consumption responses to house price dynamics, their effect on the financial vulnerability of households themselves has not been sufficiently researched, so far. Indeed, to the authors knowledge, no study explicitly researched this causal channel. This omission could be partly explained by the indicators used to define households as financially vulnerable. Indicators using financial buffers have not been as widespread as those focusing for instance on debt-service-to-income ratios only.[^24] Financially vulnerable households tend to have lower income than non-vulnerable homeowners while being highly leveraged. The dynamics are almost exclusively driven by owner-occupiers, investors play only a minor role. Especially first-time-buyers become vulnerable by purchasing their first home. Second-and-subsequent buyers tend to become more vulnerable by dissaving.

[^24]: However, it can be assumed that equity withdrawal has the potential to increase debt-service-to-income ratios -- an effect that is not part of the model.

The agent-based model utilized was able reproduce important stylized facts. However, it also has some shortcomings that could influence the results. House prices tend to fall to unrealistically low levels, due to missing stabilizing mechanisms. This limitation could allow lower-income households to enter the housing market (earlier), thereby increasing the share of young, financially vulnerable households. However, the age distributions in Figure \@ref(fig:AgeWAS) does not suggest that this is the case. Another limitation of the model is the missing macroeconomy, implying that consumption responses do not feed back into households employment income. This way, the model might underestimate the effect of changes in income financial vulnerability. By implementing a buffer to the financial margin in Chapter \@ref(households-at-risk-of-becoming-financially-vulnerable), the analysis presented here is able to account at least for some form of general income risk.

With these limitations in mind, the analysis showed that a precautionary channel could be important in explaining dynamics of financial vulnerability over the house price cycle. At the same time, the effects can be very long-lasting and levels of financial vulnerability today depend to a large extent on past purchases (as well as on current price levels). This makes addressing them by policy somewhat difficult as even without any additional sale in the current cycle, financial vulnerability could increase when house prices are high.

\FloatBarrier

# Appendix {.unnumbered}

# (APPENDIX) Appendices {.unnumbered}

# Financial Vulnerability by Agent-Class

Interestingly, the differences between both vulnerability channels purchases and dissaving are mirrored, to some extent, by the agent classes. Figure \@ref(fig:stockVulAgentClass) shows that FTB agents are almost exclusively responsible for the purchasing channel. BTL investors contribute almost nothing to the share of financially vulnerable households. FTB agents get more frequently vulnerable by purchases than SSB agents (while purchasing slightly fewer houses on average than SSB agents - see Table \@ref(tab:BoECoreIndicators)) due to their lower deposits. SSB agents usually hold higher deposits coming from the revenue of their previous home sale.

```{r, stockVulAgentClass, fig.cap="Share of financially vulnerable households by cause and agent-class - 6 months rolling averages", fig.show='hold', echo = FALSE, message=FALSE, warning=FALSE,  results=FALSE,  out.height= '25%'}

outfile_2_tmp <- outfile_2 %>%
  select( "nowVul Purchase BTL",	 "nowVul Dissaving BTL",	 "nowVul Other BTL",	"nowVul Purchase SSB",	 "nowVul Dissaving SSB",	 
          "nowVul Other SSB",	 "nowVul Purchase FTB",	 "nowVul Dissaving FTB",	 "nowVul Other FTB")


outfile_2_tmp <- as.matrix(outfile_2_tmp)/outfile_2$TotalPopulation # adjust for % of total population
outfile_2_tmp <- as.data.frame(runmean(outfile_2_tmp, rolling_averages)) # build a rolling average (6 for 6 months)

colnames(outfile_2_tmp) <- list("nowVul Purchase BTL",	 "nowVul Dissaving BTL",	 "nowVul Other BTL",	"nowVul Purchase SSB",	 "nowVul Dissaving SSB",	 
                              "nowVul Other SSB",	 "nowVul Purchase FTB",	 "nowVul Dissaving FTB",	 "nowVul Other FTB") # abbreviate colnames for figure



outfile_2_tmp <- outfile_2_tmp %>%
  bind_cols(outfile_2$`Model time`, outfile_2$`Sale HPI`)%>%
  pivot_longer(c("nowVul Purchase BTL",	 "nowVul Dissaving BTL",	 "nowVul Other BTL",	"nowVul Purchase SSB",	 "nowVul Dissaving SSB",	 
                 "nowVul Other SSB",	 "nowVul Purchase FTB",	 "nowVul Dissaving FTB",	 "nowVul Other FTB"))  ## prepare for boxplots

colnames(outfile_2_tmp) <- list("Period","HousePriceIndex", "vulnerable_by", "value")
outfile_2_tmp <- outfile_2_tmp %>%
  mutate(agent = case_when(vulnerable_by %in%c ("nowVul Purchase BTL",	 "nowVul Dissaving BTL",	 "nowVul Other BTL") ~ "BTL",
                           vulnerable_by %in% c("nowVul Purchase SSB",	 "nowVul Dissaving SSB",	 "nowVul Other SSB") ~ "SSB",
                           vulnerable_by %in% c("nowVul Purchase FTB",	 "nowVul Dissaving FTB",	 "nowVul Other FTB") ~ "FTB"))%>%
  mutate(vulnerable_by = case_when(vulnerable_by %in% c("nowVul Purchase BTL", "nowVul Purchase SSB",	"nowVul Purchase FTB") ~ "purchase",
                                   vulnerable_by %in% c("nowVul Dissaving BTL", "nowVul Dissaving SSB", "nowVul Dissaving FTB") ~ "dissaving",
                                   vulnerable_by %in% c( "nowVul Other BTL", "nowVul Other SSB", "nowVul Other FTB") ~ "other")) %>%
  mutate(value = formattable::percent(value))

outfile_2_tmp$vulnerable_by <- factor(outfile_2_tmp$vulnerable_by, levels = c("other", "purchase", "dissaving"))
# outfile_2_tmp$vulnerable_by <- factor(outfile_2_tmp$vulnerable_by, levels = c("other", "dissaving", "purchase"))

color_set_1 <- cet_pal(5, name = "r3") # color sets also used for later figure

# parameters for figure
relation_rhs_lhs <- 80

outfile_2_tmp %>%
    filter(Period >= trough_period[troughs_limits[1]], Period <= trough_period[troughs_limits[2]])%>%
  ggplot(aes(x=Period, fill = vulnerable_by))+
  geom_col( aes(y = value))+
  geom_line( aes(y = HousePriceIndex / relation_rhs_lhs), size=0.25, linetype="dashed") +
  scale_y_continuous(
    # Features of the first axis
    name = "share of vulnerable households",
    labels = scales::percent,
    # Add a second axis and specify its features
    sec.axis = sec_axis(~ . *relation_rhs_lhs, name="House Price Index"),
    expand = expansion(mult = c(0, 0.05)) # make the barplots start at the axis
  ) +
  scale_x_continuous(expand = expansion(mult = c(0,0)))+
  # theme_classic()+
  theme(legend.position = "bottom") +
  theme(legend.background = element_blank()) +  # Remove overall border
  theme(legend.key = element_blank()) +
  scale_fill_manual(values = color_set_1)+
  facet_wrap( ~ agent) # , scales = "free")
# labs(caption = "Notes: Your long reference footnote goes in here. UNd Ã¼brigensBesonders krass\n dass das so ist")
```

```{r, flowAgentClass, fig.cap="Causes for changes in the vulnerability of agent-classes", fig.show='hold', message=FALSE, echo=FALSE, warning=FALSE,  results=FALSE,  echo=FALSE, eval=FALSE, out.height= '33%'}
outfile_2_tmp <- outfile_2 %>%
  select("Vulnerable By Purchase BTL",	"Vulnerable By Purchase SSB",	 "Vulnerable By Purchase InFirstHome",	"Vulnerable By Consumption BTL",	 "Vulnerable By Consumption SSB",	 "Vulnerable By Consumption InFirstHome",	"Vulnerable By Other BTL",	 "Vulnerable By Other SSB",	 "Vulnerable By Other InFirstHome",	"Non-Vulnerable Because Sale BTL",	 "Non-Vulnerable Because Sale SSB",	 "Non-Vulnerable Because Sale InFirstHome", "Non-Vulnerable Because Saving BTL",	 "Non-Vulnerable Because Saving SSB",	 "Non-Vulnerable Because Saving InFirstHome",	 "Non-Vulnerable Because Other BTL",	 "Non-Vulnerable Because Other SSB",	 "Non-Vulnerable Because Other InFirstHome",
         "nVul activeBTL (X*medIncome Y*m)", "nVul inFirstHome (X*medIncome Y*m)",	"nVul SSB (X*medIncome Y*m)")

# set non-vulnerable values as negative
outfile_2_tmp <- outfile_2_tmp %>%
  mutate(`Non-Vulnerable Because Sale BTL` = - `Non-Vulnerable Because Sale BTL`,	 `Non-Vulnerable Because Sale SSB` = - `Non-Vulnerable Because Sale SSB`, 
         `Non-Vulnerable Because Sale InFirstHome` = - `Non-Vulnerable Because Sale InFirstHome`, `Non-Vulnerable Because Saving BTL` = - `Non-Vulnerable Because Saving BTL`,
         `Non-Vulnerable Because Saving SSB` = - `Non-Vulnerable Because Saving SSB`,	 `Non-Vulnerable Because Saving InFirstHome` = - `Non-Vulnerable Because Saving InFirstHome`,
         `Non-Vulnerable Because Other BTL` = - `Non-Vulnerable Because Other BTL`,	 `Non-Vulnerable Because Other SSB` = - `Non-Vulnerable Because Other SSB`,	
         `Non-Vulnerable Because Other InFirstHome` = - `Non-Vulnerable Because Other InFirstHome`) 


outfile_2_tmp <- as.matrix(outfile_2_tmp)/outfile_2$TotalPopulation # adjust for % of total population
outfile_2_tmp <- as.data.frame(runmean(outfile_2_tmp, rolling_averages)) # build a rolling average (6 for 6 months)

colnames(outfile_2_tmp) <- list("Vulnerable By Purchase BTL",	"Vulnerable By Purchase SSB",	 "Vulnerable By Purchase InFirstHome",	"Vulnerable By Consumption BTL",	 "Vulnerable By Consumption SSB",	 "Vulnerable By Consumption InFirstHome",	"Vulnerable By Other BTL",	 "Vulnerable By Other SSB",	 "Vulnerable By Other InFirstHome",	"Non-Vulnerable Because Sale BTL",	 "Non-Vulnerable Because Sale SSB",	 "Non-Vulnerable Because Sale InFirstHome", "Non-Vulnerable Because Saving BTL",	 "Non-Vulnerable Because Saving SSB",	 "Non-Vulnerable Because Saving InFirstHome",	 "Non-Vulnerable Because Other BTL",	 "Non-Vulnerable Because Other SSB",	 "Non-Vulnerable Because Other InFirstHome",
         "nVul activeBTL", "nVul inFirstHome",	"nVul SSB") 

## build a file with periods, HPI and the change in share of vulnerable households by agent-class
outfile_2_tmp1 <- outfile_2_tmp %>%
  mutate(change_BTL = `nVul activeBTL` - lag(`nVul activeBTL`),
         change_SSB = `nVul SSB` - lag(`nVul SSB`),
         change_FTB = `nVul inFirstHome` - lag(`nVul inFirstHome`))%>%
  select(-c(`nVul activeBTL`, `nVul SSB`,`nVul inFirstHome`, "Vulnerable By Purchase BTL",	"Vulnerable By Purchase SSB",	 "Vulnerable By Purchase InFirstHome",	"Vulnerable By Consumption BTL",	 "Vulnerable By Consumption SSB",	 "Vulnerable By Consumption InFirstHome",	"Vulnerable By Other BTL",	 "Vulnerable By Other SSB",	 "Vulnerable By Other InFirstHome",	"Non-Vulnerable Because Sale BTL",	 "Non-Vulnerable Because Sale SSB",	 "Non-Vulnerable Because Sale InFirstHome", "Non-Vulnerable Because Saving BTL",	 "Non-Vulnerable Because Saving SSB",	 "Non-Vulnerable Because Saving InFirstHome",	 "Non-Vulnerable Because Other BTL",	 "Non-Vulnerable Because Other SSB",	 "Non-Vulnerable Because Other InFirstHome")) %>%
  bind_cols(outfile_2$`Model time`) %>%
  pivot_longer(c("change_BTL", "change_SSB", "change_FTB"))
colnames(outfile_2_tmp1) <- list("Period", "agent_change", "change")

outfile_2_tmp1 <- outfile_2_tmp1 %>%
  mutate(agent = case_when(agent_change == "change_BTL" ~ "BTL",
                           agent_change == "change_SSB" ~ "SSB",
                           agent_change == "change_FTB" ~ "FTB"))

# build a data frame where the causes for vulnerability become a "factor" and the values are gathered in one column (for graph)
outfile_2_tmp <- outfile_2_tmp %>%
  bind_cols(outfile_2$`Model time`, outfile_2$`Sale HPI`) %>%
  select(-c(`nVul activeBTL`, `nVul SSB`,`nVul inFirstHome`))%>%
  pivot_longer(c("Vulnerable By Purchase BTL",	"Vulnerable By Purchase SSB",	 "Vulnerable By Purchase InFirstHome",	"Vulnerable By Consumption BTL",	 "Vulnerable By Consumption SSB",	 "Vulnerable By Consumption InFirstHome",	"Vulnerable By Other BTL",	 "Vulnerable By Other SSB",	 "Vulnerable By Other InFirstHome",	"Non-Vulnerable Because Sale BTL",	 "Non-Vulnerable Because Sale SSB",	 "Non-Vulnerable Because Sale InFirstHome", "Non-Vulnerable Because Saving BTL",	 "Non-Vulnerable Because Saving SSB",	 "Non-Vulnerable Because Saving InFirstHome",	 "Non-Vulnerable Because Other BTL",	 "Non-Vulnerable Because Other SSB",	 "Non-Vulnerable Because Other InFirstHome")) 

colnames(outfile_2_tmp) <- list("Period","HousePriceIndex", "vulnerability", "value")

outfile_2_tmp <- outfile_2_tmp %>%
  mutate(agent = case_when(vulnerability %in%c( "Vulnerable By Purchase BTL"  , "Vulnerable By Consumption BTL", "Vulnerable By Other BTL", 
                                                "Non-Vulnerable Because Sale BTL" , "Non-Vulnerable Because Saving BTL" , "Non-Vulnerable Because Other BTL") ~ "BTL",
                           vulnerability %in% c("Vulnerable By Purchase SSB", "Vulnerable By Consumption SSB", "Vulnerable By Other SSB",
                                                "Non-Vulnerable Because Sale SSB", "Non-Vulnerable Because Saving SSB","Non-Vulnerable Because Other SSB") ~ "SSB",
                           vulnerability %in% c("Vulnerable By Purchase InFirstHome", "Vulnerable By Consumption InFirstHome", "Vulnerable By Other InFirstHome",
                                                "Non-Vulnerable Because Sale InFirstHome", "Non-Vulnerable Because Saving InFirstHome","Non-Vulnerable Because Other InFirstHome") ~ "FTB"))%>%
  mutate(cause = case_when(vulnerability %in% c("Vulnerable By Purchase BTL",	"Vulnerable By Purchase SSB",	 "Vulnerable By Purchase InFirstHome") ~ "vulnerable by purchase",
                           vulnerability %in% c("Non-Vulnerable Because Sale BTL",	 "Non-Vulnerable Because Sale SSB",	 "Non-Vulnerable Because Sale InFirstHome") ~ "non-vulnerable by sale",
                           vulnerability %in% c("Vulnerable By Consumption BTL",	 "Vulnerable By Consumption SSB",	 "Vulnerable By Consumption InFirstHome") ~ "vulnerable by dissaving",
                           vulnerability %in% c("Non-Vulnerable Because Saving BTL",	 "Non-Vulnerable Because Saving SSB",	 "Non-Vulnerable Because Saving InFirstHome") ~ "non-vulnerable by saving",
                           vulnerability %in% c("Vulnerable By Other BTL",	 "Vulnerable By Other SSB",	 "Vulnerable By Other InFirstHome") ~ "vulnerable by other",
                           vulnerability %in% c("Non-Vulnerable Because Other BTL",	 "Non-Vulnerable Because Other SSB",	 "Non-Vulnerable Because Other InFirstHome") ~ "non-vulnerable by other"))

outfile_2_tmp$cause <- factor(outfile_2_tmp$cause, levels = c("vulnerable by other",  "vulnerable by purchase",  "vulnerable by dissaving", 
                                                          "non-vulnerable by other", "non-vulnerable by sale", "non-vulnerable by saving"))
# 
# #### Join tables 
outfile_2_tmp <- left_join(outfile_2_tmp, outfile_2_tmp1, by = c("Period", "agent"))%>%
  mutate(value = formattable::percent(value),
         change = formattable::percent(change))

# parameters for figure
relation_rhs_lhs <- 1000

color_set_1 <- cet_pal(5, name = "r3") # color sets also used for later figure
color_set_2 <- c(color_set_1[1:3],cet_pal(6, name = "r1")[4:6]) #, cet_pal(10, name = "r1")[6], cet_pal(10, name = "r1")[8])

# this is so I can display "change rate" and "HPI" in the graph. 
dat_text <- data.frame(
  label = c("change \nrate", "house price \nindex (rhs)"),
  Period = c(mean(c(trough_period[troughs_limits[1]],trough_period[troughs_limits[2]])+10), mean(c(trough_period[troughs_limits[1]],trough_period[troughs_limits[2]]))+10), # +10 here to shift to the right
  agent   = c("SSB", "SSB"),
  value = c(- 0.0005, 0.0015),
  # value = -mean(range(outfile_2_tmp$value)), 
  cause = c("vulnerable by other", "vulnerable by other")) # this is arbitrary, but otherwise it will not plot

p <- outfile_2_tmp %>%
  filter(Period >= trough_period[troughs_limits[1]], Period <= trough_period[troughs_limits[2]])%>%
  ggplot(aes(x=Period, fill = cause))+
  geom_col( aes(y = value))+
  geom_line( aes(y = change), size=0.5, color = "darkred")+
  geom_line( aes(y = HousePriceIndex / relation_rhs_lhs), size=0.25, linetype="dashed") +
  scale_y_continuous(
    # Features of the first axis
    name = "share of vulnerable households",
    labels = scales::percent,
    # Add a second axis and specify its features
    sec.axis = sec_axis(~ . *relation_rhs_lhs, name="House Price Index"),
    expand = expansion(mult = c(0, 0.05)) # make the barplots start at the axis
  ) +
  scale_x_continuous(expand = expansion(mult = c(0,0)))+
  # theme_classic()+
  theme(legend.position = "bottom") +
  theme(legend.background = element_blank()) +  # Remove overall border
  theme(legend.key = element_blank()) +
  scale_fill_manual(values = color_set_2)+
  facet_wrap( ~ agent)
  p+ geom_text(data = dat_text, aes(y= value), hjust = 0.1, vjust = 0.5, label = c("change \nrate", "house price \nindex (rhs)"), color = c("darkred","black"), size=3)
# 
#   annotate("text", x = mean(c(trough_period[2],trough_period[3])), y = mean(range(outfile_2_tmp$value)),hjust=-0.5, vjust = 13, label = c"change rate", color = "darkred", size = 3)
# labs(caption = "Notes: Your long reference footnote goes in here. UNd Ã¼brigensBesonders krass\n dass das so ist")
```

\FloatBarrier

# Robustness Checks for the strength of the dissaving channel

The strength of the dissaving channel could be sensitive to the parametrization of the model used here. Moreover, different parameters used in the definition of financial vulnerability -- given the parametrization of the variables of the model -- could lead to the financial vulnerability of the model not being as close to the WAS data, as with the definition used in the main analysis.

## Different Model Parametrization

```{r, echo=FALSE, message=FALSE, warning=FALSE, results=FALSE}
calibration_consChannel_param <- read.csv(here::here("statistical output R/outputsCalibrationTest_june2021.csv"))
```

To test if the strength of dissaving channel is sensitive to the specification of the free parameters in Table \@ref(tab:parameters) the average dissaving channel strength from all 1000 model runs with different parameter sets are checked first. The definition of financial vulnerability was including the income-risk buffer of Equation \@ref(eq:finVulalt). The average strength of the dissaving channel was `r formattable::percent(mean(calibration_consChannel_param$vulConsumptionChannel),digits = 0)`.[^25] To get an insight into the influence of the different free parameters, a simple linear regression is performed, shown in Figure \@ref(fig:modelParam). It shows that the higher the income percentile of first-time-buyers (FTB) that have an extra saving motive for down payments, the more important the dissaving channel becomes. This makes intuitive sense almost all households vulnerable by purchase are FTB. The fewer save extra for a down payment and thereby are able to buy a home, the fewer are vulnerable by purchase. Similarly, the lower the loan-to-value ratio for FTB is set, the higher the importance of the dissaving channel. The more the FTB's access to credit is restricted, the less important the purchasing channel becomes.

[^25]: This is regardless of how closely they were able to match UK data.

```{r, modelParam, fig.cap="Estimation of the effect of the free parameters on the strength of the consumption channel  based on 1000 calibration runs with 95 percent confidence intervals", fig.show='hold', message=FALSE, warning=FALSE, out.width='49%', results=FALSE,  echo=FALSE}



calibration_consChannel_param <- calibration_consChannel_param %>%
  mutate(LTV_FTB = case_when(LTV1 >= LTV2 & LTV1 >= LTV3 ~ LTV1, 
                             LTV2 >= LTV1 & LTV2 >= LTV3 ~ LTV2,
                             LTV3 >= LTV1 & LTV3 >= LTV2 ~ LTV3))%>%
  mutate(LTV_BTL = case_when(LTV1 <= LTV2 & LTV1 <= LTV3 ~ LTV1, 
                             LTV2 <= LTV1 & LTV2 <= LTV3 ~ LTV2,
                             LTV3 <= LTV1 & LTV3 <= LTV2 ~ LTV3))%>%
  mutate(LTV_SSB = case_when(LTV1 <= LTV2 & LTV1 >= LTV3 ~ LTV1,
                             LTV1 >= LTV2 & LTV1 <= LTV3 ~ LTV1,
                             LTV2 <= LTV1 & LTV2 >= LTV3 ~ LTV2,
                             LTV2 >= LTV1 & LTV2 <= LTV3 ~ LTV2,
                             LTV3 <= LTV1 & LTV3 >= LTV2 ~ LTV3,
                             LTV3 >= LTV1 & LTV3 <= LTV2 ~ LTV3)) 
BaseFormula             <- lm(vulConsumptionChannel ~ incomePercentile + MPC  + paymentsToIncome  + liqPref  +  bankMaxAge   + LTV_FTB   + LTV_SSB   + LTV_BTL , data = calibration_consChannel_param)

library(jtools)
plot_summs(BaseFormula, scale = TRUE, colors = "Rainbow") 
# effect_plot(BaseFormula, pred = incomePercentile, interval = TRUE, plot.points = TRUE,x.label = "Income percentile", y.label = "Strength of consumption channel")
# export_summs(BaseFormula,  scale = TRUE)

```

## Different Thresholds for Financial Vulnerability

```{r differentAmpudiaPreCalculation, message=FALSE, warning=FALSE,  echo=FALSE, results= FALSE}
# this block creates the data frame for the table, the block following this is printing this.

# WATCH OUT: when changing this you need to change the table headers by hand
calibration_values <- tibble(share_median_income = c(rep.int(0.7, 3), rep.int(0.5, 3), rep.int(0.4, 3)), 
                             months_buffer = c(rep.int(c(1, 8, 24), 3)), 
                             share_vulHH_indebtedHH_Model = NA, share_vulHH_indebtedHH_WAS = NA,
                             medianDSR_vulHH_Model = NA, medianDSR_vulHH_WAS = NA,
                             medianDSR_nonVulHH_Model = NA, medianDSR_nonVulHH_WAS = NA,
                             medianAge_vulHH_Model = NA, medianAge_vulHH_WAS = NA,
                             medianAge_nonVulHH_Model = NA, medianAge_nonVulHH_WAS = NA)

for(i in 1:nrow(calibration_values)){
  
  Wave_5_HH_vul <- Wave_5_HH %>%
    # filter(totalMortgagePayments != 0) %>%
    # filter(totalMortgageDebt!=0)%>%
    mutate(finanicalMargin = NetAnnualRegularIncome/12 - totalMortgagePayments - calibration_values$share_median_income[i] * 2749.667,
           monthsAbleToCover = GrossFinancialWealth/finanicalMargin, # negative value means finanical margin is negative
           vulnerable = case_when(monthsAbleToCover<0 & monthsAbleToCover > - calibration_values$months_buffer[i] & totalMortgagePayments != 0 ~ TRUE, TRUE ~ FALSE),
           DSR = 12*totalMortgagePayments/ GrossAnnualRegularIncome,
           DTI = totalMortgageDebt/GrossAnnualRegularIncome) 
  
  
  # calculate for indebted households
  wave_indebted <- Wave_5_HH_vul%>% 
    filter(totalMortgageDebt!=0)%>%
    filter(totalMortgagePayments != 0) 
  
  calibration_values$share_vulHH_indebtedHH_WAS[i] <- formattable::percent( weighted.mean(wave_indebted$vulnerable, w = wave_indebted$Weight), digits = 1 )
  
  # calculate for vulnerable households
  wave_vul <- Wave_5_HH_vul%>% 
    filter(totalMortgageDebt!=0)%>%
    filter(totalMortgagePayments != 0) %>%
    filter(vulnerable == TRUE)
  
  calibration_values$medianDSR_vulHH_WAS[i] <- formattable::percent( weighted.median(wave_vul$DSR, w = wave_vul$Weight), digits = 1 )
  calibration_values$medianAge_vulHH_WAS[i] <- weighted.median(wave_vul$Age, w = wave_vul$Weight)
  
  # calculate for non-vulnerable, indebted households
  wave_NonVul <- Wave_5_HH_vul%>% 
    filter(totalMortgageDebt!=0)%>%
    filter(totalMortgagePayments != 0) %>%
    filter(vulnerable == FALSE)
  
  calibration_values$medianDSR_nonVulHH_WAS[i] <- formattable::percent( weighted.median(wave_NonVul$DSR, w = wave_NonVul$Weight), digits = 1 )
  calibration_values$medianAge_nonVulHH_WAS[i] <- weighted.median(wave_NonVul$Age, w = wave_NonVul$Weight)
  
  ##### calculate Model fin vul ####  
  
  
  sortingData_vul_HH <-  agent_data_vul_2%>%
    mutate(financialMargin = MonthlyDisposableIncome+492.7 - calibration_values$share_median_income[i]*median(MonthlyGrossTotalIncome, na.rm = TRUE),
           monthsAbleToCover = BankBalance / financialMargin,
           vulnerable = case_when(monthsAbleToCover<0 & monthsAbleToCover > - calibration_values$months_buffer[i] & Debt < 0 ~ TRUE, TRUE ~ FALSE)) %>%
    mutate(DTI = Debt/(-12* MonthlyGrossTotalIncome))%>%
    mutate(DSR = MonthlyMortgagePayments/MonthlyGrossTotalIncome)%>%
    mutate(hasDebt = case_when(Debt<0 ~ TRUE, TRUE ~ FALSE))
  
  model_indebted <- sortingData_vul_HH %>%
    filter(Debt < 0)
  
  DSRs <- sortingData_vul_HH %>%
    filter(Debt < 0) %>%
    group_by(vulnerable) %>%
    summarise(coreIndicator = median(DSR, na.rm = TRUE))
  
  formattable::percent(DSRs$coreIndicator[1])
  
  calibration_values$share_vulHH_indebtedHH_Model[i] <- formattable::percent( mean(model_indebted$vulnerable), digits = 1 )
  calibration_values$medianDSR_vulHH_Model[i] <- formattable::percent(DSRs$coreIndicator[2], digits = 1 )
  calibration_values$medianDSR_nonVulHH_Model[i] <- formattable::percent(DSRs$coreIndicator[1], digits = 1 )
  
  Age_model <- sortingData_vul_HH %>%
    filter(Debt < 0) %>%
    group_by(vulnerable) %>%
    summarise(coreIndicator = median(Age, na.rm = TRUE))
  
  calibration_values$medianAge_vulHH_Model[i] <- round(Age_model$coreIndicator[2], digits = 2 )
  calibration_values$medianAge_nonVulHH_Model[i] <- round(Age_model$coreIndicator[1], digits = 2 )
  
}

# calibration_values



channel_importance_results <- data.frame(parameters = NA, dissaving_channel = NA, purchase_channel = NA, share_vul_HH = NA)

channel_importance_results[1,] <- channel_importance(data = different_Ampudia_vul_2, x = "FinVulReason_calc_0.7_1m")
channel_importance_results[2,] <- channel_importance(data = different_Ampudia_vul_2, x = "FinVulReason_calc_0.7_8m")
channel_importance_results[3,] <- channel_importance(data = different_Ampudia_vul_2, x = "FinVulReason_calc_0.7_24m")
channel_importance_results[4,] <- channel_importance(data = different_Ampudia_vul_2, x = "FinVulReason_calc_0.5_1m")
channel_importance_results[5,] <- channel_importance(data = different_Ampudia_vul_2, x = "FinVulReason_calc_0.5_8m")
channel_importance_results[6,] <- channel_importance(data = different_Ampudia_vul_2, x = "FinVulReason_calc_0.5_24m")
channel_importance_results[7,] <- channel_importance(data = different_Ampudia_vul_2, x = "FinVulReason_calc_0.4_1m")
channel_importance_results[8,] <- channel_importance(data = different_Ampudia_vul_2, x = "FinVulReason_calc_0.4_8m")
channel_importance_results[9,] <- channel_importance(data = different_Ampudia_vul_2, x = "FinVulReason_calc_0.4_24m")


# channel_importance_results

calibration_values_table <- calibration_values%>%
  # select(- share_median_income, - months_buffer)%>%
  add_column(channel_importance_results$dissaving_channel, .before = "share_vulHH_indebtedHH_Model")%>%
  add_column(channel_importance_results$purchase_channel, .before = "share_vulHH_indebtedHH_Model")
  
# row.names(calibration_values_table) <- c(1, 8, 24, 1, 8, 24, 1, 8, 24)
# colnames(calibration_values_table)<- list("share of median income",
#                                          "months of buffer", 
#                                          "consumption channel", 
#                                          "purchasing channel",
#                                          "Model", "WAS",
#                                          "Model", "WAS",
#                                          "Model", "WAS",
#                                          "Model", "WAS",
#                                          "Model", "WAS"
# )

lineBreaks_table<- c("share of\nmedian \nincome", "months of\nbuffer", 
                     "dissaving\nchannel", 
                     "purchasing\nchannel",
                     "Model", "WAS",
                     "Model", "WAS",
                     "Model", "WAS",
                     "Model", "WAS",
                     "Model", "WAS")

calibration_values_table <- as.data.frame(calibration_values_table)
# these are all % values
for (i in 3:10){
 calibration_values_table[,i] <- format(calibration_values_table[,i], digits = 3,nsmall = 0, scientific = FALSE)
}


# these are double/integer values (i.e. AGE)
for (i in 11:14){
  calibration_values_table[,i] <- format(calibration_values_table[,i], digits = 0,nsmall = 0, scientific = FALSE)
}

calibration_values_table <- as.data.frame(calibration_values_table)

calibration_values_table %>%
  mutate_all(linebreak)%>%
  kableExtra::kbl(
    caption = "Different parametrisation of the finanical vulnerability thresholds",
    booktabs = T,
    escape = F,
    align = "c",
    col.names = linebreak(lineBreaks_table, align ="c"))%>%
  kable_styling(latex_options =c("scale_down")) %>%
  column_spec(1:2, bold=T) %>%
   collapse_rows(columns = 1, latex_hline = "major")  %>%

  # Watch out -> here I set the names of the target values
  add_header_above(c(" " = 2, "vulnerability\nchannels" = 2,
                     "% vul HH in\nindebted HH" = 2,
                     "median DSR\nvul HH" = 2,
                     "median DSR\nnon-vul HH" = 2,
                     "median Age\nvul HH" = 2,
                     "medan Age\nnon-vul HH" = 2)) %>%
  footnote(general = "Median Age of non-vulnerable households includes only households with mortgage debt. Model values are calculated from single-run with 300 Periods.",           threeparttable =T)



# share_median_income = c(0.7, 0.7, 0.7, 0.5, 0.5, 0.5,  0.4, 0.4, 0.4), 
#                              months_buffer = c(1, 8, 24, 1, 8, 24, 1, 8, 24), 
#                              share_vulHH_indebtedHH_Model = NA, share_vulHH_indebtedHH_WAS = NA,
#                              medianDSR_vulHH_Model = NA, medianDSR_vulHH_WAS = NA,
#                              medianDSR_nonVulHH_Model = NA, medianDSR_nonVulHH_WAS = NA,
#                              medianAge_vulHH_Model = NA, medianAge_vulHH_WAS = NA,
#                              medianAge_nonVulHH_Model = NA, medianAge_nonVulHH_WAS = NA)



```

This chapter tests the robustness the importance of the dissaving channel to different parametrizations of the definition of financial vulnerability, i.e. changing $\rho$ -- here, the buffer for income shocks -- and the months the households needs to be able to cover the negative financial margin (including the buffer for income shocks). Table \@ref(tab:differentAmpudia) shows nine different parametrizations. $\rho$ is set to 40%, meaning there is no income shock buffer, 50%, the buffer used in the main analysis, and 70%, which resembles 30% of median income as income shock buffer. The months to cover range from one over eight to 24.

Overall, when the importance of the dissaving channel ranges widely from 33% to 89%. The fewer months to cover the higher the importance of the dissaving channel. This could be as households vulnerable by purchase would save up a precautionary buffer above this level. Also, the higher the income buffer, the lower the importance of the dissaving channel.

In terms of the model being able to match the WAS with different parameters for the definition of financial vulnerability -- while all parameters influencing the simulation itself are the same -- the results are remarkably good. Recall, that only the combination of $\rho = 0.5$ with eight months to cover were used as calibration target. For instance, the age of vulnerable households is increasing when $\rho$ is increasing -- in the model and in the WAS. In conclusion, while the importance of the dissaving channel is very sensitive to the number of months a households should be able to cover its expenses (with or without income shock buffer). However, in these reasonable boundaries, the dissaving channel is at least responsible for 33% of financially vulnerable households.

```{r differentAmpudia, message=FALSE, warning=FALSE,  echo=FALSE}
# This block prints the table, which was prepared in the block above

calibration_values_table %>%
  mutate_all(linebreak)%>%
  kableExtra::kbl(
    caption = "Different parametrisation of the finanical vulnerability thresholds",
    booktabs = T,
    escape = F,
    align = "c",
    col.names = linebreak(lineBreaks_table, align ="c"))%>%
  kable_styling(latex_options =c("scale_down")) %>%
  column_spec(1:2, bold=T) %>%
   collapse_rows(columns = 1, latex_hline = "major")  %>%

  # Watch out -> here I set the names of the target values
  add_header_above(c(" " = 2, "vulnerability\nchannels" = 2,
                     "% vul HH in\nindebted HH" = 2,
                     "median DSR\nvul HH" = 2,
                     "median DSR\nnon-vul HH" = 2,
                     "median Age\nvul HH" = 2,
                     "medan Age\nnon-vul HH" = 2)) %>%
  footnote(general = "Median Age of non-vulnerable households includes only households with mortgage debt. Model values are calculated from single-run with 300 Periods.",           threeparttable =T)
```

# Main analysis with simpler definition of financial vulnerability

In this chapter the analysis of chapter \@ref(causes-for-financial-vulnerability) and chapter \@ref(path-dependency-of-financial-vulnerability) is re-done, while using a different definition of financial vulnerability, namely all households that have less than 1500 money units on their accounts to service unexpected expenses. This measure has been popularised @lusardi_financially_2011 and used in an adapted form to research financial vulnerability of Italian [@brunetti_is_2016] and other European households [@brunetti_financial_2020].

The left panel of Figure \@ref(fig:1500MUVulCause) shows the share of households with less than 1500 money units on their bank account over the course of a housing cycle. This share rises to about 25% in the housing market upswing. However, this includes renters and owner-occupiers alike, explaining the majority of households being vulnerable by "other". The right panel shows only owner-occupiers with less than 1500 money units. The effects of purchases and dissaving on financial vulnerability are very similar to the analysis in the main paper. Purchases increase vulnerability when housing market turnover is highest and financial vulnerability by dissaving is highest when there has been a period of high prices.

```{r 1500MUVulCause, fig.cap="Share of households with less than 1500 money units -- by cause of this financial vulnerability over the house price cycle",fig.subcap=c("All households", "Without renters"),  fig.show='hold', message=FALSE, warning=FALSE, out.width='49%', results=FALSE,  echo=FALSE}
sortingData_Vul_cause <- readRDS(file = here::here(paste0("Vul_1500MU_", model_folder_noFTBSM_1,".rds")))

relation_rhs_lhs <- 6
limits_1500withRenters <- c(0,0.26)

sortingData_Vul_cause %>%
  mutate(agent = case_when(
    isBTL==1 & inFirstHome==0 & isFTB==0 ~ "BTL", 
    # isBTL ==0 & inFirstHome == 0 &isFTB==0 ~ "Mover", 
    # isFTB ==1 ~ "FirstTimeBuyer",
    # isBTL==1 &  isFTB==0 ~ "BTL", 
    NHouses>0 & isBTL == 0 & inFirstHome == 0 ~ "SSB",
    inFirstHome==1 ~ "FTB", 
    NHouses==0 ~ "Renter")) %>%
  mutate(hasDebt = case_when(Debt<0 ~ TRUE, TRUE ~ FALSE)) %>%
  filter(Period >= trough_period[troughs_limits[1]], Period <= trough_period[troughs_limits[2]])%>%
  # filter(agent !="Renter") %>%
  # filter(Debt < 0) %>%
  filter(vulnerable_1500MU == TRUE ) %>%
  mutate(FinVulReason_1500MU = factor(FinVulReason_1500MU, levels = c("other", "purchase", "dissaving"))) %>%
  group_by(Period, `Sale HPI.x`, FinVulReason_1500MU) %>%
  tally()  %>%
  ggplot(aes( x = Period,  fill = FinVulReason_1500MU)) +
  geom_col(aes(y= n/10000)) + 
  # geom_line(aes(y = `Sale HPI.x` * 1000), color = "blue") +
  geom_line( aes(y = `Sale HPI.x` / relation_rhs_lhs), size=1, linetype="dashed") +
  scale_y_continuous(
    # Features of the first axis
    name = "Share of vulnerable households",
    labels = scales::percent,
    # Add a second axis and specify its features
    sec.axis = sec_axis(~ . *relation_rhs_lhs, name="House Price Index (---)"),
    expand = expansion(mult = c(0, 0.05)), # make the barplots start at the axis
    limits = limits_1500withRenters
  ) +
  scale_fill_manual(values = color_set_1)+
    scale_x_continuous(expand = expansion(mult = c(0,0)))+
  theme(legend.position = "bottom") +
  theme(legend.background = element_blank()) +  # Remove overall border
  theme(legend.key = element_blank())

# relation_rhs_lhs <- 10

sortingData_Vul_cause %>%
  mutate(agent = case_when(
    isBTL==1 & inFirstHome==0 & isFTB==0 ~ "BTL", 
    # isBTL ==0 & inFirstHome == 0 &isFTB==0 ~ "Mover", 
    # isFTB ==1 ~ "FirstTimeBuyer",
    # isBTL==1 &  isFTB==0 ~ "BTL", 
    NHouses>0 & isBTL == 0 & inFirstHome == 0 ~ "SSB",
    inFirstHome==1 ~ "FTB", 
    NHouses==0 ~ "Renter")) %>%
  mutate(hasDebt = case_when(Debt<0 ~ TRUE, TRUE ~ FALSE)) %>%
  filter(Period >= trough_period[troughs_limits[1]], Period <= trough_period[troughs_limits[2]])%>%
  filter(agent !="Renter") %>%
  # filter(Debt < 0) %>%
  filter(vulnerable_1500MU == TRUE ) %>%
  mutate(FinVulReason_1500MU = factor(FinVulReason_1500MU, levels = c("other", "purchase", "dissaving"))) %>%
  group_by(Period, `Sale HPI.x`, FinVulReason_1500MU) %>%
  tally()  %>%
  ggplot(aes( x = Period,  fill = FinVulReason_1500MU)) +
  geom_col(aes(y= n/10000)) + 
  # geom_line(aes(y = `Sale HPI.x` * 1000), color = "blue") +
  geom_line( aes(y = `Sale HPI.x` / relation_rhs_lhs), size=1, linetype="dashed") +
  scale_y_continuous(
    # Features of the first axis
    name = "Share of vulnerable households",
     labels = scales::percent,
    # Add a second axis and specify its features
    sec.axis = sec_axis(~ . *relation_rhs_lhs, name="House Price Index (---)"),
    expand = expansion(mult = c(0, 0.05)), # make the barplots start at the axis
    , limits = limits_1500withRenters
  ) +
  scale_fill_manual(values = color_set_1)+
    scale_x_continuous(expand = expansion(mult = c(0,0)))+
  theme(legend.position = "bottom") +
  theme(legend.background = element_blank()) +  # Remove overall border
  theme(legend.key = element_blank())
```

Figure \@ref(fig:when1500Buy), similarly, confirms the effects from the main analysis of the paper to hold up when using this different concept of financial vulnerability. Households that bought their home at high prices one or two house price cycles past become vulnerable by dissaving when house prices have been high for a long time -- as shown in the increase of yellow dots in the two red squares in the right panel.

```{r when1500Buy, fig.cap="When did owner-occupiers with less than 1500 money units at house price peak and trough buy?",fig.subcap=c("Owner-occupiers with less than 1500 money units\\newline at trough House price level at last purchase", "Owner-occupiers with less than 1500 money units \\newline at trough House price level at last purchase"),  fig.show='hold', message=FALSE, warning=FALSE, out.width='49%', results=FALSE,  echo=FALSE}
####### "when did they buy" - does it hold up? ####

color_set_1 <- cet_pal(5, name = "r3") # color sets also used for later figure

vul_certain_period_trough <-sortingData_Vul_cause%>%
  mutate(agent = case_when(
    isBTL==1 & inFirstHome==0 & isFTB==0 ~ "BTL", 
    # isBTL ==0 & inFirstHome == 0 &isFTB==0 ~ "Mover", 
    # isFTB ==1 ~ "FirstTimeBuyer",
    # isBTL==1 &  isFTB==0 ~ "BTL", 
    NHouses>0 & isBTL == 0 & inFirstHome == 0 ~ "SSB",
    inFirstHome==1 ~ "FTB", 
    NHouses==0 ~ "Renter")) %>%
  filter(FinVulReason_1500MU != "not vulnerable") %>%
  filter(FinVulReason_1500MU != "other")%>%
  filter(Period == period_to_filter[1])%>%
  # filter(agent=="inFirstHome")%>%
  # left_join(transactions_vul_2, by = c("id" = "buyerId"))%>%
  mutate(principal = transactionPrice-mortgageDownpayment)%>%
  mutate(prePurchaseDeposits = principal+buyerPostPurchaseBankBalance) %>%
  mutate(LTV = principal/transactionPrice)%>%
  mutate(LTI = principal/ (12*buyerMonthlyGrossTotalIncome))%>%
  mutate(howLongAgo = Period - `Model time`) %>%
  filter(transactionType == "sale")%>%
  filter(howLongAgo > 0)%>%
  group_by(id) %>% top_n(-1, howLongAgo) 

vul_certain_period_peak <-sortingData_Vul_cause%>%
  mutate(agent = case_when(
    isBTL==1 & inFirstHome==0 & isFTB==0 ~ "BTL", 
    # isBTL ==0 & inFirstHome == 0 &isFTB==0 ~ "Mover", 
    # isFTB ==1 ~ "FirstTimeBuyer",
    # isBTL==1 &  isFTB==0 ~ "BTL", 
    NHouses>0 & isBTL == 0 & inFirstHome == 0 ~ "SSB",
    inFirstHome==1 ~ "FTB", 
    NHouses==0 ~ "Renter"))%>%
  filter(FinVulReason_1500MU != "not vulnerable")%>%
  filter(FinVulReason_1500MU != "other")%>%
  filter(Period == period_to_filter[2])%>%
  # filter(agent=="inFirstHome")%>%
  # left_join(transactions_vul_2, by = c("id" = "buyerId"))%>%
  mutate(principal = transactionPrice-mortgageDownpayment)%>%
  mutate(prePurchaseDeposits = principal+buyerPostPurchaseBankBalance) %>%
  mutate(LTV = principal/transactionPrice)%>%
  mutate(LTI = principal/ (12*buyerMonthlyGrossTotalIncome))%>%
  mutate(howLongAgo = Period - `Model time`) %>%
  filter(transactionType == "sale")%>%
  filter(howLongAgo > 0)%>%
  group_by(id) %>% top_n(-1, howLongAgo) 

########################### HPI und last sale
HPI1 <- outfile_2 %>%
  select(`Sale HPI`, `Model time`)%>%
  filter(`Model time` <= period_to_filter[1])

colnames(HPI1) <- list("House Price Index", "Period") 

data1 <- vul_certain_period_trough %>%
  filter(agent != "Renter")  # Households selling their homes at the end of the period could be still recorded vulnerable (which happens at the beginning of a period) - very rarely

(ggplot(data = HPI1, aes(y = `House Price Index`, x = Period) )+
    geom_line( size=0.5, linetype="dashed", color = "black")+ 
    geom_point(data = data1, aes(x = `Model time`,y= `Sale HPI.y`, color = FinVulReason_1500MU), position = position_jitter(width = 0.025, height = 0.025))+
    xlab(paste0("In what period did the household - vulnerable\nin period ", period_to_filter[1], " - buy their last property?"))+
    ylab(paste0("At what house price index did the household - vulnerable\nin period ", period_to_filter[1], " - buy their last property?")) +
    theme(legend.position = "bottom") +
    ylim(c(0.10, 1.5)) +
    xlim(c(period_to_filter[1] - HowLongBackPathDependency, period_to_filter[2])) + 
    geom_vline(
      xintercept = period_to_filter[1], linetype = 2, size = 1, color = "darkblue" 
    )+
    scale_color_manual(values = color_set_1[c(3,2)])+
    annotate("text", x = 2400, y = 0.8, label = "all house-\nholds \ndepicted\nare\nvulnerable\nin this\nperiod", color = "darkblue")) 


########################### HPI und last sale
HPI2 <- outfile_2 %>%
  select(`Sale HPI`, `Model time`)%>%
  filter(`Model time` <= period_to_filter[2])

colnames(HPI2) <- list("House Price Index", "Period") 

data2 <- vul_certain_period_peak %>%
  filter(agent != "Renter")  # Households selling their homes at the end of the period could be still recorded vulnerable (which happens at the beginning of a period) - very rarely


(ggplot(data = HPI2, aes(y = `House Price Index`, x = Period) )+
    geom_line( size=0.5, linetype="dashed", color = "black")+ 
    geom_point(data = data2, aes(x = `Model time`,y= `Sale HPI.y`, color = FinVulReason_1500MU), position = position_jitter(width = 0.025, height = 0.025))+
    xlab(paste0("In what period did the household - vulnerable\nin period ", period_to_filter[2], " - buy their last property?"))+
    ylab(paste0("At what house price index did the household - vulnerable\nin period ", period_to_filter[2], " - buy their last property?")) +
    theme(legend.position = "bottom") +
    ylim(c(0.10, 1.5)) +
    xlim(c(period_to_filter[1] - HowLongBackPathDependency, period_to_filter[2])) + 
    geom_vline(
      xintercept = period_to_filter[2], linetype =2, size = 1, color = "darkblue"
    )+
    scale_color_manual(values = color_set_1[c(3,2)]) +
    annotate("rect", xmin = 2212, xmax = 2252, ymin = 1, ymax = 1.4, alpha = 0, color = "red") +
    annotate("rect", xmin = 2305, xmax = 2345, ymin = 1, ymax = 1.4, alpha = 0, color = "red") +
    annotate("text", x = 2280, y = 1.2, label = "newly\nvulnerable\nwith high\nprices", color = "red")+
    annotate("text", x = 2420, y = 0.8, label = "all house-\nholds \ndepicted\nare\nvulnerable\nin this\nperiod", color = "darkblue")
)

```

In conclusion, the effect of a precautionary or collateral channel on the financial buffers of households is significant and drives up financial vulnerability in periods of high prices. Moreover, the strong path dependency of financial vulnerability holds up with this simpler definition of financial vulnerability.

\FloatBarrier

# Additional Figures

```{r, turnover, echo = FALSE, warning=FALSE,message=FALSE, results= FALSE, fig.align='center', fig.dim = c(6, 4), fig.cap = "Housing market turnover (percentages of all houses transacted per months) - 12 months rolling averages", out.width='49%'}

outfile_1_tmp <- outfile_1 %>%
  select("Sale nSales")

outfile_1_tmp <- as.matrix(outfile_1_tmp)/outfile_1$HousingStock
outfile_1_tmp <- as.data.frame(runmean(outfile_1_tmp, rolling_averages)) # build a rolling average (6 for 6 months)

outfile_1_tmp <- outfile_1_tmp %>%
  bind_cols(outfile_1$`Model time`, outfile_1$`Sale HPI`)
colnames(outfile_1_tmp) <- list("housing market turnover", "Period","HousePriceIndex")


# parameters for figure
relation_rhs_lhs <- 40
color_set_1 <- cet_pal(5, name = "r3") # color sets also used for later figure

outfile_1_tmp %>%
  filter(Period >= trough_period[troughs_limits[1]], Period <= trough_period[troughs_limits[2]])%>%
  ggplot(aes(x=Period))+
  geom_line( aes(y = `housing market turnover`), color = "darkred", size = 1.5)+
  geom_line( aes(y = HousePriceIndex / relation_rhs_lhs), size=1, linetype="dashed") +
  scale_y_continuous(
    # Features of the first axis
    name = "turnover (monthly sales to total housing stock)",
    labels = scales::percent,
    # Add a second axis and specify its features
    sec.axis = sec_axis(~ . *relation_rhs_lhs, name="House Price Index"),
    expand = expansion(mult = c(0, 0.05)) # make the barplots start at the axis
  ) +
  scale_x_continuous(expand = expansion(mult = c(0,0)))+
  # theme_classic()+
  theme(legend.position = c(.85, .85)) +
  theme(legend.background = element_blank()) +  # Remove overall border
  theme(legend.key = element_blank()) +
  scale_fill_manual(values = color_set_1)
# labs(caption = "Notes: Your long reference footnote goes in here. UNd Ã¼brigensBesonders krass\n dass das so ist")
# scale_fill_viridis_d()

```

```{r, crossCorrelation1, echo = FALSE, warning=FALSE,message=FALSE, results= FALSE, eval=FALSE, fig.cap = "Cross-Correlation of Financially Vulnerable Households and the House Price Index",  out.width='33%', fig.subcap=c("Overall Vulnerability", "Vulnerable by Dissaving", "Vulnerable by Purchase"), fig.show='hold'}
# outfile_1 <- read_outfile_1_total(wd_model = "Results", model_folder_name = model_folder_1, nRuns = nRuns) +
ccf(outfile_1$`nVulHH (X*medIncome Y*m)`, outfile_1$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "")
ccf(outfile_1$`nowVul Dissaving`, outfile_1$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "")
ccf(outfile_1$`nowVul Purchase`, outfile_1$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "")

# 
# ccf(outfile_1$`nowVul Purchase SSB`, outfile_1$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "purchase SSB")
# ccf(outfile_1$`nowVul Purchase FTB`, outfile_1$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "purchase FTB")
# ccf(outfile_1$`nowVul Purchase BTL`, outfile_1$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "purchase BTL")
# ccf(outfile_1$`nowVul Dissaving SSB`, outfile_1$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "Dissaving SSB")
# ccf(outfile_1$`nowVul Dissaving FTB`, outfile_1$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "Dissaving FTB")
# ccf(outfile_1$`nowVul Dissaving BTL`, outfile_1$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "Dissaving BTL")


#ccf(outfile_1$`vulnerable by dissaving`, outfile_1$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "")
#ccf(outfile_1$`vulnerable by purchase`, outfile_1$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "")

# ccf(outfile_1$`Vulnerable By Consumption BTL`, outfile_1$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "")
# ccf(outfile_1$`Vulnerable By Consumption SSB`, outfile_1$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "")
# ccf(outfile_1$`Vulnerable By Consumption InFirstHome`, outfile_1$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "")

```

```{r, crossCorrelation2, echo = FALSE, warning=FALSE,message=FALSE, results= FALSE, fig.cap = "Cross-Correlation of Financially Vulnerable Households and the House Price Index",  out.width='33%', fig.subcap=c("Overall Vulnerability", "Vulnerable by Dissaving", "Vulnerable by Purchase"), fig.show='hold'}
# outfile_2 <- read_outfile_2_total(wd_model = "Results", model_folder_name = model_folder_2, nRuns = nRuns) +
ccf(outfile_2$`nVulHH (X*medIncome Y*m)`, outfile_2$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "")
ccf(outfile_2$`nowVul Dissaving`, outfile_2$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "")
ccf(outfile_2$`nowVul Purchase`, outfile_2$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "")

# 
# ccf(outfile_2$`nowVul Purchase SSB`, outfile_2$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "purchase SSB")
# ccf(outfile_2$`nowVul Purchase FTB`, outfile_2$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "purchase FTB")
# ccf(outfile_2$`nowVul Purchase BTL`, outfile_2$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "purchase BTL")
# ccf(outfile_2$`nowVul Dissaving SSB`, outfile_2$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "Dissaving SSB")
# ccf(outfile_2$`nowVul Dissaving FTB`, outfile_2$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "Dissaving FTB")
# ccf(outfile_2$`nowVul Dissaving BTL`, outfile_2$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "Dissaving BTL")


#ccf(outfile_2$`vulnerable by dissaving`, outfile_2$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "")
#ccf(outfile_2$`vulnerable by purchase`, outfile_2$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "")

# ccf(outfile_2$`Vulnerable By Consumption BTL`, outfile_2$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "")
# ccf(outfile_2$`Vulnerable By Consumption SSB`, outfile_2$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "")
# ccf(outfile_2$`Vulnerable By Consumption InFirstHome`, outfile_2$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "")

```

```{r vulSince, fig.cap="When did households, vulnerable at house price peak and trough buy and for how long have they been vulnerable?",fig.subcap=c("vulnerable at trough - period 2200", "vulnerable at peak - period 2230"),  fig.show='hold', message=FALSE, warning=FALSE, out.width='49%', results=FALSE,  echo=FALSE}

color_set_1 <- cet_pal(5, name = "r3") # color sets also used for later figure
vul_certain_period <-agent_data_vul_2%>%
  mutate(agent = case_when(
    isBTL==1 & inFirstHome==0 & isFTB==0 ~ "BTL", 
    # isBTL ==0 & inFirstHome == 0 &isFTB==0 ~ "Mover", 
    # isFTB ==1 ~ "FirstTimeBuyer",
    # isBTL==1 &  isFTB==0 ~ "BTL", 
    NHouses>0 & isBTL == 0 & inFirstHome == 0 ~ "SSB",
    inFirstHome==1 ~ "FTB", 
    NHouses==0 ~ "Renter"))%>%
  filter(FinVulReason != "not vulnerable")%>%
  filter(FinVulReason != "other")%>%
  filter(Period == period_to_filter[1])%>%
  # filter(agent=="inFirstHome")%>%
  left_join(transactions_vul_2, by = c("id" = "buyerId"))%>%
  mutate(principal = transactionPrice-mortgageDownpayment)%>%
  mutate(LTV = principal/transactionPrice)%>%
  mutate(LTI = principal/ (12*buyerMonthlyGrossTotalIncome))%>%
  mutate(howLongAgo = Period - `Model time`) %>%
  filter(transactionType == "sale")%>%
  filter(howLongAgo > 0)%>%
  group_by(id) %>% top_n(-1, howLongAgo) 

########################### HPI und last sale
vul_certain_period%>%
  filter(FinVulReason != "other") %>%
  ggplot(aes(x = `Model time`,y= `Sale HPI.y`, color = FinVulReason, size = FinVulSince))+
  geom_point(position = position_jitter(width = .05, height = .05), shape = 21)+
  scale_size_area(max_size = 5)+
  scale_color_manual(values = color_set_1[c(3,2)])+
  xlab("In what period did the now vulnerable household buy their last property?")+
  ylab("House Price Index at last Purchase")# +
  # ggtitle(paste0("When did households, vulnerable in period ",period_to_filter[1]," become vulnerable?"))
  # 

vul_certain_period <-agent_data_vul_2%>%
  mutate(agent = case_when(
    isBTL==1 & inFirstHome==0 & isFTB==0 ~ "BTL", 
    # isBTL ==0 & inFirstHome == 0 &isFTB==0 ~ "Mover", 
    # isFTB ==1 ~ "FirstTimeBuyer",
    # isBTL==1 &  isFTB==0 ~ "BTL", 
    NHouses>0 & isBTL == 0 & inFirstHome == 0 ~ "SSB",
    inFirstHome==1 ~ "FTB", 
    NHouses==0 ~ "Renter"))%>%
  filter(FinVulReason != "not vulnerable")%>%
  filter(FinVulReason != "other")%>%
  filter(Period == period_to_filter[2])%>%
  # filter(agent=="inFirstHome")%>%
  left_join(transactions_vul_2, by = c("id" = "buyerId"))%>%
  mutate(principal = transactionPrice-mortgageDownpayment)%>%
  mutate(LTV = principal/transactionPrice)%>%
  mutate(LTI = principal/ (12*buyerMonthlyGrossTotalIncome))%>%
  mutate(howLongAgo = Period - `Model time`) %>%
  filter(transactionType == "sale")%>%
  filter(howLongAgo > 0)%>%
  group_by(id) %>% top_n(-1, howLongAgo) 

########################### HPI und last sale
vul_certain_period%>%
  filter(FinVulReason != "other") %>%
  ggplot(aes(x = `Model time`,y= `Sale HPI.y`, color = FinVulReason, size = FinVulSince))+
  geom_point(position = position_jitter(width = .05, height = .05), shape = 21)+
  scale_size_area(max_size = 5)+
  scale_color_manual(values = color_set_1[c(3,2)])+
  xlab("In what period did the now vulnerable household buy their last property?")+
  ylab("House Price Index at last Purchase") #+
  # ggtitle(paste0("When did households, vulnerable in period ",period_to_filter[2]," become vulnerable?"))


```

```{r, ScatterIncomePercentile, fig.cap="Scatterplot of the effect of the parameter Income Percentile on the strength of the dissaving channel", fig.show='hold', message=FALSE, warning=FALSE, out.width='66%', results=FALSE,  echo=FALSE, eval=FALSE}


effect_plot(BaseFormula, pred = incomePercentile, interval = TRUE, plot.points = TRUE,x.label = "Income percentile", y.label = "Strength of dissaving channel")

```

\FloatBarrier

# References {.unnumbered}

<!-- `r if (knitr:::is_html_output()) ' # References {-} '` -->
