---
title: "The Determinants of Homeowners' Financial Vulnerability over the House Price Cylce: an Agent-Based Analysis with a Housing Wealth Effect"
author: "Ruben Tarne"
date: "`r Sys.Date()`"
documentclass: article
linkcolor: blue
linestretch: 1.5
geometry:
- left=40mm
- right=40mm
header-includes: 
- \usepackage{amsmath, amsfonts, longtable, tabulary, calc, subfig, booktabs, array, caption}
- \usepackage{floatrow, multirow, wrapfig, float, colortbl, pdflscape, tabu, threeparttable}
- \usepackage{threeparttablex, setspace}
- \usepackage[normalem]{ulem}
- \usepackage{makecell}
- \usepackage{xcolor}
- \usepackage{placeins}
- \floatsetup[figure]{capposition=top}
- \floatsetup[table]{capposition=top}
- \renewcommand{\textfraction}{0.05}
- \renewcommand{\topfraction}{0.8}
- \renewcommand{\bottomfraction}{0.8}
- \renewcommand{\floatpagefraction}{0.75}
output:
  bookdown::pdf_document2:
    keep_tex: true
    latex_engine: xelatex
    toc: false
  html_notebook: default
  html_document:
    df_print: paged
  pdf_document: default
  bookdown::html_document2: default
  word_document: default
  bookdown: bookdown::gitbook
  bookdown::word_document2:
    toc: true
abstract: "This paper investigates the dynamics of financial vulnerability of indebted homeowners over the housing cycle with an agent-based housing market model. The model is calibrated using UK micro data. Two different channels by which mortgage debt holders can become financially vulnerable are of interest: that of purchasing property or that of depleting their financial buffers due to consumption. Interestingly, this latter 'dissaving channel' seems to be at least as important for the dynamics of financial vulnerability as the direct effect of purchases. The dissaving here is mainly driven by a housing wealth effect, which is sensitive to collateral values. This finding suggests that the housing wealth effect should be included in the analysis of the dynamics of financial vulnerability, such as in now-casts or forecasts of financial vulnerability based on household micro data. Moreover, the model produces strong path dependencies of financial vulnerability, in particular property purchases at earlier house price peaks significantly influence current financial vulnerability. This result suggests that high property prices alone, even in the absence of new property purchases, could increase financial vulnerability by leading to dissaving and thus the depletion of financial buffers. Especially if housing prices have reached very high levels in the past."
bibliography: "library-zotero.bib"
biblio-style: "apalike"
link-citations: true
indent: true
---

\pagenumbering{gobble}

\newpage

\pagenumbering{arabic}

```{r, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
# This code runs the housing market model with the pre-specified parameter values - however, for micro-data analysis pre-calculations have to be done for building the data frames necessary 
# shell(paste("mvn exec:java", shQuote("-Dexec.args=-configFile src/config-files/test/agent_Data_0.155_0.888_0.98.properties -outputFolder Results/test_agent_Data_0.155_0.888_0.98 -dev")))
# shell(paste("mvn exec:java", shQuote("-Dexec.args=-configFile src/config-files/test/agent_Data_1.0_egal_0.961_noFTBSM.properties -outputFolder Results/test_agent_Data_1.0_egal_0.961_noFTBSM -dev")))

library(here)
library(bookdown)
library(knitr)
library(kableExtra) # needs to be called here to install the necessary latex packages, see: https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_pdf.pdf
here::i_am("wealth-effect/Working paper drafts/Working-Paper-vulnerability-3rd-Draft.Rmd")
source(here::here("R code files\\R functions WP vulnerabilities.R"))
set.seed(1)
# set the model and folder names for the baseline version 
model_name_1 <- "Monte10_0.069_0.641_0.496_2.08_70_0.985_0.753_0.916_Var4_40vul" # use here either the string of param values or the Monte10 version without the "test_"
model_folder_1 <- paste0("test_", model_name_1) #agent_Data_0.155_0.888_0.98 test_Monte10_0.222_0.556_0.657_4_0.988_0.969_0.7 # the folder is named differently than the model, by adding test_ before
# model_folder_noFTBSM_1 <- "test_Agent_data_0.232_0.737_0.517_3.955_66_0.984_0.857_0.967_Var4_40vul"  # test_agent_Data_0.155_0.888_0.98_noFTBSM

# set the model and folder names for the "less-at-risk" model version
model_name_2 <- "Monte10_0.069_0.641_0.496_2.08_70_0.985_0.753_0.916_Var4_60vul" # use here either the string of param values or the Monte10 version without the "test_"
model_folder_2 <- paste0("test_", model_name_2) #agent_Data_0.155_0.888_0.98 test_Monte10_0.222_0.556_0.657_4_0.988_0.969_0.7 # the folder is named differently than the model, by adding test_ before
model_folder_noFTBSM_2 <- "test_Agent_data_0.069_0.641_0.496_2.08_70_0.985_0.753_0.916_Var4_60vul"  # test_agent_Data_0.155_0.888_0.98_noFTBSM "test_Agent_data_0.232_0.737_0.517_3.955_66_0.984_0.857_0.967_Var4_60vul"

troughs_limits <- c(9,10) # this gives the index of the troughs spanning all figures with a housing cycle. c(2,3) would mean "paint from trough 2 to trough 3"
rolling_averages <- 6
vul_rho_1 <- 0.4 # BLC calculation for financial vulnerabitlity threshold 
vul_rho_2 <- 0.6
monthsToCover <- 8


```

```{r message=FALSE, warning=FALSE, cache=FALSE, readData, echo=FALSE, results='hide'}
outfile_1 <- read_csv(here::here(paste0("wealth-effect/Results/", model_folder_1, "/Output-run1.csv")))
outfile_2 <- read_csv(here::here(paste0("wealth-effect/Results/", model_folder_2, "/Output-run1.csv")))
properties_file <- read.properties(here::here(paste0("wealth-effect/Results/", model_folder_1, "/", model_name_1, ".properties")))
nMCRuns <- as.numeric(properties_file$N_SIMS) # read here number of monte carlo simulations
nPeriods <- as.numeric(properties_file$N_STEPS) - as.numeric(properties_file$TIME_TO_START_RECORDING)
outfile_MC10 <- read_outfile_total(wd_model = "wealth-effect/Results", model_folder_name = model_folder_2, nRuns = nMCRuns)

was_wave_5_hhold_eul_final <- read_sav("~/UK-WEA-survey/UKDA-7215-spss/spss/spss24/was_wave_5_hhold_eul_final.sav")

# agent_data_vul_1 <-         readRDS(file = here::here(paste0("Agent_data_", model_folder_noFTBSM_1, ".rds")))
# transactions_vul_1 <-       readRDS(file = here::here(paste0("transactions_", model_folder_noFTBSM_1,".rds")))

# different_Ampudia_vul_1 <-  readRDS(file = here::here(paste0("different_Ampudia_", model_folder_noFTBSM_1,".rds")))

agent_data_vul_2 <-         readRDS(file = here::here(paste0("Agent_data_", model_folder_noFTBSM_2, ".rds")))
transactions_vul_2 <-       readRDS(file = here::here(paste0("transactions_", model_folder_noFTBSM_2,".rds")))
different_Ampudia_vul_2 <-  readRDS(file = here::here(paste0("different_Ampudia_", model_folder_noFTBSM_2,".rds")))

# load(here::here(file = paste0(model_folder_noFTBSM_1, ".RData"))) # this includes sortingData_data_vul_FTBS and transactions_hpi
# # load(here::here(file = paste0(model_folder_noFTBSM_1,"_diffAmpudia.RData"))) # this is for testing the dissaving channel strength with different Ampudia measures
# load(here::here(file = paste0("test_Agent_data_0.23_0.515_0.457_2.195_71_0.923_0.833_0.977_povLine40Percent_40vul","_diffAmpudia.RData")))


```

# Introduction

<!--# Teaser: Was ist das Problem? -->

The Great Financial Crisis of 2007/08 exemlified the dangers that households' balance sheets can pose to the stability of the macroeconomy. The rapid build-up of mortgage debt prior to the crisis increased the households' vulnerability to economic shocks. When the crisis hit and households were faced with falling house prices and rising unemployment, many of them cut back on their consumption or even defaulted on their mortgage loan payments, destabilising lenders' balance sheets and slowing the economic recovery. In order for policymakers to prevent these negative consequences, they need to understand the causes of financial vulnerability. This paper furthers this understanding using a housing market model that allows to investigate housing market and mortgage dynamics and their effects on the individual households' balance sheets. This focus on the housing market is motivated by the fact that housing makes up the largest asset class and mortgages make up the majority of households' debt.

<!--# 2 channels und was unterscheidet meine analyse von anderen?-->

Two channels affecting financial vulnerability are of interest here. Portfolio reshuffling towards and away from housing impact households' liquidity and their monthly debt services, consumption decisions impact households' liquidity. Portfolio reshuffling can make households vulnerable even though they hold considerable housing wealth but lack a liquid financial buffer. These households are sometimes called wealthy hand-to-mouth households [@KaplanEtAl2014]. The other channel affecting financial vulnerability is effect of housing wealth effects on consumption. For example, whether these effects can lead to homeowners becoming more financially vulnerable in a house price upswing as they consume their financial buffers. Typically, the effect of housing wealth on consumption is viewed through the lens of its impact on aggregate demand and not on creating financial vulnerability itself. In the literature concerned with aggregate demand the housing wealth effect can partly explain the empirically observed fact that house price collapses preceded by sharp increases [@IMF2012; @JordaEtAl2016; @BezemerZhang2019] and/or high levels [@BunnRostom2015; @Baker2018] of mortgage debt are usually followed by longer and more severe recessions. Highly indebted and low-income homeowners in particular---who are usually financially vulnerable---are more likely to cut back on consumption in the face of falling house prices [@MianEtAl2013].

<!--#  Zusammenfassung Methode -->

To analyse the effects of the housing market and consumption decisions on homeowners' financial vulnerability, an agent-based model is employed. The model is able reflect a high degree of heterogeneity and to simulate individual market interactions. These include interactions between households buying and selling property and between households and a commercial bank where the bank applies LTV limits to mortgage loan applications. The high degree of heterogeneity allows for the replication of the uneven distribution of financial assets, housing wealth, mortgage debt and income found in UK household microdata. This matching is crucial for the representation of the wealth effect and financial vulnerability, as both depend on the balance sheet and income of the respective household. In addition, the distribution of financial wealth and income influences which households can afford to shift their portfolio towards real estate assets if they so choose. In the model, market interactions give rise to a house price cycle in which turnover and market clearing fluctuate significantly, influencing the emergence of financially vulnerable households.

<!--#  ZusammenfassungErgebnisse-->

I find that by taking out mortgage loans, some of the lower-income households become vulnerable to shocks to their income, due to their negative financial margin[^1] and the depletion of their liquid savings---their financial buffer---for the downpayment. These households entering the ownership market explain a substantial part of the financial vulnerability dynamics over the house price cycle. Interestingly, however, the consumption decisions of homeowners are at least as relevant. Specifically, in the framework of the model, the effect of housing wealth leads to steadily increasing (decreasing) financial vulnerability during house price peaks (troughs). This dynamic is in line with the findings of @BartscherEtAl2020 for long-term US household data. In the model, the share of financially vulnerable households would only be half as large without the consumption channel. <!--# @TODO income risk is not looked at here. Household behaviour does not feed back into income (which could be the case, when aggregate consumption influences household income. There could be an alleviating effect of higher consumption -> higher income -> lower vulnerability, however, the higher consumption is only performed by a subset of the population, making it unlikely that higher income would offset all of the vulnerability-increasing effect.-->

[^1]: The financial margin is defined as net income, less mortgage payments and some essential consumption. See also Equation \@ref(eq:FM) in Section \@ref(calibration).

<!--# weiteres Result - path dependendcy -->

Another finding is that previous house price booms are identified to influence the financial vulnerability in the current cycle to a large extent. Households that bought a home in a previous house price peak may become financially vulnerable only much later, in a house price peak, due to the consumption of their financial buffer. From a policy perspective, this result implies that periods of high house prices themselves could increase financial vulnerability---even in the complete absence of new households going into debt to buy property. It follows that either an intervention in individual consumption choices, i.e. limiting the depletion of buffer stocks when house prices are high, for instance by limiting the possibility to withdraw housing equity, or a dampening of house boom phases could limit this effect.

<!--#  Zusammenfassung Contribution -->

This paper contributes to the existing literature by examining in depth the impact of consumption, which is sensitive to collateral values, on overall household financial vulnerability. This channel has hardly been studied so far. Moreover, the paper contributes by expanding the agent-based housing market model by @TarneEtAl2021 to include a precautionary channel which is sensitive to net property values and calibrate the newly implemented parameters to match key stylized facts about the UK housing market and the characteristics of financially vulnerable households.

<!--#  The remainder of the paper is structured as follows. In section @ref(related-literature) the related literature is presented. section @ref(the-model) introduces the model while focusing on the differences to the model in @TarneEtAl2021. section @ref(calibration) presents the calibration of the model and introduces the concept of financial vulnerability employed here. section @ref(results) introduces the different channels by which households become financially vulnerable in the model and shows their dynamics and relative importance over the housing cycle. section @ref(characteristics-of-financially-vulnerable-households) compares the characteristics of households financially vulnerable and non-vulnerable and section @ref(path-dependency-of-financial-vulnerability) explores the path dependency of financial vulnerability. Finally, section @ref(conclusion) concludes.-->

# Related Literature

<!--# Wealth effect and financial vulnerability -->

<!--# wealth effect: collateral channel and precautionary saving -->

This paper connects to the literature of estimating and understanding the drivers of households' financial vulnerability as well as the wider literature on housing wealth effects. Housing wealth can influence household consumption via an endowment effect or via a collateral channel. Rising house prices can make homeowners feel richer, potentially leading them to increase their consumption. As housing can be used as collateral for credit, changes in house prices can influence homeowners' access to credit. Changes in credit access, however, should only affect the real consumption of households that are at their borrowing limit. When house prices rise, these households can finance their higher consumption by withdrawing equity. Moreover, if households have a precautionary savings motive [@CarrollKimball1996], their consumption may be sensitive to changes in the value of their properties, just by being close to, but not necessarily directly at, their borrowing limit [@Aladangady2017]. For example, households that are close to their borrowing limit and see the value of their collateral falling may seek to increase their financial assets to compensate for the reduced ability to access equity in an emergency.

<!--# House Prices -> Consumption  -->

These wealth effects can be strong. For instance, @MianEtAl2013 find a collateral channel to be essential in explaining the drop in aggregate consumption in the US after the financial crisis of 2007/08. This finding has been supported utilising alternative data sources by @KaplanEtAl2020. @CloyneEtAl2019 show that a collateral channel is important in explaining aggregate consumption fluctuations in the UK between 2005-15. @Aladangady2017 finds that the overall housing wealth effect of 4.7% in the US to be exclusively driven by households above the median debt-service-to income ratio (DSR). Specifically, the housing wealth effect of these constrained households is estimated to be 12.7%, versus 0% for households below the average DSR. Similarly, @Zhang2019 finds a housing wealth effect for Dutch households above the median debt-to-income ratio (DTI) of 10.3% versus 4.1% for households below the median DTI. @GuerrieriLorenzoni2017 find that a precautionary channel can explain the recent economic recession followed by an environment of low interest rates.

<!--# Consumption -> financial vulnerability -->

Most studies concerned with financial vulnerability are concerned with the effects of financial vulnerability on households' consumption. How consumption influences financial vulnerability remains rather unexplored. @BartscherEtAl2020 estimate the impact of an income shock to all households on their financial vulnerability (debt-service-to-income ratio \> 40%) for the US from 1950 to 2016 based on household micro data. They find that the growth of debt through equity withdrawal played a crucial role in significantly increasing household financial vulnerability over time, especially among the middle class.

Other studies touch this relationship less directly. For instance, @BrunettiEtAl2016 estimate household financial vulnerability based on the Italian household micro data between 1998 and 2012. They categorize households as vulnerable when they are not able to cover 1,500 â‚¬ of unexpected expenses. This measure does therefore not necessarily aim to capture over-indebted households but households with poor portfolio allocation. They find that portfolios tend to become too illiquid in housing market boom phases, which might be explained by a wealth effect. @BrunettiEtAl2020 expand the analysis of financially vulnerable households by @BrunettiEtAl2016 to several European countries and the US. They, too, find that increases in the illiquidity of a household's portfolio due to a higher share of housing wealth in their total wealth strongly increases the household's chance of becoming financially vulnerable. Specifically, a one percentage point increase in the share of the household's housing wealth in total wealth increases its chances of being financially vulnerable by 13 percentage points. Theoretically, this illiquidity could also be driven by a wealth effect.

@KaplanEtAl2020 calculate the share of wealthy households living hand-to-mouth, i.e. households that spend all their disposable resources each pay period and have significant amounts of illiquid but not liquid assets, based on micro-household data for various countries (US 1989-2010, UK 2008-10, Germany 2008-10 and others). They find that about 20% of households in the US and 22% of households in the UK qualify as wealthy households living hand-to-mouth. Again, this high proportion could be partly explained by a wealth effect.

<!--# now-casting -->

Another strand of literature related to the present analysis deals with the estimation of current and future household financial vulnerability based on household microdata. Since household surveys are usually conducted only infrequently and over long periods of time, these data must first be "nowcasted". This can be done either in a relatively static way by projecting the developments in the national accounts onto the individual households in the micro data, or by explicitly modelling the behaviour of households. Either way, the nowcasted data can then be subjected to a series of stress tests, e.g. interest rate rises or increases in unemployment, and their impact on financial vulnerability is estimated.[^2]

[^2]: See for a brief literature overview @BankowskaEtAl2017

As the analysis here is concerned with household behaviour contributing to financial vulnerability, it might inform the subset of the literature that explicitly models household behaviour. @AmpudiaEtAl2016 use the European Household Finance and Consumption Survey (HFCS) [@EuropeanCentralBank2020] to implement a simulation of the consumption response of households to the changes in aggregate wealth (differentiated by asset class) while using heterogeneous marginal propensities to consume (MPC), dependent on the households' income, following @MianEtAl2013. They find that all income groups contribute, in real terms, equally to the observed slump in aggregate consumption, as high-income households experienced larger nominal losses in wealth than lower-income households but have lower MPCs. However, the authors only focus on the effect the loss in wealth had on aggregate consumption while not considering the effect this consumption may had on the financial vulnerability of households by lowering the households' financial buffers.

@PetersonRoberts2016 work with household micro data from the Canadian Financial monitor to build a dynamic model connecting micro-household data with macro data. It is used to simulate future financial vulnerability under a given macroeconomic scenario. Households have simple behavioural rules and their balance sheets change over time. However, the authors do not consider a consumption response to changes in wealth.

# The Model

The model used here follows @TarneEtAl2021,[^3] which itself is an adaptation of @BaptistaEtAl2016. These models have been calibrated with the help of UK data, like the Wealth and Asset Survey and the housing market data by the online sale platform Zoopla. The model has also been applied to the Danish [@Cokayne2019] and the Italian housing market [@CatapanoEtAl2021]. Only a very brief introduction to the model is given here where the focus is put on the differences between this model version and the version in @TarneEtAl2021, mainly consisting of a more elaborated wealth effect in the households' consumption function (section \@ref(households-consumption)).

[^3]: A list with all equations from @TarneEtAl2021 can be found here: [\<https://github.com/RubenTarne/wealth-effect/blob/Tarne-BezemerTheobald/Equations%20-%20WP%20-%20Tarne%20Bezemer%20Theobald.pdf\>](https://github.com/RubenTarne/wealth-effect/blob/Tarne-BezemerTheobald/Equations%20-%20WP%20-%20Tarne%20Bezemer%20Theobald.pdf){.uri}.

## Overview

The model by @TarneEtAl2021 is an agent-based housing market model, calibrated using UK data. The model consists of heterogeneous households and a commercial bank. With young households entering and old households exiting the simulation, the demographic distribution is held stable to the UK distribution of 2011. Housing consists as a fixed stock where individual houses are characterized by a quality parameter serving as a proxy for their condition, size and location. Households can be renters in private housing or owner-occupiers, consisting of first-time-buyers (FTB), second-and-subsequent buyers (SSB), and buy-to-let investors (BTL). Investors purchase property that they rent out. Households that are in neither of these regimes build a residual called 'social housing.'

Generally, households can change between these regimes, depending on their interactions on the housing and rental market. These interactions happen in discrete time (monthly steps) where households in the residual of social housing decide if renting privately or buying a home is relatively cheaper for them. When they decide to enter the ownership market their bid price is a function of their income, financial wealth and the mortgage credit the commercial bank is willing to lend. When households ask the commercial bank for a mortgage loan, the bank applies an internal loan-to-value limit, depending on the regime of the household (FTB, SSB, BTL). BTL investors decide according to the projected yield of the property, considering current rental prices, house price expectations and mortgage costs. The supply-side of the housing market is occupied by buy-to-let investors and owner occupiers. Owner occupiers move on average every seventeen years, according to UK data.[^4] The investors' decision to sell property is determined by its expected yield. The asking price by both household types is based on currently observed sale prices of houses of the same quality parameter.

[^4]: The reason for moving can be due to employment, divorce, etc. which the model does not cover.

All bids and offers are matched in a double auction. In a first round, each bid is matched with the offered house of the highest quality which it still can afford. If more than one bid is matched with an offer, there is a chance for the offer price to increase before being matched with a random bid (that still qualifies). In a second round, the mechanism of the first round is repeated with all bids and offers that have not been matched yet. Once no offers and bids can be matched anymore the auctioning process stops.

Households whose bids and offers have not been cleared decide the following month how to proceed: home-buyers re-calculate the costs of buying versus renting and might decide to enter the rental market in the following month instead. Buy-to-let investors re-calculate the prospective yield, and might decide against investing. Movers keep their house on the market but might decide to lower the offer price, buy-to-let investors with property for sale might decide to take the property off the market if the investment gain for their property becomes favourable again.

The housing market generates boom-bust cycles with high turnover in the upswing and very low turnover in the house price bust (see Figure \@ref(fig:turnover) in the Appendix). The boom-bust dynamic is primarily driven by the price expectation mechanism of households. These price expectations are backward-looking, i.e. built by projecting past price developments (conservatively) into the future. As the model does not encompass a firm sector, households receive their monthly employment income exogenously. Employment income is determined according to the household's age and their randomly pre-set income percentile, according to UK micro data. This implies that there is no feedback loop from lower consumption induced by lower house prices to lower employment income---via lower revenues of a firm sector. For the analysis of the dynamics of financial vulnerability, this will lead to an under-representation of financial vulnerability due to rising unemployment and lower income due to a housing bust.

In the present paper, the model version differs from @TarneEtAl2021 in two aspects. First, an age limit for households to take out mortgages is introduced (the specific value is part of the output calibration presented in section \@ref(calibration)). In addition, and more importantly, the consumption function is adjusted to implement a precautionary channel that is sensitive to collateral values. The households' new consumption function is described in detail in the next section.

## Households' Consumption

<!--# Hier muss eine neue Einleitung her -->

For analysing the influence of the housing cycle on financial vulnerability the distribution of liquid savings among households is relevant. Liquid savings are influenced by the households' consumption decisions, especially via a housing wealth effect. As discussed previously, this wealth effect appears to be sensitive to households' collateral values. Therefore, we implement a different parameterisation of the households' consumption function for households close to their borrowing constraint where their precautionary saving is influenced by the net value of their property. Following @Aladangady2017, households with DSRs above the median are classified as being close to their borrowing constraint. These households might consume all of their deposits when their net property wealth is sufficiently high for a long enough time, but, crucially, they don't finance their consumption with debt.[^5] The households' desired consumption is given by:

[^5]: This mechanism would require the modelling of an equity withdrawing channel which would complicate the model, while not adding much to identify financially vulnerable households: with or without equity withdrawal, financial buffers would be zero. However, households going into more debt to finance their consumption could lower their financial margin as opposed to households that only reduced their financial buffers to zero.

```{=tex}
\begin{equation}
c^{d}_{i,t} = \alpha_{i} y^{disp}_{i,t} + \beta_{i} b_{i,t} + \gamma_{i,t} (w^{h}_{i,t} -  q_{i,t}),
(\#eq:dConsumption)
\end{equation}
```
where $y^{disp}_{i,t}$ is monthly disposable income (defined as $y^{net}_{i,t} - \sum_{j=1}^{k} m_{i,k}$),[^6] with $y^{net}_{i,t}$ being post-tax income and $\sum_{j=1}^{k} m_{i,k}$ being the sum of its monthly mortgage payments (which remain constant over the repayment phase) and $k$ the house the mortgage is paid for. $b_{i,t}$ are the household's deposits, $w^{h}_{i,t}$ is the gross housing wealth and $q_{i,t}$ mortgage debt. $i$ is the individual index of the household, $t$ the simulation period (monthly steps). $\alpha_{i}$ is the marginal propensity to consume out of disposable income, ranging from $0.5$ to $0.99$, becoming weaker the higher the household's income (according to their income percentile assigned at "birth" $\Xi_{i}$), while first-time buyer agents have an extra saving motive to save up for a down payment.[^7] $\beta_{i}$, like $\alpha_{i}$ gets weaker the higher the households' income [@DynanEtAl2004; @ArrondelEtAl2019] and ranges from $0.025$ to $0.0001$.

[^6]: To be consistent with @AmpudiaEtAl2016a, I exclude mortgage and rental payments, i.e. housing consumption, from the calculation of desired consumption. Therefore, desired consumption only includes non-housing consumption.

[^7]: First-time buyers assigned to an income percentile $\Xi_{i} >$ `r properties_file$minIncomePercentile` have marginal propensity to consume out of disposable income ($\alpha_{i}$) of `r properties_file$MPCForFirstTimeBuyers`. This diverges from @TarneEtAl2021. See section \@ref(calibration) in the Appendix for the calibration of these values.

$\gamma_{i,t}$ is the effect of net housing wealth on consumption. If the households' DSR[^8] is above the median, then $\gamma_{i,t} = 0.01$ (which adds up to a yearly value of 12.7% reported by @Aladangady2017). The desired consumption is subject to certain successively-applied constraints, so that actual consumption is given by:

[^8]: The households' DSR is defined as the sum of monthly mortgage payments over its income, $\tfrac{\sum_{j=1}^{k} m_{i,k}}{y_{i,t}}$.

```{=tex}
\begin{equation}
c_{i,t} = 
\begin{cases}
\alpha_{i} y^{disp}_{i,t} & \text{if } b_{i,t} + y^{disp}_{i,t} - c^{d}_{i,t} < \zeta_{i,t} y^{net}_{i,t} \\
c_{0} & \text{if } c^{d}_{i,t} < c_{0} \\
b_{i,t} + y^{disp}_{i,t} & \text{if } b_{i,t} + y^{disp}_{i,t} <  c_{0} \\
c^{d}_{i,t} & \text{else, }
\end{cases}
(\#eq:Consumption)
\end{equation}
```
where the first condition describes a buffer-stock: if the desired consumption would lead to deposits being lower than a certain multiple $\zeta_{i,t}$ of the household's monthly net income, the household limits its consumption to that induced by its disposable income. Crucially, $\zeta_{i,t}$ is set to zero for all households with DSRs above the median as these households might decide to lower their financial buffer to zero as long as their collateral is valuable enough. For all other households with DSRs below the median $\zeta_{i,t}$ is calibrated to `r properties_file$liquidityPreference`. The second condition states that households consume at least $c_{0}$, set to 40% of median income, following @AmpudiaEtAl2016a.[^9] As the conditions are applied successively, households with $\alpha_{i,t} y^{disp}_{i,t} < c_{0}$ consume $c_{0}$. The third condition states that households only consume less than $c_{0}$ if consuming $c_{0}$ would result in negative financial wealth. In this case, they consume all their disposable income and their deposits. As employment income is very stable, these cases are very rare and this condition allows us to simplify the model by abstracting from bankruptcies.[^10]

[^9]: In the model by @TarneEtAl2021 $c_{0}$ is set lower and equal to the minimum monthly earnings a household could have, corresponding to the monthly income support of the UK government.

[^10]: In very rare cases, for instance for BTL investors with large mortgage payments and low rental income, households can have negative disposable incomes. These households then reduce their deposits to service their payments and finance their consumption. Once they go bankrupt, their deposits are set to zero for the following month---which represents a very rudimentary default mechanism.

# Calibration

```{r buildingDistributionData, echo=FALSE, message=FALSE, warning=FALSE, results=FALSE}

Wave_5_HH <- was_wave_5_hhold_eul_final%>%
  mutate(MortgagePayment1 = case_when(MPayM1W5 %in% c(-9:-6) ~ 0, TRUE~as.numeric(MPayM1W5)),
         MortgagePayment2 = case_when(MPayM2W5 %in% c(-9:-6) ~ 0, TRUE~as.numeric(MPayM2W5)),
         MortgagePayment3 = case_when(MPayM3W5 %in% c(-9:-6) ~ 0, TRUE~as.numeric(MPayM3W5)),
         totalMortgagePayments = MortgagePayment1 + MortgagePayment2 + MortgagePayment3,
         Mortgage1 = case_when(MVal1W5 %in% c(-9:-6) ~ 0, TRUE~as.numeric(MVal1W5)),
         Mortgage2 = case_when(MVal2W5 %in% c(-9:-6) ~ 0, TRUE~as.numeric(MVal2W5)),
         Mortgage3 = case_when(MVal3W5 %in% c(-9:-6) ~ 0, TRUE~as.numeric(MVal3W5)),
         totalMortgageDebt = Mortgage1 + Mortgage2 + Mortgage3)%>%
  select(totalMortgageDebt,
         totalMortgagePayments,
         w5xshhwgt,                    # weight
         HRPDVAgeW5,                # age
         
         NumAdultW5, # number adults in household
         NumChildW5, # number of children
         Ten1w5_i, # tenure (only one is imputed)
         
         ## mortgages and housing
         MNumbNW5, #	Number mortgages or loans on property (only if no mortgage in W4 on this property
         MNumbOW5, #	Number mortgages or loans on property (only if mortgage in W4 on this property
         MNumbw5_i, #	Number of mortgages/loans
         MVal1W5, #	Amount still outstanding mortgageloan
         MValB1W5, #	Banded amount outstanding on mortgageloan (only about 100)
         MYLft1W5,        # Years left to run on mortgage
         # MPayM1W5, # Total monthly repayments for mortgage
         MPayB1W5, # Banded amount (about 25)
         MPastSPA1W5, # expecting to pay mortgage past pension age
         MIntRate1W5,	# Interest paid on mortgage?

         TotMortw5, # Total mortgage on main residence
         DVHValuew5, # Value of main residence
         OthMortw5_sum, #Total property debt
         DBurdHW5, # debt burden
         HBuyYrW5, #	Year bought main residence
         
         # finanaical wealth
         
         HFINWw5_sum, # Gross Financial Wealth
         HFINWNTw5_sum,   # Household Net financial Wealth (financial assets minus financial liabilities)
        
         DVTotGIRW5,                 # Household Gross Annual (regular) income
         DVTotNIRW5,                 # Household Net Annual (regular) income
         DVGrsRentAmtAnnualw5_aggr,  # Household Gross annual income from rent
         DVNetRentAmtAnnualw5_aggr,  # Household Net annual income from rent
       
         # List of other household variables of possible interest
         HRPDVILO3aW5,	# ILO employment status of HRP or partner
         
         HRPNSSEC3W5, # Socio-economic classification of HRP or partner

         HPHYSWW5,                   # Total Physical Wealth
         HPROPWw5,                   # Total property wealth
         TOTPENw5_aggr,              # Total hhold pension value
         TotWlthW5,                  # Total household wealth
         DVPropertyw5)%>% # 5	Sum of all property values
rename(Weight = "w5xshhwgt",
         Age = "HRPDVAgeW5", 
         NFW = "HFINWNTw5_sum",
         GrossFinancialWealth = "HFINWw5_sum",
         GrossAnnualRegularIncome = "DVTotGIRW5",                 # Household Gross Annual (regular) income
         NetAnnualRegularIncome = "DVTotNIRW5",                 # Household Net Annual (regular) income
         GrossAnnualRentalIncome = "DVGrsRentAmtAnnualw5_aggr",  # Household Gross annual income from rent
         NetAnnualRentalIncome = "DVNetRentAmtAnnualw5_aggr",  # Household Net annual income from rent
         
         # List of other household variables of possible interest
         Employment = "HRPDVILO3aW5",              # Employment Status of HRP or partner
         PhysicalWealth = "HPHYSWW5",                   # Total Physical Wealth
         NetHousingWealth = "HPROPWw5",                   # Total property wealth
         TotalPensionWealth = "TOTPENw5_aggr",              # Total hhold pension value
         TotalWealth = "TotWlthW5",                  # Total household wealth
         # NetAnnualSelfEmployedIncome = "DVNISEw5_aggr",              # Household Total Annual Net self employed income
         # NetAnnualEmployeeIncome = "DVNIEMPw5_aggr",             # Household Total Annual Net employee income
         # GrossAnnualInvestmentIncome = "DVGIINVw5_aggr",             # Household Gross annual income from investments
         # NetAnnualInvestmentIncome = "DVNIINVw5_aggr",             # Household Net annual income from investments
         GrossHousingWealth = "DVPropertyw5")%>%
filter(!is.na(Weight)) %>%# there is at least one observation where the weight is NA, which leads to problems when building the unweighted version
mutate(finanicalMargin = NetAnnualRegularIncome/12 - totalMortgagePayments - vul_rho_1 * 2750, # TODO better calculate this value on the spot 
         monthsAbleToCover = GrossFinancialWealth/finanicalMargin, # negative value means finanical margin is negative
         vulnerable = case_when(monthsAbleToCover < 0 & monthsAbleToCover > -monthsToCover & totalMortgagePayments !=0 ~ 1, TRUE ~ 0),
         debtIsHeavyBurden = case_when(DBurdHW5 == 1 ~ 1,TRUE ~ 0)
  ) 

wave_5_for_graph <-Wave_5_HH %>% #Wave_5_HH %>%  weighted_Wave5
  filter(totalMortgagePayments != 0) %>%
  mutate(vulnerable = case_when(vulnerable == 0 ~ FALSE, vulnerable ==1 ~TRUE))%>%
  mutate(DSR = 12*totalMortgagePayments/ GrossAnnualRegularIncome)%>%
  mutate(DTI = totalMortgageDebt/GrossAnnualRegularIncome)

core_medians_WAS_DSR <- wave_5_for_graph %>%
  group_by(vulnerable) %>%
  summarise(coreIndicator = weighted.median(DSR, w = Weight))

core_medians_WAS_Age <- wave_5_for_graph %>%
  group_by(vulnerable) %>%
  summarise(coreIndicator = weighted.median(Age, w = Weight))

wave_5_calculating_nonPayments <-Wave_5_HH %>% #Wave_5_HH %>%  weighted_Wave5
  mutate(MortgagePaymentsRecorded = case_when(totalMortgagePayments == 0 ~ FALSE, totalMortgagePayments != 0 ~ TRUE))%>%
  filter(totalMortgageDebt !=0)%>%
  mutate(vulnerable = case_when(vulnerable == 0 ~ FALSE, vulnerable ==1 ~TRUE))%>%
  mutate(DSR = 12*totalMortgagePayments/ GrossAnnualRegularIncome)%>%
  mutate(DTI = totalMortgageDebt/GrossAnnualRegularIncome)


wave_5_payments_T_F <- wave_5_calculating_nonPayments %>%
  group_by(MortgagePaymentsRecorded) %>%
  tally(wt= Weight)
# n[2] is where mortgagepaymentsRecorded = TRUE
share_wave_5_payment <- wave_5_payments_T_F$n[2] / sum(wave_5_payments_T_F$n)

wave_5_payments_T_F_Age <- wave_5_calculating_nonPayments %>%
  group_by(MortgagePaymentsRecorded) %>%
  summarise(coreIndicator = weighted.median(Age, w = Weight))

wave_5_payments_T_F_DTI <- wave_5_calculating_nonPayments %>%
  group_by(MortgagePaymentsRecorded) %>%
  summarise(coreIndicator = weighted.median(DTI, w = Weight))


wave_5_calculating_shareVulTotalPopulation <-Wave_5_HH %>% #Wave_5_HH %>%  weighted_Wave5
  mutate(MortgagePaymentsRecorded = case_when(totalMortgagePayments == 0 ~ FALSE, totalMortgagePayments != 0 ~ TRUE))%>%
  mutate(vulnerable = case_when(vulnerable == 0 ~ FALSE, vulnerable ==1 ~TRUE))%>%
  mutate(hasDebt = case_when(totalMortgageDebt !=0 ~ TRUE, TRUE ~ FALSE))%>%  
  mutate(DSR = 12*totalMortgagePayments/ GrossAnnualRegularIncome)%>%
  mutate(DTI = totalMortgageDebt/GrossAnnualRegularIncome)

## build data frame for calculting weighed mean -> share of vulnerable households in indebted households
wave_vul_weight <- Wave_5_HH%>%  # weighted_Wave5  # Wave_5_HH
  filter(totalMortgageDebt!=0)%>%
  filter(totalMortgagePayments != 0) %>%
  select(vulnerable,Weight)

# calculating the share of vulnerable households in all households when assuming that indebted households
# reporting and not reporting have the same chance of being vulnerable (they are probably lower..)
share_vul_HH_payment_subgroup <- weighted.mean(wave_vul_weight$vulnerable, w = wave_vul_weight$Weight)

share_wave_5_VulHH_AllHH <- wave_5_calculating_shareVulTotalPopulation%>%
  group_by(hasDebt) %>%
  tally(wt = Weight)

number_households_wave_5 <- tally(wave_5_calculating_shareVulTotalPopulation, wt = Weight)

share_wave_5_VulHH_AllHH <-share_wave_5_VulHH_AllHH %>% 
  filter(hasDebt == TRUE)%>%
  select(n)
share_wave_5_VulHH_AllHH <- share_wave_5_VulHH_AllHH / number_households_wave_5 * share_vul_HH_payment_subgroup

sortingData_for_figure <-  agent_data_vul_2 %>% # sortingData_data_vul_noFTBSM sortingData_data_vul_noFTBSM_0.961
  filter(Debt < 0)%>%
  mutate(DTI = Debt/(-12* MonthlyGrossTotalIncome))%>%
  mutate(DSR = MonthlyMortgagePayments/MonthlyGrossTotalIncome)%>%
  mutate(hasDebt = case_when(Debt<0 ~ TRUE, TRUE ~ FALSE))


core_medians_DSR <- sortingData_for_figure %>%
  group_by(vulnerable) %>%
  summarise(coreIndicator = median(DSR, na.rm = TRUE))


core_medians_Age <- sortingData_for_figure %>%
  group_by(vulnerable) %>%
  summarise(coreIndicator = median(Age, na.rm = TRUE))

```

The model here introduces new parameters to the base model of @BaptistaEtAl2016, some of which have already been introduced in @TarneEtAl2021, which this paper is more closely built on. The new parameters are given in Table \@ref(tab:parameters) in Appendix \@ref(supplemental-figures-and-tables). The propensities to consume out of disposable income and wealth are based on the estimates provided by @DynanEtAl2004 and @ArrondelEtAl2019. As targets for calibrating the eight remaining new parameters to, important stylized facts from the UK are selected. The Bank of England's *Core Indicators for setting the LTV and DTI ratios* [@BankofEngland2018, p. 68] are shown in Table \@ref(tab:BoECoreIndicators). Additional stylized facts with focus on the wealth distribution and the characteristics of financially vulnerable households are reported in Table \@ref(tab:CoreIndicators).

For the calibration procedure, first, upper and lower limits for the parameter space of eacht variable were set (reported in Table \@ref(tab:parameters)). In a second step, a Latin hypercube was used to sample 1000 different parameter combinations which were used to run the model with. Each run lasted for 2500 periods, where the first 1500 periods were omitted as a burn-in phase. The outputs of these model runs were rated with help of an (unweighted) cost function, pricing the the quadratic distance of the output from the target values. From this array of models, one, matching the stylized facts as good as possible, was selected.

(ref:BoE2018-citation) [@BankofEngland2018, p.68]

```{r BoECoreIndicators, message=FALSE, warning=FALSE,  echo=FALSE}
# build data frame with the core indicators
# 2:nPeriods+1 because the files start only in their second column
coreIndicators <- data.frame(row.names = ("Model Output"),Debt_to_income_ratio =mean(rowMeans(read_csv(here::here(paste0("wealth-effect/Results/",model_folder_1,"/coreIndicator-debtToIncome.csv")), col_names = FALSE)[1:nMCRuns,2:(nPeriods+1)], na.rm = TRUE)),
                         OO_debt_to_income_ratio = mean(rowMeans(read_csv(here::here(paste0("wealth-effect/Results/",model_folder_1,"/coreIndicator-ooDebtToIncome.csv")), col_names = FALSE)[1:nMCRuns,2:(nPeriods+1)], na.rm = TRUE)),
                         OO_LTI_mean_above_median = mean(rowMeans(read_csv(here::here(paste0("wealth-effect/Results/",model_folder_1,"/coreIndicator-ooLTI.csv")), col_names = FALSE)[1:nMCRuns,2:(nPeriods+1)], na.rm = TRUE)),
                         OO_LTV_mean_above_median = mean(rowMeans(read_csv(here::here(paste0("wealth-effect/Results/",model_folder_1,"/coreIndicator-ooLTVAboveMedian.csv")), col_names = FALSE)[1:nMCRuns,2:(nPeriods+1)], na.rm = TRUE)),
                         BTL_LTV_ratio = mean(rowMeans(read_csv(here::here(paste0("wealth-effect/Results/",model_folder_1,"/coreIndicator-btlLTV.csv")), col_names = FALSE)[1:nMCRuns,2:(nPeriods+1)], na.rm = TRUE)),
                         # OO_LTV_mean = mean(rowMeans(read_csv(here::here(paste0("Results/",model_folder_1,"/coreIndicator-ooLTV.csv")), col_names = FALSE)[1:nMCRuns,2:(nPeriods+1)], na.rm = TRUE)),
                         Housing_transactions_month = mean(rowMeans(read_csv(here::here(paste0("wealth-effect/Results/",model_folder_1,"/coreIndicator-housingTransactions.csv")), col_names = FALSE)[1:nMCRuns,2:(nPeriods+1)], na.rm = TRUE)),
                         Mortgage_approvals = mean(rowMeans(read_csv(here::here(paste0("wealth-effect/Results/",model_folder_1,"/coreIndicator-mortgageApprovals.csv")), col_names = FALSE)[1:nMCRuns,2:(nPeriods+1)], na.rm = TRUE)),
                         Advances_to_homemovers = mean(rowMeans(read_csv(here::here(paste0("wealth-effect/Results/",model_folder_1,"/coreIndicator-advancesToMovers.csv")), col_names = FALSE)[1:nMCRuns,2:(nPeriods+1)], na.rm = TRUE)),
                         Advances_to_FTB = mean(rowMeans(read_csv(here::here(paste0("wealth-effect/Results/",model_folder_1,"/coreIndicator-advancesToFTB.csv")), col_names = FALSE)[1:nMCRuns,2:(nPeriods+1)], na.rm = TRUE)),
                         Advances_to_BTL = mean(rowMeans(read_csv(here::here(paste0("wealth-effect/Results/",model_folder_1,"/coreIndicator-advancesToBTL.csv")), col_names = FALSE)[1:nMCRuns,2:(nPeriods+1)], na.rm = TRUE)),
                         House_price_to_income_ratio = mean(rowMeans(read_csv(here::here(paste0("wealth-effect/Results/",model_folder_1,"/coreIndicator-priceToIncome.csv")), col_names = FALSE)[1:nMCRuns,2:(nPeriods+1)], na.rm = TRUE)),
                         Rental_Yield = mean(rowMeans(read_csv(here::here(paste0("wealth-effect/Results/",model_folder_1,"/coreIndicator-RentalYield.csv")), col_names = FALSE)[1:nMCRuns,2:(nPeriods+1)], na.rm = TRUE))
                         # Spreads_in_bp = mean(rowMeans(read_csv(here::here(paste0("Results/",model_folder_1,"/coreIndicator-interestRateSpread.csv")), col_names = FALSE)[1:nMCRuns,2:(nPeriods+1)], na.rm = TRUE)),
                         # BTL_share = mean(rowMeans(read_csv(here::here(paste0("Results/",model_folder_1,"/coreIndicator-BTLMarketShare.csv")), col_names = FALSE)[1:nMCRuns,2:(nPeriods+1)], na.rm = TRUE))
                         )
# adjsut from % to double values
coreIndicators <- coreIndicators %>%
  mutate(Debt_to_income_ratio = Debt_to_income_ratio / 100, 
         OO_debt_to_income_ratio = OO_debt_to_income_ratio / 100,
         BTL_LTV_ratio = BTL_LTV_ratio / 100,
         OO_LTV_mean_above_median = OO_LTV_mean_above_median / 100,
         Rental_Yield = Rental_Yield / 100)

# read the excel of the Bank of England's core indicators (from end 2018)
# as the table is not easily read due to its formatting, I clean the data first
BoE_coreIndicators <- as.data.frame(read_excel(path = here::here("statistical output R/Bank of England core indicators time series.xlsx")))
# name the columns
names(BoE_coreIndicators) <- c("Indicator", "sub_Indicator",		"Average 1987-2006(b)",	"Average 2006(c)",	"Minimum since 1987(b)",	"Maximum since 1987(b)",	"Previous value (oya)",	"Latest value (as of 16 November 2018)", "NA")


# read the rows where the "subindicator" is named. This could lead to errors if the names of the indicators change in the table (for instance when using newer versions)
coreIndicators_From_BoE <- data.frame(Debt_to_income_ratio = t( filter(BoE_coreIndicators, sub_Indicator %in% "of which: mortgages(h)")[3:8]), # subgroup of Household debt to income ratio(g)
                                      OO_debt_to_income_ratio = t(filter(BoE_coreIndicators, sub_Indicator %in% "of which: owner occupier mortgages(i)")[3:8]), # subgroup of Household debt to income ratio(g)
                         OO_LTI_mean_above_median = t(filter(BoE_coreIndicators, sub_Indicator %in% "Owner-occupier mortgage LTI ratio (mean above the median)(d)")[3:8]), # Owner-occupier mortgage LTI ratio (mean above the median)(d)
                         OO_LTV_mean_above_median = t(filter(BoE_coreIndicators, sub_Indicator %in% "Owner-occupier mortgage LTV ratio (mean above the median)(d)")[3:8]),
                         BTL_LTV_ratio = t(filter(BoE_coreIndicators, sub_Indicator %in% "Buy-to-let mortgage LTV ratio (mean)(e)")[3:8]),
                         # OO_LTV_mean = filter(BoE_coreIndicators, sub_Indicator %in% "Buy-to-let mortgage LTV ratio (mean)(e)")[3:8],
                         Housing_transactions_month = t(filter(BoE_coreIndicators, sub_Indicator %in% "Housing Transactions(k)")[3:8]),
                         Mortgage_approvals = t(filter(BoE_coreIndicators, sub_Indicator %in% "Approvals of loans secured on dwellings(j)")[3:8]),
                         Advances_to_homemovers = t(filter(BoE_coreIndicators, sub_Indicator %in% "Advances to homemovers(l)")[3:8]),
                         Advances_to_FTB = t(filter(BoE_coreIndicators, sub_Indicator %in% "Advances to first time buyers(l)")[3:8]),
                         Advances_to_BTL = t(filter(BoE_coreIndicators, sub_Indicator %in% "Advances to buy-to-let purchasers(l)")[3:8]),
                         House_price_to_income_ratio = t(filter(BoE_coreIndicators, sub_Indicator %in% "House price to household disposable income ratio(p)")[3:8]),
                         Rental_Yield = t(filter(BoE_coreIndicators, sub_Indicator %in% "Rental yield(q)")[3:8])
                         )

# add row names and make cells numeric
coreIndicators_From_BoE <- as.data.frame(row.names = c("Average 1987-2006(b)",	"Average 2006(c)",	"Minimum since 1987(b)",	"Maximum since 1987(b)",	"Previous value (oya)",	"Latest value (as of 16 November 2018)"), sapply(coreIndicators_From_BoE, as.numeric))

# combine BoE and model data (transpose it too)
coreIndicatorsDisplay <- as.data.frame(bind_rows(coreIndicators, coreIndicators_From_BoE))

# c("Household mortgage debt to income",
#   "Owner-occupier mortgage debt to income",
#   "Owner-occupier mortgage LTI ratio (mean above the median)",
#   "Owner-occupier mortgage LTV ratio (mean above the median)",
#   "Buy-to-let mortgage LTV ratio (mean)",
#   "Monthly Housing Transactions",
#   "Approvals of loans secured on dwellings",
#   "Advances to homemovers",
#   "Advances to first time buyers",
#   "Advances to buy-to-let purchasers",
#   "House price to household disposable income ratio",
#   "Rental yield"), .before = 1)
#   

# format(coreIndicatorsDisplay[,11:12], digits = 4, scientific = FALSE)

   
coreIndicatorsDisplay_3 <- format(coreIndicatorsDisplay[,11:12], digits = 3, scientific = FALSE)
# For some reason the BoE data in "display_3" are always 3 digits. So 2 digits does not work. I do not understand but simply
# use 3 digits for the lower numbers now
coreIndicatorsDisplay_1 <- format(coreIndicatorsDisplay[,1:5], digits = 3,  scientific = FALSE)
coreIndicatorsDisplay_2 <- format(coreIndicatorsDisplay[,6:10], digits = 0, scientific = FALSE)


coreIndicatorsDisplay_1and2 <- bind_cols(coreIndicatorsDisplay_1, coreIndicatorsDisplay_2)

coreIndicatorsDisplay <- as.data.frame(t(bind_cols(coreIndicatorsDisplay_1and2, coreIndicatorsDisplay_3)), row.names = c("Debt to income",
                                                                          "OO debt to income",
                                                                          "OO LTI ratio (mean above the median)",
                                                                          "OO LTV ratio (mean above the median)",
                                                                          "BTL LTV ratio",
                                                                          "Monthly Housing Transactions",
                                                                          "Approvals of mortages",
                                                                          "Advances to homemovers",
                                                                          "Advances to FTB",
                                                                          "Advances to BTL",
                                                                          "House price to income ratio",
                                                                          "Rental yield"))
# coreIndicatorsDisplay <- signif(coreIndicatorsDisplay, digits = 3)
# implement line-breaks 
lineBreaks_table<- c("Model Output", "Average \n1987-2006",	"Average\n2006",	"Minimum \nsince 1987",	"Maximum \nsince 1987",	"Previous \nvalue (oya)",	"Latest value\n(November 2018)" )
if (knitr:::is_latex_output()){
  coreIndicatorsDisplay %>%
    mutate_all(linebreak)%>%
    kableExtra::kbl(
                    caption = "Comparison Model and Bank of England Core Indicators",
                    booktabs =T,
                    escape =F,
                    col.names =linebreak(lineBreaks_table, align ="c"))%>%
    kable_styling(latex_options =c("striped","scale_down")) %>%
    add_header_above(c(" "=1,"Model"=1,"Bank of England Core Indicators"=6))%>%
    footnote(general = paste0("The Core Indicators are taken from the Financial Stability Report ", "(ref:BoE2018-citation)", "; OO = Owner-Occupier, encompassing FTB and SSB; all values are means, except where stated otherwise; Model values are gained from 10 Monte-Carlo runs with an observation period of 1000 after a burn-in period of 1600."),
             threeparttable =T)
}

if (knitr:::is_html_output()){
  names(coreIndicatorsDisplay) <- c("Model Output", "Average 1987-2006",	"Average 2006",	"Minimum since 1987",	"Maximum since 1987",	"Previous value (oya)",	"Latest value (November 2018)" )
  coreIndicatorsDisplay %>%
    kableExtra::kable(caption = "Comparison Model and Bank of England Core Indicators")%>%
    kable_styling(latex_options =c("striped","scale_down"))%>%
    add_header_above(c(" "=1,"Model"=1,"Bank of England Core Indicators"=6)) 
}
#####TODO: rounding numbers in table -> or set specific rows as integers
#####TODO: color the last column according to its values
```

While the model is not able to match all target values in Table \@ref(tab:BoECoreIndicators), none of the indicators are critically off target. The output of the model is in bounds of the reported Bank of England's Core Indicators' values with the exception of the slightly too-high average debt-to-income ratio (DTI) of Owner-Occupiers (encompassing first-time buyers and second-and-subsequent buyers), the too-high monthly purchases of buy-to-let (BTL) agents, and rental yield. As in the model BTL agents rarely become financially vulnerable, even with this higher turnover, this should not directly affect the analysis. However, as BTL agents' sales and purchases influence the house price cycle they could indirectly influence transaction and consumption decisions of other households.

Before assessing how well the model is able to match the financial vulnerability of the UK, the concept of financial vulnerability used here is introduced. It follows @AmpudiaEtAl2016a with a modification introduced later. First, the financial margin $FM_{i,t}$ of a household is calculated as its monthly net income, less its monthly mortgage payments and some basic living expenses $c_{0}$:

```{=tex}
\begin{equation}
FM_{i,t} = y^{\text{disp}}_{i,t} - c_{0},
(\#eq:FM)
\end{equation}
```
If a household has a negative financial margin, it is financially distressed, meaning, its disposable income is not enough to consume $c_{0}$. If the households hold debt[^11] and cannot, from income or deposits, service their payments for less than eight months,[^12] they are considered to be close to default (i.e. $d_{i,t} = 1$):

[^11]: @AmpudiaEtAl2016a include households in their analysis, regardless of them holding debt. However, as they are interested in analyzing the effects of stress tests on the overall exposure at default, they ultimately consider only indebted households. As the model presented here features only mortgage debt and thereby excludes possible indebtedness of renters, for simplicity, I only include indebted households in this analysis. However, in Appendix \@ref(main-analysis-with-simpler-definition-of-financial-vulnerability) I re-do the main analysis of the paper with a simpler definition of financial vulnerability (all households with less than 1500 money units), including households without debt holdings.

[^12]: Following @AmpudiaEtAl2016a, the number of months set as threshold here is chosen so that the exposure at default (EAD) of the commercial bank in the model is close to the share of non-performing mortgage loans to all mortgage loans in the UK, which was 2.4% between 2015-2019 [@EBA2019]. As the model does not incorporate equity withdrawal and thereby lower EAD, the value aimed for to set the threshold is lower as well. Specifically, the EAD of financially vulnerable households in the model is `r formattable::percent(mean(outfile_MC10$"EAD Ampudia (X*medIncome Y*m)"), digits = 1)`.

```{=tex}
\begin{equation}
d_{i,t} = 
\begin{cases}
1 \iff FM_{i,t} < 0 \land  |FM_{i,t}| \cdot 8 > b_{i,t} \land q_{i,t} > 0\\
0 \iff FM_{i,t} \geq 0 \lor  |FM_{i,t}| \cdot 8 \leq b_{i,t} \lor q_{i,t} \leq 0
\end{cases}.
(\#eq:finVul)
\end{equation}
```
For the present analysis, the focus is on financially vulnerable households, i.e. households that would come close to defaulting in the event of an income or interest rate shock, and not necessarily households that are already close to defaulting. The idea is to analyse this "reservoir" of financially vulnerable households over the house price cycle. To this end, the definition in Equation \@ref(eq:finVul) is broadened by introducing a buffer to the financial margin. Households whose financial margin is below this buffer and whose liquid financial assets would not be sufficient to meet their monthly payments (if their income were to fall by the amount of this buffer) are considered financially vulnerable ($f_{i,t}=1$). The buffer is set to 20% of median income. In other words, households are then considered financially vulnerable if a negative shock to their income of 20% of median income would bring them close to default. This buffer is the same for every household. This ensures that low-income households, which are generally at higher risk of negative income shocks, are also at higher risk of becoming financially vulnerable [@AmpudiaEtAl2016]. The definition is given by:

```{=tex}
\begin{equation}
f_{i,t} = 
\begin{cases}
1 \iff FM_{i,t} < 0.2 y^{median}_{t} \land  |FM_{i,t} - 0.2 y^{median}_{t}| \cdot 8 > b_{i,t}\\
0 \iff FM_{i,t} \geq 0.2 y^{median}_{t} \lor  |FM_{i,t} - 0.2 y^{median}_{t}| \cdot 8 \leq b_{i,t}
\end{cases}
(\#eq:finVulalt)
\end{equation}
```
In the model, households rarely come close to defaulting (Equation \@ref(eq:finVul)) as their employment income is stable and interest rates are fixed. This is in contrast to the real economy, reflected in the household data of the Wealth and Asset Survey (WAS). To bridge this gap for the calibration of the model, households with $f_{i,t} = 1$ in the model are compared to households with $d_{i,t}=1$ in the WAS.

```{r CoreIndicators, message=FALSE, warning=FALSE,  echo=FALSE}
# ONS wealth data https://www.ons.gov.uk/peoplepopulationandcommunity/personalandhouseholdfinances/incomeandwealth/datasets/totalwealthwealthingreatbritain
#
#- wealth inequality
# - deposits/credit
# - average deposit? - do I have that? yes - 68,160 between 43,200 and 82,000 
# - median DSR vul HH
# - median DSR non-vul HH
# - share of vul HH in indebted HH (I use this due to WAS data constraints)
# - median Age vul HH
# - median Age non-vul HH ?? - this depends

Wave_5_HH_vul <- Wave_5_HH %>%
  # filter(totalMortgagePayments != 0) %>%
  # filter(totalMortgageDebt!=0)%>%
  mutate(finanicalMargin = NetAnnualRegularIncome/12 - totalMortgagePayments - vul_rho_1 * 2749.667,
         monthsAbleToCover = GrossFinancialWealth/finanicalMargin, # negative value means finanical margin is negative
         vulnerable = case_when(monthsAbleToCover<0 & monthsAbleToCover > - monthsToCover & totalMortgagePayments != 0 ~ TRUE, TRUE ~ FALSE),
         DSR = 12*totalMortgagePayments/ GrossAnnualRegularIncome,
         DTI = totalMortgageDebt/GrossAnnualRegularIncome) 


# calculate for indebted households
wave_indebted <- Wave_5_HH_vul%>% 
  filter(totalMortgageDebt!=0)%>%
  filter(totalMortgagePayments != 0) 

# calculate for vulnerable households
wave_vul <- Wave_5_HH_vul%>% 
  filter(totalMortgageDebt!=0)%>%
  filter(totalMortgagePayments != 0) %>%
  filter(vulnerable == TRUE)

# calculate for non-vulnerable, indebted households
wave_NonVul <- Wave_5_HH_vul%>% 
  filter(totalMortgageDebt!=0)%>%
  filter(totalMortgagePayments != 0) %>%
  filter(vulnerable == FALSE)

coreIndicators_table <- data.frame(row.names = c("Wealth Inequality", 
                                                 "Deposits/Debt", 
                                                 "Average Deposit", 
                                                 "median DSR all indebted HH", # this is not non-vul!
                                                 "median DSR vul HH",
                                                 "income shock adjusted median DSR vul HH",
                                                 "share vul HH of all indebted HH",
                                                 "median Age vul HH",
                                                 "median Age non-vul HH"
),  Model_output = NA, UK_values = c(0.449, # wealth inequality (0.407 - 0.474)
                                     1.57, # deposits over debt (1.3 - 1.84)
                                     67000, # average deposits(54200 - 82000) I use here data from 2010-2016 (not starting at 2006). It is more comparable with the debt/deposit ratio
                                     format(weighted.median(wave_indebted$DSR, w = wave_indebted$Weight), digits = 3,nsmall = 0, scientific = FALSE), # median DSR all indebted HH: wave_5_for_graph %>%summarise(coreIndicator = weighted.median(DSR, w = Weight))
                                     format(weighted.median(wave_vul$DSR, w = wave_vul$Weight), digits = 3,nsmall = 0, scientific = FALSE), # median DSR vul HH
                                    "-", # this is where the table shows the adjusted DSR from the model
                                     format(share_vul_HH_payment_subgroup, digits = 3,nsmall = 0, scientific = FALSE), # share of vul HH of all indebted hh
                                     format(weighted.median(wave_vul$Age, w = wave_vul$Weight), digits = 1, nsmall=0, scientific = FALSE), # median Age of vulnerable households
                                     format(weighted.median(wave_NonVul$Age, w = wave_NonVul$Weight), digits = 1, nsmall=0, scientific = FALSE) # median age of non-vulnerable households
), 
UK_values_range = c("0.407 - 0.474",
                    "1.3 - 1.84",
                    "54200 - 82000",
                    "-",
                    "-",
                    "-",
                    "-",
                    "-",
                    "-"),
Source = c("ONS 2006-2016 (without pension wealth)", 
           "ONS 2010-2016 (net finanical wealth / mortgage debt)",
           "ONS 2010-2016 (net financial wealth without pension wealth)",
           "Wealth and Asset Survey wave 5 (July 2014 - June 2016)",
           "as above",
           "as above",
           "-",
           "as above",
           "as above"))
### footnote "parameter values defining households as vulnerable are 0.7 and 8 months"
### "data from wealth and asset survey is the subgroup of households with specific mortgage payments"

names(coreIndicators_table) <- c("Model output", "mean UK values", "UK value range", "Source")


outfile_MC10_tmp <- outfile_MC10

  line_results_median <- outfile_MC10_tmp %>%
    mutate(depositsOverDebt = DepositsEndPeriod / totalCredit)%>%
    mutate(vulConsumptionChannel = `nowVul Dissaving` / 
             (`nowVul Purchase`+ `nowVul Dissaving`+`nowVul Other`)) %>%
    mutate(averageDeposits = `DepositsEndPeriod` /  TotalPopulation) %>%
    select(`medianAge vulHH`, 
           `medianAge nonVulHH`,
           medianDebtServiceRatio, 
           `vulHH medianDSR`,
           `vulHH medianDSR adjusted`, # this implements the DSR if all households where hit with income decline
           )%>%
    apply(MARGIN = 2, FUN = mean_and_NaN_check)%>%
    round(digits = 3)


  line_results_mean <- outfile_MC10_tmp %>%
    mutate(depositsOverDebt = DepositsEndPeriod / totalCredit)%>%
    mutate(vulConsumptionChannel = `nowVul Dissaving` / 
             (`nowVul Purchase`+ `nowVul Dissaving`+`nowVul Other`)) %>%
    mutate(averageDeposits = `DepositsEndPeriod` /  TotalPopulation) %>%
    select(`%vulHH of indebtedHH`,
           depositsOverDebt, 
           vulConsumptionChannel,
           averageDeposits)%>%
    apply(MARGIN = 2, FUN = mean_and_NaN_check)%>%
    round(digits = 3)

  
  line_results_WS <- outfile_MC10_tmp %>%
    filter(`Sale HPI` > 0.98 & `Sale HPI` < 1.21) %>%
    pull(`Top 10% wealth share`)%>%
    mean_and_NaN_check()%>%
    round(digits = 3)
  
  coreIndicators_table$`Model output` <- c(line_results_WS, # wealth inequality
                                           formattable::percent(line_results_mean[["depositsOverDebt"]],digits = 1), # 
                                           line_results_mean[["averageDeposits"]],
                                           line_results_median[["medianDebtServiceRatio"]],
                                           line_results_median[["vulHH medianDSR"]],
                                           line_results_median[["vulHH medianDSR adjusted"]], # this implements the DSR if all households where hit with income decline
                                           line_results_mean[["%vulHH of indebtedHH"]],
                                           line_results_median[["medianAge vulHH"]],
                                           line_results_median[["medianAge nonVulHH"]]
  )  
  coreIndicators_table[3,] <- format(coreIndicators_table[3,], digits = 0,nsmall = 0,  scientific = FALSE)
  
  coreIndicators_table %>%
    kbl(booktabs =T,
        caption = "Other Stylized Facts to Match") %>%
    kable_styling(latex_options =c("striped", "scale_down"), full_width = FALSE)%>%
    column_spec(5, width = "12em")%>%
     collapse_rows(columns = 3)  %>%
    footnote(general = "Data by the ONS retrieved from https://www.ons.gov.uk/peoplepopulationandcommunity/ personalandhouseholdfinances/incomeandwealth/datasets/totalwealthwealthingreatbritain and for mortgage debt from https://www.ons.gov.uk/peoplepopulationandcommunity/personalandhouseholdfinances/incomeandwealth/ datasets/householddebtwealthingreatbritain ; difference in periods covered by UK data due to data constraints; wealth inequality in the model is measured with the subset of periods with house prices between 98% and 121% of 2011-prices (UK price level range from 2006-2016); data from the fifth wave of the Wealth and Asset Survey is the subgroup of households with recorded mortgage payments; vul = financially vulnerable; HH = household; DSR = Debt-Service-to-Income ratio; Model values are gained from 10 Monte-Carlo runs with an observation period of 1000 steps after a burn-in period of 1600 steps. Income shock adjusted DSRs come from lowering households' income by 20% of median income.",
           threeparttable =T)
```

The calibration results are shown in Table \@ref(tab:CoreIndicators) with other stylized facts regarding wealth inequality and the levels of debt and deposits. The wealth inequality and the deposits-to-debt ratio are slightly higher in the model than found in the data. The median debt-service-to-income ratio for non-vulnerable households in the model and households close to default in the WAS are very close together (`r line_results_median[["medianDebtServiceRatio"]]` to `r format(weighted.median(wave_indebted$DSR, w = wave_indebted$Weight), digits = 3,nsmall = 0, scientific = FALSE)`). The median DSR for financially vulnerable households in the model is reported twice, the first is calculated with their actual income, and the second including the hypothetical income shock of 20% of median income. As desired, both ratios enclose the reported DSR of households close to default in the WAS. The rest of the empirical values presented in Table \@ref(tab:CoreIndicators), are matched remarkably well. Full distributions of DSRs, Income, Age of vulnerable and non-vulnerable households in the WAS and model are shown in Appendix \@ref(additional-calibration-results). With the model matching the stylized facts reasonably well we can look at the dynamics and drivers of financial vulnerability.

\FloatBarrier

# Results

## Causes for Financial Vulnerability

Households become financially vulnerable when they a) turn their financial margin below 20% of median income and b) reduce their deposits below the defined threshold.

Purchases and sales of housing and consumption drive financial vulnerability most. Income is less important here, as labour income is stable over the housing cycle, as is the income buffer implied by Equation \@ref(eq:finVulalt). Purchasing property can reduce households' financial margin, as monthly mortgage payments increase, and reduce households' financial buffer, as down payments are made. When households become vulnerable by act of a property purchase they are defined to be *vulnerable by purchase*---or vulnerable by the purchasing channel. Consumption on the other hand only affects the deposits of households, not their financial margin. Consumption can be induced by housing wealth for households with above-median DSRs, but also by financial wealth for all households. Dissaving, i.e. consuming more than the disposable income, only occurs induced by a wealth effect as consumption induced by income ($\alpha_{i}$ in Equation \@ref(eq:dConsumption)) is never larger than `rproperties_file$consumptionFractionQ1`. Households are defined as *vulnerable by dissaving* (or via the dissaving channel) when they were dissaving the period they became vulnerable (and did not buy a house in the same period).[^13] All other cases of households becoming vulnerable are defined as *by other*, including households experiencing a decline in their income (for instance when entering retirement, or decreases in rental income for BTL agents), turning their financial margin negative.

[^13]: Households can become financially vulnerable just a few months after buying a house. Due to this temporal closeness one might classify them as *vulnerable by purchase*, too. However, while the purchase may have decreased the households' financial margin and the down payments their financial buffer, dissaving induced by positive net wealth was necessary to make the households financially vulnerable. Moreover, as will be discussed with Figure \@ref(fig:whenVulBuy), this does not happen very often.

Figure \@ref(fig:stockVulnerable2) shows the stock of financially vulnerable households[^14] over a representative house price cycle, according to the cause of their vulnerability. While households becoming financially vulnerable by dissaving make up on average `r formattable::percent(mean(outfile_MC10$"nowVul Dissaving") / (mean(outfile_MC10$"nowVul Purchase") + mean(outfile_MC10$"nowVul Dissaving") + mean(outfile_MC10$"nowVul Other")), digits = 0)` of all vulnerable households, `r formattable::percent(mean(outfile_MC10$"nowVul Purchase") / (mean(outfile_MC10$"nowVul Purchase") + mean(outfile_MC10$"nowVul Dissaving") + mean(outfile_MC10$"nowVul Other")), digits = 0)` become vulnerable by purchases.[^15] These magnitudes relate to the findings by @BartscherEtAl2020. They estimate that about 50% of the increase in household mortgage debt between 1981 and 2007 is due to home equity extraction. At the same time, the number of financially vulnerable households almost quadrupled, before falling by around 40% until 2016. This suggests a major effect of consumption induced by housing wealth on financial vulnerability. Importantly, while @BartscherEtAl2020 focus on debt-service-to-income ratios for identifying vulnerable households, the results results here further suggest that consumption also has a very strong influence on financial vulnerability when financial buffers are included in the analysis.

[^14]: The financial vulnerability is defined following Equation \@ref(eq:finVulalt). Figure \@ref(fig:stockVulnerable2) but the definition following Equation \@ref(eq:finVul) is shown in Figure \@ref(fig:stockVulnerable1) in the Appendix.

[^15]: Generally, these values give a direction of the relative strengths of both effects. They are partly influenced by the setting of the number of months a household has to be able to cover its negative financial margin (Equation \@ref(eq:finVulalt)). section \@ref(different-thresholds-for-financial-vulnerability) in the Appendix shows this for different parameter values, ranging from 74% for one month to 60% for 24 months. Additionally, section \@ref(different-model-parametrization) in the Appendix shows the sensitivity of the strength of the dissaving channel to different calibrations of the free parameters of the model. Both tests confirm the relative strength of the dissaving channel.

```{r, stockVulnerable2, echo = FALSE, warning=FALSE,message=FALSE, results= FALSE, fig.align='center', fig.cap = "Share of Fiancially Vulnerable Households -- by Cause of Financial Vulnerability over the House Price Cycle - 6 months rolling averages",  out.width='66%'}
# get first the position of house price troughs from a smoothed HPI line
# (not as necessary for troughs as for peaks, which are more irreglar)
HPI_troughs <- find_peaks_smoothed( -outfile_2$`Sale HPI`, m=10, smoothedPerdiods = 12)
# translate the position of troughs into the corresponding periods to use later in graph
trough_period <- c(outfile_2$`Model time`[HPI_troughs])

# , fig.subcap= c("cause of vulnerability", "agent classes vulnerable"), fig.show='hold' # in case this is put back in
outfile_2_tmp <- outfile_2 %>%
  select("nowVul Purchase", "nowVul Dissaving",  "nowVul Other")

outfile_2_tmp <- as.matrix(outfile_2_tmp)/outfile_2$TotalPopulation # adjust for % of total population
outfile_2_tmp <- as.data.frame(runmean(outfile_2_tmp, rolling_averages)) # build a rolling average (6 for 6 months)
colnames(outfile_2_tmp) <- list("purchase", "dissaving", "other") # abbreviate colnames for figure

outfile_2_tmp <- outfile_2_tmp %>%
  bind_cols(outfile_2$`Model time`, outfile_2$`Sale HPI`)%>%
  pivot_longer(c("purchase", "dissaving", "other"))  ## prepare for boxplots

colnames(outfile_2_tmp) <- list("Period","HousePriceIndex", "vulnerable_by", "value")
outfile_2_tmp$vulnerable_by <- factor(outfile_2_tmp$vulnerable_by, levels = c("other", "purchase", "dissaving"))
# outfile_2_tmp$vulnerable_by <- factor(outfile_2_tmp$vulnerable_by, levels = c("other", "dissaving", "purchase"))
# parameters for figure
relation_rhs_lhs <- 50

color_set_1 <- cet_pal(5, name = "r3") # color sets also used for later figure

outfile_2_tmp %>%
    filter(Period >= trough_period[troughs_limits[1]], Period <= trough_period[troughs_limits[2]])%>%
  ggplot(aes(x=Period, fill = vulnerable_by))+
  geom_col( aes(y = value))+
    geom_line( aes(y = HousePriceIndex / relation_rhs_lhs), size=1, linetype="dashed") +
  scale_y_continuous(
    # Features of the first axis
    name = "Share of vulnerable households",
     labels = scales::percent,
    # Add a second axis and specify its features
    sec.axis = sec_axis(~ . *relation_rhs_lhs, name="House Price Index (---)"),
    expand = expansion(mult = c(0, 0.05)) # make the barplots start at the axis
  ) +
  scale_x_continuous(expand = expansion(mult = c(0,0)))+
  # theme_classic()+
  theme(legend.position = "bottom") +
  theme(legend.background = element_blank()) +  # Remove overall border
  theme(legend.key = element_blank()) +
  # scale_fill_viridis_d()
  scale_fill_manual(values = color_set_1)



```

The share of financially vulnerable households shows a clear cyclicality, again in line with @BartscherEtAl2020. While the overall share of financially vulnerable households follows the house price cycle with a small lag, both effects peak at different points of the housing cycle.[^16] The share of households vulnerable by purchases increases strongly at the beginning of the price upswing, when turnover in the housing market is highest (see figure \@ref(fig:turnover) in Appendix \@ref(supplemental-figures-and-tables)) and then continues to rise. The share of households vulnerable by dissaving peaks around the midpoint of the house price downturn and then drops steadily. When house prices rise roughly above their long-term average, housing wealth-induced dissaving intensifies, steadily increasing the share of vulnerable households. When house prices fall back below their long-term average, the share of these vulnerable households falls again through deleveraging.[^17]

[^16]: Calculated over the course 10 Monte-Carlo runs the maximum correlation of overall vulnerability is `r round(ccf(outfile_MC10$"nVulHH (X*medIncome Y*m)", outfile_MC10$"Sale HPI")$acf[which.max(ccf(outfile_MC10$"nVulHH (X*medIncome Y*m)", outfile_MC10$"Sale HPI")$acf)],digits = 2)` at a lag of `r round(ccf(outfile_MC10$"nVulHH (X*medIncome Y*m)", outfile_MC10$"Sale HPI")$lag[which.max(ccf(outfile_MC10$"nVulHH (X*medIncome Y*m)", outfile_MC10$"Sale HPI")$acf)],digits = 2)` months. For the dissaving channel, the maximum correlation is `r round(ccf(outfile_MC10$"nowVul Dissaving", outfile_MC10$"Sale HPI")$acf[which.max(ccf(outfile_MC10$"nowVul Dissaving", outfile_MC10$"Sale HPI")$acf)],digits = 2)` at a lag of `r round(ccf(outfile_MC10$"nowVul Dissaving", outfile_MC10$"Sale HPI")$lag[which.max(ccf(outfile_MC10$"nowVul Dissaving", outfile_MC10$"Sale HPI")$acf)],digits = 2)` months and for the purchasing channel `r round(ccf(outfile_MC10$"nowVul Purchase", outfile_MC10$"Sale HPI")$acf[which.max(ccf(outfile_MC10$"nowVul Purchase", outfile_MC10$"Sale HPI")$acf)],digits = 2)` at a lag of `r round(ccf(outfile_MC10$"nowVul Purchase", outfile_MC10$"Sale HPI")$lag[which.max(ccf(outfile_MC10$"nowVul Purchase", outfile_MC10$"Sale HPI")$acf)],digits = 2)` months. See also Figure \@ref(fig:crossCorrelation2) in the Appendix.

[^17]: At this point households that are 'underwater', i.e. experience negative housing equity, tend to deleverage more than households with positive equity (following from Equation \@ref(eq:dConsumption)). This could be critiqued on the basis of some recent studies [@GanongNoel2020; @BergerEtAl2018; @GurenEtAl2021] that find for the US quite insensitive housing wealth consumption elasticities for households that are 'underwater'. For the model used here, this would imply that underwater households would deleverage at most with $(1-\alpha)y^{m,disp}_{i,t}$ as they would not have a spearate deleveraging motive sensitive to their net housing wealth. Deleveraging would take place more slowly. This slower deleveraging would reduce the *non-vulnerable by saving* channel and thereby reduce the volatility of financial vulnerability.

    However, this reduction in volatility might not be substantial, as financially vulnerable households in the model already tend to be restricted in their saving response by the essential consumption $c_{0}$ as they are squeezed by low incomes and high debt-service-to-income ratios. Moreover, the extra saving response in the model could be motivated with an increased income uncertainty in a house price bust---a mechanism that is not included in the model. Households with negative net housing wealth and low financial wealth---recall that in the model households with above-median debt-service-to-income ratios have no precautionary savings buffer---might build up some financial wealth as buffer-stock as, empirically, house price busts tend to go together with higher income insecurity. This timely build-up of a buffer stock could decrease the share of households vulnerable, and, therefore, generate comparable dynamics of the share of households being financially vulnerable. Moreover, in the UK adjustable rate mortgages are more common [@AronMuellbauer2016], making refinancing a higher risk and thereby potentially inducing more precautionary saving.

```{r contributorsVulnerability, fig.align='center', fig.cap="Contributors to changes in the share of financially vulnerable households over the housing cycle - 6 months rolling averages", fig.dim=c(6, 4), message=FALSE, warning=FALSE,  echo=FALSE, out.width='66%', results=FALSE}
# get first the position of house price troughs from a smoothed HPI line
# (not as necessary for troughs as for peaks, which are more irreglar)
# HPI_troughs <- find_peaks_smoothed( -outfile_2$`Sale HPI`, m=10, smoothedPerdiods = 12)
# translate the position of troughs into the corresponding periods to use later in graph
trough_period <- c(outfile_2$`Model time`[HPI_troughs])


outfile_2_tmp <- outfile_2 %>%
  select("vulnerable by purchase", "vulnerable by dissaving",  "vulnerable by other", "non-vulnerable by sale", "non-vulnerable by saving",  "non-vulnerable by other",`nVulHH (X*medIncome Y*m)`)%>%
  mutate(`non-vulnerable by sale` = -`non-vulnerable by sale`,
         `non-vulnerable by saving` = -`non-vulnerable by saving`,
         `non-vulnerable by other` = -`non-vulnerable by other`)

outfile_2_tmp <- as.matrix(outfile_2_tmp)/outfile_2$TotalPopulation # adjust for % of total population
outfile_2_tmp <- as.data.frame(runmean(outfile_2_tmp, rolling_averages)) # build a rolling average (6 for 6 months)
colnames(outfile_2_tmp) <- list("vulnerable by purchase", "vulnerable by dissaving",  "vulnerable by other", "non-vulnerable by sale", "non-vulnerable by saving",  "non-vulnerable by other", "vul HH") # abbreviate colnames for figure

outfile_2_tmp <- outfile_2_tmp %>%
  mutate(change = `vul HH`- lag(`vul HH`))%>%
  bind_cols(outfile_2$`Model time`, outfile_2$`Sale HPI`)%>%
  select(-`vul HH`) %>%
  pivot_longer(c("vulnerable by purchase", "vulnerable by dissaving",  "vulnerable by other", "non-vulnerable by sale", "non-vulnerable by saving",  "non-vulnerable by other"))  ## prepare for boxplots

colnames(outfile_2_tmp) <- list("change", "Period","HousePriceIndex", "cause", "value")
outfile_2_tmp$cause <- factor(outfile_2_tmp$cause, levels =c("vulnerable by other",  "vulnerable by purchase",  "vulnerable by dissaving", 
                                                          "non-vulnerable by other", "non-vulnerable by sale", "non-vulnerable by saving"))
# this is so I can display "change rate" and "HPI" in the graph. 
dat_text <- data.frame(
  label = c("change \nrate", "house price \nindex (rhs)"),
  Period = c(mean(c(trough_period[troughs_limits[1]],trough_period[troughs_limits[2]])+20), mean(c(trough_period[troughs_limits[1]],trough_period[troughs_limits[2]]))+20), # +10 here to shift to the right
  value = c(- 0.0015, 0.0025),
  # value = -mean(range(outfile_2_tmp$value)), 
  cause = c("vulnerable by other", "vulnerable by other")) # this is arbitrary, but otherwise it will not plot

# parameters for figure
relation_rhs_lhs <- 400
color_set_1 <- cet_pal(5, name = "r3") # color sets also used for later figure
color_set_2 <- c(color_set_1[1:3],cet_pal(6, name = "r1")[4:6]) #, cet_pal(10, name = "r1")[6], cet_pal(10, name = "r1")[8])

outfile_2_tmp %>%
  filter(Period >= trough_period[troughs_limits[1]], Period <= trough_period[troughs_limits[2]])%>%
  ggplot(aes(x=Period, fill =cause))+
  geom_col( aes(y = value))+
  geom_line( aes(y = change), size=1, color = "darkred")+
  geom_line( aes(y = HousePriceIndex / relation_rhs_lhs), size=1, linetype="dashed") +
  scale_y_continuous(
    # Features of the first axis
    name = "share of vulnerable households",
    labels = scales::percent,
    # Add a second axis and specify its features
    sec.axis = sec_axis(~ . *relation_rhs_lhs, name="House Price Index"),
    expand = expansion(mult = c(0, 0.05)) # make the barplots start at the axis
  ) +
  scale_x_continuous(expand = expansion(mult = c(0,0)))+
  # theme_classic()+
  theme(legend.position = "bottom") +
  theme(legend.background = element_blank()) +  # Remove overall border
  theme(legend.key = element_blank()) +
  scale_fill_manual(values = color_set_2)+ 
  geom_text(data = dat_text, aes(y= value), hjust = 0.1, vjust = 0.1, label = c("change \nrate (lhs)", "house price \nindex (rhs)"), color = c("darkred","black"), size=3.5)


```

Figure \@ref(fig:contributorsVulnerability) shows the causes for increases and decreases in the share of financially vulnerable households in detail. The red line shows the overall resulting change of the share of vulnerable households. Similar to the classification above, the economic actions of households reducing financial vulnerability are divided into *non-vulnerable by sales*---when they just sold property and ceased to be vulnerable---and *non-vulnerable by saving*---when they have a positive saving rate and did not just sell property. The rest---death, regular repayment, inheritance and increases in income turning the financial margin positive, but not the saving rate---are subsumed under the label *other*.

The figure shows that the overall increase in financial vulnerability by purchase in the upswing is dampened by vulnerable households both selling properties and saving deposit buffers. This savings response comes mainly from households that have become vulnerable through purchases but have sufficiently high incomes to save quickly above the vulnerability threshold. Around the middle of the house price downturn, the saving channel is stronger than the dissaving channel, leading to a reduction in overall vulnerability. Here, not only the share of households vulnerable by purchases decreases, but also the share of households vulnerable by dissaving.

## Characteristics of Financially Vulnerable Households

To understand what type of households become financially vulnerable, Figure \@ref(fig:distributionsVulHH) compares the distributions of different characteristics of households. The household types are households vulnerable by purchase and vulnerable by dissaving as well as non-vulnerable households with a mortgage. The distributions consist of aggregated monthly data, implying that households that have been vulnerable for two months are effectively double weighted compared to households that have been vulnerable for only one month. What emerges are clear differences between vulnerable (green and yellow) and non-vulnerable households (grey). Financially vulnerable households have lower income than non-vulnerable households and tend to be more highly leveraged. While the credit volume taken out is similar between vulnerable and non-vulnerable households, vulnerable households have lower incomes, resulting in higher debt-service-to-income ratios (DSR). As the median DSR of all indebted households is on average `r line_results_median[["medianDebtServiceRatio"]]` these households end up above the set threshold where housing wealth affects their consumption.

```{r distributionsVulHH, fig.cap="Densitiy curves and median values (striped lines) of central attributes of financially vulnerable and indebted non-vulnerable households", fig.subcap=c("Income", "Debt for last \\newline property purchase",  "Debt-Service-to-Income Ratio", "Deposits before last \\newline property purchase", "House price index at \\newline last property purchase", "Age"),  fig.show='hold', message=FALSE, warning=FALSE, fig.ncol = 3, out.width='33%', results=FALSE,  echo=FALSE}
transactions_to_join <- transactions_vul_2 %>%
  filter(transactionType == "sale")

sortingData_for_figure <-  agent_data_vul_2%>%
  mutate(agent = case_when(
    isBTL==1 & inFirstHome==0 & isFTB==0 ~ "BTL", 
    # isBTL ==0 & inFirstHome == 0 &isFTB==0 ~ "Mover", 
    # isFTB ==1 ~ "FirstTimeBuyer",
    # isBTL==1 &  isFTB==0 ~ "BTL", 
    NHouses>0 & isBTL == 0 & inFirstHome == 0 ~ "SSB",
    inFirstHome==1 ~ "FTB", 
    NHouses==0 ~ "Renter"))%>%
  mutate(ConsumptionNetHousingWealth = ConsHWealth + ConsDebt)%>%
  mutate(ConsumptionNetWealth = ConsHWealth + ConsDebt+ConsFWealth)%>%
  filter(Debt < 0)%>%
  filter(FinVulReason != "other")%>%
  filter(Period >= 2300)%>%
  # distinct(id, .keep_all = TRUE) %>%
  mutate(DTI = Debt/(-12* MonthlyGrossTotalIncome))%>%
  mutate(DSR = MonthlyMortgagePayments/MonthlyGrossTotalIncome)%>%
  mutate(CTI = Consumption/MonthlyDisposableIncome) %>%
  mutate(hasDebt = case_when(Debt<0 ~ TRUE, TRUE ~ FALSE))%>%
  left_join(transactions_to_join, by = c("id" = "buyerId"))%>%
  mutate(principal = transactionPrice-mortgageDownpayment)%>%
  mutate(LTV = principal/transactionPrice)%>%
  mutate(LTI = principal/ (12*buyerMonthlyGrossTotalIncome))%>%
  mutate(prePurchaseDeposits = mortgageDownpayment+buyerPostPurchaseBankBalance) %>%
  mutate(howLongAgo = Period - `Model time`) %>% # time now - time of purchase
  filter(howLongAgo > 0)%>% # future purchases have to be excluded (i.e. at period 2300 a purchase in period 2320 or similar)
  group_by(id, Period) %>% top_n(-1, howLongAgo)  # each vul HH each period has the last purchase "attached to them"

nrBins <- 20
color_temp <- cet_pal(5, name = "r3") # color sets also used for later figure
color_set_distr <- color_temp[c(3,2,4)]
color_set_distr[3] <- "darkgrey"
sortingData_for_figure$FinVulReason <- factor(sortingData_for_figure$FinVulReason, levels =c("dissaving", "purchase", "not vulnerable"))


################### INCOME
core_means <- sortingData_for_figure %>%
  group_by(FinVulReason) %>%
  summarise(coreIndicator = median(MonthlyGrossTotalIncome, na.rm = TRUE))

sortingData_for_figure %>%
  ggplot(aes(MonthlyGrossTotalIncome, fill = FinVulReason))+
  # ggtitle("Model households \nsubgroup indebted households")+
  geom_density(alpha = 0.5, position = "identity" , adjust = 5)+
  xlab("Monthly Gross Total Income \nand median value, between 0-7000")+
  # geom_histogram(alpha = 0.5, position = "identity", bins = nrBins )+
  xlim(c(0,7000))+
  geom_vline(
    data = core_means, linetype = "dashed", size = 1,
    aes(xintercept = coreIndicator, colour = FinVulReason)) +
  scale_fill_manual(values = color_set_distr) +
  scale_color_manual(values = color_set_distr)


################### DEBT
core_means <- sortingData_for_figure %>%
  group_by(FinVulReason) %>%
  summarise(coreIndicator = median(principal, na.rm = TRUE))

sortingData_for_figure %>%
  ggplot(aes(principal, fill = FinVulReason))+
  # ggtitle("Model households \nsubgroup indebted households")+
  geom_density(alpha = 0.5, position = "identity" , adjust = 5)+
  xlab("Debt taken out at last purchase (log scale) \nand median value between 1000 and 1 million")+
  # geom_histogram(alpha = 0.5, position = "identity", bins = nrBins )+
  scale_x_log10(limits = c(1000,1000000))+
  geom_vline(
    data = core_means, linetype = "dashed", size = 1,
    aes(xintercept = coreIndicator, colour = FinVulReason)) +
  scale_fill_manual(values = color_set_distr) +
  scale_color_manual(values = color_set_distr)



################### DSR
core_means <- sortingData_for_figure %>%
  group_by(FinVulReason) %>%
  summarise(coreIndicator = median(DSR, na.rm = TRUE))

sortingData_for_figure %>%
  ggplot(aes(DSR, fill = FinVulReason))+
  # ggtitle("Model households \nsubgroup indebted households")+
  geom_density(alpha = 0.5, position = "identity" , adjust = 5)+
  xlab("Debt-Service-Ratio and median value between 0 and 0.75")+
  # geom_histogram(alpha = 0.5, position = "identity", bins = nrBins )+
  xlim(c(0,0.75))+
  geom_vline(
    data = core_means, linetype = "dashed", size = 1,
    aes(xintercept = coreIndicator, colour = FinVulReason)) +
  scale_fill_manual(values = color_set_distr) +
  scale_color_manual(values = color_set_distr)

################### pre-purchase deposits
core_means <- sortingData_for_figure %>%
  group_by(FinVulReason) %>%
  summarise(coreIndicator = median(prePurchaseDeposits, na.rm = TRUE))

sortingData_for_figure %>%
  ggplot(aes(prePurchaseDeposits, fill = FinVulReason))+
  # ggtitle("Model households \nsubgroup indebted households")+
  geom_density(alpha = 0.5, position = "identity" , adjust = 5)+
  xlab("Deposits right before purchase (log scale)\nbetween 1000 and 1 million")+
  # geom_histogram(alpha = 0.5, position = "identity", bins = nrBins )+
  scale_x_log10(limits = c(1000,1000000))+
  geom_vline(
    data = core_means, linetype = "dashed", size = 1,
    aes(xintercept = coreIndicator, colour = FinVulReason)) +
  scale_fill_manual(values = color_set_distr) +
  scale_color_manual(values = color_set_distr)

################### SALE HPI
core_means <- sortingData_for_figure %>%
  group_by(FinVulReason) %>%
  summarise(coreIndicator = median(`Sale HPI.y`, na.rm = TRUE))

sortingData_for_figure %>%
  ggplot(aes(`Sale HPI.y`, fill = FinVulReason))+
  # ggtitle("Model households \nsubgroup indebted households")+
  geom_density(alpha = 0.5, position = "identity" , adjust = 5)+
  xlab("House price index when \nhoushold bought last property")+
  # geom_histogram(alpha = 0.5, position = "identity", bins = nrBins )+
  # xlim(c(0,0.75))+
  geom_vline(
    data = core_means, linetype = "dashed", size = 1,
    aes(xintercept = coreIndicator, colour = FinVulReason)) +
  scale_fill_manual(values = color_set_distr) +
  scale_color_manual(values = color_set_distr)
################# age
core_means <- sortingData_for_figure %>%
  group_by(FinVulReason) %>%
  summarise(coreIndicator = median(Age, na.rm = TRUE))

sortingData_for_figure %>%
  ggplot(aes(Age, fill = FinVulReason))+
  # ggtitle("Model households with top66%income FTB saving motive 60%\nsubgroup indebted households")+  #\nlowest income quartile exempt
  geom_density(alpha = 0.6, position = "identity" , adjust = 5)+
  # geom_histogram(alpha = 0.5, position = "identity", bins = nrBins )+
  xlim(c(20,80))+
  xlab("Age and median value between 20 and 80")+
  geom_vline(
    data = core_means, linetype = "dashed", size = 1,
    aes(xintercept = coreIndicator, color = FinVulReason)
  ) +
  scale_fill_manual(values = color_set_distr) +
  scale_color_manual(values = color_set_distr)

```

Some differences emerge between households vulnerable by purchases and vulnerable by dissaving. The deposits held just before the latest home purchase (which can be used as down payments) tend to be lower for households vulnerable by purchase. With comparable mortgage debt taken out to buy houses at comparable price levels (i.e. similar purchase prices), these lower deposits at purchase lead to lower deposits after purchase, and thus lower financial buffers. As is shown in more detail in section \@ref(financial-vulnerability-by-agent-class) in the Appendix, households vulnerable by purchase are almost exclusively first-time buyers, while households vulnerable by dissaving are almost in equal parts first-time buyer and mover. Buy-to-let investors on the other hand, due to their higher income, are unlikely to become vulnerable at all.

## Path Dependency of Financial Vulnerability

```{r loadValuesPathDependency, echo=FALSE, message=FALSE, warning=FALSE, results=FALSE}
last_trough <- length(trough_period) # this might not be precise
period_to_filter <- c(trough_period[last_trough],trough_period[last_trough]+50) # +50 is approximately the peak of fin vul by dissaving
HowLongBackPathDependency <- as.numeric(properties_file$MORTGAGE_DURATION_YEARS) * 12 
```

Due to their long contract maturity, debt-financed property purchases could influence the financial vulnerability of households for a long time [@DrehmannEtAl2018]. In the model, households become financially vulnerable at different points in time during the life of their mortgage contract and at different stages of the house price cycle. This section examines this relationship between the points in time in the terms of the vulnerable households' mortgage contracts and the house price cycle.

To this end, in Figure \@ref(fig:whenVulBuy), vulnerable households are compared at two specific points in the house price cycle with respect to their most recent real estate purchase. The left panel of Figure \@ref(fig:whenVulBuy) maps the last real estate purchase of households vulnerable in a house price trough---which is where the blue striped line intercepts (period `r period_to_filter[1]`). The right panel does the same for right after the subsequent house price upswing (marked again by the dotted line) where the share of households vulnerable by dissaving is highest. The dots symbolize one household's last property purchase. The dots are positioned according to when (x-axis) and at what price levels (y-axis) the household bought their last property. The graph is looking back 25 years, which is the maturity of all mortgage contracts.

```{r whenVulBuy, fig.cap="When did households, vulnerable at house price peak and trough buy?",fig.subcap=c("Last purchases of households vulnerable at trough \\newline House price level at last purchase", "Last purchase of households vulnerable at peak \\newline House price level at last purchase"),  fig.show='hold', message=FALSE, warning=FALSE, out.width='49%', results=FALSE,  echo=FALSE}

# period_to_filter <- c(2368,2414)
color_set_1 <- cet_pal(5, name = "r3") # color sets also used for later figure

vul_certain_period_trough <-agent_data_vul_2%>%
  mutate(agent = case_when(
    isBTL==1 & inFirstHome==0 & isFTB==0 ~ "BTL", 
    # isBTL ==0 & inFirstHome == 0 &isFTB==0 ~ "Mover", 
    # isFTB ==1 ~ "FirstTimeBuyer",
    # isBTL==1 &  isFTB==0 ~ "BTL", 
    NHouses>0 & isBTL == 0 & inFirstHome == 0 ~ "SSB",
    inFirstHome==1 ~ "FTB", 
    NHouses==0 ~ "Renter"))%>%
  filter(FinVulReason != "not vulnerable")%>%
  filter(FinVulReason != "other")%>%
  filter(Period == period_to_filter[1])%>%
  # filter(agent=="inFirstHome")%>%
  left_join(transactions_vul_2, by = c("id" = "buyerId"))%>%
  mutate(principal = transactionPrice-mortgageDownpayment)%>%
  mutate(prePurchaseDeposits = principal+buyerPostPurchaseBankBalance) %>%
  mutate(LTV = principal/transactionPrice)%>%
  mutate(LTI = principal/ (12*buyerMonthlyGrossTotalIncome))%>%
  mutate(howLongAgo = Period - `Model time`) %>%
  filter(transactionType == "sale")%>%
  filter(howLongAgo > 0)%>%
  group_by(id) %>% top_n(-1, howLongAgo) 

vul_certain_period_peak <-agent_data_vul_2%>%
  mutate(agent = case_when(
    isBTL==1 & inFirstHome==0 & isFTB==0 ~ "BTL", 
    # isBTL ==0 & inFirstHome == 0 &isFTB==0 ~ "Mover", 
    # isFTB ==1 ~ "FirstTimeBuyer",
    # isBTL==1 &  isFTB==0 ~ "BTL", 
    NHouses>0 & isBTL == 0 & inFirstHome == 0 ~ "SSB",
    inFirstHome==1 ~ "FTB", 
    NHouses==0 ~ "Renter"))%>%
  filter(FinVulReason != "not vulnerable")%>%
  filter(FinVulReason != "other")%>%
  filter(Period == period_to_filter[2])%>%
  # filter(agent=="inFirstHome")%>%
  left_join(transactions_vul_2, by = c("id" = "buyerId"))%>%
  mutate(principal = transactionPrice-mortgageDownpayment)%>%
  mutate(prePurchaseDeposits = principal+buyerPostPurchaseBankBalance) %>%
  mutate(LTV = principal/transactionPrice)%>%
  mutate(LTI = principal/ (12*buyerMonthlyGrossTotalIncome))%>%
  mutate(howLongAgo = Period - `Model time`) %>%
  filter(transactionType == "sale")%>%
  filter(howLongAgo > 0)%>%
  group_by(id) %>% top_n(-1, howLongAgo) 

########################### HPI und last sale
HPI_peaks <- find_peaks_smoothed(x = outfile_2$`Sale HPI`,m= 30,smoothedPerdiods = 24, paint = FALSE)
peak_periods <-   c(outfile_2$`Model time`[HPI_peaks])
# wideness_red_square <- 50

HPI1 <- outfile_2 %>%
  select(`Sale HPI`, `Model time`)%>%
  filter(`Model time` <= period_to_filter[1])

colnames(HPI1) <- list("House Price Index", "Period") 

data1 <- vul_certain_period_trough %>%
  filter(agent != "Renter")  # Households selling their homes at the end of the period could be still recorded vulnerable (which happens at the beginning of a period) - very rarely

(ggplot(data = HPI1, aes(y = `House Price Index`, x = Period) )+
    geom_line( size=0.5, linetype="dashed", color = "black")+ 
    geom_point(data = data1, aes(x = `Model time`,y= `Sale HPI.y`, color = FinVulReason), position = position_jitter(width = 0.025, height = 0.025))+
    xlab(paste0("In what period did the household - vulnerable\nin period ", period_to_filter[1], " - buy its last property?"))+
    ylab(paste0("At what house price index did the household - vulnerable\nin period ", period_to_filter[1], " - buy its last property?")) +
    theme(legend.position = "bottom") +
    ylim(c(0.10, 1.5)) +
    xlim(c(period_to_filter[1] - HowLongBackPathDependency, period_to_filter[2])) + 
    geom_vline(
      xintercept = period_to_filter[1], linetype = 2, size = 1, color = "darkblue" 
    )+
    scale_color_manual(values = color_set_1[c(3,2)])+
    annotate("text", x = peak_periods[last_trough], y = 0.8, label = "all purchases\ndepicted\n belong to\nhouseholds\nvulnerable\nnow", color = "darkblue")) 


########################### HPI und last sale
HPI2 <- outfile_2 %>%
  select(`Sale HPI`, `Model time`)%>%
  filter(`Model time` <= period_to_filter[2])

colnames(HPI2) <- list("House Price Index", "Period") 


data2 <- vul_certain_period_peak %>%
  filter(agent != "Renter")  # Households selling their homes at the end of the period could be still recorded vulnerable (which happens at the beginning of a period) - very rarely
  
(ggplot(data = HPI2, aes(y = `House Price Index`, x = Period) )+
    geom_line( size=0.5, linetype="dashed", color = "black")+ 
    geom_point(data = data2, aes(x = `Model time`,y= `Sale HPI.y`, color = FinVulReason), position = position_jitter(width = 0.025, height = 0.025))+
    xlab(paste0("In what period did the household - vulnerable\nin period ", period_to_filter[2], " - buy its last property?"))+
    ylab(paste0("At what house price index did the household - vulnerable\nin period ", period_to_filter[2], " - buy its last property?")) +
    theme(legend.position = "bottom") +
    ylim(c(0.10, 1.5)) +
    xlim(c(period_to_filter[1] - HowLongBackPathDependency, period_to_filter[2])) + 
    geom_vline(
      xintercept = period_to_filter[2], linetype =2, size = 1, color = "darkblue"
    )+
    scale_color_manual(values = color_set_1[c(3,2)]) 
    # annotate("rect", xmin = peak_periods[last_trough - 3] - wideness_red_square / 2, xmax = peak_periods[last_trough - 3] + wideness_red_square / 2, ymin = 1, ymax = 1.4, alpha = 0, color = "red") +
    #     annotate("rect", xmin = peak_periods[last_trough - 2] - wideness_red_square / 2, xmax = peak_periods[last_trough - 2] + wideness_red_square / 2, ymin = 1, ymax = 1.4, alpha = 0, color = "red") +
    # annotate("rect", xmin = peak_periods[last_trough - 1] - wideness_red_square / 2, xmax = peak_periods[last_trough - 1] + wideness_red_square / 2, ymin = 1, ymax = 1.4, alpha = 0, color = "red") +
    # annotate("text", x = 2280, y = 1.2, label = "purchases of newly vulnerable with high prices", color = "red")+
    # annotate("text", x = 2420, y = 0.8, label = "all house-\nholds \ndepicted\nare\nvulnerable\nin this\nperiod", color = "darkblue")
)

```

The green dots in the left panel show that when house prices are currently low, only few households are vulnerable by purchase where some either just bought property (close to the striped blue line) or up to two house price cycles past. The limited horizontal spread of these green dots suggests limited path dependency of financial vulnerability induced by purchases.[^18] Households vulnerable by dissaving (yellows dots) have their last property purchases more equally distributed over the past three housing cycles.

[^18]: Households vulnerable by purchase in the current period had to be---following from the distinction made here between vulnerability channels---vulnerable continuously from their last property purchase until the current period.

The right panel of Figure \@ref(fig:whenVulBuy) shows the financially vulnerable households `r period_to_filter[2] - period_to_filter[1]` periods later than the in the left panel, shortly after the house price peak (marked again by the dotted line). Most households that became newly vulnerable and bought their last property between period `r period_to_filter[1]` and `r period_to_filter[2]` (in other words, in the periods between the left and the right panel) became vulnerable by purchase. However, even more households becoming newly vulnerable bought their last property at a previous house price peak. This suggests that the current high property prices increase the vulnerability of households that bought their last property at an earlier peak in house prices. In Table \@ref(tab:vulnerbilityTable) in the Appendix \@ref(supplemental-figures-and-tables) the generality of this finding is confirmed for the whole simulation run.

Looking at the micro data tells us that these households---highly leveraged by the property purchase---experienced very low or even negative equity when house prices are falling. Low or even negative equity leads to overall more households spending less than they earn, thereby increasing their financial buffer. When house prices rise again, their net housing wealth turns positive, inducing the depletion of their savings.

In summary, purchases during previous house price peaks in particular increase current vulnerability when house prices are high. This would imply that past real estate price cycles should be considered when making predictions about future financial vulnerability. The longer and higher past house price phases, the higher the sensitivity of financial vulnerability to current price movements.

# Conclusion

This paper analyses two important contributors to financial vulnerability of mortgage holders stemming from housing market dynamics, using an agent-based housing market model. Purchases, as well as consumption induced by a housing wealth effect have been found to be central to understanding financial vulnerability dynamics.

In the model, purchasing and dissaving impact financial vulnerability at different points in the house price cycle. The purchasing channel increases the share of vulnerable households mainly in the upswing when households buy properties. The dissaving channel on the other hand is more important at high prices, where increases are rooted in the consumption of financial buffers, due to a housing wealth effect. Lower prices lead to a build-up of financial buffers, reducing financial vulnerability.

Financially vulnerable households tend to have lower income than non-vulnerable homeowners while being highly leveraged. Especially first-time-buyers become vulnerable by purchasing their first home. Second-and-subsequent buyers tend to become vulnerable by dissaving more frequently and buy-to-let agents become barely vulnerable at all. Finally, financial vulnerability showed strong path dependencies. Households that bought property at past house price peaks contributed to financial vulnerability when current house prices were high, driven by the depletion of their financial buffer due to housing wealth induced consumption.

<!--# hier einfÃ¼gen sowas wie: the influence of income shocks have not been analysed. That is that in the model households have a very stable employment income and they are not subject to any income shocks. The buffer we implemented is rudimentary and constant over the house price cycle, where the "chance" of households experiencing actual income shocks is higher. Changes in interest rates have even been adressed less. -->

The agent-based model utilized was able reproduce important stylized facts. However, it also has some shortcomings that could influence the results. House prices tend to fall to unrealistically low levels, due to missing stabilizing mechanisms. This limitation could allow lower-income households to enter the housing market (earlier), thereby increasing the share of young, financially vulnerable households. However, the age distributions in Figure \@ref(fig:distributionsVulHH) in Chapter \@ref(characteristics-of-financially-vulnerable-households) and Figure \@ref(fig:AgeWAS) in Appendix \@ref(additional-calibration-results) does not suggest that this is actually the case. Too low troughs could also increase deleveraging of households due to the housing wealth effect. However, deleveraging is usually limited by households' income. Another limitation of the model is the missing macroeconomy, implying that consumption responses do not feed back into households' income. The implementation of an income buffer into the definition of financially vulnerable households is able to include some general income risk, however, this constant over the house price cycle. Implementing a wider macroeconomy is therefore a promising path for further research but out of scope for this paper.

With these limitations in mind, the analysis showed that a wealth effect that is sensitive to collateral vallues could be important in explaining dynamics of financial vulnerability over the house price cycle. At the same time, the effects can be very long-lasting and levels of financial vulnerability today depend to a large extent on past purchases (as well as on current price levels). This makes addressing them by policy somewhat difficult as even without any additional sale in the current cycle, financial vulnerability could increase when house prices are high.

\FloatBarrier

# Appendix {.unnumbered}

# (APPENDIX) Appendices {.unnumbered}

# Financial Vulnerability by Agent-Class

Interestingly, the differences between both vulnerability channels purchases and dissaving are mirrored, to some extent, by the agent classes. Figure \@ref(fig:stockVulAgentClass) shows that FTB agents are almost exclusively responsible for the purchasing channel. SSB agents usually hold higher deposits coming from the revenue of their previous home sale. BTL investors contribute almost nothing to the share of financially vulnerable households.

```{r, stockVulAgentClass, fig.cap="Share of financially vulnerable households by cause and agent-class - 6 months rolling averages", fig.show='hold', echo = FALSE, message=FALSE, warning=FALSE,  results=FALSE,  out.height= '25%'}

outfile_2_tmp <- outfile_2 %>%
  select( "nowVul Purchase BTL",	 "nowVul Dissaving BTL",	 "nowVul Other BTL",	"nowVul Purchase SSB",	 "nowVul Dissaving SSB",	 
          "nowVul Other SSB",	 "nowVul Purchase FTB",	 "nowVul Dissaving FTB",	 "nowVul Other FTB")


outfile_2_tmp <- as.matrix(outfile_2_tmp)/outfile_2$TotalPopulation # adjust for % of total population
outfile_2_tmp <- as.data.frame(runmean(outfile_2_tmp, rolling_averages)) # build a rolling average (6 for 6 months)

colnames(outfile_2_tmp) <- list("nowVul Purchase BTL",	 "nowVul Dissaving BTL",	 "nowVul Other BTL",	"nowVul Purchase SSB",	 "nowVul Dissaving SSB",	 
                              "nowVul Other SSB",	 "nowVul Purchase FTB",	 "nowVul Dissaving FTB",	 "nowVul Other FTB") # abbreviate colnames for figure



outfile_2_tmp <- outfile_2_tmp %>%
  bind_cols(outfile_2$`Model time`, outfile_2$`Sale HPI`)%>%
  pivot_longer(c("nowVul Purchase BTL",	 "nowVul Dissaving BTL",	 "nowVul Other BTL",	"nowVul Purchase SSB",	 "nowVul Dissaving SSB",	 
                 "nowVul Other SSB",	 "nowVul Purchase FTB",	 "nowVul Dissaving FTB",	 "nowVul Other FTB"))  ## prepare for boxplots

colnames(outfile_2_tmp) <- list("Period","HousePriceIndex", "vulnerable_by", "value")
outfile_2_tmp <- outfile_2_tmp %>%
  mutate(agent = case_when(vulnerable_by %in%c ("nowVul Purchase BTL",	 "nowVul Dissaving BTL",	 "nowVul Other BTL") ~ "BTL",
                           vulnerable_by %in% c("nowVul Purchase SSB",	 "nowVul Dissaving SSB",	 "nowVul Other SSB") ~ "SSB",
                           vulnerable_by %in% c("nowVul Purchase FTB",	 "nowVul Dissaving FTB",	 "nowVul Other FTB") ~ "FTB"))%>%
  mutate(vulnerable_by = case_when(vulnerable_by %in% c("nowVul Purchase BTL", "nowVul Purchase SSB",	"nowVul Purchase FTB") ~ "purchase",
                                   vulnerable_by %in% c("nowVul Dissaving BTL", "nowVul Dissaving SSB", "nowVul Dissaving FTB") ~ "dissaving",
                                   vulnerable_by %in% c( "nowVul Other BTL", "nowVul Other SSB", "nowVul Other FTB") ~ "other")) %>%
  mutate(value = formattable::percent(value))

outfile_2_tmp$vulnerable_by <- factor(outfile_2_tmp$vulnerable_by, levels = c("other", "purchase", "dissaving"))
# outfile_2_tmp$vulnerable_by <- factor(outfile_2_tmp$vulnerable_by, levels = c("other", "dissaving", "purchase"))

color_set_1 <- cet_pal(5, name = "r3") # color sets also used for later figure

# parameters for figure
relation_rhs_lhs <- 80

outfile_2_tmp %>%
    filter(Period >= trough_period[troughs_limits[1]], Period <= trough_period[troughs_limits[2]])%>%
  ggplot(aes(x=Period, fill = vulnerable_by))+
  geom_col( aes(y = value))+
  geom_line( aes(y = HousePriceIndex / relation_rhs_lhs), size=0.25, linetype="dashed") +
  scale_y_continuous(
    # Features of the first axis
    name = "share of vulnerable households",
    labels = scales::percent,
    # Add a second axis and specify its features
    sec.axis = sec_axis(~ . *relation_rhs_lhs, name="House Price Index"),
    expand = expansion(mult = c(0, 0.05)) # make the barplots start at the axis
  ) +
  scale_x_continuous(expand = expansion(mult = c(0,0)))+
  # theme_classic()+
  theme(legend.position = "bottom") +
  theme(legend.background = element_blank()) +  # Remove overall border
  theme(legend.key = element_blank()) +
  scale_fill_manual(values = color_set_1)+
  facet_wrap( ~ agent) # , scales = "free")
# labs(caption = "Notes: Your long reference footnote goes in here. UNd Ã¼brigensBesonders krass\n dass das so ist")
```

```{r, flowAgentClass, fig.cap="Causes for changes in the vulnerability of agent-classes", fig.show='hold', message=FALSE, echo=FALSE, warning=FALSE,  results=FALSE,  echo=FALSE, eval=FALSE, out.height= '33%'}
outfile_2_tmp <- outfile_2 %>%
  select("Vulnerable By Purchase BTL",	"Vulnerable By Purchase SSB",	 "Vulnerable By Purchase InFirstHome",	"Vulnerable By Consumption BTL",	 "Vulnerable By Consumption SSB",	 "Vulnerable By Consumption InFirstHome",	"Vulnerable By Other BTL",	 "Vulnerable By Other SSB",	 "Vulnerable By Other InFirstHome",	"Non-Vulnerable Because Sale BTL",	 "Non-Vulnerable Because Sale SSB",	 "Non-Vulnerable Because Sale InFirstHome", "Non-Vulnerable Because Saving BTL",	 "Non-Vulnerable Because Saving SSB",	 "Non-Vulnerable Because Saving InFirstHome",	 "Non-Vulnerable Because Other BTL",	 "Non-Vulnerable Because Other SSB",	 "Non-Vulnerable Because Other InFirstHome",
         "nVul activeBTL (X*medIncome Y*m)", "nVul inFirstHome (X*medIncome Y*m)",	"nVul SSB (X*medIncome Y*m)")

# set non-vulnerable values as negative
outfile_2_tmp <- outfile_2_tmp %>%
  mutate(`Non-Vulnerable Because Sale BTL` = - `Non-Vulnerable Because Sale BTL`,	 `Non-Vulnerable Because Sale SSB` = - `Non-Vulnerable Because Sale SSB`, 
         `Non-Vulnerable Because Sale InFirstHome` = - `Non-Vulnerable Because Sale InFirstHome`, `Non-Vulnerable Because Saving BTL` = - `Non-Vulnerable Because Saving BTL`,
         `Non-Vulnerable Because Saving SSB` = - `Non-Vulnerable Because Saving SSB`,	 `Non-Vulnerable Because Saving InFirstHome` = - `Non-Vulnerable Because Saving InFirstHome`,
         `Non-Vulnerable Because Other BTL` = - `Non-Vulnerable Because Other BTL`,	 `Non-Vulnerable Because Other SSB` = - `Non-Vulnerable Because Other SSB`,	
         `Non-Vulnerable Because Other InFirstHome` = - `Non-Vulnerable Because Other InFirstHome`) 


outfile_2_tmp <- as.matrix(outfile_2_tmp)/outfile_2$TotalPopulation # adjust for % of total population
outfile_2_tmp <- as.data.frame(runmean(outfile_2_tmp, rolling_averages)) # build a rolling average (6 for 6 months)

colnames(outfile_2_tmp) <- list("Vulnerable By Purchase BTL",	"Vulnerable By Purchase SSB",	 "Vulnerable By Purchase InFirstHome",	"Vulnerable By Consumption BTL",	 "Vulnerable By Consumption SSB",	 "Vulnerable By Consumption InFirstHome",	"Vulnerable By Other BTL",	 "Vulnerable By Other SSB",	 "Vulnerable By Other InFirstHome",	"Non-Vulnerable Because Sale BTL",	 "Non-Vulnerable Because Sale SSB",	 "Non-Vulnerable Because Sale InFirstHome", "Non-Vulnerable Because Saving BTL",	 "Non-Vulnerable Because Saving SSB",	 "Non-Vulnerable Because Saving InFirstHome",	 "Non-Vulnerable Because Other BTL",	 "Non-Vulnerable Because Other SSB",	 "Non-Vulnerable Because Other InFirstHome",
         "nVul activeBTL", "nVul inFirstHome",	"nVul SSB") 

## build a file with periods, HPI and the change in share of vulnerable households by agent-class
outfile_2_tmp1 <- outfile_2_tmp %>%
  mutate(change_BTL = `nVul activeBTL` - lag(`nVul activeBTL`),
         change_SSB = `nVul SSB` - lag(`nVul SSB`),
         change_FTB = `nVul inFirstHome` - lag(`nVul inFirstHome`))%>%
  select(-c(`nVul activeBTL`, `nVul SSB`,`nVul inFirstHome`, "Vulnerable By Purchase BTL",	"Vulnerable By Purchase SSB",	 "Vulnerable By Purchase InFirstHome",	"Vulnerable By Consumption BTL",	 "Vulnerable By Consumption SSB",	 "Vulnerable By Consumption InFirstHome",	"Vulnerable By Other BTL",	 "Vulnerable By Other SSB",	 "Vulnerable By Other InFirstHome",	"Non-Vulnerable Because Sale BTL",	 "Non-Vulnerable Because Sale SSB",	 "Non-Vulnerable Because Sale InFirstHome", "Non-Vulnerable Because Saving BTL",	 "Non-Vulnerable Because Saving SSB",	 "Non-Vulnerable Because Saving InFirstHome",	 "Non-Vulnerable Because Other BTL",	 "Non-Vulnerable Because Other SSB",	 "Non-Vulnerable Because Other InFirstHome")) %>%
  bind_cols(outfile_2$`Model time`) %>%
  pivot_longer(c("change_BTL", "change_SSB", "change_FTB"))
colnames(outfile_2_tmp1) <- list("Period", "agent_change", "change")

outfile_2_tmp1 <- outfile_2_tmp1 %>%
  mutate(agent = case_when(agent_change == "change_BTL" ~ "BTL",
                           agent_change == "change_SSB" ~ "SSB",
                           agent_change == "change_FTB" ~ "FTB"))

# build a data frame where the causes for vulnerability become a "factor" and the values are gathered in one column (for graph)
outfile_2_tmp <- outfile_2_tmp %>%
  bind_cols(outfile_2$`Model time`, outfile_2$`Sale HPI`) %>%
  select(-c(`nVul activeBTL`, `nVul SSB`,`nVul inFirstHome`))%>%
  pivot_longer(c("Vulnerable By Purchase BTL",	"Vulnerable By Purchase SSB",	 "Vulnerable By Purchase InFirstHome",	"Vulnerable By Consumption BTL",	 "Vulnerable By Consumption SSB",	 "Vulnerable By Consumption InFirstHome",	"Vulnerable By Other BTL",	 "Vulnerable By Other SSB",	 "Vulnerable By Other InFirstHome",	"Non-Vulnerable Because Sale BTL",	 "Non-Vulnerable Because Sale SSB",	 "Non-Vulnerable Because Sale InFirstHome", "Non-Vulnerable Because Saving BTL",	 "Non-Vulnerable Because Saving SSB",	 "Non-Vulnerable Because Saving InFirstHome",	 "Non-Vulnerable Because Other BTL",	 "Non-Vulnerable Because Other SSB",	 "Non-Vulnerable Because Other InFirstHome")) 

colnames(outfile_2_tmp) <- list("Period","HousePriceIndex", "vulnerability", "value")

outfile_2_tmp <- outfile_2_tmp %>%
  mutate(agent = case_when(vulnerability %in%c( "Vulnerable By Purchase BTL"  , "Vulnerable By Consumption BTL", "Vulnerable By Other BTL", 
                                                "Non-Vulnerable Because Sale BTL" , "Non-Vulnerable Because Saving BTL" , "Non-Vulnerable Because Other BTL") ~ "BTL",
                           vulnerability %in% c("Vulnerable By Purchase SSB", "Vulnerable By Consumption SSB", "Vulnerable By Other SSB",
                                                "Non-Vulnerable Because Sale SSB", "Non-Vulnerable Because Saving SSB","Non-Vulnerable Because Other SSB") ~ "SSB",
                           vulnerability %in% c("Vulnerable By Purchase InFirstHome", "Vulnerable By Consumption InFirstHome", "Vulnerable By Other InFirstHome",
                                                "Non-Vulnerable Because Sale InFirstHome", "Non-Vulnerable Because Saving InFirstHome","Non-Vulnerable Because Other InFirstHome") ~ "FTB"))%>%
  mutate(cause = case_when(vulnerability %in% c("Vulnerable By Purchase BTL",	"Vulnerable By Purchase SSB",	 "Vulnerable By Purchase InFirstHome") ~ "vulnerable by purchase",
                           vulnerability %in% c("Non-Vulnerable Because Sale BTL",	 "Non-Vulnerable Because Sale SSB",	 "Non-Vulnerable Because Sale InFirstHome") ~ "non-vulnerable by sale",
                           vulnerability %in% c("Vulnerable By Consumption BTL",	 "Vulnerable By Consumption SSB",	 "Vulnerable By Consumption InFirstHome") ~ "vulnerable by dissaving",
                           vulnerability %in% c("Non-Vulnerable Because Saving BTL",	 "Non-Vulnerable Because Saving SSB",	 "Non-Vulnerable Because Saving InFirstHome") ~ "non-vulnerable by saving",
                           vulnerability %in% c("Vulnerable By Other BTL",	 "Vulnerable By Other SSB",	 "Vulnerable By Other InFirstHome") ~ "vulnerable by other",
                           vulnerability %in% c("Non-Vulnerable Because Other BTL",	 "Non-Vulnerable Because Other SSB",	 "Non-Vulnerable Because Other InFirstHome") ~ "non-vulnerable by other"))

outfile_2_tmp$cause <- factor(outfile_2_tmp$cause, levels = c("vulnerable by other",  "vulnerable by purchase",  "vulnerable by dissaving", 
                                                          "non-vulnerable by other", "non-vulnerable by sale", "non-vulnerable by saving"))
# 
# #### Join tables 
outfile_2_tmp <- left_join(outfile_2_tmp, outfile_2_tmp1, by = c("Period", "agent"))%>%
  mutate(value = formattable::percent(value),
         change = formattable::percent(change))

# parameters for figure
relation_rhs_lhs <- 1000

color_set_1 <- cet_pal(5, name = "r3") # color sets also used for later figure
color_set_2 <- c(color_set_1[1:3],cet_pal(6, name = "r1")[4:6]) #, cet_pal(10, name = "r1")[6], cet_pal(10, name = "r1")[8])

# this is so I can display "change rate" and "HPI" in the graph. 
dat_text <- data.frame(
  label = c("change \nrate", "house price \nindex (rhs)"),
  Period = c(mean(c(trough_period[troughs_limits[1]],trough_period[troughs_limits[2]])+10), mean(c(trough_period[troughs_limits[1]],trough_period[troughs_limits[2]]))+10), # +10 here to shift to the right
  agent   = c("SSB", "SSB"),
  value = c(- 0.0005, 0.0015),
  # value = -mean(range(outfile_2_tmp$value)), 
  cause = c("vulnerable by other", "vulnerable by other")) # this is arbitrary, but otherwise it will not plot

p <- outfile_2_tmp %>%
  filter(Period >= trough_period[troughs_limits[1]], Period <= trough_period[troughs_limits[2]])%>%
  ggplot(aes(x=Period, fill = cause))+
  geom_col( aes(y = value))+
  geom_line( aes(y = change), size=0.5, color = "darkred")+
  geom_line( aes(y = HousePriceIndex / relation_rhs_lhs), size=0.25, linetype="dashed") +
  scale_y_continuous(
    # Features of the first axis
    name = "share of vulnerable households",
    labels = scales::percent,
    # Add a second axis and specify its features
    sec.axis = sec_axis(~ . *relation_rhs_lhs, name="House Price Index"),
    expand = expansion(mult = c(0, 0.05)) # make the barplots start at the axis
  ) +
  scale_x_continuous(expand = expansion(mult = c(0,0)))+
  # theme_classic()+
  theme(legend.position = "bottom") +
  theme(legend.background = element_blank()) +  # Remove overall border
  theme(legend.key = element_blank()) +
  scale_fill_manual(values = color_set_2)+
  facet_wrap( ~ agent)
  p+ geom_text(data = dat_text, aes(y= value), hjust = 0.1, vjust = 0.5, label = c("change \nrate", "house price \nindex (rhs)"), color = c("darkred","black"), size=3)
# 
#   annotate("text", x = mean(c(trough_period[2],trough_period[3])), y = mean(range(outfile_2_tmp$value)),hjust=-0.5, vjust = 13, label = c"change rate", color = "darkred", size = 3)
# labs(caption = "Notes: Your long reference footnote goes in here. UNd Ã¼brigensBesonders krass\n dass das so ist")
```

\FloatBarrier

# Robustness Checks for the Strength of the Dissaving Channel

The strength of the dissaving channel could be sensitive to the parametrization selected from the calibration runs. Moreover, the setting of the financial vulnerability threshold of eight months (Equation \@ref(eq:finVulalt)) could influence the model results.

## Different Model Parametrization

```{r, echo=FALSE, message=FALSE, warning=FALSE, results=FALSE}
calibration_consChannel_param <- read.csv(here::here("statistical output R/outputsCalibrationTest_November2021_Var4_60vul.csv"))
```

To test if the strength of dissaving channel depends strongly on the choice of the free parameters, displayed in Table \@ref(tab:parameters), the results of all 1000 calibration runs are compared. First, the importance of the dissaving channel in best-fitting parametrization used, does not seem to be an outlier from all these model runs. The average strength of the dissaving channel in all 1000 calibration runs was `r formattable::percent(mean(calibration_consChannel_param$vulConsumptionChannel),digits = 0)` with `r formattable::percent(min(calibration_consChannel_param$vulConsumptionChannel),digits = 0)` being the smallest value and `r formattable::percent(max(calibration_consChannel_param$vulConsumptionChannel),digits = 0)` the largest value, compared to the `r formattable::percent(mean(outfile_MC10$"nowVul Dissaving") / (mean(outfile_MC10$"nowVul Purchase") + mean(outfile_MC10$"nowVul Dissaving") + mean(outfile_MC10$"nowVul Other")), digits = 0)` of the parametrisation used here.

```{r, modelParam, fig.cap="Ordinary least square regression of the effect of the free parameters on the strength of the dissaving channel based on 1000 calibration runs", fig.show='hold', message=FALSE, warning=FALSE, out.width='66%', results = 'asis',  echo=FALSE}


calibration_consChannel_param <- calibration_consChannel_param %>%
  mutate(LTV_FTB = case_when(LTV1 >= LTV2 & LTV1 >= LTV3 ~ LTV1, 
                             LTV2 >= LTV1 & LTV2 >= LTV3 ~ LTV2,
                             LTV3 >= LTV1 & LTV3 >= LTV2 ~ LTV3))%>%
  mutate(LTV_BTL = case_when(LTV1 <= LTV2 & LTV1 <= LTV3 ~ LTV1, 
                             LTV2 <= LTV1 & LTV2 <= LTV3 ~ LTV2,
                             LTV3 <= LTV1 & LTV3 <= LTV2 ~ LTV3))%>%
  mutate(LTV_SSB = case_when(LTV1 <= LTV2 & LTV1 >= LTV3 ~ LTV1,
                             LTV1 >= LTV2 & LTV1 <= LTV3 ~ LTV1,
                             LTV2 <= LTV1 & LTV2 >= LTV3 ~ LTV2,
                             LTV2 >= LTV1 & LTV2 <= LTV3 ~ LTV2,
                             LTV3 <= LTV1 & LTV3 >= LTV2 ~ LTV3,
                             LTV3 >= LTV1 & LTV3 <= LTV2 ~ LTV3)) 
BaseFormula             <- lm(vulConsumptionChannel ~ incomePercentile + MPC  + paymentsToIncome  + liqPref  +  bankMaxAge   + LTV_FTB   + LTV_SSB   + LTV_BTL , data = calibration_consChannel_param)
# BaseFormula             <- lm(vulConsumptionChannel ~ bankMaxAge, data = calibration_consChannel_param)
# 
# summary.lm(BaseFormula)
# 
# 
library(jtools)
# plot_summs(BaseFormula, scale = TRUE, colors = "Rainbow", 
#            coefs = c("Income Percentile" = "incomePercentile",
#                      "MPC" = "MPC",
#                      "Payments / Income" = "paymentsToIncome",
#                      "Liquidity Preference" = "liqPref",
#                      "Max. Age Repayment" = "bankMaxAge",
#                      "Max. LTV for FTB" = "LTV_FTB",
#                      "Max. LTV for SSB" = "LTV_SSB",
#                      "Max. LTV for BTL" = "LTV_BTL")) 
# effect_plot(BaseFormula, pred = incomePercentile, interval = TRUE, plot.points = TRUE,x.label = "Income percentile", y.label = "Strength of dissaving channel")
# effect_plot(BaseFormula, pred = bankMaxAge, interval = TRUE, jitter = 0.1, plot.points = TRUE,x.label = "Maximum Age for Mortgage Repayment", y.label = "Strength of dissaving channel")
export_summs(BaseFormula,  confint = TRUE, 
     coefs = c("Income Percentile" = "incomePercentile",
               "MPC" = "MPC",
               "Payments / Income" = "paymentsToIncome",
               "Precautionary Saving" = "liqPref",
               "Max. Age Repayment" = "bankMaxAge",
               "Max. LTV for FTB" = "LTV_FTB",
               "Max. LTV for SSB" = "LTV_SSB",
               "Max. LTV for BTL" = "LTV_BTL"),
     error_format = "({conf.low}, {conf.high})",
     scale = FALSE,
     ci_level = 0.999,
     digits = 3)
# plot_summs(BaseFormula, error_format = "({conf.low}, {conf.high})", scale = FALSE, ci_level = 0.999,
#            coefs = c("Income Percentile" = "incomePercentile",
#                      "MPC" = "MPC",
#                      "Payments / Income" = "paymentsToIncome",
#                      "Liquidity Preference" = "liqPref",
#                      "Max. Age Repayment" = "bankMaxAge",
#                      "Max. LTV for FTB" = "LTV_FTB",
#                      "Max. LTV for SSB" = "LTV_SSB",
#                      "Max. LTV for BTL" = "LTV_BTL"),
#            model.names = NULL)

```

Comparing all the calibration runs with one another offers the opportunity to understand which of the free parameters most strongly influence the strength of the dissaving channel. To this end a simple linear regression of the free parameters on the strength of the dissaving channel is performed.[^19] The results are shown in Table \@ref(tab:modelParam) with the upper and lower 99.9% confidence interval bounds in brackets. Most of the estimators seem to have a significant effect on the strength of the dissaving channel, while all estimators have the expected sign. For instance, the higher the income percentile for first-time-buyers (FTB), above which they have an extra saving motive, the fewer FTB agents increase their saving, the fewer enter the ownership market and the fewer become vulnerable by purchase. Similarly, the higher the precautionary saving motive of households, the fewer become financially vulnerable by dissaving. The estimators with a very strong influence on the dissaving channel seem to be the maximum age at full mortgage repayment, set by banks for home buyers, and the maximum loan-to-value ratio (LTV) for FTB agents. By increasing maximum repayment age limit by one year, the importance of the dissaving channel increases on average by one percentage point. Increasing the maximum LTV for FTB agents by one percentage point reduces the importance of the dissaving channel by 0.5 percentage points.

[^19]: This regression does not account for the fit of the model results to the UK data.

## Different Thresholds for Financial Vulnerability

To test if the choice of the number of months the households need to be able to cover their negative financial margin (Equation \@ref(eq:finVulalt)) is important for the strength of the dissaving channel and the model fit, Table \@ref(tab:differentAmpudia) shows three different parametrizations for the months of buffer: one, eight and 24. The choice of the months-of-buffer parameter influences the dissaving channel significantly. Increasing the parameter leads to a decrease of the importance of the dissaving channel---from 64% to 74%. Increasing this parameter increases the share of households that are defined as financially vulnerable. These additional households seem to become less vulnerable by dissaving and more so by purchases.

```{r differentAmpudiaPreCalculation, echo=FALSE, message=FALSE, warning=FALSE, results=FALSE}
# this block creates the data frame for the table, the block following this is printing this.

# WATCH OUT: when changing this you need to change the table headers by hand
calibration_values <- tibble(share_median_income = c(rep.int(0.6, 3)),
                             WAS_median_income = c(rep.int(0.4, 3)),
                             months_buffer = c(1, 8, 24), 
                             share_vulHH_indebtedHH_Model = NA, share_vulHH_indebtedHH_WAS = NA,
                             medianDSR_vulHH_Model = NA, medianDSR_vulHH_WAS = NA,
                             medianDSR_nonVulHH_Model = NA, medianDSR_nonVulHH_WAS = NA,
                             medianAge_vulHH_Model = NA, medianAge_vulHH_WAS = NA,
                             medianAge_nonVulHH_Model = NA, medianAge_nonVulHH_WAS = NA)

for(i in 1:nrow(calibration_values)){
  
  Wave_5_HH_vul <- Wave_5_HH %>%
    # filter(totalMortgagePayments != 0) %>%
    # filter(totalMortgageDebt!=0)%>%
    mutate(finanicalMargin = NetAnnualRegularIncome/12 - totalMortgagePayments - calibration_values$WAS_median_income[i] * 2749.667,
           monthsAbleToCover = GrossFinancialWealth/finanicalMargin, # negative value means finanical margin is negative
           vulnerable = case_when(monthsAbleToCover<0 & monthsAbleToCover > - calibration_values$months_buffer[i] & totalMortgagePayments != 0 ~ TRUE, TRUE ~ FALSE),
           DSR = 12*totalMortgagePayments/ GrossAnnualRegularIncome,
           DTI = totalMortgageDebt/GrossAnnualRegularIncome) 
  
  
  # calculate for indebted households
  wave_indebted <- Wave_5_HH_vul%>% 
    filter(totalMortgageDebt!=0)%>%
    filter(totalMortgagePayments != 0) 
  
  calibration_values$share_vulHH_indebtedHH_WAS[i] <- formattable::percent( weighted.mean(wave_indebted$vulnerable, w = wave_indebted$Weight), digits = 1 )
  
  # calculate for vulnerable households
  wave_vul <- Wave_5_HH_vul%>% 
    filter(totalMortgageDebt!=0)%>%
    filter(totalMortgagePayments != 0) %>%
    filter(vulnerable == TRUE)
  
  calibration_values$medianDSR_vulHH_WAS[i] <- formattable::percent( weighted.median(wave_vul$DSR, w = wave_vul$Weight), digits = 1 )
  calibration_values$medianAge_vulHH_WAS[i] <- weighted.median(wave_vul$Age, w = wave_vul$Weight)
  
  # calculate for non-vulnerable, indebted households
  wave_NonVul <- Wave_5_HH_vul%>% 
    filter(totalMortgageDebt!=0)%>%
    filter(totalMortgagePayments != 0) %>%
    filter(vulnerable == FALSE)
  
  calibration_values$medianDSR_nonVulHH_WAS[i] <- formattable::percent( weighted.median(wave_NonVul$DSR, w = wave_NonVul$Weight), digits = 1 )
  calibration_values$medianAge_nonVulHH_WAS[i] <- weighted.median(wave_NonVul$Age, w = wave_NonVul$Weight)
  
  ##### calculate Model fin vul ####  
  
  
  sortingData_vul_HH <-  agent_data_vul_2%>%
    mutate(financialMargin = MonthlyDisposableIncome - calibration_values$share_median_income[i] * median(MonthlyGrossTotalIncome, na.rm = TRUE),
           monthsAbleToCover = BankBalance / financialMargin,
           vulnerable = case_when(monthsAbleToCover < 0 & monthsAbleToCover > - calibration_values$months_buffer[i] & Debt < 0 ~ TRUE, TRUE ~ FALSE)) %>%
    mutate(DTI = Debt/(-12* MonthlyGrossTotalIncome))%>%
    mutate(DSR = MonthlyMortgagePayments/MonthlyGrossTotalIncome)%>%
    mutate(hasDebt = case_when(Debt<0 ~ TRUE, TRUE ~ FALSE))
  
  model_indebted <- sortingData_vul_HH %>%
    filter(Debt < 0)
  
  DSRs <- sortingData_vul_HH %>%
    filter(Debt < 0) %>%
    group_by(vulnerable) %>%
    summarise(coreIndicator = median(DSR, na.rm = TRUE))
  
  formattable::percent(DSRs$coreIndicator[1])
  
  calibration_values$share_vulHH_indebtedHH_Model[i] <- formattable::percent( mean(model_indebted$vulnerable), digits = 1 )
  calibration_values$medianDSR_vulHH_Model[i] <- formattable::percent(DSRs$coreIndicator[2], digits = 1 )
  calibration_values$medianDSR_nonVulHH_Model[i] <- formattable::percent(DSRs$coreIndicator[1], digits = 1 )
  
  Age_model <- sortingData_vul_HH %>%
    filter(Debt < 0) %>%
    group_by(vulnerable) %>%
    summarise(coreIndicator = median(Age, na.rm = TRUE))
  
  calibration_values$medianAge_vulHH_Model[i] <- round(Age_model$coreIndicator[2], digits = 2 )
  calibration_values$medianAge_nonVulHH_Model[i] <- round(Age_model$coreIndicator[1], digits = 2 )
  
}

# calibration_values



channel_importance_results <- data.frame(parameters = NA, dissaving_channel = NA, purchase_channel = NA, share_vul_HH = NA)

# channel_importance_results[1,] <- channel_importance(data = different_Ampudia_vul_2, x = "FinVulReason_calc_0.7_1m")
# channel_importance_results[2,] <- channel_importance(data = different_Ampudia_vul_2, x = "FinVulReason_calc_0.7_8m")
# channel_importance_results[3,] <- channel_importance(data = different_Ampudia_vul_2, x = "FinVulReason_calc_0.7_24m")
channel_importance_results[1,] <- channel_importance(data = different_Ampudia_vul_2, x = "FinVulReason_calc_0.6_1m")
channel_importance_results[2,] <- channel_importance(data = different_Ampudia_vul_2, x = "FinVulReason_calc_0.6_8m")
channel_importance_results[3,] <- channel_importance(data = different_Ampudia_vul_2, x = "FinVulReason_calc_0.6_24m")
# channel_importance_results[7,] <- channel_importance(data = different_Ampudia_vul_2, x = "FinVulReason_calc_0.4_1m")
# channel_importance_results[8,] <- channel_importance(data = different_Ampudia_vul_2, x = "FinVulReason_calc_0.4_8m")
# channel_importance_results[9,] <- channel_importance(data = different_Ampudia_vul_2, x = "FinVulReason_calc_0.4_24m")


# channel_importance_results

calibration_values_table <- calibration_values%>%
  select(-share_median_income, -WAS_median_income)%>%
  add_column(channel_importance_results$dissaving_channel, .before = "share_vulHH_indebtedHH_Model")%>%
  add_column(channel_importance_results$purchase_channel, .before = "share_vulHH_indebtedHH_Model")
  
# row.names(calibration_values_table) <- c(1, 8, 24, 1, 8, 24, 1, 8, 24)
# colnames(calibration_values_table)<- list("share of median income",
#                                          "months of buffer", 
#                                          "dissaving channel", 
#                                          "purchasing channel",
#                                          "Model", "WAS",
#                                          "Model", "WAS",
#                                          "Model", "WAS",
#                                          "Model", "WAS",
#                                          "Model", "WAS"
# )

lineBreaks_table<- c(
                     "months of\nbuffer", 
                     "dissaving\nchannel", 
                     "purchasing\nchannel",
                     "Model", "WAS",
                     "Model", "WAS",
                     "Model", "WAS",
                     "Model", "WAS",
                     "Model", "WAS")

calibration_values_table <- as.data.frame(calibration_values_table) 
# these are all % values
for (i in 2:9){
 calibration_values_table[,i] <- format(calibration_values_table[,i], digits = 3,nsmall = 0, scientific = FALSE)
}


# these are double/integer values (i.e. AGE)
for (i in 10:13){
  calibration_values_table[,i] <- format(calibration_values_table[,i], digits = 0,nsmall = 0, scientific = FALSE)
}

calibration_values_table <- as.data.frame(calibration_values_table)



```

```{r differentAmpudia, message=FALSE, warning=FALSE,  echo=FALSE}
# This block prints the table, which was prepared in the block above
calibration_values_table %>%
  mutate_all(linebreak)%>%
  kableExtra::kbl(
    caption = "Different parametrisation of the months-to-cover parameter",
    booktabs = T,
    escape = F,
    align = "c",
    col.names = linebreak(lineBreaks_table, align ="c"))%>%
  kable_styling(latex_options =c("scale_down")) %>%
  column_spec(1, bold=T) %>%

  # Watch out -> here I set the names of the target values
  add_header_above(c(" " = 1, "vulnerability\nchannels" = 2,
                     "% vul HH in\nindebted HH" = 2,
                     "median DSR\nvul HH" = 2,
                     "median DSR\nnon-vul HH" = 2,
                     "median Age\nvul HH" = 2,
                     "median Age\nnon-vul HH" = 2)) %>%
  footnote(general = "Rho for the financial vulnerability measure of the model is 0.6 and 0.4 for the Wealth and Asset Survey (WAS). Model values are calculated from single-run with 600 Periods. Median Age of non-vulnerable households includes only households with mortgage debt.",           threeparttable =T)

# calibration_values_table %>%
#   mutate_all(linebreak)%>%
#   kableExtra::kbl(
#     caption = "Different parametrisation of the finanical vulnerability thresholds",
#     booktabs = T,
#     escape = F,
#     align = "c",
#     col.names = linebreak(lineBreaks_table, align ="c"))%>%
#   kable_styling(latex_options =c("scale_down")) %>%
#   column_spec(1:2, bold=T) %>%
#    collapse_rows(columns = c(1,2), latex_hline = "major")  %>%
# 
#   # Watch out -> here I set the names of the target values
#   add_header_above(c(" " = 3, "vulnerability\nchannels" = 2,
#                      "% vul HH in\nindebted HH" = 2,
#                      "median DSR\nvul HH" = 2,
#                      "median DSR\nnon-vul HH" = 2,
#                      "median Age\nvul HH" = 2,
#                      "medan Age\nnon-vul HH" = 2)) %>%
#   footnote(general = "Median Age of non-vulnerable households includes only households with mortgage debt. Model values are calculated from single-run with 300 Periods.",           threeparttable =T)
```

Overall, the distribution and characteristics of the financially vulnerable households in the model match the data from the WAS very well, even when increasing or lowering the months-of-buffer parameter---recall that the model has been calibrated to match these stylized facts only with the months-of-buffer set to eight. The overall share of households being financially vulnerable holds well for all three specifications. The median DSR of financially vulnerable households increases when reducing the months-of-buffer in the model and the WAS. This increases the confidence that the financially vulnerable households in the model are similar to those in the WAS.

\FloatBarrier

# Main Analysis With Simpler Definition of Financial Vulnerability

In this section the analysis of section \@ref(causes-for-financial-vulnerability) and section \@ref(path-dependency-of-financial-vulnerability) is re-done, while using a different definition of financial vulnerability, namely including all households that have less than 1500 money units on their accounts. This measure has been popularised @LusardiEtAl2011 and used in an adapted form to research financial vulnerability of Italian [@BrunettiEtAl2016] and other European households [@BrunettiEtAl2020].

The left panel of Figure \@ref(fig:1500MUVulCause) shows the share of households with less than 1500 money units on their bank account over the course of a housing cycle. This share rises to about 25% in the housing market upswing. However, this includes renters, explaining the majority of households being vulnerable by "other". The share of vulnerable renters is very stable as they have no housing wealth effect influencing their financial buffers and as rents remain relatively stable over the house price cycle.

The right panel shows only owner-occupiers, including buy-to-let investors with deposits lower than 1500 money units. The effects of purchases and dissaving on financial vulnerability are quite similar to the analysis in the main paper. Financial vulnerability by dissaving is highest when there has been a period of high prices, like in the main analysis, only purchases increase vulnerability earlier in the house price upswing than in the main analysis, when housing market turnover is highest.

Figure \@ref(fig:when1500Buy), similarly, confirms the long path dependencies of financial vulnerability. Households that bought their home at high prices one or two house price cycles past become vulnerable by dissaving when house prices have been high for a long period of time. In conclusion, the effect of a housing wealth effect on the financial buffers of households seems to be robust to changing to this simpler definition of financial vulnerability.

```{r 1500MUVulCause, fig.cap="Share of households with less than 1500 money units -- by cause of this financial vulnerability over the house price cycle",fig.subcap=c("All households", "Without renters"),  fig.show='hold', message=FALSE, warning=FALSE, out.width='49%', results=FALSE,  echo=FALSE}
sortingData_Vul_cause_1500 <- readRDS(file = here::here(paste0("Vul_1500MU_", model_folder_noFTBSM_2,".rds")))

relation_rhs_lhs <- 4
limits_1500withRenters <- c(0,0.40)

sortingData_Vul_cause_1500 %>%
  mutate(agent = case_when(
    isBTL==1 & inFirstHome==0 & isFTB==0 ~ "BTL", 
    # isBTL ==0 & inFirstHome == 0 &isFTB==0 ~ "Mover", 
    # isFTB ==1 ~ "FirstTimeBuyer",
    # isBTL==1 &  isFTB==0 ~ "BTL", 
    NHouses>0 & isBTL == 0 & inFirstHome == 0 ~ "SSB",
    inFirstHome==1 ~ "FTB", 
    NHouses==0 ~ "Renter")) %>%
  filter(Period >= trough_period[troughs_limits[1]], Period <= trough_period[troughs_limits[2]])%>%
  # filter(agent !="Renter") %>%
  # filter(Debt < 0) %>%
  filter(vulnerable_1500MU == TRUE ) %>%
  mutate(FinVulReason_1500MU = factor(FinVulReason_1500MU, levels = c("other", "purchase", "dissaving"))) %>%
  group_by(Period, `Sale HPI.x`, FinVulReason_1500MU) %>%
  tally()  %>%
  ggplot(aes( x = Period,  fill = FinVulReason_1500MU)) +
  geom_col(aes(y= n/10000)) + 
  # geom_line(aes(y = `Sale HPI.x` * 1000), color = "blue") +
  geom_line( aes(y = `Sale HPI.x` / relation_rhs_lhs), size=1, linetype="dashed") +
  scale_y_continuous(
    # Features of the first axis
    name = "Share of vulnerable households",
    labels = scales::percent,
    # Add a second axis and specify its features
    sec.axis = sec_axis(~ . *relation_rhs_lhs, name="House Price Index (---)"),
    expand = expansion(mult = c(0, 0.05)), # make the barplots start at the axis
    limits = limits_1500withRenters
  ) +
  scale_fill_manual(values = color_set_1)+
    scale_x_continuous(expand = expansion(mult = c(0,0)))+
  theme(legend.position = "bottom") +
  theme(legend.background = element_blank()) +  # Remove overall border
  theme(legend.key = element_blank())

# relation_rhs_lhs <- 10

sortingData_Vul_cause_1500 %>%
  mutate(agent = case_when(
    isBTL==1 & inFirstHome==0 & isFTB==0 ~ "BTL", 
    # isBTL ==0 & inFirstHome == 0 &isFTB==0 ~ "Mover", 
    # isFTB ==1 ~ "FirstTimeBuyer",
    # isBTL==1 &  isFTB==0 ~ "BTL", 
    NHouses>0 & isBTL == 0 & inFirstHome == 0 ~ "SSB",
    inFirstHome==1 ~ "FTB", 
    NHouses==0 ~ "Renter")) %>%
  mutate(hasDebt = case_when(Debt<0 ~ TRUE, TRUE ~ FALSE)) %>%
  filter(Period >= trough_period[troughs_limits[1]], Period <= trough_period[troughs_limits[2]])%>%
  filter(agent !="Renter") %>%
  # filter(Debt < 0) %>%
  filter(vulnerable_1500MU == TRUE ) %>%
  mutate(FinVulReason_1500MU = factor(FinVulReason_1500MU, levels = c("other", "purchase", "dissaving"))) %>%
  group_by(Period, `Sale HPI.x`, FinVulReason_1500MU) %>%
  tally()  %>%
  ggplot(aes( x = Period,  fill = FinVulReason_1500MU)) +
  geom_col(aes(y= n/10000)) + 
  # geom_line(aes(y = `Sale HPI.x` * 1000), color = "blue") +
  geom_line( aes(y = `Sale HPI.x` / relation_rhs_lhs), size=1, linetype="dashed") +
  scale_y_continuous(
    # Features of the first axis
    name = "Share of vulnerable households",
     labels = scales::percent,
    # Add a second axis and specify its features
    sec.axis = sec_axis(~ . *relation_rhs_lhs, name="House Price Index (---)"),
    expand = expansion(mult = c(0, 0.05)), # make the barplots start at the axis
    limits = limits_1500withRenters
  ) +
  scale_fill_manual(values = color_set_1)+
    scale_x_continuous(expand = expansion(mult = c(0,0)))+
  theme(legend.position = "bottom") +
  theme(legend.background = element_blank()) +  # Remove overall border
  theme(legend.key = element_blank())
```

```{r 1500MUdistributionsVulHH, fig.cap="Densitiy curves and median values (striped lines) of central attributes of non-rental households with less than 1500MU and with more than 1500MU", fig.subcap=c("Income", "Debt for last \\newline property purchase",  "Debt-Service-to-Income Ratio", "Deposits before last \\newline property purchase", "House price index at \\newline last property purchase", "Age"),  fig.show='hold', message=FALSE, warning=FALSE, fig.ncol = 3, out.width='33%', results=FALSE,  echo=FALSE, eval=FALSE}


sortingData_for_figure <-  sortingData_Vul_cause_1500%>%
  mutate(agent = case_when(
    isBTL==1 & inFirstHome==0 & isFTB==0 ~ "BTL", 
    # isBTL ==0 & inFirstHome == 0 &isFTB==0 ~ "Mover", 
    # isFTB ==1 ~ "FirstTimeBuyer",
    # isBTL==1 &  isFTB==0 ~ "BTL", 
    NHouses>0 & isBTL == 0 & inFirstHome == 0 ~ "SSB",
    inFirstHome==1 ~ "FTB", 
    NHouses==0 ~ "Renter"))%>%
  mutate(ConsumptionNetHousingWealth = ConsHWealth + ConsDebt)%>%
  mutate(ConsumptionNetWealth = ConsHWealth + ConsDebt+ConsFWealth)%>%
  # filter(Debt < 0)%>%
  filter(agent != "Renter") %>%
  filter(FinVulReason_1500MU != "other")%>%
  filter(Period >= 2300)%>%
  # distinct(id, .keep_all = TRUE) %>%
  mutate(DTI = Debt/(-12* MonthlyGrossTotalIncome))%>%
  mutate(DSR = MonthlyMortgagePayments/MonthlyGrossTotalIncome)%>%
  mutate(CTI = Consumption/MonthlyDisposableIncome) %>%
  mutate(hasDebt = case_when(Debt<0 ~ TRUE, TRUE ~ FALSE))%>%
  # left_join(transactions_to_join, by = c("id" = "buyerId"))%>%
  mutate(principal = transactionPrice-mortgageDownpayment)%>%
  mutate(LTV = principal/transactionPrice)%>%
  mutate(LTI = principal/ (12*buyerMonthlyGrossTotalIncome))%>%
  mutate(prePurchaseDeposits = mortgageDownpayment+buyerPostPurchaseBankBalance) %>%
  mutate(howLongAgo = Period - `Model time`) %>% # time now - time of purchase
  filter(howLongAgo > 0)%>% # future purchases have to be excluded (i.e. at period 2300 a purchase in period 2320 or similar)
  group_by(id, Period) %>% top_n(-1, howLongAgo)  # each vul HH each period has the last purchase "attached to them"

nrBins <- 20
color_temp <- cet_pal(5, name = "r3") # color sets also used for later figure
color_set_distr <- color_temp[c(3,2,4)]
color_set_distr[3] <- "darkgrey"
sortingData_for_figure$FinVulReason_1500MU <- factor(sortingData_for_figure$FinVulReason_1500MU, levels =c("dissaving", "purchase", "not vulnerable"))


################### INCOME
core_means <- sortingData_for_figure %>%
  group_by(FinVulReason_1500MU) %>%
  summarise(coreIndicator = median(MonthlyGrossTotalIncome, na.rm = TRUE))

sortingData_for_figure %>%
  ggplot(aes(MonthlyGrossTotalIncome, fill = FinVulReason_1500MU))+
  # ggtitle("Model households \nsubgroup indebted households")+
  geom_density(alpha = 0.5, position = "identity" , adjust = 5)+
  xlab("Monthly Gross Total Income \nand median value, between 0-7000")+
  # geom_histogram(alpha = 0.5, position = "identity", bins = nrBins )+
  xlim(c(0,7000))+
  geom_vline(
    data = core_means, linetype = "dashed", size = 1,
    aes(xintercept = coreIndicator, colour = FinVulReason_1500MU)) +
  scale_fill_manual(values = color_set_distr) +
  scale_color_manual(values = color_set_distr)


################### DEBT
core_means <- sortingData_for_figure %>%
  group_by(FinVulReason_1500MU) %>%
  summarise(coreIndicator = median(principal, na.rm = TRUE))

sortingData_for_figure %>%
  ggplot(aes(principal, fill = FinVulReason_1500MU))+
  # ggtitle("Model households \nsubgroup indebted households")+
  geom_density(alpha = 0.5, position = "identity" , adjust = 5)+
  xlab("Debt taken out at last purchase (log scale) \nand median value between 1000 and 1 million")+
  # geom_histogram(alpha = 0.5, position = "identity", bins = nrBins )+
  scale_x_log10(limits = c(1000,1000000))+
  geom_vline(
    data = core_means, linetype = "dashed", size = 1,
    aes(xintercept = coreIndicator, colour = FinVulReason_1500MU)) +
  scale_fill_manual(values = color_set_distr) +
  scale_color_manual(values = color_set_distr)



################### DSR
core_means <- sortingData_for_figure %>%
  group_by(FinVulReason_1500MU) %>%
  summarise(coreIndicator = median(DSR, na.rm = TRUE))

sortingData_for_figure %>%
  ggplot(aes(DSR, fill = FinVulReason_1500MU))+
  # ggtitle("Model households \nsubgroup indebted households")+
  geom_density(alpha = 0.5, position = "identity" , adjust = 5)+
  xlab("Debt-Service-Ratio and median value between 0 and 0.75")+
  # geom_histogram(alpha = 0.5, position = "identity", bins = nrBins )+
  xlim(c(0,0.75))+
  geom_vline(
    data = core_means, linetype = "dashed", size = 1,
    aes(xintercept = coreIndicator, colour = FinVulReason_1500MU)) +
  scale_fill_manual(values = color_set_distr) +
  scale_color_manual(values = color_set_distr)

################### pre-purchase deposits
core_means <- sortingData_for_figure %>%
  group_by(FinVulReason_1500MU) %>%
  summarise(coreIndicator = median(prePurchaseDeposits, na.rm = TRUE))

sortingData_for_figure %>%
  ggplot(aes(prePurchaseDeposits, fill = FinVulReason_1500MU))+
  # ggtitle("Model households \nsubgroup indebted households")+
  geom_density(alpha = 0.5, position = "identity" , adjust = 5)+
  xlab("Deposits right before purchase (log scale)\nbetween 1000 and 1 million")+
  # geom_histogram(alpha = 0.5, position = "identity", bins = nrBins )+
  scale_x_log10(limits = c(1000,1000000))+
  geom_vline(
    data = core_means, linetype = "dashed", size = 1,
    aes(xintercept = coreIndicator, colour = FinVulReason_1500MU)) +
  scale_fill_manual(values = color_set_distr) +
  scale_color_manual(values = color_set_distr)

################### SALE HPI
core_means <- sortingData_for_figure %>%
  group_by(FinVulReason_1500MU) %>%
  summarise(coreIndicator = median(`Sale HPI.y`, na.rm = TRUE))

sortingData_for_figure %>%
  ggplot(aes(`Sale HPI.y`, fill = FinVulReason_1500MU))+
  # ggtitle("Model households \nsubgroup indebted households")+
  geom_density(alpha = 0.5, position = "identity" , adjust = 5)+
  xlab("House price index when \nhoushold bought last property")+
  # geom_histogram(alpha = 0.5, position = "identity", bins = nrBins )+
  # xlim(c(0,0.75))+
  geom_vline(
    data = core_means, linetype = "dashed", size = 1,
    aes(xintercept = coreIndicator, colour = FinVulReason_1500MU)) +
  scale_fill_manual(values = color_set_distr) +
  scale_color_manual(values = color_set_distr)
################# age
core_means <- sortingData_for_figure %>%
  group_by(FinVulReason_1500MU) %>%
  summarise(coreIndicator = median(Age, na.rm = TRUE))

sortingData_for_figure %>%
  ggplot(aes(Age, fill = FinVulReason_1500MU))+
  # ggtitle("Model households with top66%income FTB saving motive 60%\nsubgroup indebted households")+  #\nlowest income quartile exempt
  geom_density(alpha = 0.6, position = "identity" , adjust = 5)+
  # geom_histogram(alpha = 0.5, position = "identity", bins = nrBins )+
  xlim(c(20,80))+
  xlab("Age and median value between 20 and 80")+
  geom_vline(
    data = core_means, linetype = "dashed", size = 1,
    aes(xintercept = coreIndicator, color = FinVulReason_1500MU)
  ) +
  scale_fill_manual(values = color_set_distr) +
  scale_color_manual(values = color_set_distr)
```

```{r when1500Buy, fig.cap="When did owner-occupiers with less than 1500 money units at house price peak and trough buy?",fig.subcap=c("Owner-occupiers with less than 1500 money units\\newline at trough House price level at last purchase", "Owner-occupiers with less than 1500 money units \\newline at trough House price level at last purchase"),  fig.show='hold', message=FALSE, warning=FALSE, out.width='49%', results=FALSE,  echo=FALSE}
####### "when did they buy" - does it hold up? ####

color_set_1 <- cet_pal(5, name = "r3") # color sets also used for later figure

vul_certain_period_trough <-sortingData_Vul_cause_1500%>%
  mutate(agent = case_when(
    isBTL==1 & inFirstHome==0 & isFTB==0 ~ "BTL", 
    # isBTL ==0 & inFirstHome == 0 &isFTB==0 ~ "Mover", 
    # isFTB ==1 ~ "FirstTimeBuyer",
    # isBTL==1 &  isFTB==0 ~ "BTL", 
    NHouses>0 & isBTL == 0 & inFirstHome == 0 ~ "SSB",
    inFirstHome==1 ~ "FTB", 
    NHouses==0 ~ "Renter")) %>%
  filter(FinVulReason_1500MU != "not vulnerable") %>%
  filter(FinVulReason_1500MU != "other")%>%
  filter(Period == period_to_filter[1])%>%
  # filter(agent=="inFirstHome")%>%
  # left_join(transactions_vul_2, by = c("id" = "buyerId"))%>%
  mutate(principal = transactionPrice-mortgageDownpayment)%>%
  mutate(prePurchaseDeposits = principal+buyerPostPurchaseBankBalance) %>%
  mutate(LTV = principal/transactionPrice)%>%
  mutate(LTI = principal/ (12*buyerMonthlyGrossTotalIncome))%>%
  mutate(howLongAgo = Period - `Model time`) %>%
  filter(transactionType == "sale")%>%
  filter(howLongAgo > 0)%>%
  group_by(id) %>% top_n(-1, howLongAgo) 

vul_certain_period_peak <-sortingData_Vul_cause_1500%>%
  mutate(agent = case_when(
    isBTL==1 & inFirstHome==0 & isFTB==0 ~ "BTL", 
    # isBTL ==0 & inFirstHome == 0 &isFTB==0 ~ "Mover", 
    # isFTB ==1 ~ "FirstTimeBuyer",
    # isBTL==1 &  isFTB==0 ~ "BTL", 
    NHouses>0 & isBTL == 0 & inFirstHome == 0 ~ "SSB",
    inFirstHome==1 ~ "FTB", 
    NHouses==0 ~ "Renter"))%>%
  filter(FinVulReason_1500MU != "not vulnerable")%>%
  filter(FinVulReason_1500MU != "other")%>%
  filter(Period == period_to_filter[2])%>%
  # filter(agent=="inFirstHome")%>%
  # left_join(transactions_vul_2, by = c("id" = "buyerId"))%>%
  mutate(principal = transactionPrice-mortgageDownpayment)%>%
  mutate(prePurchaseDeposits = principal+buyerPostPurchaseBankBalance) %>%
  mutate(LTV = principal/transactionPrice)%>%
  mutate(LTI = principal/ (12*buyerMonthlyGrossTotalIncome))%>%
  mutate(howLongAgo = Period - `Model time`) %>%
  filter(transactionType == "sale")%>%
  filter(howLongAgo > 0)%>%
  group_by(id) %>% top_n(-1, howLongAgo) 

########################### HPI und last sale
HPI1 <- outfile_2 %>%
  select(`Sale HPI`, `Model time`)%>%
  filter(`Model time` <= period_to_filter[1])

colnames(HPI1) <- list("House Price Index", "Period") 

data1 <- vul_certain_period_trough %>%
  filter(agent != "Renter")  # Households selling their homes at the end of the period could be still recorded vulnerable (which happens at the beginning of a period) - very rarely

(ggplot(data = HPI1, aes(y = `House Price Index`, x = Period) )+
    geom_line( size=0.5, linetype="dashed", color = "black")+ 
    geom_point(data = data1, aes(x = `Model time`,y= `Sale HPI.y`, color = FinVulReason_1500MU), position = position_jitter(width = 0.025, height = 0.025))+
    xlab(paste0("In what period did the household - vulnerable\nin period ", period_to_filter[1], " - buy its last property?"))+
    ylab(paste0("At what house price index did the household - vulnerable\nin period ", period_to_filter[1], " - buy its last property?")) +
    theme(legend.position = "bottom") +
    ylim(c(0.10, 1.5)) +
    xlim(c(period_to_filter[1] - HowLongBackPathDependency, period_to_filter[2])) + 
    geom_vline(
      xintercept = period_to_filter[1], linetype = 2, size = 1, color = "darkblue" 
    )+
    scale_color_manual(values = color_set_1[c(3,2)])+
    annotate("text", x = peak_periods[last_trough], y = 0.8, label = "all purchases\ndepicted\n belong to\nhouseholds\nvulnerable\nnow", color = "darkblue")) 


########################### HPI und last sale
HPI2 <- outfile_2 %>%
  select(`Sale HPI`, `Model time`)%>%
  filter(`Model time` <= period_to_filter[2])

colnames(HPI2) <- list("House Price Index", "Period") 

data2 <- vul_certain_period_peak %>%
  filter(agent != "Renter")  # Households selling their homes at the end of the period could be still recorded vulnerable (which happens at the beginning of a period) - very rarely


(ggplot(data = HPI2, aes(y = `House Price Index`, x = Period) )+
    geom_line( size=0.5, linetype="dashed", color = "black")+ 
    geom_point(data = data2, aes(x = `Model time`,y= `Sale HPI.y`, color = FinVulReason_1500MU), position = position_jitter(width = 0.025, height = 0.025))+
    xlab(paste0("In what period did the household - vulnerable\nin period ", period_to_filter[2], " - buy its last property?"))+
    ylab(paste0("At what house price index did the household - vulnerable\nin period ", period_to_filter[2], " - buy its last property?")) +
    theme(legend.position = "bottom") +
    ylim(c(0.10, 1.5)) +
    xlim(c(period_to_filter[1] - HowLongBackPathDependency, period_to_filter[2])) + 
    geom_vline(
      xintercept = period_to_filter[2], linetype =2, size = 1, color = "darkblue"
    )+
    scale_color_manual(values = color_set_1[c(3,2)]) 
    # annotate("rect", xmin = 2212, xmax = 2252, ymin = 1, ymax = 1.4, alpha = 0, color = "red") +
    # annotate("rect", xmin = 2305, xmax = 2345, ymin = 1, ymax = 1.4, alpha = 0, color = "red") +
    # annotate("text", x = 2280, y = 1.2, label = "newly\nvulnerable\nwith high\nprices", color = "red")+
    # annotate("text", x = 2420, y = 0.8, label = "all house-\nholds \ndepicted\nare\nvulnerable\nin this\nperiod", color = "darkblue")
)

```

# Additional Calibration Results

This section provides a more detailed comparison of the debt-service-to-income ratios, gross income and age structures of financially vulnerable and non-vulnerable households between the model and the Wealth and Asset Survey (WAS). Figure \@ref(fig:DSRWAS) shows the debt-service-to-income ratio distributions (density curves) for financially vulnerable and non-vulnerable indebted homeowners in the WAS (left panel) and model (right panel). As the figure consists of density curves, the share of financially vulnerable households in all households with mortgage debt is hidden.[^20] The median DSR of non-vulnerable indebted homeowners is `r formattable::percent(core_medians_WAS_DSR$coreIndicator[1], digits = 1)` in the WAS and `r formattable::percent(core_medians_DSR$coreIndicator[1], digits = 1)` in the model. Financially vulnerable indebted homeowners' DSR is `r formattable::percent(core_medians_WAS_DSR$coreIndicator[2], digits = 1)` in the WAS and `r formattable::percent(core_medians_DSR$coreIndicator[2], digits = 1)` in the model.[^21] While median DSRs of the non-vulnerable households of the model and WAS are very close together, the median DSRs of the vulnerable households diverge due to the near absence of negative income risk in the model, as is more discussed in section \@ref(calibration).

[^20]: More specifically, due to data limitations I only take the sub-group of interviewed households with recorded mortgage payments into account, as I need those to calculate their financial margin. They make up `r formattable::percent(share_wave_5_payment, digits = 0)` of all indebted households interviewed. Both sub-groups seem to be quite similar, while those reporting specific monthly mortgage payments tend to be a bit younger (median age is `r wave_5_payments_T_F_Age%>%filter(MortgagePaymentsRecorded == TRUE)%>% select(coreIndicator)` instead of `r wave_5_payments_T_F_Age%>%filter(MortgagePaymentsRecorded == FALSE)%>% select(coreIndicator)`). Assuming the share of vulnerable households would be the same in the sub-group with and without recorded mortgage payments, the share of financially vulnerable households of *all* households would be `r formattable::percent(share_wave_5_VulHH_AllHH, digits = 1)`---in the model this share is `r formattable::percent(mean(outfile_MC10$"nVulHH (X*medIncome Y*m)" / outfile_MC10$TotalPopulation), digits = 1)`.

[^21]: A alternative measurement for the model is the mean of the median DSR in each period - not the overall median of the DSR distribution of all financially vulnerable households over all periods (i.e. each households is recorded once per period). The median DSR of vulnerable households is then `r formattable::percent(median(outfile_MC10$"vulHH medianDSR"), digits = 1)`. This measurement is also used in table \@ref(tab:CoreIndicators).

The DSR distributions in the the model have a higher density at very low values, possibly due to the house prices falling to lower levels in the model than observed in reality. The density of DSRs at the right tail is lower in the model than in the WAS, which is probably due to the higher stability of households' wages in the model than observed in reality. For the WAS the share of vulnerable households of all households with mortgage debt is `r formattable::percent(share_vul_HH_payment_subgroup, digits = 1)` and for the model, using the same definition as introduced above, this share is `r formattable::percent(mean(outfile_MC10$"%vulHH of indebtedHH"), digits = 1)`. Figure \@ref(fig:IncomeWAS) shows the different income distributions of the WAS and the model, discussed in section \@ref(calibration).

```{r DSRWAS, fig.cap="Histogram and median value of debt-service-ratios of finanically vulnerable and non-vulnerable households in the Wealth and Asset Survey (left) and the model (right)",fig.subcap=c("Wealth and Asset Survey", "Model output"),  fig.show='hold', message=FALSE, warning=FALSE, out.width='49%', results=FALSE,  echo=FALSE}

# when using density curves, the WAS data of indebted households is about 2500 data points (which are then weighed, i.e. multiplied by their weight) which makes the distribution very smooth. To achieve a comparable smoothness for model data the kernel adjustment value is higher
kernel_adjust_WAS <- 2
kernel_adjust_model <- 4

### WAS 
wave_5_for_graph%>%
  ggplot(aes(DSR, fill = vulnerable, weight = Weight)) +
  geom_density(alpha = 0.5, position = "identity", adjust = kernel_adjust_WAS) +
  # geom_histogram(alpha = 0.5, position = "identity") +
  xlim(c(0,0.75))+
  geom_vline(
    data = core_medians_WAS_DSR, linetype = "dashed", size = 1,
    aes(xintercept = coreIndicator, colour = vulnerable)
  )+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  labs(caption = "Notes: Subgroup of households with recorded mortgage payments.")

##### model 
sortingData_for_figure %>%
  ggplot(aes(DSR, fill = vulnerable)) +
  geom_density(alpha = 0.5, position = "identity", adjust = kernel_adjust_model) +
  # geom_histogram(alpha = 0.5, position = "identity" ) +
  xlim(c(0,0.75))+
  geom_vline(
    data = core_medians_DSR, linetype = "dashed", size = 1,
    aes(xintercept = coreIndicator, colour = vulnerable)
  )+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  labs(caption = "Notes: Each data point is one household in one period (month) \nover one Monte-Carlo simulation with 600 periods.")
```

```{r IncomeWAS, fig.cap="Histogram and median value of Monthly Gross Total Income of finanically vulnerable and non-vulnerable households in the Wealth and Asset Survey (left) and the model (right)",fig.subcap=c("Wealth and Asset Survey", "Model output"),  fig.show='hold', message=FALSE, warning=FALSE, out.width='49%', results=FALSE,  echo=FALSE}

# when using density curves, the WAS data of indebted households is about 2500 data points (which are then weighed, i.e. multiplied by their weight) which makes the distribution very smooth. To achieve a comparable smoothness for model data the kernel adjustment value is higher
kernel_adjust_WAS <- 2
kernel_adjust_model <- 4

### WAS 
core_medians_WAS_Income <- wave_5_for_graph %>%
  group_by(vulnerable) %>%
  summarise(coreIndicator = weighted.median(GrossAnnualRegularIncome/12, w = Weight))

wave_5_for_graph%>%
  ggplot(aes(x = GrossAnnualRegularIncome/12, fill = vulnerable, weight = Weight)) +
  geom_density(alpha = 0.5, position = "identity", adjust = kernel_adjust_WAS) +
  # geom_histogram(alpha = 0.5, position = "identity") +
  xlim(c(0,10000))+
  geom_vline(
    data = core_medians_WAS_Income, linetype = "dashed", size = 1,
    aes(xintercept = coreIndicator, colour = vulnerable)
  )+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  labs(caption = "Notes: Subgroup of households with recorded mortgage payments.")


##### model 
core_medians_Income <- sortingData_for_figure %>%
  group_by(vulnerable) %>%
  summarise(coreIndicator = median(MonthlyGrossTotalIncome, na.rm = TRUE))

sortingData_for_figure %>%
  ggplot(aes(MonthlyGrossTotalIncome, fill = vulnerable)) +
  geom_density(alpha = 0.5, position = "identity", adjust = kernel_adjust_model) +
  # geom_histogram(alpha = 0.5, position = "identity" ) +
  xlim(c(0,10000))+
  geom_vline(
    data = core_medians_Income, linetype = "dashed", size = 1,
    aes(xintercept = coreIndicator, colour = vulnerable)
  )+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  labs(caption = "Notes: Each data point is one household in one period (month) \nover one Monte-Carlo simulation with 600 periods.")
```

<!-- median Age -->

Another important stylized fact is to match the age distribution of vulnerable and non-vulnerable households. Since with retirement the households' in the model income falls significantly at age 65, a higher share of vulnerable households here (as opposed to the WAS) could imply an overestimation of dissaving on financial vulnerability, driven by drops in income. In the model, the age of financially vulnerable households is driven by both the saving motive for first-time buyers (stronger motive leads to younger households entering the market) and the maximum age by which a household has to repay its mortgages (the higher the maximum age, the older financially vulnerable households tend to be). In the WAS the median age for financially non-vulnerable households is `r round(core_medians_WAS_Age$coreIndicator[1], digits = 0)` years and `r round(core_medians_Age$coreIndicator[1], digits = 1)` years in the model. For vulnerable households the median age is `r round(core_medians_WAS_Age$coreIndicator[2], digits = 0)` years in the WAS and `r round(core_medians_Age$coreIndicator[2], digits = 1)` in the model. The age distributions of both household groups from the model are remarkably similar to those of the WAS, but with lower densities at both tails.

```{r AgeWAS, fig.cap="Histogram of the age of finanically vulnerable and non-vulnerable households in the Wealth and Asset Survey (left) and the model (right)", fig.subcap=c("Wealth and Asset Survey", "Model output"), fig.show='hold', message=FALSE, warning=FALSE, out.width='49%', results=FALSE,  echo=FALSE}


binSize <- 20 # if using histogram

# WAS
wave_5_for_graph%>%
  ggplot(aes(Age, fill = vulnerable, weight = Weight))+
  geom_density(alpha = 0.5, position = "identity" , adjust = kernel_adjust_WAS) +
  # geom_histogram(alpha = 0.5, position = "identity", bins = binSize) +
  xlim(c(20,80))+
  geom_vline(
    data = core_medians_WAS_Age, linetype = "dashed", size = 1,
    aes(xintercept = coreIndicator, colour = vulnerable)
  )+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
    labs(caption = "Notes: Subgroup of households with recorded mortgage payments.")


# Model
sortingData_for_figure %>%
  ggplot(aes(Age, fill = vulnerable))+
  geom_density(alpha = 0.5, position = "identity", adjust = kernel_adjust_model )+
  # geom_histogram(alpha = 0.5, position = "identity" , bins = binSize)+
  xlim(c(20,80))+
  geom_vline(
    data = core_medians_Age, linetype = "dashed", size = 1,
    aes(xintercept = coreIndicator, colour = vulnerable)
  )+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  labs(caption = "Notes: Each data point is one household in one period (month) \nover one Monte-Carlo simulation with 600 periods.")
```

\FloatBarrier

# Supplemental Figures and Tables

(ref:Dynan-citation) @DynanEtAl2004

(ref:Arrondel-citation) @ArrondelEtAl2019

(ref:TarneEtAl2021-citation) [@TarneEtAl2021]

```{r parameters, echo=FALSE, message=FALSE, warning=FALSE}
# - FTB SM MPC check
# - FTB SM percentile check
# - financial wealth effect for income percentiles check 
# - precautionary buffer
# - payments to income
# - LTV FTB, SSB BTL



parameters_table <-data.frame(Parameter = c("$\\alpha_{\\Xi \\leq 0.25}$", 
                                            "$\\alpha_{\\Xi > 0.25 \\leq 0.5}$", 
                                            "$\\alpha_{\\Xi > 0.5 \\leq 0.75}$", 
                                            "$\\alpha_{\\Xi > 0.75 \\leq 0.9}$", 
                                            "$\\alpha_{\\Xi > 0.9 \\leq 0.99}$",
                                            "$\\alpha_{\\Xi > 0.99}$",
                                            "$\\beta_{\\Xi \\leq 0.25}$", 
                                            "$\\beta_{\\Xi > 0.25 \\leq 0.5}$", 
                                            "$\\beta_{\\Xi > 0.5 \\leq 0.75}$", 
                                            "$\\beta_{\\Xi > 0.75 \\leq 0.9}$", 
                                            "$\\beta_{\\Xi > 0.9}$", 
                                            "$\\alpha_{FTB,i}$", 
                                            "$\\Xi_{i}$", 
                                            "$\\zeta_{i,t}$",
                                            "$\\sigma$",
                                            "$Age^{OO}_{repayment}$",
                                            "$LTV^{cap}_{FTB}$",
                                            "$LTV^{cap}_{SSB}$",
                                            "$LTV^{cap}_{BTL}$"), # possibly use another variable name. In the equation list this is alpha (with equation number 39 as of March 2021) ###### TODO Update once complete model description is written
                              Description = c("Monthly propensity to consume out of disposable income for households in income percentile $\\leq 0.25$",
                                              "Monthly propensity to consume out of disposable income for households in income percentile $> 0.25 \\leq 0.5$",
                                              "Monthly propensity to consume out of disposable income for households in income percentile $> 0.5 \\leq 0.75$",
                                              "Monthly propensity to consume out of disposable income for households in income percentile $> 0.75 \\leq 0.9$",
                                              "Monthly propensity to consume out of disposable income for households in income percentile $> 0.9 \\leq 0.99$",
                                              "Monthly propensity to consume out of disposable income for households in income percentile $> 0.99$",
                                              "Monthly propensity to consume induced by finanical wealth for households in income percentile $\\leq 0.25$",
                                              "Monthly propensity to consume induced by finanical wealth for households in income percentile $> 0.25 \\leq 0.5$",
                                              "Monthly propensity to consume induced by finanical wealth for households in income percentile $> 0.5 \\leq 0.75$",
                                              "Monthly propensity to consume induced by finanical wealth for households in income percentile $> 0.75 \\leq 0.9$",
                                              "Monthly propensity to consume induced by finanical wealth for households in income percentile $> 0.9$",
                                              "Propensity to consume out of disposable income for FTB agents above specific income percentile",
                                              "Income percentile value above which FTB agents save for a downpayment via $\\alpha_{FTB,i}$",
                                              "Precautionary buffer (multple of monthly net income) for households with DSRs below the median, for households with DSRs above the median $\\zeta_{i,t} = 0$",
                                              "Maximum share of posttax income that investors spend on mortgage payments",
                                              "Maximum age by which mortgages for owner-occupiers have to be repaid",
                                              "Maximum LTV of FTB mortgage contracts", 
                                              "Maximum LTV of SSB mortgage contracts",
                                              "Maximum LTV of BTL mortgage contracts"),
                              Value = c(properties_file$consumptionFractionQ1,
                                        properties_file$consumptionFractionQ2,
                                        properties_file$consumptionFractionQ3,
                                        properties_file$consumptionFractionQ4,
                                        properties_file$consumptionFractionTop10,
                                        properties_file$consumptionFractionTop1,
                                        properties_file$wealthEffectQ1, # in the properties file Q1 and Q2 are separate fields
                                        properties_file$wealthEffectQ2,
                                        properties_file$wealthEffectQ3,
                                        properties_file$wealthEffectQ4,
                                        properties_file$wealthEffectTop10, #  in the properties file there is a top 1% field as well
                                        properties_file$MPCForFirstTimeBuyers,
                                        properties_file$minIncomePercentile,
                                        properties_file$liquidityPreference,
                                        properties_file$paymentsToIncome,
                                        properties_file$BANK_AGE_LIMIT,
                                        properties_file$centralBankFirstTimeBuyerLTVLimit,
                                        properties_file$centralBankOwnerOccupierLTVLimit,
                                        properties_file$centralBankBTLLTVLimit),
                              Source = c("(ref:Dynan-citation) PSID and SCF Data",
                                         "as above", 
                                         "as above",
                                         "as above",
                                         "as above",
                                         "as above",
                                         "(ref:Arrondel-citation)",
                                         "as above",
                                         "as above",
                                         "as above",
                                         "as above",
                                         "[0 - 1.0]",
                                         "[0.5 - 1.0]",
                                         "[0 - 4.0]",
                                         "[0.33 - 0.75]",
                                         "[65 - 75]",
                                         "[0.75 - 0.99]",
                                         "[0.75 - 0.99]",
                                         "[0.75 - 0.99]"
                              )
)

# parameter list
# 1# min income percentile       #  0 - 1.0
# 2# MPCForFirstTimeBuyers       #  0.5 - 1.0
# 3# payments to income          #  0.33 - 0.75
# 4# precautionary saving        #  0 - 4.0
# 5# BANK_AGE_LIMIT              #  65 - 75
# 6# LTV 1                       #  0.75 - 0.99
# 7# LTV 2                       #  0.75 - 0.99
# 8# LTV 3                       #  0.75 - 0.99

names(parameters_table) <- c("Parameter", "Description", "Value", "Range for calibration / Source")

parameters_table %>%
  kbl(booktabs =T, 
      # align ="c",
      escape = FALSE, # this will convert the math expressions properly
      caption = "New parameters") %>%
  kable_styling(latex_options =c("striped"), full_width = FALSE)%>%
  column_spec(2, width = "9cm") %>%
  column_spec(4, width = "2.5cm") %>%
footnote(general = paste0("The marginal propensities to consume, based on ", "(ref:Dynan-citation)" ," and ", "(ref:Arrondel-citation)", ", are each slightly adjusted to match the wealth inequality and debt-to-deposit ratio. The commercial bank's internal LTV caps for the different agent classes have been re-calibrated to match the stylized facts. To the author's knowledge, there is no publicly available data on these caps and the Bank of England is currently not enforcing LTV caps themselves. As LTV caps have strong effects on the housing market dynamics ", "(ref:TarneEtAl2021)", " they are included in the calibration."),
         threeparttable =T)




```

```{r, stockVulnerable1, echo = FALSE, warning=FALSE,message=FALSE, results= FALSE, fig.align='center', fig.cap = "Share of households at current risk of default by cause of financial vulnerability over the house price cycle - 6 months rolling averages",  out.width='66%'}
# get first the position of house price troughs from a smoothed HPI line
# (not as necessary for troughs as for peaks, which are more irreglar)
HPI_troughs <- find_peaks_smoothed( -outfile_1$`Sale HPI`, m=10, smoothedPerdiods = 12)
# translate the position of troughs into the corresponding periods to use later in graph
trough_period <- c(outfile_1$`Model time`[HPI_troughs])

# , fig.subcap= c("cause of vulnerability", "agent classes vulnerable"), fig.show='hold' # in case this is put back in
outfile_1_tmp <- outfile_1 %>%
  select("nowVul Purchase", "nowVul Dissaving",  "nowVul Other")

outfile_1_tmp <- as.matrix(outfile_1_tmp)/outfile_1$TotalPopulation # adjust for % of total population
outfile_1_tmp <- as.data.frame(runmean(outfile_1_tmp, rolling_averages)) # build a rolling average (6 for 6 months)
colnames(outfile_1_tmp) <- list("purchase", "dissaving", "other") # abbreviate colnames for figure

outfile_1_tmp <- outfile_1_tmp %>%
  bind_cols(outfile_1$`Model time`, outfile_1$`Sale HPI`)%>%
  pivot_longer(c("purchase", "dissaving", "other"))  ## prepare for boxplots

colnames(outfile_1_tmp) <- list("Period","HousePriceIndex", "vulnerable_by", "value")
outfile_1_tmp$vulnerable_by <- factor(outfile_1_tmp$vulnerable_by, levels = c("other", "purchase", "dissaving"))
# outfile_1_tmp$vulnerable_by <- factor(outfile_1_tmp$vulnerable_by, levels = c("other", "dissaving", "purchase"))
# parameters for figure
relation_rhs_lhs <- 500

color_set_1 <- cet_pal(5, name = "r3") # color sets also used for later figure

outfile_1_tmp %>%
    filter(Period >= trough_period[troughs_limits[1]], Period <= trough_period[troughs_limits[2]])%>%
  ggplot(aes(x=Period, fill = vulnerable_by))+
  geom_col( aes(y = value))+
  geom_line( aes(y = HousePriceIndex / relation_rhs_lhs), size=1, linetype="dashed") +
  scale_y_continuous(
    # Features of the first axis
    name = "Share of vulnerable households",
     labels = scales::percent,
    # Add a second axis and specify its features
    sec.axis = sec_axis(~ . *relation_rhs_lhs, name="House Price Index (---)"),
    expand = expansion(mult = c(0, 0.05)) # make the barplots start at the axis
  ) +
  scale_x_continuous(expand = expansion(mult = c(0,0)))+
  # theme_classic()+
  theme(legend.position = "bottom") +
  theme(legend.background = element_blank()) +  # Remove overall border
  theme(legend.key = element_blank()) +
  # scale_fill_viridis_d()
  scale_fill_manual(values = color_set_1)



```

```{r, turnover, echo = FALSE, warning=FALSE,message=FALSE, results= FALSE, fig.align='center', fig.dim = c(6, 4), fig.cap = "Housing market turnover (percentages of all houses transacted per months) - 12 months rolling averages", out.width='49%'}

outfile_1_tmp <- outfile_1 %>%
  select("Sale nSales")

outfile_1_tmp <- as.matrix(outfile_1_tmp)/outfile_1$HousingStock
outfile_1_tmp <- as.data.frame(runmean(outfile_1_tmp, rolling_averages)) # build a rolling average (6 for 6 months)

outfile_1_tmp <- outfile_1_tmp %>%
  bind_cols(outfile_1$`Model time`, outfile_1$`Sale HPI`)
colnames(outfile_1_tmp) <- list("housing market turnover", "Period","HousePriceIndex")


# parameters for figure
relation_rhs_lhs <- 40
color_set_1 <- cet_pal(5, name = "r3") # color sets also used for later figure

outfile_1_tmp %>%
  filter(Period >= trough_period[troughs_limits[1]], Period <= trough_period[troughs_limits[2]])%>%
  ggplot(aes(x=Period))+
  geom_line( aes(y = `housing market turnover`), color = "darkred", size = 1.5)+
  geom_line( aes(y = HousePriceIndex / relation_rhs_lhs), size=1, linetype="dashed") +
  scale_y_continuous(
    # Features of the first axis
    name = "turnover (monthly sales to total housing stock)",
    labels = scales::percent,
    # Add a second axis and specify its features
    sec.axis = sec_axis(~ . *relation_rhs_lhs, name="House Price Index"),
    expand = expansion(mult = c(0, 0.05)) # make the barplots start at the axis
  ) +
  scale_x_continuous(expand = expansion(mult = c(0,0)))+
  # theme_classic()+
  theme(legend.position = c(.85, .85)) +
  theme(legend.background = element_blank()) +  # Remove overall border
  theme(legend.key = element_blank()) +
  scale_fill_manual(values = color_set_1)
# labs(caption = "Notes: Your long reference footnote goes in here. UNd Ã¼brigensBesonders krass\n dass das so ist")
# scale_fill_viridis_d()

```

```{r, crossCorrelation1, echo = FALSE, warning=FALSE,message=FALSE, results= FALSE, eval=FALSE, fig.cap = "Cross-Correlation of Financially Vulnerable Households and the House Price Index",  out.width='33%', fig.subcap=c("Overall Vulnerability", "Vulnerable by Dissaving", "Vulnerable by Purchase"), fig.show='hold'}
# outfile_1 <- read_outfile_1_total(wd_model = "Results", model_folder_name = model_folder_1, nRuns = nRuns) +
ccf(outfile_1$`nVulHH (X*medIncome Y*m)`, outfile_1$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "")
ccf(outfile_1$`nowVul Dissaving`, outfile_1$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "")
ccf(outfile_1$`nowVul Purchase`, outfile_1$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "")

# 
# ccf(outfile_1$`nowVul Purchase SSB`, outfile_1$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "purchase SSB")
# ccf(outfile_1$`nowVul Purchase FTB`, outfile_1$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "purchase FTB")
# ccf(outfile_1$`nowVul Purchase BTL`, outfile_1$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "purchase BTL")
# ccf(outfile_1$`nowVul Dissaving SSB`, outfile_1$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "Dissaving SSB")
# ccf(outfile_1$`nowVul Dissaving FTB`, outfile_1$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "Dissaving FTB")
# ccf(outfile_1$`nowVul Dissaving BTL`, outfile_1$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "Dissaving BTL")


#ccf(outfile_1$`vulnerable by dissaving`, outfile_1$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "")
#ccf(outfile_1$`vulnerable by purchase`, outfile_1$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "")

# ccf(outfile_1$`Vulnerable By Consumption BTL`, outfile_1$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "")
# ccf(outfile_1$`Vulnerable By Consumption SSB`, outfile_1$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "")
# ccf(outfile_1$`Vulnerable By Consumption InFirstHome`, outfile_1$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "")

```

```{r, crossCorrelation2, echo = FALSE, warning=FALSE,message=FALSE, results= FALSE, fig.cap = "Cross-Correlation of Financially Vulnerable Households and the House Price Index",  out.width='33%', fig.subcap=c("Overall Vulnerability", "Vulnerable by Dissaving", "Vulnerable by Purchase"), fig.show='hold'}
# outfile_2 <- read_outfile_2_total(wd_model = "Results", model_folder_name = model_folder_2, nRuns = nRuns) +
ccf(outfile_MC10$`nVulHH (X*medIncome Y*m)`, outfile_MC10$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "")
ccf(outfile_MC10$`nowVul Dissaving`, outfile_MC10$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "")
ccf(outfile_MC10$`nowVul Purchase`, outfile_MC10$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "")

# 
# ccf(outfile_MC10$`nowVul Purchase SSB`, outfile_MC10$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "purchase SSB")
# ccf(outfile_MC10$`nowVul Purchase FTB`, outfile_MC10$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "purchase FTB")
# ccf(outfile_MC10$`nowVul Purchase BTL`, outfile_MC10$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "purchase BTL")
# ccf(outfile_MC10$`nowVul Dissaving SSB`, outfile_MC10$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "Dissaving SSB")
# ccf(outfile_MC10$`nowVul Dissaving FTB`, outfile_MC10$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "Dissaving FTB")
# ccf(outfile_MC10$`nowVul Dissaving BTL`, outfile_MC10$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "Dissaving BTL")


#ccf(outfile_MC10$`vulnerable by dissaving`, outfile_MC10$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "")
#ccf(outfile_MC10$`vulnerable by purchase`, outfile_MC10$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "")

# ccf(outfile_MC10$`Vulnerable By Consumption BTL`, outfile_MC10$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "")
# ccf(outfile_MC10$`Vulnerable By Consumption SSB`, outfile_MC10$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "")
# ccf(outfile_MC10$`Vulnerable By Consumption InFirstHome`, outfile_MC10$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "")

```

```{r vulSince, fig.cap="When did households, vulnerable at house price peak and trough buy and for how long have they been vulnerable?",fig.subcap=c("vulnerable at trough - period 2200", "vulnerable at peak - period 2230"),  fig.show='hold', message=FALSE, warning=FALSE, out.width='49%', results=FALSE,  echo=FALSE, eval=FALSE}

color_set_1 <- cet_pal(5, name = "r3") # color sets also used for later figure
vul_certain_period <-agent_data_vul_2%>%
  mutate(agent = case_when(
    isBTL==1 & inFirstHome==0 & isFTB==0 ~ "BTL", 
    # isBTL ==0 & inFirstHome == 0 &isFTB==0 ~ "Mover", 
    # isFTB ==1 ~ "FirstTimeBuyer",
    # isBTL==1 &  isFTB==0 ~ "BTL", 
    NHouses>0 & isBTL == 0 & inFirstHome == 0 ~ "SSB",
    inFirstHome==1 ~ "FTB", 
    NHouses==0 ~ "Renter"))%>%
  filter(FinVulReason != "not vulnerable")%>%
  filter(FinVulReason != "other")%>%
  filter(Period == period_to_filter[1])%>%
  # filter(agent=="inFirstHome")%>%
  left_join(transactions_vul_2, by = c("id" = "buyerId"))%>%
  mutate(principal = transactionPrice-mortgageDownpayment)%>%
  mutate(LTV = principal/transactionPrice)%>%
  mutate(LTI = principal/ (12*buyerMonthlyGrossTotalIncome))%>%
  mutate(howLongAgo = Period - `Model time`) %>%
  filter(transactionType == "sale")%>%
  filter(howLongAgo > 0)%>%
  group_by(id) %>% top_n(-1, howLongAgo) 

########################### HPI und last sale
vul_certain_period%>%
  filter(FinVulReason != "other") %>%
  ggplot(aes(x = `Model time`,y= `Sale HPI.y`, color = FinVulReason, size = FinVulSince))+
  geom_point(position = position_jitter(width = .05, height = .05), shape = 21)+
  scale_size_area(max_size = 5)+
  scale_color_manual(values = color_set_1[c(3,2)])+
  xlab("In what period did the now vulnerable household buy its last property?")+
  ylab("House Price Index at last Purchase")# +
  # ggtitle(paste0("When did households, vulnerable in period ",period_to_filter[1]," become vulnerable?"))
  #

vul_certain_period <-agent_data_vul_2%>%
  mutate(agent = case_when(
    isBTL==1 & inFirstHome==0 & isFTB==0 ~ "BTL", 
    # isBTL ==0 & inFirstHome == 0 &isFTB==0 ~ "Mover", 
    # isFTB ==1 ~ "FirstTimeBuyer",
    # isBTL==1 &  isFTB==0 ~ "BTL", 
    NHouses>0 & isBTL == 0 & inFirstHome == 0 ~ "SSB",
    inFirstHome==1 ~ "FTB", 
    NHouses==0 ~ "Renter"))%>%
  filter(FinVulReason != "not vulnerable")%>%
  filter(FinVulReason != "other")%>%
  filter(Period == period_to_filter[2])%>%
  # filter(agent=="inFirstHome")%>%
  left_join(transactions_vul_2, by = c("id" = "buyerId"))%>%
  mutate(principal = transactionPrice-mortgageDownpayment)%>%
  mutate(LTV = principal/transactionPrice)%>%
  mutate(LTI = principal/ (12*buyerMonthlyGrossTotalIncome))%>%
  mutate(howLongAgo = Period - `Model time`) %>%
  filter(transactionType == "sale")%>%
  filter(howLongAgo > 0)%>%
  group_by(id) %>% top_n(-1, howLongAgo) 
########################### HPI und last sale
vul_certain_period%>%
  filter(FinVulReason != "other") %>%
  ggplot(aes(x = `Model time`,y= `Sale HPI.y`, color = FinVulReason, size = FinVulSince))+
  geom_point(position = position_jitter(width = .05, height = .05), shape = 21)+
  scale_size_area(max_size = 5)+
  scale_color_manual(values = color_set_1[c(3,2)])+
  xlab("In what period did the now vulnerable household buy their last property?")+
  ylab("House Price Index at last Purchase") #+
  # ggtitle(paste0("When did households, vulnerable in period ",period_to_filter[2]," become vulnerable?"))

```

```{r vulnerbilityTable, message=FALSE, warning=FALSE,  echo=FALSE}



out <- read_csv(here::here(paste0("wealth-effect/Results/", model_folder_noFTBSM_2, "/Output-run", 1, ".csv")))


hpi_median <- out %>%
  filter(`Model time` > 2300) %>%
  select(`Sale HPI`, `Model time`, `vulnerable by dissaving`, `vulnerable by purchase`)
  # median(hpi_median$`Sale HPI`)


out_HPI <- out %>%
  select(`Model time`, `Sale HPI`)

peaks <-  find_peaks_smoothed(x = hpi_median$`Sale HPI`,m= 30,smoothedPerdiods = 24, paint = FALSE)
# diff(peaks)
beginning_period_high <- c()
# shift a quarter of the cycle left from the point of highest vul diss (which is +15 periods after cycle due to crosscorrelations (kann man auch noch reincoden))
for(i in 1:(length(peaks)-1))beginning_period_high[i] <- peaks[i] + (15 - round(0.25 * diff(peaks)[i], digits = 0))

end_period_high <- vector()
for(i in 1:(length(peaks)-1))end_period_high[i] <- peaks[i] + (15 + round(0.25 * diff(peaks)[i], digits = 0))

# build the high dissaving frame
high_periods <- c()
for(i in 1:(length(peaks)-1)) high_periods <- append(high_periods,c(beginning_period_high[i]:end_period_high[i]))

low_periods <- c()
for(i in 1:(length(peaks)-2)) low_periods <- append(low_periods,c(end_period_high[i]:beginning_period_high[i+1]))

# plot(hpi_median$`Sale HPI`, type = 'l', main = "high_periods")
# points(low_periods, hpi_median$`Sale HPI`[low_periods], col = 'red', pch = 19)
# points(high_periods, hpi_median$`Sale HPI`[high_periods], col = 'blue', pch = 19)


# translate to periods
adjusted_high_periods <- hpi_median$`Model time`[high_periods]
adjusted_low_periods <- hpi_median$`Model time`[low_periods]

table_vul <- different_Ampudia_vul_2 %>%
  left_join(out_HPI, by = c("Period" = "Model time")) %>%
  left_join(out_HPI, by = "Model time") %>%
  filter(vulnerable == "TRUE") %>%
  mutate(Price_level = case_when(Period %in% adjusted_high_periods ~ "high", Period %in% adjusted_low_periods ~ "low", TRUE ~ "undefined"))%>%
  mutate(Price_level_purchase = case_when(`Sale HPI.y`>= median(hpi_median$`Sale HPI`)~ "high", TRUE~ "low")) # %>%


table_vul_2 <- table_vul %>%
  filter(Price_level != "undefined") %>%
  filter(FinVulReason %in% c("dissaving", "purchase")) %>%
  # group_by(Price_level, Period)%>%
  group_by(Price_level, FinVulReason, Price_level_purchase)%>%
  # tally() %>%
  tally()


a <- table_vul_2 %>%
  filter(Price_level == "high")%>%
  mutate(n = (n / 10000) / length(high_periods))

b <- table_vul_2 %>%
  filter(Price_level == "low")%>%
  mutate(n = (n / 10000) / length(low_periods))

table_vul_2 <- bind_rows(a,b)
table_vul_2$n <-  formattable::percent(table_vul_2$n, digits = 1)

table_vul_print <- pivot_wider(table_vul_2, names_from = c( FinVulReason, Price_level_purchase), values_from = n) 
table_vul_print$Share_vul_hh_diss <- table_vul_print$dissaving_high + table_vul_print$dissaving_low
table_vul_print$Share_vul_hh_purch <- table_vul_print$purchase_high + table_vul_print$purchase_low

table_vul_print <- table_vul_print[,c(1,6,7,2,4,3,5)]

colnames(table_vul_print) <- list(" ", "by dissaving", "by purchase"," by dissaving", " by purchase","by dissaving ", "by purchase " )

table_vul_print <- as.data.frame(table_vul_print)

table_vul_print %>%
  # mutate_all(linebreak)%>%
  kableExtra::kbl(
    caption = "Path dependency of financial vulnerability",
    booktabs = T,
    escape = T,
    align = "c"
    # col.names = linebreak(lineBreaks_table, align ="c")
    )%>%
  kable_styling(latex_options =c("scale_down")) %>%

  # Watch out -> here I set the names of the target values
  add_header_above(c("Price\ninfluence" = 1, "% vulnerable\nhouseholds" = 2,
                     "% vul HH that purchased\nat high prices" = 2,
                     "% vul HH that purchased\nat low prices" = 2)) %>%
  footnote(general = "Model values are calculated from single-run with 300 Periods. These periods are equally divided into periods of high and low price influence, where the mid-point of the high price influence is defined as the period where the number of households financially vulnerable by dissaving is highest, based on the cross-correaltions in the Appendix. Periods of high and low prices, on the other hand, are defined as periods with price indices above and below the median house price index, respectively. Here, periods where the house price influence on vulnerability is high are defined as the half of the house price cycle where the share of households vulnerable by dissaving is highest. When this price influence is high, the share of households vulnerable by dissaving that bought their last property at high (i.e. above median) prices is 0.9% versus only 0.3% when price influence is low. The share of households vulnerable by dissaving that bought their last property at low prices is less affected by the overall price influence (only falls from from 0.2% to 0.1%).",threeparttable =T)
```

```{r, ScatterIncomePercentile, fig.cap="Scatterplot of the effect of the parameter Income Percentile on the strength of the dissaving channel", fig.show='hold', message=FALSE, warning=FALSE, out.width='66%', results=FALSE,  echo=FALSE, eval=FALSE}


effect_plot(BaseFormula, pred = incomePercentile, interval = TRUE, plot.points = TRUE,x.label = "Income percentile", y.label = "Strength of dissaving channel")

```

\FloatBarrier

# References {.unnumbered}

<!-- `r if (knitr:::is_html_output()) ' # References {-} '` -->
