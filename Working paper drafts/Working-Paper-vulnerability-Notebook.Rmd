---
title: "Financial Vulnerability and the Housing Market - an Agent-Based Analysis"
author: "Ruben Tarne"
date: "`r Sys.Date()`"
header-includes: 
- \usepackage{amsmath, amsfonts, longtable, tabulary, calc, subfig, booktabs, array, caption}
- \usepackage{floatrow, multirow, wrapfig, float, colortbl, pdflscape, tabu, threeparttable}
- \usepackage{threeparttablex}
- \usepackage[normalem]{ulem}
- \usepackage{makecell}
- \usepackage{xcolor}
- \usepackage{placeins}
- \floatsetup[figure]{capposition=top}
- \floatsetup[table]{capposition=top}
- \renewcommand{\textfraction}{0.05}
- \renewcommand{\topfraction}{0.8}
- \renewcommand{\bottomfraction}{0.8}
- \renewcommand{\floatpagefraction}{0.75}
output:
  bookdown::pdf_document2:
    keep_tex: true
    latex_engine: xelatex
  html_notebook: default
  html_document:
    df_print: paged
  bookdown::html_document2: default
  pdf_document: default
  word_document: default
  bookdown: bookdown::gitbook
  bookdown::word_document2:
    toc: true
abstract: "This paper explores two different channels that homeowners can become financiallly vulnerable by using an agent-based housing market model, calibrated to the UK. Two channels are of interest: Households becoming financially vulnerable by purchasing property with the help of mortgages and homeowners becoming vulnerable by their consumption decisions. We estimate these two channels' relative importance over the housing cycle and find that, interestingly, both channels are of similar importance, while at different states of the housing cycle. Moreover, the characteristics of households becoming vulnerable by these channels differ significantly. While both groups are lower-income, households financially vulnerable after the purchase of a house tend to be younger and are comparatively lowly leveraged, while households vulnerable by dissaving tend to be older and are comparatively highly leveraged. Additionally, we find strong path-depencies, i.e. that peaks of previous housing cycles influence current financial vulnerability significantly. This result This gives Policy implications - be careful when house prices are high, as financial vulnerability can increase today due to transactions in a past cycle. Households "
bibliography: "library-zotero.bib"
biblio-style: "apalike"
link-citations: true
indent: true
---

```{r, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
# This code runs the housing market model with the pre-specified parameter values - however, for micro-data analysis pre-calculations have to be done for building the data frames necessary 
# shell(paste("mvn exec:java", shQuote("-Dexec.args=-configFile src/config-files/test/agent_Data_0.155_0.888_0.98.properties -outputFolder Results/test_agent_Data_0.155_0.888_0.98 -dev")))
# shell(paste("mvn exec:java", shQuote("-Dexec.args=-configFile src/config-files/test/agent_Data_1.0_egal_0.961_noFTBSM.properties -outputFolder Results/test_agent_Data_1.0_egal_0.961_noFTBSM -dev")))

library(here)
library(bookdown)
library(knitr)
library(kableExtra) # needs to be called here to install the necessary latex packages, see: https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_pdf.pdf
source(here::here("R code files\\R functions WP vulnerabilities.R"))
set.seed(1)
model_name <- "Monte10_0.23_0.515_0.457_2.195_71_0.923_0.833_0.977_povLine40Percent_40vul" # use here either the string of param values or the Monte10 version without the "test_"
model_folder <- paste0("test_", model_name) #agent_Data_0.155_0.888_0.98 test_Monte10_0.222_0.556_0.657_4_0.988_0.969_0.7 # the folder is named differently than the model, by adding test_ before

model_folder_noFTBSM <- "test_Agent_data_0.23_0.515_0.457_2.195_71_0.923_0.833_0.977_povLine40Percent_40vul"  # test_agent_Data_0.155_0.888_0.98_noFTBSM
troughs_limits <- c(9,10) # this gives the index of the troughs spanning all figures with a housing cycle. c(2,3) would mean "paint from trough 2 to trough 3"
rolling_averages <- 6
vul_rho <- 0.4
monthsToCover <- 8


```

```{r message=FALSE, warning=FALSE, cache=FALSE, readData, echo=FALSE, results='hide'}
outfile <- read_csv(here::here(paste0("Results/", model_folder, "/Output-run1.csv")))
properties_file <- read.properties(here::here(paste0("Results/", model_folder, "/", model_name, ".properties")))
nMCRuns <- as.numeric(properties_file$N_SIMS) # read here number of monte carlo simulations
nPeriods <- as.numeric(properties_file$N_STEPS) - as.numeric(properties_file$TIME_TO_START_RECORDING)
# outfile <- read_outfile_total(wd_model = "Results", model_folder_name = model_folder, nRuns = nMCRuns) 
was_wave_5_hhold_eul_final <- read_sav("~/UK-WEA-survey/UKDA-7215-spss/spss/spss24/was_wave_5_hhold_eul_final.sav")
# load(here::here(file = "Agent_Data_0.155_0.888_0.98.RData"))
# load(here::here(file = "Agent_Data_1.0_egal_0.961_noFTBSM.RData"))
load(here::here(file = paste0(model_folder_noFTBSM, ".RData"))) # this includes sortingData_data_vul_FTBS and transactions_hpi
# load(here::here(file = paste0(model_folder_noFTBSM,"_diffAmpudia.RData"))) # this is for testing the consumption channel strength with different Ampudia measures
load(here::here(file = paste0("test_Agent_data_0.23_0.515_0.457_2.195_71_0.923_0.833_0.977_povLine40Percent_40vul","_diffAmpudia.RData")))
```

# Introduction

-   Households that dissave when prices are high can become financially vulnerable (more susceptible to employment shocks) and therefore a danger to economic stability

-   As most agent-based models, the model used here is not analytically solvable, which is why we run (repeated) computational simulations with plausible parameterisations to produce numerical results and then investigate the transmission channels.

-   @albacete_distribution_2016 Test the loss given default stemming from financially vulnerable households in Austria for the case of falling house prices. They built for each household They conclude that the loss given default does not increase to a

-   @Mian2013 find evidence that lower-income households and more highly leveraged households have larger marginal propensities to consume out of housing wealth. They study the housing bust from 2006 --- 2009 in the US. They find stronger declines of refinancing in ZIP codes with higher leverage. Their findings are in support of Fisher's [@fisher_debt-deflation_1933] "debt deflation".

-   @Kaplan2016 expand the analysis by @Mian2013 and confirm their findings.

-   @guerrieri_credit_2017 permanently shock consumers' borrowing capacity in a heterogeneous-agent, incomplete-market model and find that precautionary saving helps in producing a recession with low interest rates.

-   @dalessio_over-indebtedness_2016 research the evolution of financial vulnerability in Italy from 2008 to 2014. They conclude that a vulnerability measure incorporating the financial asset position of households captures financial distress of households. The measured persistence of households in states of financial vulnerability is low, but these could be partly explained by high volatility of financial assets and measurement errors in wealth. Real house prices continuously declined from 2008 until 2014.

-   The paper also connects to the literature of stress-testing households and nowcasting indicators of financial vulnerability of households. This literature is concerned with the lack of timeliness of micro household data needed to perform nowcasting @bankowska_household_2017.

    -   @peterson_household_2016 build a dynamic model connecting micro-household data with macro data to simulate future financial vulnerability under a given macroeconomic scenario. Households have simple behavioural rules and their balance sheet change over time. However, the authors do not consider a consumption response to wealth and only households that are unemployed can dissave.

-   Research question: how do the consumption decisions of households with mortgages influence financial vulnerability (of this subgroup) over the housing cycle? So we focus on financial vulnerability stemming from the housing market and debt repayments - house prices... strongly fluctuating asset prices

-   Policy implications: if consumption decisions have large influences, it is difficult to intervene. If house prices seem to be a problem, they should be tackled. Be careful wehn house prices are high. There are longer-lasting consequences of buying.

-   We find not only different stages in the cycle are important, but also different cycles -\> mortgage debt is usually held for a longer period of time, where more cycles could happen

# Literature

[...]

# The Model

## Model structure 

[...]

## Bids on the housing market

[...]

## Offers on the housing market

[...]

## Households' Consumption

@Aladangady2017 found the overall housing wealth effect of 4.7% in the US to be exclusively driven by households with above-median debt-service-to income ratios (DSR), which he defined as potentially credit constraint. Specifically, households with above-median DSRs have an estimated housing wealth effect of 12.7%, versus 0% for households with below-average DSRs. Similarly, @Zhang2019 finds a housing wealth effect for Dutch households with above-median debt-to-income ratios (DTI) of 10.3% versus 4.1% for households with below-median DTIs. These different responses to house prices could be driven by a collateral or a precautionary saving channel. The collateral channel would imply that with falling house prices more credit-constraint households would have less ability to withdraw house equity, lowering their consumption spending. Similarly, households getting closer to their borrowing limit (due to falling house prices) could reduce their spending to increase their precautionary wealth [@Carroll2011]. We implement a desired-consumption function mirroring these findings:

```{=tex}
\begin{equation}
c^{desired}_{i,t} = c_{0} + \alpha_{i} y^{m,disp}_{i,t} + \beta_{i}b_{i,t} + \gamma_{i,t} (w^{h}_{i,t} -  q_{i,t}),
(\#eq:dConsumption)
\end{equation}
```
where $c_{0}$ represents essential consumption, $y^{m,disp}_{i,t}$ monthly disposable income (defined as $y_{i,t} - \sum_{i=1}^{k} m_{i,k}$), $b_{i,t}$ deposits, $w^{h}_{i,t}$ gross housing wealth and $q_{i,t}$ mortgage debt. $\alpha_{i}$ is dependent on the on the agents' income (specifically their income percentile assigned at "birth" $\Xi_{i}$), becoming weaker the richer the household is, while first-time buyer agents have an extra saving motive to save up for a downpayment[^1]. $\beta_{i}$, like $\alpha_{i}$ gets weaker the higher the households' income [@Dynan2004; @Arrondel2019].

[^1]: First-time buyers with $\Xi_{i} >$ `r properties_file$minIncomePercentile` have marginal propensity to consume out of disposable income ($\alpha_{i}$) of `r properties_file$MPCForFirstTimeBuyers`. See chapter \@ref(calibration) in the Appendix for the calibration of these values.

$\gamma_{i,t}$ is the effect of net housing wealth on consumption. If the households DSR is above the median, $\gamma_{i,t} = 0.01$ (which adds up to a yearly value of 12.7%). The households DSR is defined as the sum of monthly mortgage payments over its income $\sum_{i=1}^{k} m_{i,k} / y_{i,t}$.

The desired consumption is subject to certain constraints:

```{=tex}
\begin{equation}
c_{i,t} = 
\begin{cases}
\text{if } b_{i,t}-( c^{desired}_{i,t} - y^{m,disp}_{i,t} )<\zeta_{i,t} y^{m,disp}_{i,t} &\text{, }\beta_{i}, \gamma_{i,t} = 0\\
\text{if } c^{desired}_{i,t} < c_{0} & \text{, } \alpha_{i}, \beta_{i}, \gamma_{i,t} = 0\\
\text{else } & \text{, } c_{i,t}=c^{desired}_{i,t}
\end{cases}
(\#eq:consumption)
\end{equation}
```
where the first condition states that households do not consume more than their current disposable income (after taxes and mortgage/rental payments) if it would bring their deposits below a precautionary value ($\zeta_{i,t} y^{m,disp}_{i,t}$)[^2], which is $0$ if the household has a DSR above the median. The second condition states that households always consume $c_{0}$, even if their desired consumption is below that (for instance due to large negative housing wealth).

[^2]: Set to `r properties_file$liquidityPreference`. See calibration in chapter \@ref(calibration).

## Calibration

```{r buildingDistributionData, echo=FALSE, message=FALSE, warning=FALSE, results=FALSE}

Wave_5_HH <- was_wave_5_hhold_eul_final%>%
  mutate(MortgagePayment1 = case_when(MPayM1W5 %in% c(-9:-6) ~ 0, TRUE~as.numeric(MPayM1W5)),
         MortgagePayment2 = case_when(MPayM2W5 %in% c(-9:-6) ~ 0, TRUE~as.numeric(MPayM2W5)),
         MortgagePayment3 = case_when(MPayM3W5 %in% c(-9:-6) ~ 0, TRUE~as.numeric(MPayM3W5)),
         totalMortgagePayments = MortgagePayment1 + MortgagePayment2 + MortgagePayment3,
         Mortgage1 = case_when(MVal1W5 %in% c(-9:-6) ~ 0, TRUE~as.numeric(MVal1W5)),
         Mortgage2 = case_when(MVal2W5 %in% c(-9:-6) ~ 0, TRUE~as.numeric(MVal2W5)),
         Mortgage3 = case_when(MVal3W5 %in% c(-9:-6) ~ 0, TRUE~as.numeric(MVal3W5)),
         totalMortgageDebt = Mortgage1 + Mortgage2 + Mortgage3)%>%
  select(totalMortgageDebt,
         totalMortgagePayments,
         w5xshhwgt,                    # weight
         HRPDVAgeW5,                # age
         
         NumAdultW5, # number adults in household
         NumChildW5, # number of children
         Ten1w5_i, # tenure (only one is imputed)
         
         ## mortgages and housing
         MNumbNW5, #	Number mortgages or loans on property (only if no mortgage in W4 on this property
         MNumbOW5, #	Number mortgages or loans on property (only if mortgage in W4 on this property
         MNumbw5_i, #	Number of mortgages/loans
         MVal1W5, #	Amount still outstanding mortgageloan
         MValB1W5, #	Banded amount outstanding on mortgageloan (only about 100)
         MYLft1W5,        # Years left to run on mortgage
         # MPayM1W5, # Total monthly repayments for mortgage
         MPayB1W5, # Banded amount (about 25)
         MPastSPA1W5, # expecting to pay mortgage past pension age
         MIntRate1W5,	# Interest paid on mortgage?

         TotMortw5, # Total mortgage on main residence
         DVHValuew5, # Value of main residence
         OthMortw5_sum, #Total property debt
         DBurdHW5, # debt burden
         HBuyYrW5, #	Year bought main residence
         
         # finanaical wealth
         
         HFINWw5_sum, # Gross Financial Wealth
         HFINWNTw5_sum,   # Household Net financial Wealth (financial assets minus financial liabilities)
        
         DVTotGIRW5,                 # Household Gross Annual (regular) income
         DVTotNIRW5,                 # Household Net Annual (regular) income
         DVGrsRentAmtAnnualw5_aggr,  # Household Gross annual income from rent
         DVNetRentAmtAnnualw5_aggr,  # Household Net annual income from rent
       
         # List of other household variables of possible interest
         HRPDVILO3aW5,	# ILO employment status of HRP or partner
         
         HRPNSSEC3W5, # Socio-economic classification of HRP or partner

         HPHYSWW5,                   # Total Physical Wealth
         HPROPWw5,                   # Total property wealth
         TOTPENw5_aggr,              # Total hhold pension value
         TotWlthW5,                  # Total household wealth
         DVPropertyw5)%>% # 5	Sum of all property values
rename(Weight = "w5xshhwgt",
         Age = "HRPDVAgeW5", 
         NFW = "HFINWNTw5_sum",
         GrossFinancialWealth = "HFINWw5_sum",
         GrossAnnualRegularIncome = "DVTotGIRW5",                 # Household Gross Annual (regular) income
         NetAnnualRegularIncome = "DVTotNIRW5",                 # Household Net Annual (regular) income
         GrossAnnualRentalIncome = "DVGrsRentAmtAnnualw5_aggr",  # Household Gross annual income from rent
         NetAnnualRentalIncome = "DVNetRentAmtAnnualw5_aggr",  # Household Net annual income from rent
         
         # List of other household variables of possible interest
         Employment = "HRPDVILO3aW5",              # Employment Status of HRP or partner
         PhysicalWealth = "HPHYSWW5",                   # Total Physical Wealth
         NetHousingWealth = "HPROPWw5",                   # Total property wealth
         TotalPensionWealth = "TOTPENw5_aggr",              # Total hhold pension value
         TotalWealth = "TotWlthW5",                  # Total household wealth
         # NetAnnualSelfEmployedIncome = "DVNISEw5_aggr",              # Household Total Annual Net self employed income
         # NetAnnualEmployeeIncome = "DVNIEMPw5_aggr",             # Household Total Annual Net employee income
         # GrossAnnualInvestmentIncome = "DVGIINVw5_aggr",             # Household Gross annual income from investments
         # NetAnnualInvestmentIncome = "DVNIINVw5_aggr",             # Household Net annual income from investments
         GrossHousingWealth = "DVPropertyw5")%>%
filter(!is.na(Weight)) %>%# there is at least one observation where the weight is NA, which leads to problems when building the unweighted version
mutate(finanicalMargin = NetAnnualRegularIncome/12 - totalMortgagePayments - vul_rho*2750, # TODO better calculate this value on the spot 
         monthsAbleToCover = GrossFinancialWealth/finanicalMargin, # negative value means finanical margin is negative
         vulnerable = case_when(monthsAbleToCover<0 & monthsAbleToCover > -8 & totalMortgagePayments !=0 ~ 1, TRUE ~ 0),
         debtIsHeavyBurden = case_when(DBurdHW5 == 1 ~ 1,TRUE ~ 0)
  ) 

wave_5_for_graph <-Wave_5_HH %>% #Wave_5_HH %>%  weighted_Wave5
  filter(totalMortgagePayments != 0) %>%
  mutate(vulnerable = case_when(vulnerable == 0 ~ FALSE, vulnerable ==1 ~TRUE))%>%
  mutate(DSR = 12*totalMortgagePayments/ GrossAnnualRegularIncome)%>%
  mutate(DTI = totalMortgageDebt/GrossAnnualRegularIncome)

core_medians_WAS_DSR <- wave_5_for_graph %>%
  group_by(vulnerable) %>%
  summarise(coreIndicator = weighted.median(DSR, w = Weight))

core_medians_WAS_Age <- wave_5_for_graph %>%
  group_by(vulnerable) %>%
  summarise(coreIndicator = weighted.median(Age, w = Weight))

wave_5_calculating_nonPayments <-Wave_5_HH %>% #Wave_5_HH %>%  weighted_Wave5
  mutate(MortgagePaymentsRecorded = case_when(totalMortgagePayments == 0 ~ FALSE, totalMortgagePayments != 0 ~ TRUE))%>%
  filter(totalMortgageDebt !=0)%>%
  mutate(vulnerable = case_when(vulnerable == 0 ~ FALSE, vulnerable ==1 ~TRUE))%>%
  mutate(DSR = 12*totalMortgagePayments/ GrossAnnualRegularIncome)%>%
  mutate(DTI = totalMortgageDebt/GrossAnnualRegularIncome)


wave_5_payments_T_F <- wave_5_calculating_nonPayments %>%
  group_by(MortgagePaymentsRecorded) %>%
  tally(wt= Weight)
# n[2] is where mortgagepaymentsRecorded = TRUE
share_wave_5_payment <- wave_5_payments_T_F$n[2] / sum(wave_5_payments_T_F$n)

wave_5_payments_T_F_Age <- wave_5_calculating_nonPayments %>%
  group_by(MortgagePaymentsRecorded) %>%
  summarise(coreIndicator = weighted.median(Age, w = Weight))

wave_5_payments_T_F_DTI <- wave_5_calculating_nonPayments %>%
  group_by(MortgagePaymentsRecorded) %>%
  summarise(coreIndicator = weighted.median(DTI, w = Weight))


wave_5_calculating_shareVulTotalPopulation <-Wave_5_HH %>% #Wave_5_HH %>%  weighted_Wave5
  mutate(MortgagePaymentsRecorded = case_when(totalMortgagePayments == 0 ~ FALSE, totalMortgagePayments != 0 ~ TRUE))%>%
  mutate(vulnerable = case_when(vulnerable == 0 ~ FALSE, vulnerable ==1 ~TRUE))%>%
  mutate(hasDebt = case_when(totalMortgageDebt !=0 ~ TRUE, TRUE ~ FALSE))%>%  
  mutate(DSR = 12*totalMortgagePayments/ GrossAnnualRegularIncome)%>%
  mutate(DTI = totalMortgageDebt/GrossAnnualRegularIncome)

## build data frame for calculting weighed mean -> share of vulnerable households in indebted households
wave_vul_weight <- Wave_5_HH%>%  # weighted_Wave5  # Wave_5_HH
  filter(totalMortgageDebt!=0)%>%
  filter(totalMortgagePayments != 0) %>%
  select(vulnerable,Weight)

# calculating the share of vulnerable households in all households when assuming that indebted households
# reporting and not reporting have the same chance of being vulnerable (they are probably lower..)
share_vul_HH_payment_subgroup <- weighted.mean(wave_vul_weight$vulnerable, w = wave_vul_weight$Weight)

share_wave_5_VulHH_AllHH <- wave_5_calculating_shareVulTotalPopulation%>%
  group_by(hasDebt) %>%
  tally(wt = Weight)

number_households_wave_5 <- tally(wave_5_calculating_shareVulTotalPopulation, wt = Weight)

share_wave_5_VulHH_AllHH <-share_wave_5_VulHH_AllHH %>% 
  filter(hasDebt == TRUE)%>%
  select(n)
share_wave_5_VulHH_AllHH <- share_wave_5_VulHH_AllHH / number_households_wave_5 * share_vul_HH_payment_subgroup

sortingData_for_figure <-  sortingData_data_vul_FTBSM%>% # sortingData_data_vul_noFTBSM sortingData_data_vul_noFTBSM_0.961
  filter(Debt < 0)%>%
  mutate(DTI = Debt/(-12* MonthlyGrossTotalIncome))%>%
  mutate(DSR = MonthlyMortgagePayments/MonthlyGrossTotalIncome)%>%
  mutate(hasDebt = case_when(Debt<0 ~ TRUE, TRUE ~ FALSE))


core_medians_DSR <- sortingData_for_figure %>%
  group_by(vulnerable) %>%
  summarise(coreIndicator = median(DSR, na.rm = TRUE))


core_medians_Age <- sortingData_for_figure %>%
  group_by(vulnerable) %>%
  summarise(coreIndicator = median(Age, na.rm = TRUE))

```

The new parameters introduced into the base model [@Baptista2016] are given in Table \@ref(tab:parameters). Apart from these new parameters, we re-calibrated the commercial bank's internal LTV caps for the different agent classes to match the stylized facts. There are no empirical statistics on these caps and the Bank of England is currently not enforcing LTV caps themselves. As LTV caps have strong effects on the housing market dynamics [Reference Working Paper 1] they are included in the calibration.

The model is calibrated[^3] to match specific stylized facts from the UK housing market which are important for estimating the effect of housing transactions and dissaving on financial vulnerability. These include the Bank of England's *Core Indicators for setting the LTV and DTI ratios* [@BoE2018, p. 68] shown in Table \@ref(tab:BoECoreIndicators). Additional stylized facts with focus on the wealth distribution and the characteristics of financially vulnerable households are taken from the ONS and the Wealth and Asset Survey, reported in Table \@ref(tab:CoreIndicators).

[^3]: We first set upper and lower limits for the parameters in Table \@ref(tab:parameters) and then used a Latin Hypercube to sample 1000 different parameter combinations which we ran the model with. The outputs were rated with help of an (unweighed) cost function of the quadratic distance from the target values. From this array of models we selected one matching the stylized facts as good as possible.

While we are not able to match all stylized facts, none of our indicators are critically off target. The model's output is in bounds of the reported Bank of England's Core Indicators' values (Table \@ref(tab:BoECoreIndicators)) with the exception of the slightly too-high average debt-to-income ratio (DTI) of Owner-Occupiers (encompassing first-time buyers and second-and-subsequent buyers), the too-high monthly purchases of buy-to-let (BTL) agents, and rental yield. As in the model BTL agents rarely become financially vulnerable, even with this higher turnover, this should not distort our analysis much.

As we are making statements about the importance of a wealth effect channel on financial vulnerability we have to make sure that the households vulnerable in our model are similar to those in the UK. Therefore, we compare the model's output with the fifth wave of the Wealth and Asset Survey (WAS), using the same definition of financial vulnerability as presented in chapter \@ref(financial-vulnerability).

Figure \@ref(fig:DSRWAS) shows the debt-service-to-income ratio distributions for financially vulnerable and non-vulnerable households in the WAS (left panel) and model (right panel). The median DSR of non-vulnerable households is `r formattable::percent(core_medians_WAS_DSR$coreIndicator[1], digits = 1)` in the WAS and `r formattable::percent(core_medians_DSR$coreIndicator[1], digits = 1)` in the model. Financially vulnerable households' DSR is `r formattable::percent(core_medians_WAS_DSR$coreIndicator[2], digits = 1)` in the WAS and `r formattable::percent(core_medians_DSR$coreIndicator[2], digits = 1)` in the model[^4]. While median DSRs of the model and WAS are very close together, the model's DSRs are more spread out with higher density at very low and high values. We will discuss the potential consequences on the results in the conclusion. The figure shows another important relationship, namely the share of financially vulnerable households in all households with mortgage debt[^5]. For the WAS the share of vulnerable households of all households with mortgage debt is `r formattable::percent(share_vul_HH_payment_subgroup, digits = 1)` and for the model, using the same definition as introduced above, this share is `r formattable::percent(mean(outfile$"%vulHH of indebtedHH"), digits = 1)`.

[^4]: An alternative measurement for the model is the mean of the median DSR in each period - not the overall median of the DSR distribution of all financially vulnerable households over all periods (i.e. each households is recorded once per period). The DSR of vulnerable households is then `r formattable::percent(mean(outfile$"vulHH medianDSR"), digits = 1)`. This measurement is also used in table \@ref(tab:CoreIndicators).

[^5]: More specifically, due to data limitations we only take the sub-group of interviewed households with recorded mortgage payments into account, as we need those to calculate their financial margin. They make up `r formattable::percent(share_wave_5_payment, digits = 0)` of all indebted households interviewed. Both sub-groups seem to be quite similar, while those reporting specific monthly mortgage payments tend to be a bit younger (median age is `r wave_5_payments_T_F_Age%>%filter(MortgagePaymentsRecorded == TRUE)%>% select(coreIndicator)` instead of `r wave_5_payments_T_F_Age%>%filter(MortgagePaymentsRecorded == FALSE)%>% select(coreIndicator)`). Assuming the share of vulnerable households would be the same in the sub-group with and without recorded mortgage payments, the share of financially vulnerable households of *all* households would be `r formattable::percent(share_wave_5_VulHH_AllHH, digits = 1)` -- in the model this share is `r formattable::percent(mean(outfile$"nVulHH (X*medIncome Y*m)" / outfile$TotalPopulation), digits = 1)`.

```{r DSRWAS, fig.cap="Histogram and median value of debt-service-ratios of finanically vulnerable and non-vulnerable households in the Wealth and Asset Survey (left) and the model (right)",fig.subcap=c("Wealth and Asset Survey", "Model output"),  fig.show='hold', message=FALSE, warning=FALSE, out.width='49%', results=FALSE,  echo=FALSE}


graph <- wave_5_for_graph%>%
  ggplot(aes(DSR, fill = vulnerable, weight = Weight))+
  # ggtitle("Vulnerable households \n(subgroup: mortgage payments, N= 4,204,219 households)")+
  # ggtitle("Testing the differences in distribution between \nhouseholds with recorded mortgage payments and those without")+
  # ggtitle("WAS output (unweighed, and only HH with explicit mortgage payments)")+
  # scale_x_log10()+
  xlim(c(0,0.75))+
  geom_vline(
    data = core_medians_WAS_DSR, linetype = "dashed", size = 1,
    aes(xintercept = coreIndicator, colour = vulnerable)
  )+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  # theme(plot.caption = element_text(family = ,
  #                                   size = 14))+
    labs(caption = "Notes: Subgroup of households with recorded mortgage payments.")
    

##### model 
sortingData_for_figure %>%
  ggplot(aes(DSR, fill = vulnerable))+
  # ggtitle("Model households")+ # \nsubgroup indebted households")+
  # ggtitle("Model output (over")+  #\nlowest income quartile exempt
  # geom_density(alpha = 0.5, position = "identity" )+
  geom_histogram(alpha = 0.5, position = "identity" )+
  xlim(c(0,0.75))+
  # scale_x_log10()+
  geom_vline(
    data = core_medians_DSR, linetype = "dashed", size = 1,
    aes(xintercept = coreIndicator, colour = vulnerable)
  )+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  labs(caption = "Notes: Each data point is one household in one period (month) \nover one Monte-Carlo simulation with 600 periods.")
# graph + geom_density(alpha = 0.5, position = "identity" )

### WAS 
graph + geom_histogram(alpha = 0.5, position = "identity")





```

<!-- median Age -->

Another important stylized fact is to match the age distribution of vulnerable and non-vulnerable households. Since with retirement the model's households' income falls significantly at age 65, a higher share of vulnerable households here (as opposed to the WAS) could imply an overestimation of dissaving on financial vulnerability, driven by drops in income. In the model, the age of financially vulnerable households is driven by both the saving motive for first-time buyers (stronger motive leads to younger households entering the market) and the maximum age by which a household has to repay her mortgages (the higher the maximum age, the older financially vulnerable households tend to be). In the WAS the median age for financially vulnerable and non-vulnerable households is equally `r round(core_medians_WAS_Age$coreIndicator[1], digits = 0)`. The median age for non-vulnerable households in the model is `r round(core_medians_Age$coreIndicator[1], digits = 1)` and `r round(core_medians_Age$coreIndicator[2], digits = 1)` for vulnerable households. The model's age distribution shows higher density at the lower tail, with more households vulnerable below 30 years and has a cluster between 50 and 60 years, where the WAS seems to have a cluster around 50 years.

The rest of the empirical values, which are presented in Table \@ref(tab:CoreIndicators), are matched remarkably well.

```{r AgeWAS, fig.cap="Histogram of the age of finanically vulnerable and non-vulnerable households in the Wealth and Asset Survey (left) and the model (right)", fig.subcap=c("Wealth and Asset Survey", "Model output"), fig.show='hold', message=FALSE, warning=FALSE, out.width='49%', results=FALSE,  echo=FALSE}


binSize <- 20

graph <- wave_5_for_graph%>%
  ggplot(aes(Age, fill = vulnerable, weight = Weight))+
  # ggtitle("Vulnerable households \n(subgroup: mortgage payments, N= 4,204,219 households)")+
  # ggtitle("Testing the differences in distribution between \nhouseholds with recorded mortgage payments and those without")+
  # ggtitle("WAS output (unweighed, and only HH with explicit mortgage payments)")+
  # scale_x_log10()+
  xlim(c(20,80))+
  geom_vline(
    data = core_medians_WAS_Age, linetype = "dashed", size = 1,
    aes(xintercept = coreIndicator, colour = vulnerable)
  )+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
    labs(caption = "Notes: Subgroup of households with recorded mortgage payments.")

# graph + geom_density(alpha = 0.5, position = "identity" )
graph + geom_histogram(alpha = 0.5, position = "identity", bins = binSize)

sortingData_for_figure %>%
  ggplot(aes(Age, fill = vulnerable))+
  # ggtitle("Model households")+ # \nsubgroup indebted households")+
  # ggtitle("Model output (over")+  #\nlowest income quartile exempt
  # geom_density(alpha = 0.5, position = "identity" )+
  geom_histogram(alpha = 0.5, position = "identity" , bins = binSize)+
  xlim(c(20,80))+
  # scale_x_log10()+
  geom_vline(
    data = core_medians_Age, linetype = "dashed", size = 1,
    aes(xintercept = coreIndicator, colour = vulnerable)
  )+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  labs(caption = "Notes: Each data point is one household in one period (month) \nover one Monte-Carlo simulation with 600 periods.")
```

(ref:Dynan-citation) @Dynan2004

(ref:Arrondel-citation) @Arrondel2019

```{r parameters, message=FALSE, warning=FALSE,  echo=FALSE}
# - FTB SM MPC check
# - FTB SM percentile check
# - financial wealth effect for income percentiles check 
# - liquidity preference
# - payments to income
# - LTV FTB, SSB BTL



parameters_table <-data.frame(Parameter = c("$\\alpha_{\\Xi \\leq 0.25}$", 
                                            "$\\alpha_{\\Xi > 0.25 \\leq 0.5}$", 
                                            "$\\alpha_{\\Xi > 0.5 \\leq 0.75}$", 
                                            "$\\alpha_{\\Xi > 0.75 \\leq 0.9}$", 
                                            "$\\alpha_{\\Xi > 0.9 \\leq 0.99}$",
                                            "$\\alpha_{\\Xi > 0.99}$",
                                            "$\\beta_{\\Xi \\leq 0.25}$", 
                                            "$\\beta_{\\Xi > 0.25 \\leq 0.5}$", 
                                            "$\\beta_{\\Xi > 0.5 \\leq 0.75}$", 
                                            "$\\beta_{\\Xi > 0.75 \\leq 0.9}$", 
                                            "$\\beta_{\\Xi > 0.9}$", 
                                            "$\\alpha_{FTB,i}$", 
                                            "$\\Xi_{i}$", 
                                            "$\\zeta_{i,t}$",
                                            "$\\sigma$",
                                            "$Age^{OO}_{repayment}$",
                                            "$LTV^{cap}_{FTB}$",
                                            "$LTV^{cap}_{SSB}$",
                                            "$LTV^{cap}_{BTL}$"), # possibly use another variable name. In the equation list this is alpha (with equation number 39 as of March 2021) ###### TODO Update once complete model description is written
                              Description = c("Monthly propensity to consume out of disposable income for households in income percentile $\\leq 0.25$",
                                              "Monthly propensity to consume out of disposable income for households in income percentile $> 0.25 \\leq 0.5$",
                                              "Monthly propensity to consume out of disposable income for households in income percentile $> 0.5 \\leq 0.75$",
                                              "Monthly propensity to consume out of disposable income for households in income percentile $> 0.75 \\leq 0.9$",
                                              "Monthly propensity to consume out of disposable income for households in income percentile $> 0.9 \\leq 0.99$",
                                              "Monthly propensity to consume out of disposable income for households in income percentile $> 0.99$",
                                              "Monthly propensity to consume induced by finanical wealth for households in income percentile $\\leq 0.25$",
                                              "Monthly propensity to consume induced by finanical wealth for households in income percentile $> 0.25 \\leq 0.5$",
                                              "Monthly propensity to consume induced by finanical wealth for households in income percentile $> 0.5 \\leq 0.75$",
                                              "Monthly propensity to consume induced by finanical wealth for households in income percentile $> 0.75 \\leq 0.9$",
                                              "Monthly propensity to consume induced by finanical wealth for households in income percentile $> 0.9$",
                                              "Propensity to consume out of disposable income for FTB agents above specific income percentile",
                                              "Income percentile value above which FTB agents save for a downpayment via $\\alpha_{FTB,i}$",
                                              "Liquidity preference for households with DSRs below the median, for households with DSRs above the median $\\zeta_{i,t} = 0$",
                                              "Maximum share of posttax income that investors spend on mortgage payments",
                                              "Maximum age by which mortgages for owner-occupiers have to be repaid",
                                              "Maximum LTV of FTB mortgage contracts", 
                                              "Maximum LTV of SSB mortgage contracts",
                                              "Maximum LTV of BTL mortgage contracts"),
                              Value = c(properties_file$consumptionFractionQ1,
                                        properties_file$consumptionFractionQ2,
                                        properties_file$consumptionFractionQ3,
                                        properties_file$consumptionFractionQ4,
                                        properties_file$consumptionFractionTop10,
                                        properties_file$consumptionFractionTop1,
                                        properties_file$wealthEffectQ1, # in the properties file Q1 and Q2 are separate fields
                                        properties_file$wealthEffectQ2,
                                        properties_file$wealthEffectQ3,
                                        properties_file$wealthEffectQ4,
                                        properties_file$wealthEffectTop10, #  in the properties file there is a top 1% field as well
                                        properties_file$MPCForFirstTimeBuyers,
                                        properties_file$minIncomePercentile,
                                        properties_file$liquidityPreference,
                                        properties_file$paymentsToIncome,
                                        properties_file$BANK_AGE_LIMIT,
                                        properties_file$centralBankFirstTimeBuyerLTVLimit,
                                        properties_file$centralBankOwnerOccupierLTVLimit,
                                        properties_file$centralBankBTLLTVLimit),
                              Source = c("(ref:Dynan-citation) PSID and SCF Data",
                                                                   "as above", 
                                                                   "as above",
                                                                   "as above",
                                                                   "as above",
                                                                   "as above",
                                                                   "(ref:Arrondel-citation)",
                                                                   "as above",
                                                                   "as above",
                                                                   "as above",
                                                                   "as above",
                                                                   "[0 - 1.0]",
                                                                   "[0.5 - 1.0]",
                                                                   "[0.33 - 0.75]",
                                                                   "[0 - 4.0]",
                                                                   "[65 - 80]",
                                                                   "[0.75 - 0.99]",
                                                                   "[0.75 - 0.99]",
                                                                   "[0.75 - 0.99]"
                                                                   )
)

# parameter list
# 1# min income percentile       #  0 - 1.0
# 2# MPCForFirstTimeBuyers       #  0.5 - 1.0
# 3# payments to income          #  0.33 - 0.75
# 4# liquidity preference        #  0 - 4.0
# 5# BANK_AGE_LIMIT              #  65 - 80
# 6# LTV 1                       #  0.75 - 0.99
# 7# LTV 2                       #  0.75 - 0.99
# 8# LTV 3                       #  0.75 - 0.99

names(parameters_table) <- c("Parameter", "Description", "Value", "Range for calibration / Source")

parameters_table %>%
  kbl(booktabs =T, 
      # align ="c",
      escape = FALSE, # this will convert the math expressions properly
      caption = "New parameters") %>%
  kable_styling(latex_options =c("striped"), full_width = FALSE)%>%
  column_spec(2, width = "9cm") %>%
  column_spec(4, width = "2.5cm") %>%
footnote(general = paste0("The marginal propensities to consume, based on ", "(ref:Dynan-citation)" ," and ", "(ref:Arrondel-citation)", ", are each slightly adjusted to match the wealth inequality and debt-to-deposit ratio."),
         threeparttable =T)




```

(ref:BoE2018-citation) [@BoE2018, p.68]

```{r BoECoreIndicators, message=FALSE, warning=FALSE,  echo=FALSE}
# build data frame with the core indicators
# 2:nPeriods+1 because the files start only in their second column
coreIndicators <- data.frame(row.names = ("Model Output"),Debt_to_income_ratio =mean(rowMeans(read_csv(here::here(paste0("Results/",model_folder,"/coreIndicator-debtToIncome.csv")), col_names = FALSE)[1:nMCRuns,2:(nPeriods+1)], na.rm = TRUE)),
                         OO_debt_to_income_ratio = mean(rowMeans(read_csv(here::here(paste0("Results/",model_folder,"/coreIndicator-ooDebtToIncome.csv")), col_names = FALSE)[1:nMCRuns,2:(nPeriods+1)], na.rm = TRUE)),
                         OO_LTI_mean_above_median = mean(rowMeans(read_csv(here::here(paste0("Results/",model_folder,"/coreIndicator-ooLTI.csv")), col_names = FALSE)[1:nMCRuns,2:(nPeriods+1)], na.rm = TRUE)),
                         OO_LTV_mean_above_median = mean(rowMeans(read_csv(here::here(paste0("Results/",model_folder,"/coreIndicator-ooLTVAboveMedian.csv")), col_names = FALSE)[1:nMCRuns,2:(nPeriods+1)], na.rm = TRUE)),
                         BTL_LTV_ratio = mean(rowMeans(read_csv(here::here(paste0("Results/",model_folder,"/coreIndicator-btlLTV.csv")), col_names = FALSE)[1:nMCRuns,2:(nPeriods+1)], na.rm = TRUE)),
                         # OO_LTV_mean = mean(rowMeans(read_csv(here::here(paste0("Results/",model_folder,"/coreIndicator-ooLTV.csv")), col_names = FALSE)[1:nMCRuns,2:(nPeriods+1)], na.rm = TRUE)),
                         Housing_transactions_month = mean(rowMeans(read_csv(here::here(paste0("Results/",model_folder,"/coreIndicator-housingTransactions.csv")), col_names = FALSE)[1:nMCRuns,2:(nPeriods+1)], na.rm = TRUE)),
                         Mortgage_approvals = mean(rowMeans(read_csv(here::here(paste0("Results/",model_folder,"/coreIndicator-mortgageApprovals.csv")), col_names = FALSE)[1:nMCRuns,2:(nPeriods+1)], na.rm = TRUE)),
                         Advances_to_homemovers = mean(rowMeans(read_csv(here::here(paste0("Results/",model_folder,"/coreIndicator-advancesToMovers.csv")), col_names = FALSE)[1:nMCRuns,2:(nPeriods+1)], na.rm = TRUE)),
                         Advances_to_FTB = mean(rowMeans(read_csv(here::here(paste0("Results/",model_folder,"/coreIndicator-advancesToFTB.csv")), col_names = FALSE)[1:nMCRuns,2:(nPeriods+1)], na.rm = TRUE)),
                         Advances_to_BTL = mean(rowMeans(read_csv(here::here(paste0("Results/",model_folder,"/coreIndicator-advancesToBTL.csv")), col_names = FALSE)[1:nMCRuns,2:(nPeriods+1)], na.rm = TRUE)),
                         House_price_to_income_ratio = mean(rowMeans(read_csv(here::here(paste0("Results/",model_folder,"/coreIndicator-priceToIncome.csv")), col_names = FALSE)[1:nMCRuns,2:(nPeriods+1)], na.rm = TRUE)),
                         Rental_Yield = mean(rowMeans(read_csv(here::here(paste0("Results/",model_folder,"/coreIndicator-RentalYield.csv")), col_names = FALSE)[1:nMCRuns,2:(nPeriods+1)], na.rm = TRUE))
                         # Spreads_in_bp = mean(rowMeans(read_csv(here::here(paste0("Results/",model_folder,"/coreIndicator-interestRateSpread.csv")), col_names = FALSE)[1:nMCRuns,2:(nPeriods+1)], na.rm = TRUE)),
                         # BTL_share = mean(rowMeans(read_csv(here::here(paste0("Results/",model_folder,"/coreIndicator-BTLMarketShare.csv")), col_names = FALSE)[1:nMCRuns,2:(nPeriods+1)], na.rm = TRUE))
                         )
# adjsut from % to double values
coreIndicators <- coreIndicators %>%
  mutate(Debt_to_income_ratio = Debt_to_income_ratio / 100, 
         OO_debt_to_income_ratio = OO_debt_to_income_ratio / 100,
         BTL_LTV_ratio = BTL_LTV_ratio / 100,
         OO_LTV_mean_above_median = OO_LTV_mean_above_median / 100,
         Rental_Yield = Rental_Yield / 100)

# read the excel of the Bank of England's core indicators (from end 2018)
# as the table is not easily read due to its formatting, I clean the data first
BoE_coreIndicators <- as.data.frame(read_excel(path = here::here("statistical output R/Bank of England core indicators time series.xlsx")))
# name the columns
names(BoE_coreIndicators) <- c("Indicator", "sub_Indicator",		"Average 1987-2006(b)",	"Average 2006(c)",	"Minimum since 1987(b)",	"Maximum since 1987(b)",	"Previous value (oya)",	"Latest value (as of 16 November 2018)", "NA")


# read the rows where the "subindicator" is named. This could lead to errors if the names of the indicators change in the table (for instance when using newer versions)
coreIndicators_From_BoE <- data.frame(Debt_to_income_ratio = t( filter(BoE_coreIndicators, sub_Indicator %in% "of which: mortgages(h)")[3:8]), # subgroup of Household debt to income ratio(g)
                                      OO_debt_to_income_ratio = t(filter(BoE_coreIndicators, sub_Indicator %in% "of which: owner occupier mortgages(i)")[3:8]), # subgroup of Household debt to income ratio(g)
                         OO_LTI_mean_above_median = t(filter(BoE_coreIndicators, sub_Indicator %in% "Owner-occupier mortgage LTI ratio (mean above the median)(d)")[3:8]), # Owner-occupier mortgage LTI ratio (mean above the median)(d)
                         OO_LTV_mean_above_median = t(filter(BoE_coreIndicators, sub_Indicator %in% "Owner-occupier mortgage LTV ratio (mean above the median)(d)")[3:8]),
                         BTL_LTV_ratio = t(filter(BoE_coreIndicators, sub_Indicator %in% "Buy-to-let mortgage LTV ratio (mean)(e)")[3:8]),
                         # OO_LTV_mean = filter(BoE_coreIndicators, sub_Indicator %in% "Buy-to-let mortgage LTV ratio (mean)(e)")[3:8],
                         Housing_transactions_month = t(filter(BoE_coreIndicators, sub_Indicator %in% "Housing Transactions(k)")[3:8]),
                         Mortgage_approvals = t(filter(BoE_coreIndicators, sub_Indicator %in% "Approvals of loans secured on dwellings(j)")[3:8]),
                         Advances_to_homemovers = t(filter(BoE_coreIndicators, sub_Indicator %in% "Advances to homemovers(l)")[3:8]),
                         Advances_to_FTB = t(filter(BoE_coreIndicators, sub_Indicator %in% "Advances to first time buyers(l)")[3:8]),
                         Advances_to_BTL = t(filter(BoE_coreIndicators, sub_Indicator %in% "Advances to buy-to-let purchasers(l)")[3:8]),
                         House_price_to_income_ratio = t(filter(BoE_coreIndicators, sub_Indicator %in% "House price to household disposable income ratio(p)")[3:8]),
                         Rental_Yield = t(filter(BoE_coreIndicators, sub_Indicator %in% "Rental yield(q)")[3:8])
                         )

# add row names and make cells numeric
coreIndicators_From_BoE <- as.data.frame(row.names = c("Average 1987-2006(b)",	"Average 2006(c)",	"Minimum since 1987(b)",	"Maximum since 1987(b)",	"Previous value (oya)",	"Latest value (as of 16 November 2018)"), sapply(coreIndicators_From_BoE, as.numeric))

# combine BoE and model data (transpose it too)
coreIndicatorsDisplay <- as.data.frame(bind_rows(coreIndicators, coreIndicators_From_BoE))

# c("Household mortgage debt to income",
#   "Owner-occupier mortgage debt to income",
#   "Owner-occupier mortgage LTI ratio (mean above the median)",
#   "Owner-occupier mortgage LTV ratio (mean above the median)",
#   "Buy-to-let mortgage LTV ratio (mean)",
#   "Monthly Housing Transactions",
#   "Approvals of loans secured on dwellings",
#   "Advances to homemovers",
#   "Advances to first time buyers",
#   "Advances to buy-to-let purchasers",
#   "House price to household disposable income ratio",
#   "Rental yield"), .before = 1)
#   

# format(coreIndicatorsDisplay[,11:12], digits = 4, scientific = FALSE)

   
coreIndicatorsDisplay_3 <- format(coreIndicatorsDisplay[,11:12], digits = 3, scientific = FALSE)
# For some reason the BoE data in "display_3" are always 3 digits. So 2 digits does not work. I do not understand but simply
# use 3 digits for the lower numbers now
coreIndicatorsDisplay_1 <- format(coreIndicatorsDisplay[,1:5], digits = 3,  scientific = FALSE)
coreIndicatorsDisplay_2 <- format(coreIndicatorsDisplay[,6:10], digits = 0, scientific = FALSE)


coreIndicatorsDisplay_1and2 <- bind_cols(coreIndicatorsDisplay_1, coreIndicatorsDisplay_2)

coreIndicatorsDisplay <- as.data.frame(t(bind_cols(coreIndicatorsDisplay_1and2, coreIndicatorsDisplay_3)), row.names = c("Debt to income",
                                                                          "OO debt to income",
                                                                          "OO LTI ratio (mean above the median)",
                                                                          "OO LTV ratio (mean above the median)",
                                                                          "BTL LTV ratio",
                                                                          "Monthly Housing Transactions",
                                                                          "Approvals of mortages",
                                                                          "Advances to homemovers",
                                                                          "Advances to FTB",
                                                                          "Advances to BTL",
                                                                          "House price to income ratio",
                                                                          "Rental yield"))
# coreIndicatorsDisplay <- signif(coreIndicatorsDisplay, digits = 3)
# implement line-breaks 
lineBreaks_table<- c("Model Output", "Average \n1987-2006",	"Average\n2006",	"Minimum \nsince 1987",	"Maximum \nsince 1987",	"Previous \nvalue (oya)",	"Latest value\n(November 2018)" )
if (knitr:::is_latex_output()){
  coreIndicatorsDisplay %>%
    mutate_all(linebreak)%>%
    kableExtra::kbl(
                    caption = "Comparison Model and Bank of England Core Indicators",
                    booktabs =T,
                    escape =F,
                    col.names =linebreak(lineBreaks_table, align ="c"))%>%
    kable_styling(latex_options =c("striped","scale_down")) %>%
    add_header_above(c(" "=1,"Model"=1,"Bank of England Core Indicators"=6))%>%
    footnote(general = paste0("The Core Indicators are taken from the Financial Stability Report ", "(ref:BoE2018-citation)", "; OO = Owner-Occupier, encompassing FTB and SSB; all values are means, except where stated otherwise; Model values are gained from 10 Monte-Carlo runs with an observation period of 1000 after a burn-in period of 1600."),
             threeparttable =T)
}

if (knitr:::is_html_output()){
  names(coreIndicatorsDisplay) <- c("Model Output", "Average 1987-2006",	"Average 2006",	"Minimum since 1987",	"Maximum since 1987",	"Previous value (oya)",	"Latest value (November 2018)" )
  coreIndicatorsDisplay %>%
    kableExtra::kable(caption = "Comparison Model and Bank of England Core Indicators")%>%
    kable_styling(latex_options =c("striped","scale_down"))%>%
    add_header_above(c(" "=1,"Model"=1,"Bank of England Core Indicators"=6)) 
}
#####TODO: rounding numbers in table -> or set specific rows as integers
#####TODO: color the last column according to its values
```

```{r CoreIndicators, message=FALSE, warning=FALSE,  echo=FALSE}
# ONS wealth data https://www.ons.gov.uk/peoplepopulationandcommunity/personalandhouseholdfinances/incomeandwealth/datasets/totalwealthwealthingreatbritain
#
#- wealth inequality
# - deposits/credit
# - average deposit? - do I have that? yes - 68,160 between 43,200 and 82,000 
# - median DSR vul HH
# - median DSR non-vul HH
# - share of vul HH in indebted HH (I use this due to WAS data constraints)
# - median Age vul HH
# - median Age non-vul HH ?? - this depends

coreIndicators_table <- data.frame(row.names = c("Wealth Inequality", 
                                                 "Deposits/Debt", 
                                                 "Average Deposit", 
                                                 "median DSR all indebted HH", # this is not non-vul!
                                                 "median DSR vul HH",
                                                 "share vul HH of all indebted HH",
                                                 "median Age vul HH",
                                                 "median Age non-vul HH"
),  Model_output = NA, UK_values = c(0.449, # wealth inequality (0.407 - 0.474)
                                     1.57, # deposits over debt (1.3 - 1.84)
                                     67000, # average deposits(54200 - 82000) I use here data from 2010-2016 (not starting at 2006). It is more comparable with the debt/deposit ratio
                                     0.136, # median DSR all indebted HH: wave_5_for_graph %>%summarise(coreIndicator = weighted.median(DSR, w = Weight))
                                     0.219, # median DSR vul HH
                                     0.128, # share of vul HH of all indebted hh
                                     44, # median Age of vulnerable households
                                     44 # median age of non-vulnerable households
), 
UK_values_range = c("0.407 - 0.474",
                    "1.3 - 1.84",
                    "54200 - 82000",
                    "-",
                    "-",
                    "-",
                    "-",
                    "-"),
Source = c("ONS 2006-2016 (without pension wealth)", 
           "ONS 2010-2016 (net finanical wealth / mortgage debt)",
           "ONS 2010-2016 (net financial wealth without pension wealth)",
           "Wealth and Asset Survey wave 5 (July 2014 - June 2016)",
           "as above",
           "as above",
           "as above",
           "as above"))
### footnote "parameter values defining households as vulnerable are 0.7 and 8 months"
### "data from wealth and asset survey is the subgroup of households with specific mortgage payments"

names(coreIndicators_table) <- c("Model output", "mean UK values", "UK value range", "Source")


outfile_tmp <- read_outfile_total(wd_model = "Results", model_folder_name = model_folder, nRuns = nMCRuns) 

  line_results <- outfile_tmp%>%
    mutate(depositsOverDebt = DepositsEndPeriod / totalCredit)%>%
    mutate(vulConsumptionChannel = `nowVul Dissaving` / 
             (`nowVul Purchase`+ `nowVul Dissaving`+`nowVul Other`)) %>%
    mutate(averageDeposits = `DepositsEndPeriod` /  TotalPopulation) %>%
    select(`medianAge vulHH`, 
           `medianAge nonVulHH`,
           medianDebtServiceRatio, 
           `vulHH medianDSR`, 
           `%vulHH of indebtedHH`,
           depositsOverDebt, 
           vulConsumptionChannel,
           averageDeposits)%>%
    apply(MARGIN = 2, FUN = mean_and_NaN_check)%>%
    round(digits = 3)

  
  line_results_WS <- outfile_tmp%>%
    filter(`Sale HPI` > 0.98 & `Sale HPI` < 1.21) %>%
    pull(`Top 10% wealth share`)%>%
    mean_and_NaN_check()%>%
    round(digits = 3)
  
  coreIndicators_table$`Model output` <- c(line_results_WS, # wealth inequality
                                           formattable::percent(line_results[["depositsOverDebt"]],digits = 1), # 
                                           line_results[["averageDeposits"]],
                                           line_results[["medianDebtServiceRatio"]],
                                           line_results[["vulHH medianDSR"]],
                                           line_results[["%vulHH of indebtedHH"]],
                                           line_results[["medianAge vulHH"]],
                                           line_results[["medianAge nonVulHH"]]
  )  
  coreIndicators_table[3,] <- format(coreIndicators_table[3,], digits = 0,nsmall = 0,  scientific = FALSE)
  coreIndicators_table %>%
    kbl(booktabs =T,
        caption = "Other Stylized Facts to Match") %>%
    kable_styling(latex_options =c("striped", "scale_down"), full_width = FALSE)%>%
    column_spec(5, width = "12em")%>%
    footnote(general = "Data by the ONS retrieved from https://www.ons.gov.uk/peoplepopulationandcommunity/ personalandhouseholdfinances/incomeandwealth/datasets/totalwealthwealthingreatbritain and for mortgage debt from https://www.ons.gov.uk/peoplepopulationandcommunity/personalandhouseholdfinances/incomeandwealth/ datasets/householddebtwealthingreatbritain ; difference in periods covered by UK data due to data constraints; model's wealth inequality is measured with the subset of periods with house prices between 98% and 121% of 2011-prices (UK price level range from 2006-2016); data from the fifth wave of the Wealth and Asset Survey is the subgroup of households with recorded mortgage payments; vul = financially vulnerable; HH = household; DSR = Debt-Service-to-Income ratio; Model values are gained from 10 Monte-Carlo runs with an observation period of 1000 after a burn-in period of 1600.",
           threeparttable =T)

```

# Results

With the model matching a wide range of stylized facts we can look at the dynamics and drivers of financial vulnerability.

## Financial Vulnerability

We define **financial vulnerability** following @Ampudia2016. First we introduce the financial margin of a household as its monthly income, less its monthly mortgage payments and a certain amount of basic living expenses, set to the poverty line:

```{=tex}
\begin{equation}
\text{financial margin}_{i,t} = y^{\text{net}}_{i,t} - \sum_{i=1}^{k} m_{i,k} - \rho y^{\text{median}}_{t},
(\#eq:FM)
\end{equation}
```
where $\sum_{i=1}^{k} m_{i,k}$ is the sum of the monthly mortgage payments (which are constant over their individual repayment period), $i$ the individual household, $t$ the simulation period (month) and $k$ the house the mortgage is paid for. $y^{\text{net}}_{i,t}$ is the households post-tax monthly income and $\rho y^{\text{median}}_{t}$ is the poverty line where $\rho$ is set to 70% of median income [@Ampudia2016][^6].

[^6]: This definition of basic living expenses is different from the model's households' minimum consumption $c_{0}$, which equals the minimum personal allowance for a married couple and is . In the model households can - therefore - consume less than this relative poverty line. For instance low-icnome households could be induced to deleverage in an economic downturn

If a household has a negative financial margin, it is financially distressed, meaning, income minus the mortgage payments is not enough to meet monthly basic living expenses. If the households cannot, from income and deposits, service its payments for less than eight months we consider it to be financially vulnerable[^7].

[^7]: $\rho$ is set to `r vul_rho`. The exposure at default (EAD) in the current model calibration is `r formattable::percent(mean(outfile$"EAD Ampudia (X*medIncome Y*m)"), digits = 1)`, which is above the target value of the share of non-performing loans (like @Ampudia2016), which is at 2.4% between 2015-2019 [@EBA2019].

```{=tex}
\begin{equation}
b_{i,t} < 8 \cdot |\text{financial margin}_{i,t}|
(\#eq:finVul)
\end{equation}
```
## Causes for Financial Vulnerability

Following from our definition of financial vulnerability (chapter \@ref(financial-vulnerability)), households run the risk of becoming financially vulnerable when they a) turn their financial margin negative or b) reduce their deposits below the defined threshold.

In the model, the behaviour of households driving financial vulnerability most are property transactions and consumption. Purchases reduce the household's financial margin (Equation \@ref(eq:FM)) by increases in monthly mortgage payments and downpayments deplete its deposits (Equation \@ref(eq:finVul)). We define households to be *vulnerable by purchase* -- or vulnerable by the purchase channel -- when they become vulnerable by act of a property purchase, i.e. immediately after. Dissaving only affects the deposits of households, not their financial margin. Here, households are defined as *vulnerable by dissaving* (or via the dissaving channel) when they were dissaving the period they became vulnerable (and did not buy a house at the same time)[^8]. Dissaving only occurs induced by a wealth effect as consumption induced by income ($\alpha_{i}$ in Equation \@ref(eq:dConsumption)) is never larger than the household's disposable income. All other cases of households becoming vulnerable are defined as *by other*, including households experiencing a decline in their income, turning their financial margin negative.

[^8]: Households can become financially vulnerable just a few months after buying a house. Due to this temporal closeness we might classify them as *vulnerable by purchase*, too*.* However, while the purchase may have decreased the households' financial margin and the downpayments their financial buffer, dissaving induced by positive net wealth was necessary to make the households financially vulnerable.

Figure \@ref(fig:stockVulnerable) shows the stock of financially vulnerable households, divided up by the cause for their vulnerability, over a representative house price cycle. Both effects are substantial, while households becoming financially vulnerable by dissaving make up on average `r formattable::percent(mean(outfile$"nowVul Dissaving") / (mean(outfile$"nowVul Purchase") + mean(outfile$"nowVul Dissaving") + mean(outfile$"nowVul Other")), digits = 1)` of all vulnerable households, `r formattable::percent(mean(outfile$"nowVul Purchase") / (mean(outfile$"nowVul Purchase") + mean(outfile$"nowVul Dissaving") + mean(outfile$"nowVul Other")), digits = 1)` are vulnerable by purchases, suggesting a strong impact of a collateral/precautionary saving channel on overall financial vulnerability. While the overall share of financially vulnerable households follows the house price cycle with a small lag, interestingly, both effects peak at different points of the housing cycle. The share of households vulnerable by purchases peaks around the middle of the upswing, where housing market turnover is highest (see the market turnover in Figure \@ref(fig:turnover) in the Appendix). The share of households vulnerable by dissaving peaks around the midpoint of the house price downturn[^9].

[^9]: Calculated over the course 10 Monte-Carlo runs the maximum correlation of overall vulnerability is `r round(ccf(outfile$"nVulHH (X*medIncome Y*m)", outfile$"Sale HPI")$acf[which.max(ccf(outfile$"nVulHH (X*medIncome Y*m)", outfile$"Sale HPI")$acf)],digits = 2)` at a lag of `r round(ccf(outfile$"nVulHH (X*medIncome Y*m)", outfile$"Sale HPI")$lag[which.max(ccf(outfile$"nVulHH (X*medIncome Y*m)", outfile$"Sale HPI")$acf)],digits = 2)` months. For the dissaving channel, the maximum correlation is `r round(ccf(outfile$"nowVul Dissaving", outfile$"Sale HPI")$acf[which.max(ccf(outfile$"nowVul Dissaving", outfile$"Sale HPI")$acf)],digits = 2)` at a lag of `r round(ccf(outfile$"nowVul Dissaving", outfile$"Sale HPI")$lag[which.max(ccf(outfile$"nowVul Dissaving", outfile$"Sale HPI")$acf)],digits = 2)` months and for the purchase channel `r round(ccf(outfile$"nowVul Purchase", outfile$"Sale HPI")$acf[which.max(ccf(outfile$"nowVul Purchase", outfile$"Sale HPI")$acf)],digits = 2)` at a lag of `r round(ccf(outfile$"nowVul Purchase", outfile$"Sale HPI")$lag[which.max(ccf(outfile$"nowVul Purchase", outfile$"Sale HPI")$acf)],digits = 2)` months. See also Figure \@ref(fig:crossCorrelation) in the Appendix.

```{r, stockVulnerable, echo = FALSE, warning=FALSE,message=FALSE, results= FALSE, fig.align='center', fig.cap = "Share of financially vulnerable households by cause of financial vulnerability over the house price cycle - 6 months rolling averages",  out.width='66%'}
# get first the position of house price troughs from a smoothed HPI line
# (not as necessary for troughs as for peaks, which are more irreglar)
HPI_troughs <- find_peaks_smoothed( -outfile$`Sale HPI`, m=10, smoothedPerdiods = 12)
# translate the position of troughs into the corresponding periods to use later in graph
trough_period <- c(outfile$`Model time`[HPI_troughs])

# , fig.subcap= c("cause of vulnerability", "agent classes vulnerable"), fig.show='hold' # in case this is put back in
outfile_tmp <- outfile %>%
  select("nowVul Purchase", "nowVul Dissaving",  "nowVul Other")

outfile_tmp <- as.matrix(outfile_tmp)/outfile$TotalPopulation # adjust for % of total population
outfile_tmp <- as.data.frame(runmean(outfile_tmp, rolling_averages)) # build a rolling average (6 for 6 months)
colnames(outfile_tmp) <- list("purchase", "dissaving", "other") # abbreviate colnames for figure

outfile_tmp <- outfile_tmp %>%
  bind_cols(outfile$`Model time`, outfile$`Sale HPI`)%>%
  pivot_longer(c("purchase", "dissaving", "other"))  ## prepare for boxplots

colnames(outfile_tmp) <- list("Period","HousePriceIndex", "vulnerable_by", "value")
outfile_tmp$vulnerable_by <- factor(outfile_tmp$vulnerable_by, levels = c("other", "purchase", "dissaving"))
# outfile_tmp$vulnerable_by <- factor(outfile_tmp$vulnerable_by, levels = c("other", "dissaving", "purchase"))
# parameters for figure
relation_rhs_lhs <- 100

color_set_1 <- cet_pal(5, name = "r3") # color sets also used for later figure

outfile_tmp %>%
    filter(Period >= trough_period[troughs_limits[1]], Period <= trough_period[troughs_limits[2]])%>%
  ggplot(aes(x=Period, fill = vulnerable_by))+
  geom_col( aes(y = value))+
  geom_line( aes(y = HousePriceIndex / relation_rhs_lhs), size=1, linetype="dashed") +
  scale_y_continuous(
    # Features of the first axis
    name = "Share of vulnerable households",
     labels = scales::percent,
    # Add a second axis and specify its features
    sec.axis = sec_axis(~ . *relation_rhs_lhs, name="House Price Index (---)"),
    expand = expansion(mult = c(0, 0.05)) # make the barplots start at the axis
  ) +
  scale_x_continuous(expand = expansion(mult = c(0,0)))+
  # theme_classic()+
  theme(legend.position = "bottom") +
  theme(legend.background = element_blank()) +  # Remove overall border
  theme(legend.key = element_blank()) +
  # scale_fill_viridis_d()
  scale_fill_manual(values = color_set_1)



```

Financial vulnerability decreases by households either increasing their financial margin or deposits. Similar to the classification above, we divide the economic actions of households reducing financial vulnerability into *non-vulnerable by sales* -- when they just sold property and ceased to be vulnerable -- and *non-vulnerable by saving* -- when they have a positive saving rate and did not just sell property. The rest --death, regular repayment, inheritance and increases in income turning the financial margin positive, but not the saving rate -- are subsumed under the label *other*.

Figure \@ref(fig:contributorsVulnerability) shows the causes for increases and decreases in the share of financially vulnerable households. The red line shows the overall resulting change of the share of vulnerable households. As already mentioned above, in the house price upswing the overall increase in financial vulnerability is driven by purchases. The reason this increase is not stronger is due to both financially vulnerable households selling property and saving up deposit-buffers. The saving channel here consists mainly of households becoming vulnerable by purchases but with high enough income to save up above the vulnerability threshold quickly. The saving channel reducing vulnerability is dominant in most parts of the cycle. From around the midpoint of the house price downturn on the saving channel is stronger than the dissaving channel leading to reductions in overall vulnerability. Here, not only the share of households vulnerable by purchases declines but also those vulnerable by dissaving.

```{r contributorsVulnerability, fig.align='center', fig.cap="Contributors to changes in the share of financially vulnerable households over the housing cycle - 6 months rolling averages", fig.dim=c(6, 4), message=FALSE, warning=FALSE,  echo=FALSE, out.width='66%', results=FALSE}
# get first the position of house price troughs from a smoothed HPI line
# (not as necessary for troughs as for peaks, which are more irreglar)
# HPI_troughs <- find_peaks_smoothed( -outfile$`Sale HPI`, m=10, smoothedPerdiods = 12)
# translate the position of troughs into the corresponding periods to use later in graph
trough_period <- c(outfile$`Model time`[HPI_troughs])


outfile_tmp <- outfile %>%
  select("vulnerable by purchase", "vulnerable by dissaving",  "vulnerable by other", "non-vulnerable by sale", "non-vulnerable by saving",  "non-vulnerable by other",`nVulHH (X*medIncome Y*m)`)%>%
  mutate(`non-vulnerable by sale` = -`non-vulnerable by sale`,
         `non-vulnerable by saving` = -`non-vulnerable by saving`,
         `non-vulnerable by other` = -`non-vulnerable by other`)

outfile_tmp <- as.matrix(outfile_tmp)/outfile$TotalPopulation # adjust for % of total population
outfile_tmp <- as.data.frame(runmean(outfile_tmp, rolling_averages)) # build a rolling average (6 for 6 months)
colnames(outfile_tmp) <- list("vulnerable by purchase", "vulnerable by dissaving",  "vulnerable by other", "non-vulnerable by sale", "non-vulnerable by saving",  "non-vulnerable by other", "vul HH") # abbreviate colnames for figure

outfile_tmp <- outfile_tmp %>%
  mutate(change = `vul HH`- lag(`vul HH`))%>%
  bind_cols(outfile$`Model time`, outfile$`Sale HPI`)%>%
  select(-`vul HH`) %>%
  pivot_longer(c("vulnerable by purchase", "vulnerable by dissaving",  "vulnerable by other", "non-vulnerable by sale", "non-vulnerable by saving",  "non-vulnerable by other"))  ## prepare for boxplots

colnames(outfile_tmp) <- list("change", "Period","HousePriceIndex", "cause", "value")
outfile_tmp$cause <- factor(outfile_tmp$cause, levels =c("vulnerable by other",  "vulnerable by purchase",  "vulnerable by dissaving", 
                                                          "non-vulnerable by other", "non-vulnerable by sale", "non-vulnerable by saving"))
# this is so I can display "change rate" and "HPI" in the graph. 
dat_text <- data.frame(
  label = c("change \nrate", "house price \nindex (rhs)"),
  Period = c(mean(c(trough_period[troughs_limits[1]],trough_period[troughs_limits[2]])+20), mean(c(trough_period[troughs_limits[1]],trough_period[troughs_limits[2]]))+20), # +10 here to shift to the right
  value = c(- 0.0025, 0.0025),
  # value = -mean(range(outfile_tmp$value)), 
  cause = c("vulnerable by other", "vulnerable by other")) # this is arbitrary, but otherwise it will not plot

# parameters for figure
relation_rhs_lhs <- 700
color_set_1 <- cet_pal(5, name = "r3") # color sets also used for later figure
color_set_2 <- c(color_set_1[1:3],cet_pal(6, name = "r1")[4:6]) #, cet_pal(10, name = "r1")[6], cet_pal(10, name = "r1")[8])

outfile_tmp %>%
  filter(Period >= trough_period[troughs_limits[1]], Period <= trough_period[troughs_limits[2]])%>%
  ggplot(aes(x=Period, fill =cause))+
  geom_col( aes(y = value))+
  geom_line( aes(y = change), size=1, color = "darkred")+
  geom_line( aes(y = HousePriceIndex / relation_rhs_lhs), size=1, linetype="dashed") +
  scale_y_continuous(
    # Features of the first axis
    name = "share of vulnerable households",
    labels = scales::percent,
    # Add a second axis and specify its features
    sec.axis = sec_axis(~ . *relation_rhs_lhs, name="House Price Index"),
    expand = expansion(mult = c(0, 0.05)) # make the barplots start at the axis
  ) +
  scale_x_continuous(expand = expansion(mult = c(0,0)))+
  # theme_classic()+
  theme(legend.position = "bottom") +
  theme(legend.background = element_blank()) +  # Remove overall border
  theme(legend.key = element_blank()) +
  scale_fill_manual(values = color_set_2)+ 
  geom_text(data = dat_text, aes(y= value), hjust = 0.1, vjust = 0.5, label = c("change \nrate", "house price \nindex (rhs)"), color = c("darkred","black"), size=3)


```

## Characteristics of Financially Vulnerable Households

To understand which households become financially vulnerable we look at the households' characteristics. Figure \@ref(fig:distributionsVulHH) shows the age, debt, income and DSR distributions (by their density curves) of indebted non-vulnerable and vulnerable households. What emerges are clear differences between these two groups as well as between households vulnerable by purchases and vulnerable by dissaving. The age distributions show that households vulnerable by purchases tend to be significantly younger than non-vulnerable indebted households, while households vulnerable by dissaving tend to be significantly older. Taking the characteristics of nominal debt, Income and DSRs into account, households vulnerable by purchases tend to be younger and hold less (nominal) debt than the other groups. Even with their low income this debt results in clearly below-average DSR ratios. Households vulnerable by dissaving tend to be older than other indebted households. They hold higher amounts of mortgage debt, which -- combined with their low income -- results in very high DSRs. As the median DSR of all indebted households is on average `r line_results[["medianDebtServiceRatio"]]` most of those vulnerable by dissaving end up above the set threshold where housing wealth affects their consumption, i.e. where they are considered *credit-constrained*.

The cause for these different characteristics between the two groups of financially vulnerable households can be found in the amount of deposits they hold when they buy property. Panel (e) shows the deposits a households held when they bought their last property. Households vulnerable by dissaving hold generally significantly higher deposits before they purchased their last property. This allows them to pay larger downpayments and by that take on more (nominal) debt, leading to higher DSRs. Moreover, they do not use all of their deposits as downpayment, granting a financial buffer[^10]. This initial difference in deposits arises either due to saving -- simply by entering the housing market later on (remember that income of households vulnerable by purchase and dissaving are very similar, while households vulnerable by dissaving tend to be older) or due to revenues from selling property. As shown in panel (f), households vulnerable by dissaving purchase property more frequently at higher prices, because first, they have the means to buy more expensive homes, and second -- as these households are often second-and-subsequent buyers -- they have to sell their current home first, before they can buy a new one. Often, they are stuck in the offer position until the housing market turnover is very high, i.e. when house prices are already higher as well.

[^10]: Note here that households can become first vulnerable by purchases and -- if in between they ceased to be vulnerable --become vulnerable by dissaving later on.

As is shown in more detail in Chapter \@ref(financial-vulnerability-by-agent-class) in the Appendix, the differences in the vulnerability-group characteristics align to a large extent with the different agent classes. Second-and-Subsequent buyers tend to be vulnerable by dissaving rather than First-time buyers which tend to be vulnerable by purchases. Note here that buy-to-let investors are rarely vulnerable at all, due to their higher income.

```{r distributionsVulHH, fig.cap="Densitiy curves and median values of central attributes of financially vulnerable and non-vulnerable (indebted) households", fig.subcap=c("Age", "Nominal Debt", "Income", "Debt-Service-to-Income Ratio", "Deposits before last property purchase", "House price index at last property purchase"),  fig.show='hold', message=FALSE, warning=FALSE, fig.ncol = 2, out.width='49%', results=FALSE,  echo=FALSE}
transactions_to_join <- transactions_hpi %>%
  filter(transactionType == "sale")

sortingData_for_figure <-  sortingData_data_vul_FTBSM%>%
  mutate(agent = case_when(
    isBTL==1 & inFirstHome==0 & isFTB==0 ~ "BTL", 
    # isBTL ==0 & inFirstHome == 0 &isFTB==0 ~ "Mover", 
    # isFTB ==1 ~ "FirstTimeBuyer",
    # isBTL==1 &  isFTB==0 ~ "BTL", 
    NHouses>0 & isBTL == 0 & inFirstHome == 0 ~ "SSB",
    inFirstHome==1 ~ "FTB", 
    NHouses==0 ~ "Renter"))%>%
  mutate(ConsumptionNetHousingWealth = ConsHWealth + ConsDebt)%>%
  mutate(ConsumptionNetWealth = ConsHWealth + ConsDebt+ConsFWealth)%>%
  filter(Debt < 0)%>%
  filter(FinVulReason != "other")%>%
  filter(Period >= 2300)%>%
  # distinct(id, .keep_all = TRUE) %>%
  mutate(DTI = Debt/(-12* MonthlyGrossTotalIncome))%>%
  mutate(DSR = MonthlyMortgagePayments/MonthlyGrossTotalIncome)%>%
  mutate(CTI = Consumption/MonthlyDisposableIncome) %>%
  mutate(hasDebt = case_when(Debt<0 ~ TRUE, TRUE ~ FALSE))%>%
  left_join(transactions_to_join, by = c("id" = "buyerId"))%>%
  mutate(principal = transactionPrice-mortgageDownpayment)%>%
  mutate(LTV = principal/transactionPrice)%>%
  mutate(LTI = principal/ (12*buyerMonthlyGrossTotalIncome))%>%
  mutate(prePurchaseDeposits = principal+buyerPostPurchaseBankBalance) %>%
  mutate(howLongAgo = Period - `Model time`) %>% # time now - time of purchase
  filter(howLongAgo > 0)%>% # future purchases have to be excluded (i.e. at period 2300 a purchase in period 2320 or similar)
  group_by(id, Period) %>% top_n(-1, howLongAgo)  # each vul HH each period has the last purchase "attached to them"

nrBins <- 20
color_temp <- cet_pal(5, name = "r3") # color sets also used for later figure
color_set_distr <- color_temp[c(3,2,4)]
color_set_distr[3] <- "darkgrey"
sortingData_for_figure$FinVulReason <- factor(sortingData_for_figure$FinVulReason, levels =c("dissaving", "purchase", "not vulnerable"))
################# age
core_means <- sortingData_for_figure %>%
  group_by(FinVulReason) %>%
  summarise(coreIndicator = median(Age, na.rm = TRUE))

sortingData_for_figure %>%
  ggplot(aes(Age, fill = FinVulReason))+
  # ggtitle("Model households with top66%income FTB saving motive 60%\nsubgroup indebted households")+  #\nlowest income quartile exempt
  geom_density(alpha = 0.6, position = "identity" , adjust = 5)+
  # geom_histogram(alpha = 0.5, position = "identity", bins = nrBins )+
  xlim(c(20,80))+
  xlab("Age and median value")+
  geom_vline(
    data = core_means, linetype = "dashed", size = 1,
    aes(xintercept = coreIndicator, color = FinVulReason)
  ) +
  scale_fill_manual(values = color_set_distr) +
  scale_color_manual(values = color_set_distr)

################### DEBT
core_means <- sortingData_for_figure %>%
  group_by(FinVulReason) %>%
  summarise(coreIndicator = median(-Debt, na.rm = TRUE))

sortingData_for_figure %>%
  ggplot(aes(-Debt, fill = FinVulReason))+
  # ggtitle("Model households \nsubgroup indebted households")+
  geom_density(alpha = 0.5, position = "identity" , adjust = 5)+
  xlab("Debt in money units (log scale) and median value")+
  # geom_histogram(alpha = 0.5, position = "identity", bins = nrBins )+
  scale_x_log10(limits = c(1000,1000000))+
  geom_vline(
    data = core_means, linetype = "dashed", size = 1,
    aes(xintercept = coreIndicator, colour = FinVulReason)) +
  scale_fill_manual(values = color_set_distr) +
  scale_color_manual(values = color_set_distr)

################### INCOME
core_means <- sortingData_for_figure %>%
  group_by(FinVulReason) %>%
  summarise(coreIndicator = median(MonthlyGrossTotalIncome, na.rm = TRUE))

sortingData_for_figure %>%
  ggplot(aes(MonthlyGrossTotalIncome, fill = FinVulReason))+
  # ggtitle("Model households \nsubgroup indebted households")+
  geom_density(alpha = 0.5, position = "identity" , adjust = 5)+
  xlab("Monthly Gross Total Income (money units) and median value")+
  # geom_histogram(alpha = 0.5, position = "identity", bins = nrBins )+
  xlim(c(0,7000))+
  geom_vline(
    data = core_means, linetype = "dashed", size = 1,
    aes(xintercept = coreIndicator, colour = FinVulReason)) +
  scale_fill_manual(values = color_set_distr) +
  scale_color_manual(values = color_set_distr)

################### DSR
core_means <- sortingData_for_figure %>%
  group_by(FinVulReason) %>%
  summarise(coreIndicator = median(DSR, na.rm = TRUE))

sortingData_for_figure %>%
  ggplot(aes(DSR, fill = FinVulReason))+
  # ggtitle("Model households \nsubgroup indebted households")+
  geom_density(alpha = 0.5, position = "identity" , adjust = 5)+
  xlab("Debt-Service-Ratio and median value")+
  # geom_histogram(alpha = 0.5, position = "identity", bins = nrBins )+
  xlim(c(0,0.75))+
  geom_vline(
    data = core_means, linetype = "dashed", size = 1,
    aes(xintercept = coreIndicator, colour = FinVulReason)) +
  scale_fill_manual(values = color_set_distr) +
  scale_color_manual(values = color_set_distr)

################### pre-purchase debt
core_means <- sortingData_for_figure %>%
  group_by(FinVulReason) %>%
  summarise(coreIndicator = median(prePurchaseDeposits, na.rm = TRUE))

sortingData_for_figure %>%
  ggplot(aes(prePurchaseDeposits, fill = FinVulReason))+
  # ggtitle("Model households \nsubgroup indebted households")+
  geom_density(alpha = 0.5, position = "identity" , adjust = 5)+
  xlab("Deposits right before purchase (log scale)")+
  # geom_histogram(alpha = 0.5, position = "identity", bins = nrBins )+
  scale_x_log10(limits = c(1000,1000000))+
  geom_vline(
    data = core_means, linetype = "dashed", size = 1,
    aes(xintercept = coreIndicator, colour = FinVulReason)) +
  scale_fill_manual(values = color_set_distr) +
  scale_color_manual(values = color_set_distr)

################### SALE HPI
core_means <- sortingData_for_figure %>%
  group_by(FinVulReason) %>%
  summarise(coreIndicator = median(`Sale HPI.y`, na.rm = TRUE))

sortingData_for_figure %>%
  ggplot(aes(`Sale HPI.y`, fill = FinVulReason))+
  # ggtitle("Model households \nsubgroup indebted households")+
  geom_density(alpha = 0.5, position = "identity" , adjust = 5)+
  xlab("House price index when houshold bought last property")+
  # geom_histogram(alpha = 0.5, position = "identity", bins = nrBins )+
  # xlim(c(0,0.75))+
  geom_vline(
    data = core_means, linetype = "dashed", size = 1,
    aes(xintercept = coreIndicator, colour = FinVulReason)) +
  scale_fill_manual(values = color_set_distr) +
  scale_color_manual(values = color_set_distr)


```

## Path Dependency of Financial Vulnerability

Financial vulnerability is subject to considerable path dependency. First, there are a considerable amount of households staying financially vulnerable for most of their mortgage repayment period

```{r loadValuesPathDependency, echo=FALSE, message=FALSE, warning=FALSE, results=FALSE}
period_to_filter <- c(trough_period[11],trough_period[11]+50)
```

The last part of the analysis focuses on the question what households tend to stay financially vulnerable for longer periods of time and why. The left panel of Figure \@ref(fig:whenVulBuy) maps the households vulnerable at the beginning of the house price upswing according to when (x-axis) and at what price levels (y-axis) they bought their last property. The horizontal line marks the present period (period `r period_to_filter[1]`). Both, households vulnerable by dissaving (yellow dots) and by purchases (green dots) have predominantly bought their last property at rater low prices (below 0.4). It shows that a significant part of the households vulnerable today have been vulnerable for one up to two house price cycles. Specifically, this is true for households vulnerable by purchase, as by our definition these became vulnerable directly from the purchase of property. However, households vulnerable by dissaving, that bought a long time ago at low prices tend to be vulnerable for a long time as well (see Figure \@ref(fig:vulSince) in the Appendix).

Table \@ref(tab:vulnerbilityTable) test.

The right panel of Figure \@ref(fig:whenVulBuy) shows the financially vulnerable households `r period_to_filter[2] - period_to_filter[1]` periods later at the house price peak (marked by the dotted line). There are two major differences from low to high prices. Most households that became newly vulnerable and bought their last property between period `r period_to_filter[1]` and `r period_to_filter[2]` became vulnerable by purchase. Only very few bought property and became vulnerable only a couple of periods later due to increased consumption induced by their positive net housing wealth (the few yellow dots between both vertical lines). The other major difference can be found around periods 2225 and 2325 where a large amount of households vulnerable by dissaving appear. This tells us that with the rising house prices (between periods `r period_to_filter[1]` and `r period_to_filter[2]`) households which bought their last property at high house price levels, one or two cycles ago, now became newly financially vulnerable by dissaving. Looking at the micro data tells us that these households -- highly leveraged by the property purchase -- experienced negative equity when house prices started to drop. Negative housing wealth leads to increased saving (see Equation \@ref(eq:dConsumption)) and thereby increasing deposits as long as prices stay low. When house prices rise again, their net housing wealth turns positive, inducing the depletion of their savings. It turns out that households buying at lower price levels tend to stay financially vulnerable for longer periods of time, as they rarely experience negative housing equity, and thereby deleveraging. This is true for households vulnerable by purchase and dissaving.

In conclusion, the financial-vulnerability-channels of purchasing and dissaving work at different points of the house price cycle. The purchasing channel increases the share of vulnerable households mainly in the upswing and immediately after households buy property. The dissaving channel on the other hand is more important at high prices, where increases are rooted in purchases at previous house price peaks. This way, also households that previously became vulnerable by purchases can become vulnerable again by dissaving at a later house price peak. For both effects there is a "floor" of financially vulnerable households, consisting mainly of households that bought at low prices, therefore experiencing almost exclusively positive net housing wealth, which -- due to their above-median DSR -- leads to below-vulnerability-threshold deposits.

```{r whenVulBuy, fig.cap="When did households, vulnerable at house price peak and trough buy?",fig.subcap=c("Households vulnerable at trough \\newline House price level at last purchase", "Households vulnerable at peak \\newline House price level at last purchase"),  fig.show='hold', message=FALSE, warning=FALSE, out.width='49%', results=FALSE,  echo=FALSE}

# period_to_filter <- c(2368,2414)
color_set_1 <- cet_pal(5, name = "r3") # color sets also used for later figure

vul_certain_period_trough <-sortingData_data_vul_FTBSM%>%
  mutate(agent = case_when(
    isBTL==1 & inFirstHome==0 & isFTB==0 ~ "BTL", 
    # isBTL ==0 & inFirstHome == 0 &isFTB==0 ~ "Mover", 
    # isFTB ==1 ~ "FirstTimeBuyer",
    # isBTL==1 &  isFTB==0 ~ "BTL", 
    NHouses>0 & isBTL == 0 & inFirstHome == 0 ~ "SSB",
    inFirstHome==1 ~ "FTB", 
    NHouses==0 ~ "Renter"))%>%
  filter(FinVulReason != "not vulnerable")%>%
  filter(FinVulReason != "other")%>%
  filter(Period == period_to_filter[1])%>%
  # filter(agent=="inFirstHome")%>%
  left_join(transactions_hpi, by = c("id" = "buyerId"))%>%
  mutate(principal = transactionPrice-mortgageDownpayment)%>%
  mutate(prePurchaseDeposits = principal+buyerPostPurchaseBankBalance) %>%
  mutate(LTV = principal/transactionPrice)%>%
  mutate(LTI = principal/ (12*buyerMonthlyGrossTotalIncome))%>%
  mutate(howLongAgo = Period - `Model time`) %>%
  filter(transactionType == "sale")%>%
  filter(howLongAgo > 0)%>%
  group_by(id) %>% top_n(-1, howLongAgo) 

vul_certain_period_peak <-sortingData_data_vul_FTBSM%>%
  mutate(agent = case_when(
    isBTL==1 & inFirstHome==0 & isFTB==0 ~ "BTL", 
    # isBTL ==0 & inFirstHome == 0 &isFTB==0 ~ "Mover", 
    # isFTB ==1 ~ "FirstTimeBuyer",
    # isBTL==1 &  isFTB==0 ~ "BTL", 
    NHouses>0 & isBTL == 0 & inFirstHome == 0 ~ "SSB",
    inFirstHome==1 ~ "FTB", 
    NHouses==0 ~ "Renter"))%>%
  filter(FinVulReason != "not vulnerable")%>%
  filter(FinVulReason != "other")%>%
  filter(Period == period_to_filter[2])%>%
  # filter(agent=="inFirstHome")%>%
  left_join(transactions_hpi, by = c("id" = "buyerId"))%>%
  mutate(principal = transactionPrice-mortgageDownpayment)%>%
  mutate(prePurchaseDeposits = principal+buyerPostPurchaseBankBalance) %>%
  mutate(LTV = principal/transactionPrice)%>%
  mutate(LTI = principal/ (12*buyerMonthlyGrossTotalIncome))%>%
  mutate(howLongAgo = Period - `Model time`) %>%
  filter(transactionType == "sale")%>%
  filter(howLongAgo > 0)%>%
  group_by(id) %>% top_n(-1, howLongAgo) 

########################### HPI und last sale
HPI1 <- outfile %>%
  select(`Sale HPI`, `Model time`)%>%
  filter(`Model time` <= period_to_filter[1])

colnames(HPI1) <- list("House Price Index", "Period") 

data1 <- vul_certain_period_trough %>%
  filter(agent != "Renter")  # Households selling their homes at the end of the period could be still recorded vulnerable (which happens at the beginning of a period) - very rarely

(ggplot(data = HPI1, aes(y = `House Price Index`, x = Period) )+
    geom_line( size=0.5, linetype="dashed", color = "black")+ 
    geom_point(data = data1, aes(x = `Model time`,y= `Sale HPI.y`, color = FinVulReason), position = position_jitter(width = 0.025, height = 0.025))+
    xlab(paste0("In what period did the household - vulnerable\nin period ", period_to_filter[1], " - buy their last property?"))+
    ylab("House price index") +
    theme(legend.position = "bottom") +
    ylim(c(0.10, 1.5)) +
    xlim(c(period_to_filter[2]-240,period_to_filter[2])) + 
    geom_vline(
      xintercept = period_to_filter[1], linetype = 2, size = 1, color = "darkblue" 
    )+
    scale_color_manual(values = color_set_1[c(3,2)])+
    annotate("text", x = 2400, y = 0.8, label = "all house-\nholds are\nvulnerable\nat these low\nprices", color = "darkblue")) 


########################### HPI und last sale
HPI2 <- outfile %>%
  select(`Sale HPI`, `Model time`)%>%
  filter(`Model time` <= period_to_filter[2])

colnames(HPI2) <- list("House Price Index", "Period") 


data2 <- vul_certain_period_peak %>%
  filter(agent != "Renter")  # Households selling their homes at the end of the period could be still recorded vulnerable (which happens at the beginning of a period) - very rarely

  
(ggplot(data = HPI2, aes(y = `House Price Index`, x = Period) )+
    geom_line( size=0.5, linetype="dashed", color = "black")+ 
    geom_point(data = data2, aes(x = `Model time`,y= `Sale HPI.y`, color = FinVulReason), position = position_jitter(width = 0.025, height = 0.025))+
    xlab(paste0("In what period did the household - vulnerable\nin period ", period_to_filter[2], " - buy their last property?"))+
    ylab("House price index") +
    theme(legend.position = "bottom") +
    ylim(c(0.10, 1.5)) +
    xlim(c(period_to_filter[2]-240,period_to_filter[2])) + 
    geom_vline(
      xintercept = period_to_filter[2], linetype =2, size = 1, color = "darkblue"
    )+
    scale_color_manual(values = color_set_1[c(3,2)]) +
    annotate("rect", xmin = 2200, xmax = 2250, ymin = 1, ymax = 1.4, alpha = 0, color = "red") +
    annotate("rect", xmin = 2295, xmax = 2340, ymin = 0.9, ymax = 1.3, alpha = 0, color = "red") +
    annotate("text", x = 2270, y = 1.2, label = "newly\nvulnerable\nwith high\nprices", color = "red")+
    annotate("text", x = 2400, y = 0.8, label = "all house-\nholds are\nvulnerable\nat these high\nprices", color = "darkblue")
)


```

```{r vulnerbilityTable, message=FALSE, warning=FALSE,  echo=FALSE}



out <- read_csv(here::here(paste0("Results\\", model_folder_noFTBSM, "\\Output-run", 1, ".csv")))


hpi_median <- out %>%
  filter(`Model time` > 2300) %>%
  select(`Sale HPI`, `Model time`, `vulnerable by dissaving`, `vulnerable by purchase`)
  # median(hpi_median$`Sale HPI`)


out_HPI <- out %>%
  select(`Model time`, `Sale HPI`)

peaks <-  find_peaks_smoothed(x = hpi_median$`Sale HPI`,m= 30,smoothedPerdiods = 24, paint = TRUE)
# diff(peaks)
beginning_period_high <- c()
# shift a quarter of the cycle left from the point of highest vul diss (which is +15 periods after cycle due to crosscorrelations (kann man auch noch reincoden))
for(i in 1:(length(peaks)-1))beginning_period_high[i] <- peaks[i] + (15 - round(0.25 * diff(peaks)[i], digits = 0))

end_period_high <- vector()
for(i in 1:(length(peaks)-1))end_period_high[i] <- peaks[i] + (15 + round(0.25 * diff(peaks)[i], digits = 0))

# build the high dissaving frame
high_periods <- c()
for(i in 1:(length(peaks)-1)) high_periods <- append(high_periods,c(beginning_period_high[i]:end_period_high[i]))

low_periods <- c()
for(i in 1:(length(peaks)-2)) low_periods <- append(low_periods,c(end_period_high[i]:beginning_period_high[i+1]))

# plot(hpi_median$`Sale HPI`, type = 'l', main = "high_periods")
# points(low_periods, hpi_median$`Sale HPI`[low_periods], col = 'red', pch = 19)
# points(high_periods, hpi_median$`Sale HPI`[high_periods], col = 'blue', pch = 19)


# translate to periods
adjusted_high_periods <- hpi_median$`Model time`[high_periods]
adjusted_low_periods <- hpi_median$`Model time`[low_periods]

table_vul <- sortingData_different_Ampudia %>%
  left_join(out_HPI, by = c("Period" = "Model time")) %>%
  left_join(out_HPI, by = "Model time") %>%
  filter(vulnerable == "TRUE") %>%
  mutate(Price_level = case_when(Period %in% adjusted_high_periods ~ "high", Period %in% adjusted_low_periods ~ "low", TRUE ~ "undefined"))%>%
  mutate(Price_level_purchase = case_when(`Sale HPI.y`>= median(hpi_median$`Sale HPI`)~ "high", TRUE~ "low")) # %>%


table_vul_2 <- table_vul %>%
  filter(Price_level != "undefined") %>%
  filter(FinVulReason %in% c("dissaving", "purchase")) %>%
  # group_by(Price_level, Period)%>%
  group_by(Price_level, FinVulReason, Price_level_purchase)%>%
  # tally() %>%
  tally()


a <- table_vul_2 %>%
  filter(Price_level == "high")%>%
  mutate(n = (n / 10000) / length(high_periods))

b <- table_vul_2 %>%
  filter(Price_level == "low")%>%
  mutate(n = (n / 10000) / length(low_periods))

table_vul_2 <- bind_rows(a,b)
table_vul_2$n <-  formattable::percent(table_vul_2$n, digits = 1)

table_vul_print <- pivot_wider(table_vul_2, names_from = c( FinVulReason, Price_level_purchase), values_from = n) 
table_vul_print$Share_vul_hh_diss <- table_vul_print$dissaving_high + table_vul_print$dissaving_low
table_vul_print$Share_vul_hh_purch <- table_vul_print$purchase_high + table_vul_print$purchase_low

table_vul_print <- table_vul_print[,c(1,6,7,2,4,3,5)]

colnames(table_vul_print) <- list(" ", "by dissaving", "by purchase"," by dissaving", " by purchase","by dissaving ", "by purchase " )

table_vul_print <- as.data.frame(table_vul_print)

table_vul_print %>%
  # mutate_all(linebreak)%>%
  kableExtra::kbl(
    caption = "Path dependency of financial vulnerability",
    booktabs = T,
    escape = T,
    align = "c"
    # col.names = linebreak(lineBreaks_table, align ="c")
    )%>%
  kable_styling(latex_options =c("scale_down")) %>%

  # Watch out -> here we set the names of the target values
  add_header_above(c("Price\ninfluence" = 1, "% vulnerable\nhouseholds" = 2,
                     "% vul HH that purchased\nat high prices" = 2,
                     "% vul HH that purchased\nat low prices" = 2)) %>%
  footnote(general = "Model values are calculated from single-run with 300 Periods. Periods of high price influence are calculated as those where the share of households vulnerable by dissaving is largest, based on the cross-correaltions in the Appendix.",threeparttable =T)
```

# Robustness Checks

The strength of the consumption channel could be sensitive to the parametrisation of the model or the definition of financial vulnerability Ampudia-measures. Moreover, different parameters used in the definition of financial vulnerability -- given the parametrisation of the model's variables -- could lead to the model not as close to the WAS data.

## Different Model Parametrisation

```{r, echo=FALSE, message=FALSE, warning=FALSE, results=FALSE}
calibration_consChannel_param <- read.csv(here::here("statistical output R/outputsCalibrationTest_may2021.csv"))
```

To test if the strength of consumption channel is sensitive to the specification of the free parameters in \@ref(tab:parameters) we first check the average consumption channel strength from all 1000 model runs with different parameter sets the average strength of the consumption channel was at `r formattable::percent(mean(calibration_consChannel_param$vulConsumptionChannel),digits = 1)`[^11]. Next, we perform a simple linear regression. Figure \@ref(fig:modelParam) shows that the parameter of the income percentile from which the

[^11]: This is regardless of how closely they were able to match UK data.

```{r, modelParam, fig.cap="Estimation of the effect of the free parameters on the strength of the consumption channel  based on 1000 calibration runs with 95 percent confidence intervals", fig.show='hold', message=FALSE, warning=FALSE, out.width='49%', results=FALSE,  echo=FALSE}



calibration_consChannel_param <- calibration_consChannel_param %>%
  mutate(LTV_FTB = case_when(LTV1 >= LTV2 & LTV1 >= LTV3 ~ LTV1, 
                             LTV2 >= LTV1 & LTV2 >= LTV3 ~ LTV2,
                             LTV3 >= LTV1 & LTV3 >= LTV2 ~ LTV3))%>%
  mutate(LTV_BTL = case_when(LTV1 <= LTV2 & LTV1 <= LTV3 ~ LTV1, 
                             LTV2 <= LTV1 & LTV2 <= LTV3 ~ LTV2,
                             LTV3 <= LTV1 & LTV3 <= LTV2 ~ LTV3))%>%
  mutate(LTV_SSB = case_when(LTV1 <= LTV2 & LTV1 >= LTV3 ~ LTV1,
                             LTV1 >= LTV2 & LTV1 <= LTV3 ~ LTV1,
                             LTV2 <= LTV1 & LTV2 >= LTV3 ~ LTV2,
                             LTV2 >= LTV1 & LTV2 <= LTV3 ~ LTV2,
                             LTV3 <= LTV1 & LTV3 >= LTV2 ~ LTV3,
                             LTV3 >= LTV1 & LTV3 <= LTV2 ~ LTV3)) 
BaseFormula             <- lm(vulConsumptionChannel ~ incomePercentile + MPC  + paymentsToIncome  + liqPref  +  bankMaxAge   + LTV_FTB   + LTV_SSB   + LTV_BTL , data = calibration_consChannel_param)

library(jtools)
plot_summs(BaseFormula, scale = TRUE, colors = "Rainbow") 
# effect_plot(BaseFormula, pred = incomePercentile, interval = TRUE, plot.points = TRUE,x.label = "Income percentile", y.label = "Strength of consumption channel")
# export_summs(BaseFormula,  scale = TRUE)

```

## Different Thresholds for Financial Vulnerability

Applying different thresholds for financial vulnerability, i.e. calculating basic living costs as a lower percentage of median income and defining the

-   \@ref(tab:differentAmpudia) shows that with $\rho$ set to 0.7 the model is very much able to match the WAS data. However, the strength of the consumption channel varies between 44% and 73%, depending on the deposit threshold used, with lower thresholds increasing the strength of the channel.

-   With lower $\rho$ the importance of the consumption channel increases.

-   The share of financially vulnerable households of all indebted households becomes significantly lower than in the WAS. This is mainly due to the absence of any shocks to employment income in the model.

-   The values for non-vulnerable households stay close to WAS data.

-   The values of median DSRs for vulnerable households do not increase as much as in the WAS when $\rho$ is lower. This could be driven, again, by the relatively stable incomes of the model's households.

-   As in the WAS, the median age of vulnerable households rises with lower $\rho$, albeit more strongly.

```{r differentAmpudia, message=FALSE, warning=FALSE,  echo=FALSE}
# WATCH OUT: when changing this you need to change the table headers by hand
calibration_values <- tibble(share_median_income = c(rep.int(0.7, 3), rep.int(0.5, 3), rep.int(0.4, 3)), 
                             months_buffer = c(rep.int(c(1, 8, 24), 3)), 
                             share_vulHH_indebtedHH_Model = NA, share_vulHH_indebtedHH_WAS = NA,
                             medianDSR_vulHH_Model = NA, medianDSR_vulHH_WAS = NA,
                             medianDSR_nonVulHH_Model = NA, medianDSR_nonVulHH_WAS = NA,
                             medianAge_vulHH_Model = NA, medianAge_vulHH_WAS = NA,
                             medianAge_nonVulHH_Model = NA, medianAge_nonVulHH_WAS = NA)

for(i in 1:nrow(calibration_values)){
  
  Wave_5_HH_vul <- Wave_5_HH %>%
    # filter(totalMortgagePayments != 0) %>%
    # filter(totalMortgageDebt!=0)%>%
    mutate(finanicalMargin = NetAnnualRegularIncome/12 - totalMortgagePayments - calibration_values$share_median_income[i] * 2749.667,
           monthsAbleToCover = GrossFinancialWealth/finanicalMargin, # negative value means finanical margin is negative
           vulnerable = case_when(monthsAbleToCover<0 & monthsAbleToCover > - calibration_values$months_buffer[i] & totalMortgagePayments != 0 ~ TRUE, TRUE ~ FALSE),
           DSR = 12*totalMortgagePayments/ GrossAnnualRegularIncome,
           DTI = totalMortgageDebt/GrossAnnualRegularIncome) 
  
  
  # calculate for indebted households
  wave_indebted <- Wave_5_HH_vul%>% 
    filter(totalMortgageDebt!=0)%>%
    filter(totalMortgagePayments != 0) 
  
  calibration_values$share_vulHH_indebtedHH_WAS[i] <- formattable::percent( weighted.mean(wave_indebted$vulnerable, w = wave_indebted$Weight), digits = 1 )
  
  # calculate for vulnerable households
  wave_vul <- Wave_5_HH_vul%>% 
    filter(totalMortgageDebt!=0)%>%
    filter(totalMortgagePayments != 0) %>%
    filter(vulnerable == TRUE)
  
  calibration_values$medianDSR_vulHH_WAS[i] <- formattable::percent( weighted.median(wave_vul$DSR, w = wave_vul$Weight), digits = 1 )
  calibration_values$medianAge_vulHH_WAS[i] <- weighted.median(wave_vul$Age, w = wave_vul$Weight)
  
  # calculate for non-vulnerable, indebted households
  wave_NonVul <- Wave_5_HH_vul%>% 
    filter(totalMortgageDebt!=0)%>%
    filter(totalMortgagePayments != 0) %>%
    filter(vulnerable == FALSE)
  
  calibration_values$medianDSR_nonVulHH_WAS[i] <- formattable::percent( weighted.median(wave_NonVul$DSR, w = wave_NonVul$Weight), digits = 1 )
  calibration_values$medianAge_nonVulHH_WAS[i] <- weighted.median(wave_NonVul$Age, w = wave_NonVul$Weight)
  
  ##### calculate Model fin vul ####  
  
  
  sortingData_vul_HH <-  sortingData_data_vul_FTBSM%>%
    mutate(financialMargin = MonthlyDisposableIncome+492.7 - calibration_values$share_median_income[i]*median(MonthlyGrossTotalIncome, na.rm = TRUE),
           monthsAbleToCover = BankBalance / financialMargin,
           vulnerable = case_when(monthsAbleToCover<0 & monthsAbleToCover > - calibration_values$months_buffer[i] & Debt < 0 ~ TRUE, TRUE ~ FALSE)) %>%
    mutate(DTI = Debt/(-12* MonthlyGrossTotalIncome))%>%
    mutate(DSR = MonthlyMortgagePayments/MonthlyGrossTotalIncome)%>%
    mutate(hasDebt = case_when(Debt<0 ~ TRUE, TRUE ~ FALSE))
  
  model_indebted <- sortingData_vul_HH %>%
    filter(Debt < 0)
  
  DSRs <- sortingData_vul_HH %>%
    filter(Debt < 0) %>%
    group_by(vulnerable) %>%
    summarise(coreIndicator = median(DSR, na.rm = TRUE))
  
  formattable::percent(DSRs$coreIndicator[1])
  
  calibration_values$share_vulHH_indebtedHH_Model[i] <- formattable::percent( mean(model_indebted$vulnerable), digits = 1 )
  calibration_values$medianDSR_vulHH_Model[i] <- formattable::percent(DSRs$coreIndicator[2], digits = 1 )
  calibration_values$medianDSR_nonVulHH_Model[i] <- formattable::percent(DSRs$coreIndicator[1], digits = 1 )
  
  Age_model <- sortingData_vul_HH %>%
    filter(Debt < 0) %>%
    group_by(vulnerable) %>%
    summarise(coreIndicator = median(Age, na.rm = TRUE))
  
  calibration_values$medianAge_vulHH_Model[i] <- round(Age_model$coreIndicator[2], digits = 2 )
  calibration_values$medianAge_nonVulHH_Model[i] <- round(Age_model$coreIndicator[1], digits = 2 )
  
}

# calibration_values



channel_importance_results <- data.frame(parameters = NA, dissaving_channel = NA, purchase_channel = NA, share_vul_HH = NA)

channel_importance_results[1,] <- channel_importance("FinVulReason_calc_0.7_1m")
channel_importance_results[2,] <- channel_importance("FinVulReason_calc_0.7_8m")
channel_importance_results[3,] <- channel_importance("FinVulReason_calc_0.7_24m")
channel_importance_results[4,] <- channel_importance("FinVulReason_calc_0.5_1m")
channel_importance_results[5,] <- channel_importance("FinVulReason_calc_0.5_8m")
channel_importance_results[6,] <- channel_importance("FinVulReason_calc_0.5_24m")
channel_importance_results[7,] <- channel_importance("FinVulReason_calc_0.4_1m")
channel_importance_results[8,] <- channel_importance("FinVulReason_calc_0.4_8m")
channel_importance_results[9,] <- channel_importance("FinVulReason_calc_0.4_24m")


# channel_importance_results

calibration_values_table <- calibration_values%>%
  # select(- share_median_income, - months_buffer)%>%
  add_column(channel_importance_results$dissaving_channel, .before = "share_vulHH_indebtedHH_Model")%>%
  add_column(channel_importance_results$purchase_channel, .before = "share_vulHH_indebtedHH_Model")
  
# row.names(calibration_values_table) <- c(1, 8, 24, 1, 8, 24, 1, 8, 24)
# colnames(calibration_values_table)<- list("share of median income",
#                                          "months of buffer", 
#                                          "consumption channel", 
#                                          "purchasing channel",
#                                          "Model", "WAS",
#                                          "Model", "WAS",
#                                          "Model", "WAS",
#                                          "Model", "WAS",
#                                          "Model", "WAS"
# )

lineBreaks_table<- c("share of\nmedian \nincome", "months of\nbuffer", 
                     "consumption\nchannel", 
                     "purchasing\nchannel",
                     "Model", "WAS",
                     "Model", "WAS",
                     "Model", "WAS",
                     "Model", "WAS",
                     "Model", "WAS")

calibration_values_table <- as.data.frame(calibration_values_table)
# these are all % values
for (i in 3:10){
 calibration_values_table[,i] <- format(calibration_values_table[,i], digits = 3,nsmall = 0, scientific = FALSE)
}


# these are double/integer values (i.e. AGE)
for (i in 11:14){
  calibration_values_table[,i] <- format(calibration_values_table[,i], digits = 0,nsmall = 0, scientific = FALSE)
}

calibration_values_table <- as.data.frame(calibration_values_table)

calibration_values_table %>%
  mutate_all(linebreak)%>%
  kableExtra::kbl(
    caption = "Different parametrisation of the finanical vulnerability thresholds",
    booktabs = T,
    escape = F,
    align = "c",
    col.names = linebreak(lineBreaks_table, align ="c"))%>%
  kable_styling(latex_options =c("scale_down")) %>%
  column_spec(1:2, bold=T) %>%
   collapse_rows(columns = 1, latex_hline = "major")  %>%

  # Watch out -> here we set the names of the target values
  add_header_above(c(" " = 2, "vulnerability\nchannels" = 2,
                     "% vul HH in\nindebted HH" = 2,
                     "median DSR\nvul HH" = 2,
                     "median DSR\nnon-vul HH" = 2,
                     "median Age\nvul HH" = 2,
                     "medan Age\nnon-vul HH" = 2)) %>%
  footnote(general = "Median Age of non-vulnerable households includes only households with mortgage debt. Model values are calculated from single-run with 300 Periods.",           threeparttable =T)



# share_median_income = c(0.7, 0.7, 0.7, 0.5, 0.5, 0.5,  0.4, 0.4, 0.4), 
#                              months_buffer = c(1, 8, 24, 1, 8, 24, 1, 8, 24), 
#                              share_vulHH_indebtedHH_Model = NA, share_vulHH_indebtedHH_WAS = NA,
#                              medianDSR_vulHH_Model = NA, medianDSR_vulHH_WAS = NA,
#                              medianDSR_nonVulHH_Model = NA, medianDSR_nonVulHH_WAS = NA,
#                              medianAge_vulHH_Model = NA, medianAge_vulHH_WAS = NA,
#                              medianAge_nonVulHH_Model = NA, medianAge_nonVulHH_WAS = NA)



```

# Conclusion

This paper analysed two important channels for financial vulnerability of the household sector stemming from housing market dynamics. Purchases, as well as housing wealth effects, have been found to be central for understanding financial vulnerability dynamics. The dynamics are almost exclusively driven by owner-occupiers, investors play only a minor role. Younger households with lower deposits, tend to become financially vulnerable at the beginning of the housing market upswing due to buying their (often first) home, older households with more deposits buy their home at higher prices with higher leverage, making them susceptible to housing wealth effects (via a collateral or precautionary saving channel). This susceptibility leads to them becoming vulnerable when price levels are high and ceasing to be vulnerable when price levels are low. Overall, financial vulnerability shows strong path dependencies with households staying vulnerable over the course of several housing cycles, while others (vulnerable by dissaving) switch between financial vulnerability and non-vulnerability depending on the house price level.

The agent-based model utilised was able reproduce important stylized facts. However, it also has some shortcomings that could influence the results. House prices tend to fall to unrealistically low levels, due to missing stabilising mechanisms. This limitation could allow lower-income households to enter the housing market (earlier), thereby increasing the share of young, financially vulnerable households. The age distributions in Figure \@ref(fig:AgeWAS) suggest that this is partly the case. Another limitation of the model is the missing marcroeconomy, implying that consumption responses do not feed back into households employment income. This way we underestimate the effect of changes in income financial vulnerability.

Nonetheless, the analysis showed that the housing markets can affect financial vulnerability by two important channels, affecting different household-types differently. At the same time, the effects can be very long-lasting and levels of financial vulnerability today depend to a large extent on past purchases (as well as on current price levels).

# Appendix {.unnumbered}

# (APPENDIX) Appendices {.unnumbered}

# Financial Vulnerability by Agent-Class

Interestingly, the differences between both vulnerability channels purchases and dissaving are mirrored by the agent classes. Figure \@ref(fig:stockVulAgentClass) shows that FTB agents are almost exclusively responsible for the purchasing channel and SSB agents predominantly for the dissaving channel. BTL investors contribute almost nothing to the share of financially vulnerable households. FTB agents get more frequently vulnerable by purchases than SSB agents (while purchasing slightly fewer houses on average than SSB agents - see Table \@ref(tab:BoECoreIndicators)) due to their lower deposits. Figure \@ref(fig:flowAgentClass) shows the agent based version of Figure \@ref(fig:contributorsVulnerability).

```{r, stockVulAgentClass, fig.cap="Share of financially vulnerable households by cause and agent-class - 6 months rolling averages", fig.show='hold', message=FALSE, warning=FALSE,  results=FALSE,  echo=FALSE, out.height= '33%'}
outfile_tmp <- outfile %>%
  select( "nowVul Purchase BTL",	 "nowVul Dissaving BTL",	 "nowVul Other BTL",	"nowVul Purchase SSB",	 "nowVul Dissaving SSB",	 
          "nowVul Other SSB",	 "nowVul Purchase FTB",	 "nowVul Dissaving FTB",	 "nowVul Other FTB")


outfile_tmp <- as.matrix(outfile_tmp)/outfile$TotalPopulation # adjust for % of total population
outfile_tmp <- as.data.frame(runmean(outfile_tmp, rolling_averages)) # build a rolling average (6 for 6 months)

colnames(outfile_tmp) <- list("nowVul Purchase BTL",	 "nowVul Dissaving BTL",	 "nowVul Other BTL",	"nowVul Purchase SSB",	 "nowVul Dissaving SSB",	 
                              "nowVul Other SSB",	 "nowVul Purchase FTB",	 "nowVul Dissaving FTB",	 "nowVul Other FTB") # abbreviate colnames for figure



outfile_tmp <- outfile_tmp %>%
  bind_cols(outfile$`Model time`, outfile$`Sale HPI`)%>%
  pivot_longer(c("nowVul Purchase BTL",	 "nowVul Dissaving BTL",	 "nowVul Other BTL",	"nowVul Purchase SSB",	 "nowVul Dissaving SSB",	 
                 "nowVul Other SSB",	 "nowVul Purchase FTB",	 "nowVul Dissaving FTB",	 "nowVul Other FTB"))  ## prepare for boxplots

colnames(outfile_tmp) <- list("Period","HousePriceIndex", "vulnerable_by", "value")
outfile_tmp <- outfile_tmp %>%
  mutate(agent = case_when(vulnerable_by %in%c ("nowVul Purchase BTL",	 "nowVul Dissaving BTL",	 "nowVul Other BTL") ~ "BTL",
                           vulnerable_by %in% c("nowVul Purchase SSB",	 "nowVul Dissaving SSB",	 "nowVul Other SSB") ~ "SSB",
                           vulnerable_by %in% c("nowVul Purchase FTB",	 "nowVul Dissaving FTB",	 "nowVul Other FTB") ~ "FTB"))%>%
  mutate(vulnerable_by = case_when(vulnerable_by %in% c("nowVul Purchase BTL", "nowVul Purchase SSB",	"nowVul Purchase FTB") ~ "purchase",
                                   vulnerable_by %in% c("nowVul Dissaving BTL", "nowVul Dissaving SSB", "nowVul Dissaving FTB") ~ "dissaving",
                                   vulnerable_by %in% c( "nowVul Other BTL", "nowVul Other SSB", "nowVul Other FTB") ~ "other")) %>%
  mutate(value = formattable::percent(value))

outfile_tmp$vulnerable_by <- factor(outfile_tmp$vulnerable_by, levels = c("other", "purchase", "dissaving"))
# outfile_tmp$vulnerable_by <- factor(outfile_tmp$vulnerable_by, levels = c("other", "dissaving", "purchase"))

color_set_1 <- cet_pal(5, name = "r3") # color sets also used for later figure

# parameters for figure
relation_rhs_lhs <- 40

outfile_tmp %>%
    filter(Period >= trough_period[troughs_limits[1]], Period <= trough_period[troughs_limits[2]])%>%
  ggplot(aes(x=Period, fill = vulnerable_by))+
  geom_col( aes(y = value))+
  geom_line( aes(y = HousePriceIndex / relation_rhs_lhs), size=0.25, linetype="dashed") +
  scale_y_continuous(
    # Features of the first axis
    name = "share of vulnerable households",
    labels = scales::percent,
    # Add a second axis and specify its features
    sec.axis = sec_axis(~ . *relation_rhs_lhs, name="House Price Index"),
    expand = expansion(mult = c(0, 0.05)) # make the barplots start at the axis
  ) +
  scale_x_continuous(expand = expansion(mult = c(0,0)))+
  # theme_classic()+
  theme(legend.position = "bottom") +
  theme(legend.background = element_blank()) +  # Remove overall border
  theme(legend.key = element_blank()) +
  scale_fill_manual(values = color_set_1)+
  facet_wrap( ~ agent) # , scales = "free")
# labs(caption = "Notes: Your long reference footnote goes in here. UNd brigensBesonders krass\n dass das so ist")
```

```{r, flowAgentClass, fig.cap="Causes for changes in the vulnerability of agent-classes", fig.show='hold', message=FALSE, warning=FALSE,  results=FALSE,  echo=FALSE,  out.height= '33%'}
outfile_tmp <- outfile %>%
  select("Vulnerable By Purchase BTL",	"Vulnerable By Purchase SSB",	 "Vulnerable By Purchase InFirstHome",	"Vulnerable By Consumption BTL",	 "Vulnerable By Consumption SSB",	 "Vulnerable By Consumption InFirstHome",	"Vulnerable By Other BTL",	 "Vulnerable By Other SSB",	 "Vulnerable By Other InFirstHome",	"Non-Vulnerable Because Sale BTL",	 "Non-Vulnerable Because Sale SSB",	 "Non-Vulnerable Because Sale InFirstHome", "Non-Vulnerable Because Saving BTL",	 "Non-Vulnerable Because Saving SSB",	 "Non-Vulnerable Because Saving InFirstHome",	 "Non-Vulnerable Because Other BTL",	 "Non-Vulnerable Because Other SSB",	 "Non-Vulnerable Because Other InFirstHome",
         "nVul activeBTL (X*medIncome Y*m)", "nVul inFirstHome (X*medIncome Y*m)",	"nVul SSB (X*medIncome Y*m)")

# set non-vulnerable values as negative
outfile_tmp <- outfile_tmp %>%
  mutate(`Non-Vulnerable Because Sale BTL` = - `Non-Vulnerable Because Sale BTL`,	 `Non-Vulnerable Because Sale SSB` = - `Non-Vulnerable Because Sale SSB`, 
         `Non-Vulnerable Because Sale InFirstHome` = - `Non-Vulnerable Because Sale InFirstHome`, `Non-Vulnerable Because Saving BTL` = - `Non-Vulnerable Because Saving BTL`,
         `Non-Vulnerable Because Saving SSB` = - `Non-Vulnerable Because Saving SSB`,	 `Non-Vulnerable Because Saving InFirstHome` = - `Non-Vulnerable Because Saving InFirstHome`,
         `Non-Vulnerable Because Other BTL` = - `Non-Vulnerable Because Other BTL`,	 `Non-Vulnerable Because Other SSB` = - `Non-Vulnerable Because Other SSB`,	
         `Non-Vulnerable Because Other InFirstHome` = - `Non-Vulnerable Because Other InFirstHome`) 


outfile_tmp <- as.matrix(outfile_tmp)/outfile$TotalPopulation # adjust for % of total population
outfile_tmp <- as.data.frame(runmean(outfile_tmp, rolling_averages)) # build a rolling average (6 for 6 months)

colnames(outfile_tmp) <- list("Vulnerable By Purchase BTL",	"Vulnerable By Purchase SSB",	 "Vulnerable By Purchase InFirstHome",	"Vulnerable By Consumption BTL",	 "Vulnerable By Consumption SSB",	 "Vulnerable By Consumption InFirstHome",	"Vulnerable By Other BTL",	 "Vulnerable By Other SSB",	 "Vulnerable By Other InFirstHome",	"Non-Vulnerable Because Sale BTL",	 "Non-Vulnerable Because Sale SSB",	 "Non-Vulnerable Because Sale InFirstHome", "Non-Vulnerable Because Saving BTL",	 "Non-Vulnerable Because Saving SSB",	 "Non-Vulnerable Because Saving InFirstHome",	 "Non-Vulnerable Because Other BTL",	 "Non-Vulnerable Because Other SSB",	 "Non-Vulnerable Because Other InFirstHome",
         "nVul activeBTL", "nVul inFirstHome",	"nVul SSB") 

## build a file with periods, HPI and the change in share of vulnerable households by agent-class
outfile_tmp1 <- outfile_tmp %>%
  mutate(change_BTL = `nVul activeBTL` - lag(`nVul activeBTL`),
         change_SSB = `nVul SSB` - lag(`nVul SSB`),
         change_FTB = `nVul inFirstHome` - lag(`nVul inFirstHome`))%>%
  select(-c(`nVul activeBTL`, `nVul SSB`,`nVul inFirstHome`, "Vulnerable By Purchase BTL",	"Vulnerable By Purchase SSB",	 "Vulnerable By Purchase InFirstHome",	"Vulnerable By Consumption BTL",	 "Vulnerable By Consumption SSB",	 "Vulnerable By Consumption InFirstHome",	"Vulnerable By Other BTL",	 "Vulnerable By Other SSB",	 "Vulnerable By Other InFirstHome",	"Non-Vulnerable Because Sale BTL",	 "Non-Vulnerable Because Sale SSB",	 "Non-Vulnerable Because Sale InFirstHome", "Non-Vulnerable Because Saving BTL",	 "Non-Vulnerable Because Saving SSB",	 "Non-Vulnerable Because Saving InFirstHome",	 "Non-Vulnerable Because Other BTL",	 "Non-Vulnerable Because Other SSB",	 "Non-Vulnerable Because Other InFirstHome")) %>%
  bind_cols(outfile$`Model time`) %>%
  pivot_longer(c("change_BTL", "change_SSB", "change_FTB"))
colnames(outfile_tmp1) <- list("Period", "agent_change", "change")

outfile_tmp1 <- outfile_tmp1 %>%
  mutate(agent = case_when(agent_change == "change_BTL" ~ "BTL",
                           agent_change == "change_SSB" ~ "SSB",
                           agent_change == "change_FTB" ~ "FTB"))

# build a data frame where the causes for vulnerability become a "factor" and the values are gathered in one column (for graph)
outfile_tmp <- outfile_tmp %>%
  bind_cols(outfile$`Model time`, outfile$`Sale HPI`) %>%
  select(-c(`nVul activeBTL`, `nVul SSB`,`nVul inFirstHome`))%>%
  pivot_longer(c("Vulnerable By Purchase BTL",	"Vulnerable By Purchase SSB",	 "Vulnerable By Purchase InFirstHome",	"Vulnerable By Consumption BTL",	 "Vulnerable By Consumption SSB",	 "Vulnerable By Consumption InFirstHome",	"Vulnerable By Other BTL",	 "Vulnerable By Other SSB",	 "Vulnerable By Other InFirstHome",	"Non-Vulnerable Because Sale BTL",	 "Non-Vulnerable Because Sale SSB",	 "Non-Vulnerable Because Sale InFirstHome", "Non-Vulnerable Because Saving BTL",	 "Non-Vulnerable Because Saving SSB",	 "Non-Vulnerable Because Saving InFirstHome",	 "Non-Vulnerable Because Other BTL",	 "Non-Vulnerable Because Other SSB",	 "Non-Vulnerable Because Other InFirstHome")) 

colnames(outfile_tmp) <- list("Period","HousePriceIndex", "vulnerability", "value")

outfile_tmp <- outfile_tmp %>%
  mutate(agent = case_when(vulnerability %in%c( "Vulnerable By Purchase BTL"  , "Vulnerable By Consumption BTL", "Vulnerable By Other BTL", 
                                                "Non-Vulnerable Because Sale BTL" , "Non-Vulnerable Because Saving BTL" , "Non-Vulnerable Because Other BTL") ~ "BTL",
                           vulnerability %in% c("Vulnerable By Purchase SSB", "Vulnerable By Consumption SSB", "Vulnerable By Other SSB",
                                                "Non-Vulnerable Because Sale SSB", "Non-Vulnerable Because Saving SSB","Non-Vulnerable Because Other SSB") ~ "SSB",
                           vulnerability %in% c("Vulnerable By Purchase InFirstHome", "Vulnerable By Consumption InFirstHome", "Vulnerable By Other InFirstHome",
                                                "Non-Vulnerable Because Sale InFirstHome", "Non-Vulnerable Because Saving InFirstHome","Non-Vulnerable Because Other InFirstHome") ~ "FTB"))%>%
  mutate(cause = case_when(vulnerability %in% c("Vulnerable By Purchase BTL",	"Vulnerable By Purchase SSB",	 "Vulnerable By Purchase InFirstHome") ~ "vulnerable by purchase",
                           vulnerability %in% c("Non-Vulnerable Because Sale BTL",	 "Non-Vulnerable Because Sale SSB",	 "Non-Vulnerable Because Sale InFirstHome") ~ "non-vulnerable by sale",
                           vulnerability %in% c("Vulnerable By Consumption BTL",	 "Vulnerable By Consumption SSB",	 "Vulnerable By Consumption InFirstHome") ~ "vulnerable by dissaving",
                           vulnerability %in% c("Non-Vulnerable Because Saving BTL",	 "Non-Vulnerable Because Saving SSB",	 "Non-Vulnerable Because Saving InFirstHome") ~ "non-vulnerable by saving",
                           vulnerability %in% c("Vulnerable By Other BTL",	 "Vulnerable By Other SSB",	 "Vulnerable By Other InFirstHome") ~ "vulnerable by other",
                           vulnerability %in% c("Non-Vulnerable Because Other BTL",	 "Non-Vulnerable Because Other SSB",	 "Non-Vulnerable Because Other InFirstHome") ~ "non-vulnerable by other"))

outfile_tmp$cause <- factor(outfile_tmp$cause, levels = c("vulnerable by other",  "vulnerable by purchase",  "vulnerable by dissaving", 
                                                          "non-vulnerable by other", "non-vulnerable by sale", "non-vulnerable by saving"))
# 
# #### Join tables 
outfile_tmp <- left_join(outfile_tmp, outfile_tmp1, by = c("Period", "agent"))%>%
  mutate(value = formattable::percent(value),
         change = formattable::percent(change))

# parameters for figure
relation_rhs_lhs <- 1000

color_set_1 <- cet_pal(5, name = "r3") # color sets also used for later figure
color_set_2 <- c(color_set_1[1:3],cet_pal(6, name = "r1")[4:6]) #, cet_pal(10, name = "r1")[6], cet_pal(10, name = "r1")[8])

# this is so I can display "change rate" and "HPI" in the graph. 
dat_text <- data.frame(
  label = c("change \nrate", "house price \nindex (rhs)"),
  Period = c(mean(c(trough_period[troughs_limits[1]],trough_period[troughs_limits[2]])+10), mean(c(trough_period[troughs_limits[1]],trough_period[troughs_limits[2]]))+10), # +10 here to shift to the right
  agent   = c("SSB", "SSB"),
  value = c(- 0.0005, 0.0015),
  # value = -mean(range(outfile_tmp$value)), 
  cause = c("vulnerable by other", "vulnerable by other")) # this is arbitrary, but otherwise it will not plot

p <- outfile_tmp %>%
  filter(Period >= trough_period[troughs_limits[1]], Period <= trough_period[troughs_limits[2]])%>%
  ggplot(aes(x=Period, fill = cause))+
  geom_col( aes(y = value))+
  geom_line( aes(y = change), size=0.5, color = "darkred")+
  geom_line( aes(y = HousePriceIndex / relation_rhs_lhs), size=0.25, linetype="dashed") +
  scale_y_continuous(
    # Features of the first axis
    name = "share of vulnerable households",
    labels = scales::percent,
    # Add a second axis and specify its features
    sec.axis = sec_axis(~ . *relation_rhs_lhs, name="House Price Index"),
    expand = expansion(mult = c(0, 0.05)) # make the barplots start at the axis
  ) +
  scale_x_continuous(expand = expansion(mult = c(0,0)))+
  # theme_classic()+
  theme(legend.position = "bottom") +
  theme(legend.background = element_blank()) +  # Remove overall border
  theme(legend.key = element_blank()) +
  scale_fill_manual(values = color_set_2)+
  facet_wrap( ~ agent)
  p+ geom_text(data = dat_text, aes(y= value), hjust = 0.1, vjust = 0.5, label = c("change \nrate", "house price \nindex (rhs)"), color = c("darkred","black"), size=3)
# 
#   annotate("text", x = mean(c(trough_period[2],trough_period[3])), y = mean(range(outfile_tmp$value)),hjust=-0.5, vjust = 13, label = c"change rate", color = "darkred", size = 3)
# labs(caption = "Notes: Your long reference footnote goes in here. UNd brigensBesonders krass\n dass das so ist")
```

\FloatBarrier

# Additional Figures

```{r, turnover, echo = FALSE, warning=FALSE,message=FALSE, results= FALSE, fig.align='center', fig.dim = c(6, 4), fig.cap = "Housing market turnover (percentages of all houses transacted per months) - 12 months rolling averages", out.width='49%'}

outfile_tmp <- outfile %>%
  select("Sale nSales")

outfile_tmp <- as.matrix(outfile_tmp)/outfile$HousingStock
outfile_tmp <- as.data.frame(runmean(outfile_tmp, rolling_averages)) # build a rolling average (6 for 6 months)

outfile_tmp <- outfile_tmp %>%
  bind_cols(outfile$`Model time`, outfile$`Sale HPI`)
colnames(outfile_tmp) <- list("housing market turnover", "Period","HousePriceIndex")


# parameters for figure
relation_rhs_lhs <- 40
color_set_1 <- cet_pal(5, name = "r3") # color sets also used for later figure

outfile_tmp %>%
  filter(Period >= trough_period[troughs_limits[1]], Period <= trough_period[troughs_limits[2]])%>%
  ggplot(aes(x=Period))+
  geom_line( aes(y = `housing market turnover`), color = "darkred", size = 1.5)+
  geom_line( aes(y = HousePriceIndex / relation_rhs_lhs), size=1, linetype="dashed") +
  scale_y_continuous(
    # Features of the first axis
    name = "turnover (monthly sales to total housing stock)",
    labels = scales::percent,
    # Add a second axis and specify its features
    sec.axis = sec_axis(~ . *relation_rhs_lhs, name="House Price Index"),
    expand = expansion(mult = c(0, 0.05)) # make the barplots start at the axis
  ) +
  scale_x_continuous(expand = expansion(mult = c(0,0)))+
  # theme_classic()+
  theme(legend.position = c(.85, .85)) +
  theme(legend.background = element_blank()) +  # Remove overall border
  theme(legend.key = element_blank()) +
  scale_fill_manual(values = color_set_1)
# labs(caption = "Notes: Your long reference footnote goes in here. UNd brigensBesonders krass\n dass das so ist")
# scale_fill_viridis_d()

```

```{r, crossCorrelation, echo = FALSE, warning=FALSE,message=FALSE, results= FALSE, fig.cap = "Cross-Correlation of Financially Vulnerable Households and the House Price Index",  out.width='33%', fig.subcap=c("Overall Vulnerability", "Vulnerable by Dissaving", "Vulnerable by Purchase"), fig.show='hold'}
# outfile <- read_outfile_total(wd_model = "Results", model_folder_name = model_folder, nRuns = nRuns) +
ccf(outfile$`nVulHH (X*medIncome Y*m)`, outfile$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "")
ccf(outfile$`nowVul Dissaving`, outfile$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "")
ccf(outfile$`nowVul Purchase`, outfile$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "")

# 
# ccf(outfile$`nowVul Purchase SSB`, outfile$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "purchase SSB")
# ccf(outfile$`nowVul Purchase FTB`, outfile$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "purchase FTB")
# ccf(outfile$`nowVul Purchase BTL`, outfile$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "purchase BTL")
# ccf(outfile$`nowVul Dissaving SSB`, outfile$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "Dissaving SSB")
# ccf(outfile$`nowVul Dissaving FTB`, outfile$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "Dissaving FTB")
# ccf(outfile$`nowVul Dissaving BTL`, outfile$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "Dissaving BTL")


#ccf(outfile$`vulnerable by dissaving`, outfile$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "")
#ccf(outfile$`vulnerable by purchase`, outfile$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "")

# ccf(outfile$`Vulnerable By Consumption BTL`, outfile$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "")
# ccf(outfile$`Vulnerable By Consumption SSB`, outfile$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "")
# ccf(outfile$`Vulnerable By Consumption InFirstHome`, outfile$`Sale HPI`, lag.max = 30, ylab = "cross-correlation", xlab = "lag in months", main = "")

```

```{r vulSince, fig.cap="When did households, vulnerable at house price peak and trough buy and for how long have they been vulnerable?",fig.subcap=c("vulnerable at trough - period 2200", "vulnerable at peak - period 2230"),  fig.show='hold', message=FALSE, warning=FALSE, out.width='49%', results=FALSE,  echo=FALSE}
period_to_filter <- c(2200,2230)
color_set_1 <- cet_pal(5, name = "r3") # color sets also used for later figure
vul_certain_period <-sortingData_data_vul_FTBSM%>%
  mutate(agent = case_when(
    isBTL==1 & inFirstHome==0 & isFTB==0 ~ "BTL", 
    # isBTL ==0 & inFirstHome == 0 &isFTB==0 ~ "Mover", 
    # isFTB ==1 ~ "FirstTimeBuyer",
    # isBTL==1 &  isFTB==0 ~ "BTL", 
    NHouses>0 & isBTL == 0 & inFirstHome == 0 ~ "SSB",
    inFirstHome==1 ~ "FTB", 
    NHouses==0 ~ "Renter"))%>%
  filter(FinVulReason != "not vulnerable")%>%
  filter(FinVulReason != "other")%>%
  filter(Period == period_to_filter[1])%>%
  # filter(agent=="inFirstHome")%>%
  left_join(transactions_hpi, by = c("id" = "buyerId"))%>%
  mutate(principal = transactionPrice-mortgageDownpayment)%>%
  mutate(LTV = principal/transactionPrice)%>%
  mutate(LTI = principal/ (12*buyerMonthlyGrossTotalIncome))%>%
  mutate(howLongAgo = Period - `Model time`) %>%
  filter(transactionType == "sale")%>%
  filter(howLongAgo > 0)%>%
  group_by(id) %>% top_n(-1, howLongAgo) 

########################### HPI und last sale
vul_certain_period%>%
  filter(FinVulReason != "other") %>%
  ggplot(aes(x = `Model time`,y= `Sale HPI.y`, color = FinVulReason, size = FinVulSince))+
  geom_point(position = position_jitter(width = .05, height = .05), shape = 21)+
  scale_size_area(max_size = 5)+
  scale_color_manual(values = color_set_1[c(3,2)])+
  xlab("In what period did the now vulnerable household buy their last property?")+
  ylab("House Price Index at last Purchase")# +
  # ggtitle(paste0("When did households, vulnerable in period ",period_to_filter[1]," become vulnerable?"))
  # 

vul_certain_period <-sortingData_data_vul_FTBSM%>%
  mutate(agent = case_when(
    isBTL==1 & inFirstHome==0 & isFTB==0 ~ "BTL", 
    # isBTL ==0 & inFirstHome == 0 &isFTB==0 ~ "Mover", 
    # isFTB ==1 ~ "FirstTimeBuyer",
    # isBTL==1 &  isFTB==0 ~ "BTL", 
    NHouses>0 & isBTL == 0 & inFirstHome == 0 ~ "SSB",
    inFirstHome==1 ~ "FTB", 
    NHouses==0 ~ "Renter"))%>%
  filter(FinVulReason != "not vulnerable")%>%
  filter(FinVulReason != "other")%>%
  filter(Period == period_to_filter[2])%>%
  # filter(agent=="inFirstHome")%>%
  left_join(transactions_hpi, by = c("id" = "buyerId"))%>%
  mutate(principal = transactionPrice-mortgageDownpayment)%>%
  mutate(LTV = principal/transactionPrice)%>%
  mutate(LTI = principal/ (12*buyerMonthlyGrossTotalIncome))%>%
  mutate(howLongAgo = Period - `Model time`) %>%
  filter(transactionType == "sale")%>%
  filter(howLongAgo > 0)%>%
  group_by(id) %>% top_n(-1, howLongAgo) 

########################### HPI und last sale
vul_certain_period%>%
  filter(FinVulReason != "other") %>%
  ggplot(aes(x = `Model time`,y= `Sale HPI.y`, color = FinVulReason, size = FinVulSince))+
  geom_point(position = position_jitter(width = .05, height = .05), shape = 21)+
  scale_size_area(max_size = 5)+
  scale_color_manual(values = color_set_1[c(3,2)])+
  xlab("In what period did the now vulnerable household buy their last property?")+
  ylab("House Price Index at last Purchase") #+
  # ggtitle(paste0("When did households, vulnerable in period ",period_to_filter[2]," become vulnerable?"))


```

```{r, ScatterIncomePercentile, fig.cap="Scatterplot of the effect of the parameter Income Percentile on the strength of the consumption channel", fig.show='hold', message=FALSE, warning=FALSE, out.width='66%', results=FALSE,  echo=FALSE}


effect_plot(BaseFormula, pred = incomePercentile, interval = TRUE, plot.points = TRUE,x.label = "Income percentile", y.label = "Strength of consumption channel")

```

\FloatBarrier

# References {.unnumbered}

<!-- `r if (knitr:::is_html_output()) ' # References {-} '` -->
